<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>S·∫Øp x·∫øp ·∫£nh - Mobile Optimized</title>
<!-- Th∆∞ vi·ªán x·ª≠ l√Ω file ZIP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
    /* === CSS CHUNG === */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; overflow-x: hidden; }
    
    /* N√∫t b·∫•m chung */
    button, label.custom-file-label { 
        padding: 8px 12px; 
        background-color: #007bff; 
        color: white; 
        border: none; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 14px; 
        transition: all 0.2s; 
        white-space: nowrap; 
        text-align: center; 
        display: inline-flex;
        align-items: center;
        justify-content: center;
        user-select: none;
    }
    button:active, label.custom-file-label:active { transform: scale(0.96); }
    button:hover, label.custom-file-label:hover { background-color: #0056b3; }
    input[type="file"].custom-file-input { display: none; }

    /* === THANH C√îNG C·ª§ (HEADER) === */
    .controls {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    /* N√∫t ·∫©n/hi·ªán thanh c√¥ng c·ª• */
    .toggle-controls-btn {
        position: absolute;
        bottom: -24px;
        right: 10px;
        width: 30px;
        height: 24px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        z-index: 1001;
        font-weight: bold;
        color: #555;
    }

    .controls.collapsed {
        transform: translateY(-100%);
    }
    .controls.collapsed .toggle-controls-btn {
        bottom: -24px; /* Gi·ªØ n√∫t lu√¥n hi·ªÉn th·ªã b√™n d∆∞·ªõi header */
    }

    .control-inner {
        padding: 10px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .control-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
    }
    
    .control-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

    /* Paste Zone */
    #paste-zone { 
        flex: 1 1 100%;
        padding: 15px; 
        border: 2px dashed #ccc; 
        border-radius: 6px; 
        text-align: center; 
        color: #888; 
        background-color: #fafafa;
        font-size: 13px;
    }
    #paste-zone.drag-over { background-color: #e3f2fd; border-color: #2196f3; color: #2196f3; }

    /* Khu v·ª±c nh·∫≠p t√™n danh s√°ch */
    #name-list { width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
    
    /* === DANH S√ÅCH ·∫¢NH === */
    .main-content {
        padding: 15px 10px 80px 10px; /* Padding bottom ƒë·ªÉ kh√¥ng b·ªã che khu·∫•t */
        min-height: 100vh;
    }

.photo-grid {
        display: flex;
        flex-direction: column;
        gap: 1px; /* <--- GI·∫¢M T·ª™ 25px XU·ªêNG C√íN 4px */
        max-width: 800px;
        margin: 0 auto;
    }

    .photo-wrapper {
        background: #fff;
        border-radius: 4px; /* Bo g√≥c nh·ªè l·∫°i cho g·ªçn */
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        padding: 2px; /* <--- GI·∫¢M T·ª™ 10px XU·ªêNG 5px ƒê·ªÇ KHUNG NH·ªé L·∫†I */
        position: relative;
    }
    /* Khung ch·ª©a ·∫£nh */
    .img-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 75%; /* T·ªâ l·ªá khung h√¨nh (c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh) */
        background-color: #eee;
        border-radius: 6px;
        overflow: hidden;
        cursor: zoom-in;
        touch-action: pan-y; /* M·∫∑c ƒë·ªãnh cho ph√©p cu·ªôn d·ªçc */
    }
    
    .img-container.zoomed-active {
        cursor: grab;
        touch-action: none; /* Khi zoom th√¨ ch·∫∑n cu·ªôn trang ƒë·ªÉ x·ª≠ l√Ω pan */
        z-index: 10;
        outline: 2px solid #007bff;
    }

    .photo-item {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        object-fit: contain;
        transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* M∆∞·ª£t m√† khi zoom */
        transform-origin: center center;
    }

    /* N√∫t x√≥a ·∫£nh */
    .delete-btn {
        position: absolute;
        top: -8px; right: -8px;
        width: 28px; height: 28px;
        background: #ff4444;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center; justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 20;
    }

    /* Khu v·ª±c t√™n v√† n√∫t copy/paste */
    .name-toolbar {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
    }

    .name-input-wrapper {
        flex: 1;
        position: relative;
    }

    .name-container input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px; /* Font size > 16px ƒë·ªÉ tr√°nh iOS zoom khi focus */
        font-weight: 500;
    }

    /* N√∫t Copy Paste nh·ªè */
    .tool-btn {
        padding: 0;
        width: 36px;
        height: 36px;
        background-color: #f0f0f0;
        color: #555;
        border: 1px solid #ccc;
        font-size: 16px;
    }
    .tool-btn:hover { background-color: #e0e0e0; }
    .tool-btn svg { width: 18px; height: 18px; fill: currentColor; }

    /* Hi·ªáu ·ª©ng */
    .newly-added { animation: flash 1s; }
    @keyframes flash { 0% { background-color: #fff3cd; } 100% { background-color: #fff; } }

    /* Progress Bar */
    #download-progress { width: 100%; height: 4px; margin-top: 5px; display: none; appearance: none; }
    #download-progress::-webkit-progress-bar { background-color: #eee; }
    #download-progress::-webkit-progress-value { background-color: #28a745; }

    /* Responsive cho m√†n h√¨nh nh·ªè */
    @media (max-width: 600px) {
        .control-group button, .control-group label {
            flex: 1;
            font-size: 13px;
            padding: 10px 5px;
        }
        .name-container input[type="text"] {
            font-size: 16px; /* Gi·ªØ 16px ƒë·ªÉ mobile ko auto zoom */
        }
    }
</style>
</head>
<body>

<div class="controls" id="controls-bar">
    <div class="control-inner">
        <!-- Nh√≥m 1: Thao t√°c file -->
        <div class="control-group">
            <label for="photo-input" class="custom-file-label">üì∑ Th√™m ·∫£nh</label>
            <label for="zip-input" class="custom-file-label">üì¶ T·∫£i ZIP</label>
            <button id="download-all-btn" style="background-color: #28a745;">‚¨áÔ∏è T·∫£i v·ªÅ (ZIP)</button>
            <button id="clear-btn" style="background-color: #dc3545;">üóëÔ∏è X√≥a h·∫øt</button>
        </div>
        
        <!-- Nh√≥m 2: Paste Zone -->
        <div class="control-group">
            <div id="paste-zone">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c b·∫•m Ctrl+V</div>
        </div>

        <!-- Nh√≥m 3: ƒê·∫∑t t√™n -->
        <div class="control-group">
            <textarea id="name-list" placeholder="Nh·∫≠p danh s√°ch t√™n (m·ªói t√™n 1 d√≤ng)..."></textarea>
            <button id="assign-names-btn" style="width: 100%; margin-top: 5px;">G√°n t√™n theo list</button>
        </div>

        <progress id="download-progress" value="0" max="100"></progress>
    </div>
    
    <!-- N√∫t Toggle ·∫©n hi·ªán -->
    <div class="toggle-controls-btn" id="toggle-btn" title="·∫®n/Hi·ªán menu">‚ñ≤</div>
</div>

<div class="main-content" id="main-content">
    <div id="photo-grid-main" class="photo-grid">
        <!-- ·∫¢nh s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JS -->
    </div>
</div>

<!-- Input ·∫©n -->
<input type="file" id="photo-input" multiple accept="image/*" class="custom-file-input">
<!-- Input ch·∫•p nh·∫≠n zip v√† rar (l∆∞u √Ω rar c·∫ßn x·ª≠ l√Ω server ho·∫∑c th∆∞ vi·ªán n·∫∑ng, ·ªü ƒë√¢y ta ∆∞u ti√™n zip) -->
<input type="file" id="zip-input" accept=".zip,.rar,application/zip,application/x-rar-compressed" class="custom-file-input">

<script>
// === KHAI B√ÅO BI·∫æN ===
const photoInput = document.getElementById('photo-input');
const zipInput = document.getElementById('zip-input');
const photoGrid = document.getElementById('photo-grid-main');
const downloadProgress = document.getElementById('download-progress');
let photoDataMap = new Map();
let photoIdCounter = 0;

// === X·ª¨ L√ù THANH C√îNG C·ª§ (COLLAPSE) ===
const controlsBar = document.getElementById('controls-bar');
const toggleBtn = document.getElementById('toggle-btn');
let isControlsCollapsed = false;

toggleBtn.addEventListener('click', () => {
    isControlsCollapsed = !isControlsCollapsed;
    if (isControlsCollapsed) {
        controlsBar.classList.add('collapsed');
        toggleBtn.textContent = '‚ñº';
    } else {
        controlsBar.classList.remove('collapsed');
        toggleBtn.textContent = '‚ñ≤';
    }
});

// === LOGIC T·∫†O ·∫¢NH & GIAO DI·ªÜN ===
function createPhotoElement(id, blob, fileName) {
    const wrapper = document.createElement('div');
    wrapper.className = 'photo-wrapper newly-added';
    wrapper.dataset.id = id;

    // Khung ·∫£nh
    const imgContainer = document.createElement('div');
    imgContainer.className = 'img-container';
    
    const img = document.createElement('img');
    img.src = URL.createObjectURL(blob);
    img.className = 'photo-item';
    
    // G√°n s·ª± ki·ªán zoom
    setupZoomEvents(imgContainer, img);

    // N√∫t x√≥a
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.innerHTML = '√ó';
    deleteBtn.onclick = () => {
        if(confirm('X√≥a ·∫£nh n√†y?')) {
            wrapper.remove();
            photoDataMap.delete(id);
            updateNumbering();
        }
    };

    imgContainer.appendChild(img);
    imgContainer.appendChild(deleteBtn);

    // Khu v·ª±c t√™n + N√∫t Copy/Paste
    const nameToolbar = document.createElement('div');
    nameToolbar.className = 'name-toolbar';

    // Input t√™n
    const nameWrapper = document.createElement('div');
    nameWrapper.className = 'name-input-wrapper name-container';
    const input = document.createElement('input');
    input.type = 'text';
    // L·∫•y t√™n file g·ªëc, b·ªè ƒëu√¥i
    let cleanName = fileName.replace(/\.[^/.]+$/, "");
    // X√≥a s·ªë th·ª© t·ª± c≈© n·∫øu c√≥ (vd: "1. anh dep" -> "anh dep")
    cleanName = cleanName.replace(/^\d+\.\s+/, ''); 
    input.value = cleanName;
    nameWrapper.appendChild(input);

    // N√∫t Copy
    const copyBtn = document.createElement('button');
    copyBtn.className = 'tool-btn';
    copyBtn.title = 'Sao ch√©p t√™n';
    copyBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>`;
    copyBtn.onclick = () => {
        navigator.clipboard.writeText(input.value).then(() => {
            copyBtn.style.color = '#28a745';
            setTimeout(() => copyBtn.style.color = '', 1000);
        });
    };

    // N√∫t Paste
    const pasteBtn = document.createElement('button');
    pasteBtn.className = 'tool-btn';
    pasteBtn.title = 'D√°n t√™n v√†o ƒë√¢y';
    pasteBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>`;
    pasteBtn.onclick = async () => {
        try {
            const text = await navigator.clipboard.readText();
            if(text) input.value = text;
        } catch (err) {
            alert('Kh√¥ng th·ªÉ d√°n: Tr√¨nh duy·ªát ch·∫∑n quy·ªÅn truy c·∫≠p clipboard.');
        }
    };

    nameToolbar.appendChild(nameWrapper);
    nameToolbar.appendChild(copyBtn);
    nameToolbar.appendChild(pasteBtn);

    wrapper.appendChild(imgContainer);
    wrapper.appendChild(nameToolbar);

    photoDataMap.set(id, { blob, fileName });
    return wrapper;
}

// === LOGIC ZOOM & PAN (X·ª≠ l√Ω vu·ªët/zoom) ===
function setupZoomEvents(container, img) {
    let isZoomed = false;
    let scale = 1;
    let pointX = 0, pointY = 0; // ƒêi·ªÉm g·ªëc khi zoom
    let startX = 0, startY = 0; // ƒêi·ªÉm b·∫Øt ƒë·∫ßu vu·ªët
    let translateX = 0, translateY = 0; // T·ªça ƒë·ªô d·ªãch chuy·ªÉn hi·ªán t·∫°i

    // H√†m reset v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
    const resetZoom = () => {
        isZoomed = false;
        scale = 1;
        translateX = 0;
        translateY = 0;
        img.style.transform = `translate(0px, 0px) scale(1)`;
        container.classList.remove('zoomed-active');
    };

    // 1. Double click handling
    container.addEventListener('dblclick', (e) => {
        e.preventDefault(); // NgƒÉn zoom m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát
        
        if (!isZoomed) {
            // L·∫ßn click 1: Zoom v√†o ch·ªó click
            isZoomed = true;
            scale = 2;
            
            // T√≠nh to√°n v·ªã tr√≠ click t∆∞∆°ng ƒë·ªëi trong ·∫£nh
            const rect = container.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            
            // ƒê·∫∑t transform origin ngay ch·ªó click ƒë·ªÉ zoom v√†o ƒë√≥
            // C√°ch ƒë∆°n gi·∫£n nh·∫•t ƒë·ªÉ zoom v√†o ƒëi·ªÉm click: D·ªãch chuy·ªÉn ·∫£nh ng∆∞·ª£c h∆∞·ªõng click
            // C√¥ng th·ª©c: translate = (center - clickPoint) * (scale - 1)
            // Tuy nhi√™n ƒë·ªÉ ƒë∆°n gi·∫£n cho t√≠nh nƒÉng Pan sau n√†y, ta d√πng transform origin
            img.style.transformOrigin = `${clickX}px ${clickY}px`;
            img.style.transform = `scale(2)`;
            
            // Reset translate v√¨ ƒëang d√πng transformOrigin
            translateX = 0;
            translateY = 0;

            container.classList.add('zoomed-active');
        } else {
            // L·∫ßn click 2: Tr·ªü v·ªÅ
            resetZoom();
        }
    });

    // 2. Logic Vu·ªët (Touch/Mouse) ƒë·ªÉ Pan khi ƒëang Zoom
    const handleStart = (clientX, clientY) => {
        if (!isZoomed) return;
        startX = clientX - translateX;
        startY = clientY - translateY;
    };

    const handleMove = (e, clientX, clientY) => {
        if (!isZoomed) return; // N·∫øu ch∆∞a zoom, ƒë·ªÉ tr√¨nh duy·ªát x·ª≠ l√Ω cu·ªôn trang
        
        e.preventDefault(); // CH·∫∂N CU·ªòN TRANG KHI ƒêANG ZOOM
        
        // T√≠nh to√°n ƒë·ªô d·ªãch chuy·ªÉn m·ªõi
        // V√¨ scale=2, ta c·∫ßn chia ƒë√¥i t·ªëc ƒë·ªô di chuy·ªÉn ho·∫∑c ƒë·ªÉ nguy√™n t√πy c·∫£m gi√°c
        // ·ªû ƒë√¢y ta c·ªông d·ªìn v√†o translateX/Y hi·ªán t·∫°i
        const x = clientX - startX;
        const y = clientY - startY;
        
        translateX = x;
        translateY = y;

        // C·∫≠p nh·∫≠t transform: Gi·ªØ scale, thay ƒë·ªïi translate
        // L∆∞u √Ω: Khi d√πng transformOrigin, translate s·∫Ω t√°c ƒë·ªông l√™n khung nh√¨n ƒë√£ zoom
        img.style.transform = `translate(${translateX}px, ${translateY}px) scale(2)`;
    };

    // S·ª± ki·ªán chu·ªôt
    container.addEventListener('mousedown', e => {
        if(isZoomed) {
            handleStart(e.clientX, e.clientY);
            container.style.cursor = 'grabbing';
        }
    });
    
    window.addEventListener('mousemove', e => {
        if(isZoomed && e.buttons === 1) { // Ch·ªâ di chuy·ªÉn khi ƒëang gi·ªØ chu·ªôt tr√°i
            handleMove(e, e.clientX, e.clientY);
        }
    });

    window.addEventListener('mouseup', () => {
        if(isZoomed) container.style.cursor = 'grab';
    });

    // S·ª± ki·ªán c·∫£m ·ª©ng (Touch) cho ƒëi·ªán tho·∫°i
    container.addEventListener('touchstart', e => {
        if (e.touches.length === 1) {
            handleStart(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, { passive: false }); // passive: false ƒë·ªÉ c√≥ th·ªÉ preventDefault

    container.addEventListener('touchmove', e => {
        if (e.touches.length === 1) {
            handleMove(e, e.touches[0].clientX, e.touches[0].clientY);
        }
    }, { passive: false }); // QUAN TR·ªåNG: passive false m·ªõi ch·∫∑n ƒë∆∞·ª£c cu·ªôn trang

    // 3. Logic Reset khi cu·ªôn trang
    // L·∫Øng nghe s·ª± ki·ªán scroll tr√™n window, n·∫øu ph√°t hi·ªán scroll -> reset t·∫•t c·∫£ zoom
    window.addEventListener('scroll', () => {
        if (isZoomed) {
            resetZoom();
        }
    }, { passive: true });
}


// === X·ª¨ L√ù FILE (ZIP/IMAGE) ===

// H√†m s·∫Øp x·∫øp l·∫°i s·ªë th·ª© t·ª±
function updateNumbering() {
    const inputs = photoGrid.querySelectorAll('.name-container input');
    inputs.forEach((input, index) => {
        let val = input.value.replace(/^\d+\.\s+/, '');
        input.value = `${index + 1}. ${val}`;
    });
}

// H√†m th√™m danh s√°ch file
async function addFiles(files) {
    if(!files || files.length === 0) return;
    
    // N·∫øu l√† file ZIP/RAR
    const zipFile = Array.from(files).find(f => f.name.toLowerCase().endsWith('.zip'));
    if (zipFile) {
        handleZipFile(zipFile);
        return;
    }

    // X·ª≠ l√Ω ·∫£nh th∆∞·ªùng
    const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
    for (let file of imageFiles) {
        const id = 'photo_' + Date.now() + Math.random().toString(36).substr(2, 9);
        const wrapper = createPhotoElement(id, file, file.name);
        photoGrid.appendChild(wrapper);
    }
    updateNumbering();
}

// X·ª≠ l√Ω ZIP (Fix l·ªói kh√¥ng upload ƒë∆∞·ª£c folder zip)
async function handleZipFile(file) {
    try {
        const zip = new JSZip();
        const content = await zip.loadAsync(file);
        const promises = [];

        // Duy·ªát qua t·∫•t c·∫£ file trong zip
        content.forEach((relativePath, zipEntry) => {
            // B·ªè qua th∆∞ m·ª•c v√† file h·ªá th·ªëng Mac
            if (zipEntry.dir || zipEntry.name.startsWith('__MACOSX') || zipEntry.name.includes('/.')) return;
            
            // Ki·ªÉm tra ƒëu√¥i ·∫£nh
            if (/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(zipEntry.name)) {
                const promise = zipEntry.async('blob').then(blob => {
                    // L·∫•y t√™n file cu·ªëi c√πng (lo·∫°i b·ªè folder path)
                    const fileName = zipEntry.name.split('/').pop();
                    return { blob, fileName };
                });
                promises.push(promise);
            }
        });

        if (promises.length === 0) {
            alert('Kh√¥ng t√¨m th·∫•y ·∫£nh trong file ZIP n√†y.');
            return;
        }

        const results = await Promise.all(promises);
        results.forEach(item => {
            const id = 'photo_' + Date.now() + Math.random().toString(36).substr(2, 9);
            const wrapper = createPhotoElement(id, item.blob, item.fileName);
            photoGrid.appendChild(wrapper);
        });
        updateNumbering();

    } catch (err) {
        console.error(err);
        alert('L·ªói ƒë·ªçc file ZIP. ƒê·∫£m b·∫£o ƒë√¢y l√† file ZIP chu·∫©n. N·∫øu l√† RAR, vui l√≤ng gi·∫£i n√©n ra tr∆∞·ªõc v√¨ tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ RAR tr·ª±c ti·∫øp.');
    }
}

// === C√ÅC S·ª∞ KI·ªÜN CH√çNH ===

photoInput.addEventListener('change', e => {
    addFiles(e.target.files);
    e.target.value = '';
});

zipInput.addEventListener('change', e => {
    // N·∫øu l√† zip th√¨ x·ª≠ l√Ω
    if (e.target.files[0].name.toLowerCase().endsWith('.zip')) {
        handleZipFile(e.target.files[0]);
    } else {
        alert('Hi·ªán t·∫°i web ch·ªâ h·ªó tr·ª£ t·ªët nh·∫•t cho file .ZIP. V·ªõi file .RAR vui l√≤ng gi·∫£i n√©n th·ªß c√¥ng tr∆∞·ªõc.');
    }
    e.target.value = '';
});

// S·ª± ki·ªán Paste (Ctrl+V)
document.addEventListener('paste', e => {
    const items = e.clipboardData.items;
    const files = [];
    for (let i = 0; i < items.length; i++) {
        if (items[i].kind === 'file' && items[i].type.startsWith('image/')) {
            files.push(items[i].getAsFile());
        }
    }
    if (files.length > 0) addFiles(files);
});

// S·ª± ki·ªán K√©o Th·∫£
const pasteZone = document.getElementById('paste-zone');
pasteZone.addEventListener('dragover', e => { e.preventDefault(); pasteZone.classList.add('drag-over'); });
pasteZone.addEventListener('dragleave', e => { e.preventDefault(); pasteZone.classList.remove('drag-over'); });
pasteZone.addEventListener('drop', e => {
    e.preventDefault();
    pasteZone.classList.remove('drag-over');
    addFiles(e.dataTransfer.files);
});

// N√∫t X√≥a t·∫•t c·∫£
document.getElementById('clear-btn').addEventListener('click', () => {
    if(confirm('X√≥a to√†n b·ªô ·∫£nh?')) {
        photoGrid.innerHTML = '';
        photoDataMap.clear();
    }
});

// N√∫t G√°n t√™n t·ª´ List
document.getElementById('assign-names-btn').addEventListener('click', () => {
    const rawText = document.getElementById('name-list').value;
    const names = rawText.split('\n').filter(t => t.trim() !== '');
    if (names.length === 0) return alert('Ch∆∞a nh·∫≠p danh s√°ch t√™n!');

    const inputs = photoGrid.querySelectorAll('.name-container input');
    inputs.forEach((input, index) => {
        if (names[index]) {
            const num = index + 1;
            input.value = `${num}. ${names[index].trim()}`;
        }
    });
});

// N√∫t T·∫£i v·ªÅ (T·∫°o ZIP)
document.getElementById('download-all-btn').addEventListener('click', () => {
    const wrappers = photoGrid.querySelectorAll('.photo-wrapper');
    if (wrappers.length === 0) return alert('Ch∆∞a c√≥ ·∫£nh n√†o!');

    const zip = new JSZip();
    const folder = zip.folder("Images");
    
    downloadProgress.style.display = 'block';
    downloadProgress.value = 0;

    let processed = 0;
    wrappers.forEach(w => {
        const id = w.dataset.id;
        const data = photoDataMap.get(id);
        const nameInput = w.querySelector('.name-container input');
        
        if (data && nameInput) {
            let fileName = nameInput.value.trim();
            // ƒê·∫£m b·∫£o ƒëu√¥i file
            if (!fileName.toLowerCase().endsWith('.jpg') && !fileName.toLowerCase().endsWith('.png')) {
                const ext = data.fileName.split('.').pop();
                fileName += `.${ext}`;
            }
            // Thay k√Ω t·ª± ƒë·∫∑c bi·ªát
            fileName = fileName.replace(/[<>:"/\\|?*]/g, '_');
            
            folder.file(fileName, data.blob);
        }
        processed++;
    });

    zip.generateAsync({ type: "blob" }, (metadata) => {
        downloadProgress.value = metadata.percent;
    }).then((content) => {
        saveAs(content, "sorted_photos.zip");
        downloadProgress.style.display = 'none';
    });
});

</script>
</body>
</html>

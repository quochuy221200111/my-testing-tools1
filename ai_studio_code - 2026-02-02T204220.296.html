<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vocal Studio Pro (Upgraded)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    :root {
        --bg: #101010; --surface: #1e1e1e; --panel: #252525;
        --primary: #00d2ff; --secondary: #7b42f6; --accent: #ff0055; --warning: #ffc107;
        --text: #e0e0e0; --text-muted: #888;
        --border-color: #333;
    }
    /* YÊU CẦU 1: Tối ưu responsive */
    * {
        box-sizing: border-box;
    }
    body {
        font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text);
        margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        padding: 10px; /* Thêm padding để nội dung không dính sát viền */
    }
    /* YÊU CẦU 5: Bỏ tiêu đề, tối ưu không gian */
    .main-container {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 15px;
        width: 100%;
        max-width: 1300px;
        margin-top: 5px;
    }
    .panel { background: var(--panel); border-radius: 15px; padding: 20px; border: 1px solid var(--border-color); margin-bottom: 15px; }
    .panel-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
    /* YÊU CẦU 3: Chỉ cho icon kích hoạt cuộn */
    .panel-title span { flex-grow: 1; }
    .toggle-icon { cursor: pointer; padding: 5px; transition: transform 0.3s; }
    .panel.collapsed .panel-content { max-height: 0; margin-top: -15px !important; overflow: hidden; }
    .panel.collapsed .toggle-icon { transform: rotate(-90deg); }

    /* YÊU CẦU 4: Màn hình giám sát với 2 biểu đồ */
    .monitor-screen { background: #000; border-radius: 10px; height: 150px; position: relative; border: 1px solid #444; overflow: hidden; display: flex; flex-direction: column; }
    #realtimeVisualizer { width: 100%; height: 65%; display: block; }
    #volumeTimelineCanvas { width: 100%; height: 35%; display: block; border-top: 1px solid #333;}
    .pitch-meter-container { position: absolute; left: 15px; top: 10px; bottom: 10px; width: 25px; border: 1px solid #444; border-radius: 10px; display: flex; flex-direction: column; justify-content: flex-end; background: #222; z-index: 10; }
    .pitch-meter-bar { background: linear-gradient(to top, var(--primary), var(--secondary)); width: 100%; height: 0%; border-radius: 10px; transition: height 0.1s ease-out; }
    .pitch-meter-label { position: absolute; left: 45px; font-size: 0.7rem; color: var(--text-muted); z-index: 11; }
    .pitch-meter-label-low { bottom: 10px; } .pitch-meter-label-high { top: 10px; }
    .timer-overlay { position: absolute; bottom: 10px; right: 15px; font-family: monospace; color: var(--primary); font-size: 1.2rem; z-index: 10; }
    
    /* YÊU CẦU 1: Nút control mới */
    .main-controls { display: flex; justify-content: center; gap: 20px; margin: 20px 0; align-items: center;}
    .btn-big { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 1.8rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    .btn-medium { width: 50px; height: 50px; font-size: 1.2rem; background: #444; color: var(--text); }
    .btn-medium.paused { background: var(--warning); color: #000;}
    #btnRecord { background: var(--surface); color: var(--text); }
    #btnRecord.recording { background: var(--accent); color: white; animation: pulse 1.5s infinite; }
    
    /* YÊU CẦU 3: Cải thiện thanh trượt */
    .fx-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .btn-edit-sliders { background: #333; color: var(--text); border: 1px solid #555; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
    .btn-edit-sliders.active { background: var(--primary); color: #000; }
    .control-group { margin-bottom: 15px; }
    .slider-container { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .slider-label { width: 70px; font-size: 0.8rem; color: #aaa; flex-shrink: 0; }
    input[type=range] { flex-grow: 1; accent-color: var(--primary); height: 4px; background: #444; border-radius: 2px; -webkit-appearance: none; min-width: 50px; transition: opacity 0.2s; }
    .sliders-locked input[type=range] { pointer-events: none; opacity: 0.5; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: white; border-radius: 50%; cursor: pointer; }
    .slider-value-input { width: 50px; background: #1a1a1a; border: 1px solid #444; color: var(--text); border-radius: 5px; text-align: center; font-size: 0.8rem; padding: 2px; }
    .preset-controls { display: flex; gap: 10px; margin-top: 15px; }
    select, .preset-controls input { background: #1a1a1a; border: 1px solid #444; color: var(--text); border-radius: 5px; padding: 5px;}
    .btn-simple { background: #333; color: var(--text); border: 1px solid #555; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }

    .fx-buttons { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
    .fx-btn { flex-grow: 1; background: transparent; color: var(--text-muted); border: none; padding: 10px 5px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.8rem; }
    .fx-btn:not(:last-child) { border-right: 1px solid var(--border-color); }
    .fx-btn:hover { background-color: #333; }
    .fx-btn.active { background: var(--primary); color: #000; font-weight: 600; }
    
    .lyrics-container { position: relative; height: 300px; background: #151515; border-radius: 10px; overflow: hidden; border: 1px solid var(--border-color); }
    #lyricsInput { width: 100%; height: 100%; background: transparent; color: #ddd; border: none; padding: 20px; font-size: 1.1rem; line-height: 1.6; resize: none; outline: none; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    
    /* YÊU CẦU 2: UI Hệ thống dự án */
    .project-item, .record-item { background: #2a2a2a; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; border: 1px solid #444; transition: 0.2s; cursor: pointer; }
    .project-item.selected, .record-item.selected-for-playback { background-color: #303f5a; border-color: var(--primary); }
    .record-item-info { flex-grow: 1; }
    
    /* YÊU CẦU 7: Giao diện cảnh báo dung lượng */
    #storageQuotaWarning { display: none; background: var(--warning); color: #000; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem;}
    #storageStatus { font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; text-align: center; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
    .modal-content { background: var(--surface); padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; text-align: center; }
    .trim-canvas-container { width: 100%; height: 150px; background: #000; position: relative; margin: 20px 0; border: 1px solid #444; }
    #trimCanvas { position: absolute; top:0; left:0; width:100%; height:100%;}
    .trim-controls { display:flex; flex-wrap: wrap; gap:20px; justify-content:center; }
    .btn-save { background: var(--primary); color: #000; border: none; padding: 10px 30px; border-radius: 5px; font-weight: bold; cursor: pointer; margin: 0 10px; }
    
    /* YÊU CẦU 6: Giao diện đặt tên file mới */
    .filename-container { display: flex; align-items: center; justify-content: center; gap: 5px; margin: 20px 0;}
    #recordingNameInput { background: #1a1a1a; border: 1px solid #444; color: var(--text); border-radius: 5px; padding: 8px; font-size: 1rem;}
    #dateSuffix { color: var(--text-muted); }
    
    /* YÊU CẦU 2: Giao diện chọn dự án trong modal */
    .project-selection-container { margin-top: 20px; }
    #projectSelector, #newProjectName { width: 60%; max-width: 300px; }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 0, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); } }
    @media (max-width: 900px) {
        .main-container { grid-template-columns: 1fr; }
        .trim-controls { flex-direction: column; align-items: center; }
    }
</style>
</head>
<body>

<!-- YÊU CẦU 7: Vùng cảnh báo dung lượng -->
<div id="storageQuotaWarning"></div>

<div class="main-container">
    <!-- CỘT TRÁI: ĐIỀU KHIỂN & HÌNH ẢNH -->
    <div>
        <div class="panel">
            <div class="monitor-screen">
                <!-- YÊU CẦU 4: Canvas cho 2 biểu đồ -->
                <canvas id="realtimeVisualizer"></canvas>
                <canvas id="volumeTimelineCanvas"></canvas>
                <div class="pitch-meter-container" title="Thang đo cao độ">
                    <span class="pitch-meter-label pitch-meter-label-high">Cao</span>
                    <div id="pitchMeterBar" class="pitch-meter-bar"></div>
                    <span class="pitch-meter-label pitch-meter-label-low">Thấp</span>
                </div>
                <div id="timer" class="timer-overlay">00:00</div>
            </div>
        </div>

        <!-- YÊU CẦU 1: Cụm nút control mới -->
        <div class="main-controls">
            <button id="btnRecord" class="btn-big" title="Thu âm / Dừng"><i class="fas fa-microphone"></i></button>
            <button id="btnPause" class="btn-medium btn-big" title="Tạm dừng"><i class="fas fa-pause"></i></button>
        </div>

        <div class="panel fx-panel">
            <div class="panel-title">
                <span>Hiệu ứng & EQ</span>
                <!-- YÊU CẦU 3: Chỉ icon là nút cuộn -->
                <i class="fas fa-sliders-h toggle-icon"></i>
            </div>
            <div class="panel-content">
                <!-- YÊU CẦU 3: Nút khóa và Preset -->
                <div class="fx-panel-header">
                     <button id="toggleSliderLock" class="btn-edit-sliders">Sửa</button>
                     <div class="preset-controls">
                         <select id="presetSelector"></select>
                         <button id="btnSavePreset" class="btn-simple">Lưu Preset</button>
                     </div>
                </div>
                <div class="control-group">
                    <div style="margin-bottom:10px; font-size:0.8rem; color:#aaa;">Equalizer (5-Band)</div>
                    <!-- YÊU CẦU 3: Thêm ô nhập số -->
                    <div class="slider-container"><span class="slider-label">Low</span><input type="range" class="fx-slider" data-param="eq.low" min="-12" max="12" value="0" step="1"><input type="number" class="slider-value-input" data-param="eq.low" value="0"></div>
                    <div class="slider-container"><span class="slider-label">Low-Mid</span><input type="range" class="fx-slider" data-param="eq.lowMid" min="-12" max="12" value="0" step="1"><input type="number" class="slider-value-input" data-param="eq.lowMid" value="0"></div>
                    <div class="slider-container"><span class="slider-label">Mid</span><input type="range" class="fx-slider" data-param="eq.mid" min="-12" max="12" value="0" step="1"><input type="number" class="slider-value-input" data-param="eq.mid" value="0"></div>
                    <div class="slider-container"><span class="slider-label">Hi-Mid</span><input type="range" class="fx-slider" data-param="eq.highMid" min="-12" max="12" value="0" step="1"><input type="number" class="slider-value-input" data-param="eq.highMid" value="0"></div>
                    <div class="slider-container"><span class="slider-label">High</span><input type="range" class="fx-slider" data-param="eq.high" min="-12" max="12" value="0" step="1"><input type="number" class="slider-value-input" data-param="eq.high" value="0"></div>
                </div>
                <div class="control-group">
                    <div style="margin-bottom:10px; font-size:0.8rem; color:#aaa;">Reverb (Vang không gian)</div>
                    <div class="fx-buttons">
                        <button class="fx-btn reverb-btn active" data-type="off">Tắt</button>
                        <button class="fx-btn reverb-btn" data-type="studio">Studio</button>
                        <button class="fx-btn reverb-btn" data-type="hall">Hội trường</button>
                    </div>
                    <div class="slider-container" style="margin-top:15px;">
                        <span class="slider-label">Độ lớn</span>
                        <input type="range" id="reverbMix" class="fx-slider" data-param="reverb.mix" min="0" max="1" step="0.05" value="0.3">
                        <input type="number" class="slider-value-input" data-param="reverb.mix" value="0.3" step="0.05">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CỘT PHẢI: LYRICS & THƯ VIỆN -->
    <div>
        <div class="panel lyrics-panel">
            <div class="panel-title"><span>Lời bài hát</span> <i class="fas fa-music toggle-icon"></i></div>
            <div class="panel-content">
                <div class="lyrics-container">
                    <textarea id="lyricsInput" placeholder="Dán lời bài hát vào đây..."></textarea>
                </div>
            </div>
        </div>

        <!-- YÊU CẦU 2: Panel dự án -->
        <div class="panel project-panel">
            <div class="panel-title">
                <span>Dự án</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-folder-open toggle-icon"></i>
                </div>
            </div>
            <div class="panel-content">
                 <div id="projectList" class="project-list"> <!-- Items inserted by JS --> </div>
            </div>
        </div>

        <div class="panel playlist-panel">
            <div class="panel-title">
                <span>Thư viện Bản ghi</span>
                 <i class="fas fa-list-ul toggle-icon"></i>
            </div>
            <div class="panel-content">
                <div id="playlist" class="playlist"> <!-- Items inserted by JS --> </div>
                <!-- YÊU CẦU 7: Hiển thị trạng thái bộ nhớ -->
                <div id="storageStatus"></div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CHỈNH SỬA -->
<div id="trimModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--text)">Lưu & Chỉnh sửa</h2>
        <p style="color:#888; font-size:0.9rem;">Kéo để chọn vùng âm thanh bạn muốn giữ lại.</p>
        <div class="trim-canvas-container">
            <canvas id="trimCanvas"></canvas>
        </div>

        <div class="trim-controls control-group">
            <div>
                <span class="slider-label">Bắt đầu: </span><span id="startTimeDisplay">0.0s</span>
                <input type="range" id="trimStart" value="0" step="0.01" style="max-width:200px; width:100%;">
            </div>
            <div>
                <span class="slider-label">Kết thúc: </span><span id="endTimeDisplay">0.0s</span>
                <input type="range" id="trimEnd" value="100" step="0.01" style="max-width:200px; width:100%;">
            </div>
        </div>
        
        <!-- YÊU CẦU 6: Đặt tên file -->
        <div class="filename-container">
            <input type="text" id="recordingNameInput" placeholder="Đặt tên bản thu...">
            <span id="dateSuffix"></span>
        </div>

        <!-- YÊU CẦU 2: Chọn dự án -->
        <div class="project-selection-container">
             <select id="projectSelector"></select>
             <input type="text" id="newProjectName" placeholder="...hoặc nhập tên dự án mới" style="display:none; margin-top: 5px;">
        </div>

        <div style="margin-top:20px;">
            <button id="btnCancelTrim" class="btn-cancel">Hủy bỏ</button>
            <button id="btnSaveTrim" class="btn-save"><i class="fas fa-save"></i> Lưu bản thu</button>
        </div>
    </div>
</div>
<script>
// --- GLOBAL STATE & DOM ELEMENTS ---
let db;
let audioCtx, micStream, micSource, workletNode, analyser;
let isRecording = false;
let isPaused = false;
let areSlidersLocked = true;
let audioBuffer = [];
let fullAudioData;
let sampleRate = 48000;
let timerInterval, startTime, pausedTime = 0;
let currentProjectId = null;

// YÊU CẦU 4: Biến cho biểu đồ timeline
let volumeHistory = [];
const historyLength = 256; // Số điểm dữ liệu hiển thị trên timeline

let fxState = {
    reverb: { type: 'off', mix: 0.3 },
    eq: { low: 0, lowMid: 0, mid: 0, highMid: 0, high: 0 }
};

// --- PITCH DETECTION CONSTANTS ---
const MIN_PITCH_HZ = 80; // C2
const MAX_PITCH_HZ = 1000; // C6

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    initDB();
    setupEventListeners();
    updateSliderLockUI();
});

function initDB() {
    const req = indexedDB.open("VocalStudioDB_V3", 3); // Tăng version để nâng cấp schema
    req.onupgradeneeded = e => {
        db = e.target.result;
        if (!db.objectStoreNames.contains('projects')) {
            db.createObjectStore('projects', { keyPath: 'id', autoIncrement: true });
        }
        if (!db.objectStoreNames.contains('recs')) {
            const recStore = db.createObjectStore('recs', { keyPath: 'id', autoIncrement: true });
            recStore.createIndex('projectId', 'projectId', { unique: false });
        }
        if (!db.objectStoreNames.contains('lyrics')) {
             const lyricStore = db.createObjectStore('lyrics', { keyPath: 'projectId' }); // Dùng projectId làm key
        }
        if (!db.objectStoreNames.contains('presets')) {
            db.createObjectStore('presets', { keyPath: 'name' });
        }
    };
    req.onsuccess = e => {
        db = e.target.result;
        // YÊU CẦU 7: Yêu cầu persistent storage và kiểm tra dung lượng
        requestPersistentStorage();
        checkStorageQuota();
        loadProjects();
        loadPresets();
        // Load bản ghi không thuộc dự án nào lúc đầu
        loadPlaylist(null);
    };
    req.onerror = e => console.error("DB Error:", e.target.errorCode);
}

// YÊU CẦU 7: Hàm yêu cầu Persistent Storage
async function requestPersistentStorage() {
    if (navigator.storage && navigator.storage.persist) {
        if (await navigator.storage.persisted()) {
            console.log("Lưu trữ bền vững (Persistent Storage) đã được cấp.");
            return;
        }
        const isPersisted = await navigator.storage.persist();
        console.log(`Yêu cầu lưu trữ bền vững: ${isPersisted ? 'Thành công' : 'Bị từ chối'}.`);
        if(!isPersisted){
            // Cân nhắc hiển thị một thông báo không quá aufdringlich cho người dùng
        }
    }
}

// YÊU CẦU 7: Hàm kiểm tra và cảnh báo dung lượng
async function checkStorageQuota() {
    if (navigator.storage && navigator.storage.estimate) {
        const { usage, quota } = await navigator.storage.estimate();
        const usageMB = (usage / 1024 / 1024).toFixed(2);
        const quotaMB = (quota / 1024 / 1024).toFixed(2);
        const percentageUsed = (usage / quota) * 100;
        
        const statusEl = document.getElementById('storageStatus');
        if(statusEl) statusEl.innerHTML = `Đã dùng: <b>${usageMB} MB</b> / ${quotaMB} MB (${percentageUsed.toFixed(1)}%)`;

        const warningEl = document.getElementById('storageQuotaWarning');
        if (percentageUsed > 80) {
            warningEl.style.display = 'block';
            warningEl.textContent = `Cảnh báo: Bộ nhớ cục bộ đã sử dụng ${percentageUsed.toFixed(0)}%. Vui lòng tải xuống các bản ghi cũ để tránh bị lỗi lưu.`;
        } else {
            warningEl.style.display = 'none';
        }
        return percentageUsed;
    }
    return 0;
}


function setupEventListeners() {
    document.getElementById('btnRecord').onclick = toggleRecording;
    document.getElementById('btnPause').onclick = togglePause;
    
    // YÊU CẦU 3: Event listener chỉ cho icon
    document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.onclick = (e) => {
            e.stopPropagation(); // Ngăn sự kiện nổi bọt
            icon.closest('.panel').classList.toggle('collapsed');
        };
    });

    document.querySelectorAll('.reverb-btn').forEach(btn => {
        btn.onclick = () => {
            fxState.reverb.type = btn.dataset.type;
            document.querySelectorAll('.reverb-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            applyReverbSettings();
        };
    });

    // YÊU CẦU 3: Event Listeners cho slider và input số
    document.querySelectorAll('.fx-slider').forEach(slider => {
        slider.oninput = e => {
            if (areSlidersLocked) return;
            const paramPath = e.target.dataset.param.split('.');
            const value = paramPath[0] === 'reverb' ? parseFloat(e.target.value) : parseInt(e.target.value);
            
            if (paramPath.length > 1) fxState[paramPath[0]][paramPath[1]] = value;
            else fxState[paramPath[0]] = value;
            
            // Cập nhật input số tương ứng
            document.querySelector(`.slider-value-input[data-param="${e.target.dataset.param}"]`).value = value;
            applyFX();
        };
    });
    
    document.querySelectorAll('.slider-value-input').forEach(input => {
        input.onchange = e => { // Dùng onchange để không bị nhảy khi đang gõ
            if (areSlidersLocked) return;
            const paramPath = e.target.dataset.param.split('.');
            const value = paramPath[0] === 'reverb' ? parseFloat(e.target.value) : parseInt(e.target.value);
            
            if (paramPath.length > 1) fxState[paramPath[0]][paramPath[1]] = value;
            else fxState[paramPath[0]] = value;
            
            // Cập nhật slider tương ứng
            document.querySelector(`.fx-slider[data-param="${e.target.dataset.param}"]`).value = value;
            applyFX();
        }
    });
    
    document.getElementById('toggleSliderLock').onclick = () => {
        areSlidersLocked = !areSlidersLocked;
        updateSliderLockUI();
    };
    
    document.getElementById('btnSavePreset').onclick = savePreset;
    document.getElementById('presetSelector').onchange = loadSelectedPreset;

    document.getElementById('projectList').addEventListener('click', (e) => {
        const item = e.target.closest('.project-item');
        if (item) {
            selectProject(parseInt(item.dataset.id));
        }
    });
    
    document.getElementById('projectSelector').onchange = (e) => {
        document.getElementById('newProjectName').style.display = (e.target.value === 'new') ? 'block' : 'none';
    };

    document.getElementById('btnCancelTrim').onclick = discardRecording;
    document.getElementById('btnSaveTrim').onclick = saveTrimmedAudio;
    document.getElementById('trimStart').oninput = drawTrimWaveform;
    document.getElementById('trimEnd').oninput = drawTrimWaveform;
}

function applyFX() {
    applyEQSettings();
    applyReverbSettings();
}

function updateSliderLockUI() {
    const btn = document.getElementById('toggleSliderLock');
    const panelContent = btn.closest('.panel-content');
    btn.classList.toggle('active', !areSlidersLocked);
    panelContent.classList.toggle('sliders-locked', areSlidersLocked);
    btn.textContent = areSlidersLocked ? 'Sửa' : 'Khóa';
}

// --- AUDIO ENGINE ---
async function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
    sampleRate = audioCtx.sampleRate;

    micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, channelCount: 1 }
    });
    micSource = audioCtx.createMediaStreamSource(micStream);
    buildFXChain(micSource); 
    
    const workletBlob = new Blob([`class RecorderProcessor extends AudioWorkletProcessor { process(inputs) { this.port.postMessage(inputs[0][0]); return true; } } registerProcessor('recorder-processor', RecorderProcessor);`], { type: 'application/javascript' });
    const workletURL = URL.createObjectURL(workletBlob);
    await audioCtx.audioWorklet.addModule(workletURL);
    workletNode = new AudioWorkletNode(audioCtx, 'recorder-processor');
    workletNode.port.onmessage = (event) => {
        if (isRecording && !isPaused && event.data) {
            audioBuffer.push(new Float32Array(event.data));
        }
    };
    analyser.connect(workletNode);
    // Không cần connect worklet tới destination vì nó chỉ dùng để ghi
}

// --- RECORDING CONTROLS ---
async function toggleRecording() {
    const btn = document.getElementById('btnRecord');
    const icon = btn.querySelector('i');

    if (!isRecording) { // Bắt đầu ghi
        await initAudio();
        isRecording = true;
        isPaused = false;
        audioBuffer = [];
        pausedTime = 0;
        
        btn.classList.add('recording');
        icon.className = 'fas fa-stop';
        
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
        drawVisualizer();

    } else { // Dừng ghi
        isRecording = false;
        clearInterval(timerInterval);
        btn.classList.remove('recording');
        icon.className = 'fas fa-microphone';
        
        if(micStream) micStream.getTracks().forEach(track => track.stop());
        micStream = null;
        if (audioCtx) {
            audioCtx.close().then(() => { audioCtx = null; });
        }
        openTrimmer();
    }
}

function togglePause() {
    if (!isRecording) return;
    const btn = document.getElementById('btnPause');
    
    isPaused = !isPaused;
    btn.classList.toggle('paused', isPaused);
    
    if (isPaused) {
        audioCtx.suspend();
        pausedTime = Date.now() - startTime;
        clearInterval(timerInterval);
    } else {
        audioCtx.resume();
        startTime = Date.now() - pausedTime;
        timerInterval = setInterval(updateTimer, 1000);
    }
}

function updateTimer() {
    const diff = Math.floor((Date.now() - startTime) / 1000);
    const m = Math.floor(diff/60).toString().padStart(2,'0');
    const s = (diff%60).toString().padStart(2,'0');
    document.getElementById('timer').innerText = `${m}:${s}`;
}

// --- VISUALIZATION ---
function drawVisualizer() {
    if (!isRecording || !analyser) return;

    const visualizerCanvas = document.getElementById('realtimeVisualizer');
    const timelineCanvas = document.getElementById('volumeTimelineCanvas');
    const vCtx = visualizerCanvas.getContext('2d');
    const tCtx = timelineCanvas.getContext('2d');
    const pitchBar = document.getElementById('pitchMeterBar');
    
    const bufferLength = analyser.frequencyBinCount; // Changed from fftSize
    const dataArray = new Float32Array(bufferLength);
    const timeDomainArray = new Float32Array(analyser.fftSize);

    const draw = () => {
        if (!isRecording) {
             vCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
             tCtx.clearRect(0, 0, timelineCanvas.width, timelineCanvas.height);
             pitchBar.style.height = '0%';
             return;
        }
        requestAnimationFrame(draw);

        if (isPaused) return;

        // Oscilloscope (Sóng âm)
        analyser.getFloatTimeDomainData(timeDomainArray);
        vCtx.fillStyle = 'black';
        vCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        vCtx.lineWidth = 2;
        vCtx.strokeStyle = 'var(--primary)';
        vCtx.beginPath();
        const sliceWidth = visualizerCanvas.width / analyser.fftSize;
        for(let i = 0, x = 0; i < analyser.fftSize; i++, x += sliceWidth) {
            const v = timeDomainArray[i] * visualizerCanvas.height/2 + visualizerCanvas.height/2;
            if(i === 0) vCtx.moveTo(x, v); else vCtx.lineTo(x, v);
        }
        vCtx.stroke();
        
        // Volume Timeline
        let sumSquares = 0.0;
        for (const amplitude of timeDomainArray) { sumSquares += amplitude * amplitude; }
        const rms = Math.sqrt(sumSquares / timeDomainArray.length);
        volumeHistory.push(rms);
        if (volumeHistory.length > historyLength) volumeHistory.shift();
        
        tCtx.fillStyle = 'black';
        tCtx.fillRect(0, 0, timelineCanvas.width, timelineCanvas.height);
        tCtx.lineWidth = 2;
        tCtx.strokeStyle = 'var(--accent)';
        tCtx.beginPath();
        for (let i = 0; i < volumeHistory.length; i++) {
             const x = (i / (historyLength - 1)) * timelineCanvas.width;
             const y = (1 - (volumeHistory[i] * 4)) * timelineCanvas.height; // *4 để khuếch đại cho rõ
             if (i === 0) tCtx.moveTo(x, y); else tCtx.lineTo(x, y);
        }
        tCtx.stroke();

        // Pitch meter
        const frequency = detectPitch(timeDomainArray);
        if (frequency) {
            const logFreq = Math.log(frequency);
            const logMin = Math.log(MIN_PITCH_HZ);
            const logMax = Math.log(MAX_PITCH_HZ);
            const percent = ((logFreq - logMin) / (logMax - logMin)) * 100;
            pitchBar.style.height = `${Math.min(100, Math.max(0, percent))}%`;
        } else {
            pitchBar.style.height = '0%';
        }
    };
    draw();
}

function detectPitch(buffer) {
    if (!audioCtx) return null;
    let rms = Math.sqrt(buffer.reduce((s, v) => s + v*v, 0) / buffer.length);
    if (rms < 0.01) return null;

    let r = new Float32Array(buffer.length);
    for (let t = 0; t < buffer.length; t++) {
        for (let i = 0; i < buffer.length - t; i++) r[t] += buffer[i] * buffer[i+t];
    }
    let d = 0;
    while (r[d] > r[d+1]) d++;
    let max_val = -1, max_pos = -1;
    for (let i = d; i < buffer.length; i++) {
        if (r[i] > max_val) { max_val = r[i]; max_pos = i; }
    }
    return max_pos > 0 ? audioCtx.sampleRate / max_pos : null;
}

// --- PROJECT & PLAYLIST ---
function loadProjects() {
    if (!db) return;
    const list = document.getElementById('projectList');
    list.innerHTML = '';
    db.transaction('projects').objectStore('projects').openCursor(null, 'prev').onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
            const item = document.createElement('div');
            item.className = 'project-item';
            item.dataset.id = cursor.value.id;
            item.textContent = cursor.value.name;
            list.appendChild(item);
            cursor.continue();
        }
    };
}

function selectProject(projectId) {
    currentProjectId = projectId;
    document.querySelectorAll('#projectList .project-item').forEach(item => {
        item.classList.toggle('selected', parseInt(item.dataset.id) === projectId);
    });
    
    // Load lời bài hát của dự án
    const tx = db.transaction(['lyrics'], 'readonly');
    const store = tx.objectStore('lyrics');
    const req = store.get(projectId);
    req.onsuccess = e => {
        document.getElementById('lyricsInput').value = e.target.result ? e.target.result.content : '';
    };

    // Load playlist của dự án
    loadPlaylist(projectId);
}

function loadPlaylist(projectId) {
    if(!db) return;
    const list = document.getElementById('playlist');
    list.innerHTML = '';
    const store = db.transaction('recs').objectStore('recs');
    const index = store.index('projectId');
    const request = index.getAll(projectId);
    
    request.onsuccess = () => {
        const recordings = request.result.sort((a,b) => b.date - a.date); // Sắp xếp mới nhất trước
        recordings.forEach(rec => {
            const url = URL.createObjectURL(rec.blob);
            const div = document.createElement('div');
            div.className = 'record-item';
            div.dataset.id = rec.id;
            div.innerHTML = `
                <div class="record-item-info">
                    <div style="font-weight:bold">${rec.name}</div>
                    <div style="font-size:0.8rem; color:#888">${new Date(rec.date).toLocaleString('vi-VN')}</div>
                </div>
                <audio controls src="${url}" style="height:35px;" class="player"></audio>
                <a href="${url}" download="${rec.name.replace(/[^a-z0-9]/gi, '_')}.wav" class="download-btn"><i class="fas fa-download"></i></a>`;
            list.appendChild(div);
        });
    };
}


// --- TRIMMER & SAVING ---
function openTrimmer() {
    const modal = document.getElementById('trimModal');
    modal.style.display = 'flex';
    
    const length = audioBuffer.reduce((sum, chunk) => sum + chunk.length, 0);
    fullAudioData = new Float32Array(length);
    let offset = 0;
    audioBuffer.forEach(chunk => {
        fullAudioData.set(chunk, offset);
        offset += chunk.length;
    });

    const duration = length / sampleRate;
    document.getElementById('trimStart').max = duration; 
    document.getElementById('trimEnd').max = duration;
    document.getElementById('trimStart').value = 0; 
    document.getElementById('trimEnd').value = duration;
    
    // YÊU CẦU 6: Set hậu tố ngày và focus
    const d = new Date();
    const dateSuffix = d.getDate().toString().padStart(2, '0') + (d.getMonth() + 1).toString().padStart(2, '0') + d.getFullYear().toString().slice(-2);
    document.getElementById('dateSuffix').textContent = `_${dateSuffix}.wav`;
    document.getElementById('recordingNameInput').focus();
    
    // YÊU CẦU 2: Load dự án vào selector
    loadProjectsIntoSelector();
    
    drawTrimWaveform();
}

function loadProjectsIntoSelector() {
    const selector = document.getElementById('projectSelector');
    selector.innerHTML = '<option value="">-- Lưu không thuộc dự án --</option>';
    selector.innerHTML += '<option value="new">** TẠO DỰ ÁN MỚI **</option>';
    
    db.transaction('projects').objectStore('projects').openCursor(null, 'prev').onsuccess = e => {
        const cursor = e.target.result;
        if(cursor) {
            selector.innerHTML += `<option value="${cursor.value.id}">${cursor.value.name}</option>`;
            cursor.continue();
        }
    }
}

function drawTrimWaveform() {
    const sStart = document.getElementById('trimStart');
    const sEnd = document.getElementById('trimEnd');
    if (parseFloat(sStart.value) >= parseFloat(sEnd.value)) sStart.value = parseFloat(sEnd.value) - 0.01;
    if (parseFloat(sEnd.value) <= parseFloat(sStart.value)) sEnd.value = parseFloat(sStart.value) + 0.01;

    const cvs = document.getElementById('trimCanvas');
    const ctx = cvs.getContext('2d');
    const w = cvs.width = cvs.clientWidth; const h = cvs.height = cvs.clientHeight;
    ctx.clearRect(0,0,w,h);
    
    const step = Math.ceil(fullAudioData.length / w);
    const amp = h / 2;
    ctx.strokeStyle = '#555'; ctx.lineWidth = 1; ctx.beginPath();
    for(let i=0; i<w; i++){
        let min = 1.0, max = -1.0;
        for (let j=0; j<step; j++) {
            const val = fullAudioData[(i * step) + j] || 0;
            if (val < min) min = val; if (val > max) max = val;
        }
        ctx.moveTo(i, amp + min * amp); ctx.lineTo(i, amp + max * amp);
    }
    ctx.stroke();

    const duration = fullAudioData.length / sampleRate;
    const startT = parseFloat(sStart.value); const endT = parseFloat(sEnd.value);
    const x1 = (startT / duration) * w; const x2 = (endT / duration) * w;
    ctx.fillStyle = 'rgba(0, 210, 255, 0.3)'; ctx.fillRect(x1, 0, x2 - x1, h);
    ctx.fillStyle = '#fff'; ctx.fillRect(x1 - 1, 0, 2, h); ctx.fillRect(x2 - 1, 0, 2, h);
    
    document.getElementById('startTimeDisplay').innerText = startT.toFixed(2)+'s';
    document.getElementById('endTimeDisplay').innerText = endT.toFixed(2)+'s';
}

async function saveTrimmedAudio() {
    // YÊU CẦU 7: Kiểm tra dung lượng trước khi lưu
    const usagePercent = await checkStorageQuota();
    if(usagePercent > 95) {
        alert("Lỗi: Bộ nhớ sắp đầy! Không thể lưu bản ghi mới. Vui lòng tải về và xóa bớt các bản ghi cũ.");
        return;
    }

    const customName = document.getElementById('recordingNameInput').value.trim();
    if (!customName) return alert("Vui lòng đặt tên cho bản thu.");
    
    const dateSuffix = document.getElementById('dateSuffix').textContent.replace('.wav','');
    const recordingName = customName + dateSuffix;
    
    const projectSelector = document.getElementById('projectSelector');
    let selectedProjectId = projectSelector.value;
    
    const newProjectName = document.getElementById('newProjectName').value.trim();
    
    if (selectedProjectId === 'new') {
        if (!newProjectName) return alert("Vui lòng nhập tên cho dự án mới.");
        // Tạo dự án mới và sau đó lưu bản ghi
        createNewProject(newProjectName, (newId) => {
            saveRecordingData(newId, recordingName);
        });
    } else {
        // Lưu vào dự án đã chọn (hoặc không có dự án)
        saveRecordingData(selectedProjectId ? parseInt(selectedProjectId) : null, recordingName);
    }
}

function createNewProject(name, callback) {
    const tx = db.transaction(['projects'], 'readwrite');
    const store = tx.objectStore('projects');
    const req = store.add({ name: name });
    req.onsuccess = (e) => {
        callback(e.target.result); // Trả về ID của dự án mới
    };
    tx.oncomplete = () => {
        loadProjects(); // Cập nhật lại danh sách dự án
    };
}

function saveRecordingData(projectId, recordingName) {
    const lyricContent = document.getElementById('lyricsInput').value.trim();
    
    // Hàm thực hiện lưu bản ghi
    const performSave = () => {
        const startT = parseFloat(document.getElementById('trimStart').value);
        const endT = parseFloat(document.getElementById('trimEnd').value);
        const startSample = Math.floor(startT * sampleRate);
        const endSample = Math.floor(endT * sampleRate);
        const slicedData = fullAudioData.slice(startSample, endSample);
        const wavBlob = encodeWAV(slicedData, sampleRate);

        const txRec = db.transaction(['recs'], 'readwrite');
        txRec.objectStore('recs').add({ name: recordingName, blob: wavBlob, date: new Date(), projectId: projectId });
        txRec.oncomplete = () => {
            document.getElementById('trimModal').style.display = 'none';
            if (projectId) {
                selectProject(projectId);
            } else {
                loadPlaylist(null); // Tải lại danh sách không thuộc dự án
            }
            audioBuffer = []; fullAudioData = null;
            checkStorageQuota(); // Cập nhật lại dung lượng sau khi lưu
        };
    };

    // Nếu có projectId và có lời, tiến hành kiểm tra và lưu lời
    if (projectId && lyricContent) {
        const txLyric = db.transaction(['lyrics'], 'readwrite');
        const store = txLyric.objectStore('lyrics');
        const getReq = store.get(projectId);

        getReq.onsuccess = (e) => {
            const existingLyric = e.target.result;
            if (existingLyric && existingLyric.content !== lyricContent) {
                if (confirm("Lời bài hát hiện tại khác với lời đã lưu trong dự án này. Bạn có muốn ghi đè không?")) {
                    store.put({ projectId: projectId, content: lyricContent });
                }
            } else if (!existingLyric) {
                store.add({ projectId: projectId, content: lyricContent });
            }
        };
        txLyric.oncomplete = performSave; // Sau khi xử lý lyric xong thì mới lưu audio
    } else {
        performSave(); // Không có lời hoặc không có dự án, lưu thẳng audio
    }
}

function discardRecording() {
    if(confirm("Hủy bản thu này?")) {
        document.getElementById('trimModal').style.display = 'none';
        audioBuffer = []; fullAudioData = null;
    }
}

function encodeWAV(samples, sampleRate) {
    const buffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(buffer);
    const write = (o,s) => { for(let i=0;i<s.length;i++) view.setUint8(o+i,s.charCodeAt(i)); };
    write(0, 'RIFF'); view.setUint32(4, 36 + samples.length * 2, true);
    write(8, 'WAVE'); write(12, 'fmt '); view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true); view.setUint16(34, 16, true);
    write(36, 'data'); view.setUint32(40, samples.length * 2, true);
    for (let i = 0; i < samples.length; i++) {
        let s = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }
    return new Blob([view], { type: 'audio/wav' });
}

// --- FX & EQ LOGIC ---
let eqNodes = [], reverbNode, reverbGain, dryGain;
function buildFXChain(sourceNode) {
    const freqs = [60, 250, 1000, 4000, 12000];
    let prevNode = sourceNode;
    eqNodes = freqs.map((f, i) => {
        const eq = audioCtx.createBiquadFilter();
        eq.frequency.value = f;
        eq.type = i === 0 ? 'lowshelf' : (i === 4 ? 'highshelf' : 'peaking');
        prevNode.connect(eq);
        prevNode = eq;
        return eq;
    });

    dryGain = audioCtx.createGain();
    reverbGain = audioCtx.createGain();
    reverbNode = audioCtx.createConvolver();
    prevNode.connect(dryGain);
    prevNode.connect(reverbNode);
    reverbNode.connect(reverbGain);
    
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    
    const mergePoint = audioCtx.createGain();
    dryGain.connect(mergePoint);
    reverbGain.connect(mergePoint);
    mergePoint.connect(analyser);
    mergePoint.connect(audioCtx.destination); // Nghe được âm thanh
    
    applyFX();
}

function applyEQSettings() {
    if (!audioCtx || !eqNodes || eqNodes.length === 0) return;
    eqNodes[0].gain.setTargetAtTime(fxState.eq.low, audioCtx.currentTime, 0.01);
    eqNodes[1].gain.setTargetAtTime(fxState.eq.lowMid, audioCtx.currentTime, 0.01);
    eqNodes[2].gain.setTargetAtTime(fxState.eq.mid, audioCtx.currentTime, 0.01);
    eqNodes[3].gain.setTargetAtTime(fxState.eq.highMid, audioCtx.currentTime, 0.01);
    eqNodes[4].gain.setTargetAtTime(fxState.eq.high, audioCtx.currentTime, 0.01);
}

function applyReverbSettings() {
    if (!audioCtx || !reverbGain) return;
    if (fxState.reverb.type === 'off') {
        reverbGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.01);
    } else {
        setReverbImpulse(fxState.reverb.type);
        reverbGain.gain.setTargetAtTime(fxState.reverb.mix, audioCtx.currentTime, 0.01);
    }
}

function setReverbImpulse(type) {
    if (!audioCtx || !reverbNode) return;
    const duration = type === 'hall' ? 2.0 : (type === 'studio' ? 0.8 : 0.01);
    const decay = type === 'hall' ? 2.5 : 4.0;
    const length = sampleRate * duration;
    const impulse = audioCtx.createBuffer(2, length, sampleRate);
    for (let c = 0; c < 2; c++) {
        const data = impulse.getChannelData(c);
        for (let i = 0; i < length; i++) {
            data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
        }
    }
    reverbNode.buffer = impulse;
}

// --- PRESET LOGIC ---
function savePreset() {
    const name = prompt("Đặt tên cho preset này:");
    if (!name || !name.trim()) return;
    const tx = db.transaction(['presets'], 'readwrite');
    tx.objectStore('presets').put({ name: name, settings: fxState });
    tx.oncomplete = () => {
        alert('Đã lưu preset!');
        loadPresets();
    };
}
function loadPresets() {
    const selector = document.getElementById('presetSelector');
    selector.innerHTML = '<option>-- Chọn Preset --</option>';
    db.transaction('presets').objectStore('presets').openCursor().onsuccess = e => {
        const cursor = e.target.result;
        if(cursor) {
            selector.innerHTML += `<option value="${cursor.value.name}">${cursor.value.name}</option>`;
            cursor.continue();
        }
    };
}
function loadSelectedPreset() {
    const selector = document.getElementById('presetSelector');
    const name = selector.value;
    if (!name.startsWith('--')) {
        db.transaction('presets').objectStore('presets').get(name).onsuccess = e => {
            const preset = e.target.result;
            if (preset) {
                fxState = preset.settings;
                updateUIFromFxState();
                applyFX();
            }
        };
    }
}
function updateUIFromFxState() {
     // Cập nhật tất cả slider và input số từ fxState
    Object.keys(fxState.eq).forEach(key => {
        const value = fxState.eq[key];
        document.querySelector(`.fx-slider[data-param="eq.${key}"]`).value = value;
        document.querySelector(`.slider-value-input[data-param="eq.${key}"]`).value = value;
    });
    document.querySelector(`.fx-slider[data-param="reverb.mix"]`).value = fxState.reverb.mix;
    document.querySelector(`.slider-value-input[data-param="reverb.mix"]`).value = fxState.reverb.mix;
    
    document.querySelectorAll('.reverb-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.reverb-btn[data-type="${fxState.reverb.type}"]`).classList.add('active');
}
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phòng trưng bày Nghệ thuật Kỹ thuật số</title>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Cormorant+Garamond:wght@400;600&family=Roboto+Slab:wght@300;400&family=Cinzel:wght@400;700&family=Dancing+Script:wght@400;700&family=EB+Garamond:ital@0;1&family=Great+Vibes&family=Lora:ital@0;1&family=Merriweather:ital,wght@0,400;0,700;1,400&family=Parisienne&family=Tangerine&display=swap" rel="stylesheet">


<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- ResponsiveVoice Text-to-Speech Library -->
<script src="https://code.responsivevoice.org/responsivevoice.js?key=m4IVb9vJ"></script>

<style>
/* --- BẢNG MÀU & CHỦ ĐỀ CỔ ĐIỂN --- */
:root {
/* Màu sắc */
--color-background: #fdf6e3;
--color-dark-wood: #3a2e24;
--color-light-wood: #5f4c3d;
--color-text-dark: #4f4a45;
--color-text-light: #e8e4d9;
--color-accent: #c5a56a;
--color-accent-hover: #dab97f;
--color-desc-text: #dcd2b4;
--color-active: #c5a56a;

/* Màu chức năng */
--danger-color: #a03a3a;
--success-color: #5a7d5a;
--warning-color: #b9892d;

/* Font chữ */
--font-heading: 'Playfair Display', serif;
--font-body: 'Montserrat', sans-serif;
--font-art-desc: 'Libre Baskerville', serif;

/* Nền tường trưng bày */
--wall-texture: url('https://www.transparenttextures.com/patterns/dark-denim-3.png');

/* CSS Variables cho màu và font tự động */
--dynamic-artwork-color: var(--color-accent-hover);
/* YÊU CẦU 3: Biến CSS mới cho màu cuối cùng sau khi điều chỉnh độ sáng */
--final-dynamic-color: var(--color-accent-hover);
--artwork-title-font: var(--font-heading);
--artwork-title-size: 1.8rem;
--artwork-artist-font: var(--font-body);
--artwork-artist-size: 1.1rem;
--artwork-desc-font: var(--font-art-desc);
--artwork-desc-size: 16px;
--first-letter-size: 4.5em;
/* YÊU CẦU 3: Biến CSS cho độ sáng không còn được dùng để filter, chỉ dùng để tính toán trong JS */
--title-brightness: 1;
/* YÊU CẦU 1: Biến CSS cho hiệu ứng soft edge */
--soft-edge-size: 0px;
/* YÊU CẦU 7: Biến CSS cho khoảng cách */
--header-spacing: 0.3em;
--desc-line-height: 1.8;
}

body, html {
margin: 0;
padding: 0;
height: 100%;
font-family: var(--font-body);
background-color: var(--color-background);
color: var(--color-text-dark);
overflow: hidden;
}

/* CSS cho chế độ chỉnh sửa */
.edit-control, .delete-control {
display: none; /* Ẩn mặc định */
font-size: 14px;
margin-left: 10px;
cursor: pointer;
color: var(--color-accent);
opacity: 0.7;
}
.edit-control:hover, .delete-control:hover {
opacity: 1;
color: var(--color-accent-hover);
}
body.edit-mode-active .edit-control,
body.edit-mode-active .delete-control {
display: inline-block; /* Hiện khi có class */
}
.delete-control {
color: var(--danger-color);
}
#delete-current-combo-btn {
grid-column: span 2;
background-color: var(--danger-color);
}
.inline-edit-input {
width: 100%;
background-color: #333;
border: 1px solid var(--color-accent);
color: white;
padding: 8px;
font-family: inherit;
font-size: inherit;
border-radius: 4px;
margin-top: 5px;
box-sizing: border-box;
}
textarea.inline-edit-input {
height: 150px;
resize: vertical;
}

/* === BẮT ĐẦU: SỬA ĐỔI CHO YÊU CẦU 2 (NÚT LƯU) === */
.inline-edit-wrapper {
    display: flex;
    flex-direction: column;
    gap: 10px; /* Khoảng cách giữa ô nhập liệu và nút Lưu */
    width: 100%;
}

.save-edit-btn {
    align-self: flex-start; /* Căn nút về phía bên trái */
    padding: 6px 18px;
    font-size: 13px;
    font-weight: bold;
    background-color: var(--success-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.2s;
}

.save-edit-btn:hover {
    opacity: 0.85;
}
/* === KẾT THÚC: SỬA ĐỔI CHO YÊU CẦU 2 === */


/* --- GIAO DIỆN CHÍNH (GIẤY MỜI) --- */
#main-content {
padding: 20px 30px 30px 30px;
max-width: 900px;
margin: 20px auto;
background-color: white;
border: 1px solid #ddd;
box-shadow: 0 10px 30px rgba(0,0,0,0.1);
border-radius: 4px;
border-left: 5px solid var(--color-accent);
height: calc(100vh - 40px);
box-sizing: border-box;
display: flex;
flex-direction: column;
}

#main-header {
text-align: center;
margin-bottom: 20px;
flex-shrink: 0;
}

#main-content-body {
flex-grow: 1;
overflow-y: auto;
padding-right: 15px;
}
#main-top-controls {
display: flex;
justify-content: center;
gap: 15px;
margin-bottom: 30px;
}

h2 {
text-align: center;
font-family: var(--font-heading);
color: var(--color-dark-wood);
border-bottom: 1px solid #e0d9c8;
padding-bottom: 10px;
margin-top: 25px;
margin-bottom: 15px;
}

textarea {
width: 98%;
height: 70px;
margin-bottom: 15px;
padding: 10px;
border: 1px solid #ccc;
border-radius: 4px;
font-size: 14px;
background-color: #f8f8f8;
font-family: var(--font-body);
color: var(--color-text-dark);
resize: vertical;
transition: height 0.2s ease;
}
textarea:focus {
outline-color: var(--color-accent);
height: 120px;
}

.input-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
}
.full-width-input {
grid-column: 1 / -1;
}

/* --- GIAO DIỆN TRÌNH CHIẾU (PHÒNG TRƯNG BÀY) --- */
.slideshow-container {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: 1000;
background-color: #1a1a1a;
background-image: var(--wall-texture);
flex-direction: row;
transition: background-image 0.5s ease-in-out;
background-size: cover;
background-position: center center;
background-repeat: no-repeat;
}

#left-panel {
flex: 0 0 60%;
height: 100%;
display: flex;
align-items: center;
justify-content: center;
overflow: hidden;
position: relative;
padding: 5vh 5vw;
box-sizing: border-box;
}

#artwork-wrapper {
position: relative;
width: 100%;
height: 100%;
display: flex;
align-items: center;
justify-content: center;
}

.slideshow-image, .frame-image {
position: absolute;
transition: opacity 0.5s ease-in-out;
opacity: 0;
}

.slideshow-image {
z-index: 2;
max-width: 100%;
max-height: 100%;
object-fit: contain;
cursor: grab;
border: none;
box-shadow: none;
will-change: transform;
/* YÊU CẦU 1: Thay đổi mask-image cho hiệu ứng soft edge hình chữ nhật trên cả 4 cạnh */
mask-image: linear-gradient(to right, transparent, black var(--soft-edge-size), black calc(100% - var(--soft-edge-size)), transparent),
linear-gradient(to bottom, transparent, black var(--soft-edge-size), black calc(100% - var(--soft-edge-size)), transparent);
-webkit-mask-image: linear-gradient(to right, transparent, black var(--soft-edge-size), black calc(100% - var(--soft-edge-size)), transparent),
linear-gradient(to bottom, transparent, black var(--soft-edge-size), black calc(100% - var(--soft-edge-size)), transparent);
mask-composite: intersect;
-webkit-mask-composite: destination-in;
}


.frame-image {
z-index: 1;
box-shadow: 0 10px 25px rgba(0,0,0,0.5);
}
.slideshow-image.visible, .frame-image.visible {
opacity: 1;
}
.slideshow-image:active { cursor: grabbing; }


/* KHUNG MÔ TẢ TRANH & HỌA SĨ (BÊN PHẢI) */
#description-container {
flex: 1;
height: 100vh;
color: var(--color-desc-text);
box-sizing: border-box;
opacity: 0;
position: relative;
padding: 60px 80px 60px 40px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: flex-start;
transition: opacity 0.5s ease-in-out 0.2s;
}
#description-container.visible {
opacity: 1;
}

/* === BẮT ĐẦU: SỬA ĐỔI CHO YÊU CẦU 1 (THANH CUỘN) === */
#description-wrapper {
    max-width: 100%;
    overflow-y: auto; /* Thay đổi từ 'hidden' sang 'auto' để cho phép cuộn */
    max-height: 100%;
    text-align: left;
    position: relative;
    padding-right: 15px; /* Thêm khoảng trống để thanh cuộn không che chữ */
}

/* Tùy chỉnh thanh cuộn cho các trình duyệt WebKit (Chrome, Safari, Edge) */
#description-wrapper::-webkit-scrollbar {
  width: 8px;
}

#description-wrapper::-webkit-scrollbar-track {
  background: transparent; /* Nền của rãnh cuộn trong suốt */
}

#description-wrapper::-webkit-scrollbar-thumb {
  background-color: var(--color-light-wood); /* Màu của con trượt */
  border-radius: 10px;
  border: 2px solid transparent;
  background-clip: content-box;
}

#description-wrapper::-webkit-scrollbar-thumb:hover {
  background-color: var(--color-accent); /* Màu con trượt khi di chuột qua */
}

/* Tùy chỉnh thanh cuộn cho Firefox */
#description-wrapper {
  scrollbar-width: thin;
  scrollbar-color: var(--color-light-wood) transparent;
}
/* === KẾT THÚC: SỬA ĐỔI CHO YÊU CẦU 1 === */


/* Định dạng thông tin tranh kiểu bảo tàng */
#artwork-info {
margin-bottom: var(--header-spacing);
/* YÊU CẦU 3: Bỏ filter brightness, màu sẽ được set trực tiếp */
transition: color 0.3s ease;
}
#artwork-title {
font-family: var(--artwork-title-font);
font-size: var(--artwork-title-size);
font-weight: 700;
/* YÊU CẦU 3: Sử dụng biến màu cuối cùng */
color: var(--final-dynamic-color);
margin: 0 0 0.1em 0;
border: none;
line-height: 1.3;
}
#artwork-title .vietnamese-title {
display: block;
font-size: 0.8em;
opacity: 0.9;
font-weight: 600;
font-style: italic;
}
#artwork-artist {
font-family: var(--artwork-artist-font);
font-size: var(--artwork-artist-size);
font-weight: 400;
/* YÊU CẦU 3: Sử dụng biến màu cuối cùng */
color: var(--final-dynamic-color);
margin: 0;
border: none;
padding: 0;
}
#desc-separator {
height: 2px;
width: 50%;
/* YÊU CẦU 3: Sử dụng biến màu cuối cùng */
background-color: var(--final-dynamic-color);
border: 0;
margin: var(--header-spacing) 0;
opacity: 0.5;
}

#artwork-main-desc {
/* YÊU CẦU 4: Sử dụng biến CSS để font và size có thể được điều khiển từ JS */
font-family: var(--artwork-desc-font);
font-size: var(--artwork-desc-size);
line-height: var(--desc-line-height);
white-space: pre-wrap;
text-align: justify;
transition: none; /* Bỏ transition transform vì không còn phân trang */
will-change: auto;
}
#artwork-main-desc p {
margin: 0 0 1em 0;
padding: 0;
}
#artwork-main-desc p:last-child {
margin-bottom: 0;
}
#artwork-main-desc p:first-child::first-letter {
/* YÊU CẦU 5: Đổi font-family để chỉ bị ảnh hưởng bởi font của tiêu đề */
font-family: var(--artwork-title-font);
font-size: var(--first-letter-size);
float: left;
margin: 0.05em 0.1em 0 0;
line-height: 0.8;
/* YÊU CẦU 3: Sử dụng biến màu cuối cùng và bỏ filter */
color: var(--final-dynamic-color);
transition: font-size 0.3s ease, color 0.3s ease;
}


#artist-info-container {
margin-top: 25px;
padding-top: 20px;
border-top: 1px solid var(--color-light-wood);
display: flex;
gap: 15px;
align-items: center;
opacity: 0;
transition: opacity 0.5s ease;
}
#artist-info-container.visible { opacity: 1; }
#artist-photo-wrapper { position: relative; flex-shrink: 0; }
#artist-photo {
width: 60px;
height: 60px;
border-radius: 50%;
object-fit: cover;
border: 3px solid var(--color-light-wood);
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
cursor: pointer;
}
#artist-tooltip {
visibility: hidden; opacity: 0; position: absolute; bottom: 70px; left: 50%;
transform: translateX(-50%); width: 300px; background-color: var(--color-dark-wood);
color: var(--color-text-light); padding: 15px; border-radius: 6px;
z-index: 1003; font-size: 13px; line-height: 1.6; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
transition: opacity 0.4s ease, visibility 0.4s ease; pointer-events: none;
}
#artist-photo-wrapper:hover #artist-tooltip { visibility: visible; opacity: 1; }

/* === GEMINI AI DESCRIPTION CONTROLS === */
#ai-description-controls {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--color-light-wood);
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.ai-control-btn {
    padding: 5px 12px;
    font-size: 12px;
    font-weight: bold;
    border: 1px solid var(--color-accent);
    color: var(--color-accent);
    background-color: transparent;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}
.ai-control-btn:hover {
    background-color: var(--color-accent);
    color: var(--color-dark-wood);
}
.ai-control-btn i {
    margin-right: 6px;
}
#ai-description-display {
    margin-top: 15px;
    background-color: rgba(0,0,0,0.2);
    border-left: 3px solid var(--warning-color);
    padding: 15px;
    border-radius: 4px;
    font-size: 14px;
    font-style: italic;
    white-space: pre-wrap;
}

/* PANEL ĐIỀU KHIỂN BÊN PHẢI */
#right-panel-wrapper {
position: fixed; top: 0; right: 0; height: 100%; z-index: 1001;
transition: transform 0.4s ease-in-out;
}
#panel-toggle-btn {
position: absolute; top: 50%; left: -25px; transform: translateY(-50%);
width: 25px; height: 60px; background-color: var(--color-dark-wood); color: var(--color-text-light);
border: 1px solid var(--color-light-wood); border-right: none; border-radius: 8px 0 0 8px;
cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; font-size: 16px;
}
#panel-toggle-btn i { transition: transform 0.3s; }

#right-panel-wrapper.collapsed { transform: translateX(calc(100% - 10px)); }
#right-panel-wrapper.collapsed #panel-toggle-btn i { transform: rotate(180deg); }

#right-panel {
width: 310px; height: 100vh; background-color: var(--color-dark-wood); color: var(--color-text-light);
padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px;
overflow: hidden; border-left: 2px solid var(--color-light-wood);
}

.slideshow-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
#stop-button { grid-column: span 2; background-color: var(--danger-color); }

#status-panel {
flex-grow: 1; background-color: rgba(0, 0, 0, 0.2); border-radius: 8px;
border: 1px solid var(--color-light-wood); padding: 15px; display: flex; flex-direction: column;
overflow: hidden;
}
#lock-status-display {
border-bottom: 1px solid var(--color-light-wood); padding-bottom: 10px; margin-bottom: 10px;
}
#lock-status-display .status-mode {
padding: 4px 8px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 10px;
font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
}
.status-mode.locked { background-color: var(--danger-color); }
.status-mode.free { background-color: var(--success-color); }
#lock-status-display h4 { margin: 10px 0 8px 0; color: var(--color-accent); font-size: 14px; font-family: var(--font-heading); }
#locked-songs-list { list-style: none; padding-left: 0; margin-top: 5px; font-size: 13px; max-height: 120px; overflow-y: auto; }
#locked-songs-list li { padding: 6px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; transition: background-color 0.2s; }
#locked-songs-list li:hover { background-color: rgba(255,255,255,0.05); }
#locked-songs-list .song-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; cursor: pointer; }
.unlock-song-btn { background-color: var(--warning-color); color: black; border: none; border-radius: 3px; padding: 3px 8px; font-size: 11px; cursor: pointer; font-weight: bold; flex-shrink: 0; min-width: 50px; text-align: center; }
.unlock-song-btn:disabled { background-color: #6c757d; cursor: not-allowed; }

/* MÁY PHÁT NHẠC */
#now-playing { margin-top: auto; background-color: #1a1510; padding: 8px 12px; border: 1px solid var(--color-light-wood); border-radius: 5px; font-size: 13px; flex-shrink: 0; display: flex; align-items: center; gap: 10px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); }
#now-playing-link { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-decoration: none; color: var(--color-accent); font-weight: bold; font-family: var(--font-heading); font-size: 11px; }
#now-playing-link:hover { color: var(--color-accent-hover); }

/* --- KIỂU DÁNG NÚT BẤM --- */
.action-button, .control-btn { padding: 8px; font-size: 13px; cursor: pointer; color: var(--color-text-light); border: 1px solid var(--color-light-wood); border-radius: 5px; transition: all 0.2s ease; text-align: center; position: relative; background: linear-gradient(to bottom, #5f5043, #4a3c31); box-shadow: 0 2px 3px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1); text-shadow: 0 -1px 0 rgba(0,0,0,0.5); }
.action-button i { margin-right: 5px; }

.action-button:hover { border-color: var(--color-accent); transform: translateY(-1px); }
.action-button:active { transform: translateY(1px); box-shadow: 0 1px 1px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1); }
.action-button.active {
background: var(--color-light-wood); border-color: var(--color-active);
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5); color: var(--color-active);
}

.main-control-btn { background: var(--color-dark-wood); color: white; padding: 12px; font-size: 15px; font-family: var(--font-heading); }
#start-button { background: var(--color-accent); color: var(--color-dark-wood); font-weight: bold; padding: 14px 30px; }
#import-file-input { display: none; }

#change-button { background-color: var(--color-accent); color: var(--color-dark-wood); }
#lock-music-button { background-color: var(--success-color); }
#lock-image-button.locked { background-color: var(--danger-color); }
#play-pause-btn { background-color: var(--color-light-wood); color: var(--color-text-light); border: 1px solid #776554; border-radius: 50%; padding: 0; width: 30px; height: 30px; line-height: 30px; text-align: center; font-size: 14px; cursor: pointer; flex-shrink: 0; transition: all 0.2s; }
#play-pause-btn:hover { background-color: var(--color-accent); color: var(--color-dark-wood); border-color: var(--color-accent-hover); }

/* PANEL PHỤ BÊN TRÁI */
#left-panel-wrapper {
position: fixed;
top: 0;
left: 0;
height: 100%;
z-index: 1002;
display: flex;
align-items: flex-start;
transform: translateX(0);
transition: transform 0.4s ease-in-out;
}
#left-panel-wrapper.collapsed {
transform: translateX(calc(-100% + 10px));
}

#left-panel-container {
display: flex;
height: 100%;
}
#left-panel-toggle-btn {
margin-top: 20px;
background-color: var(--color-dark-wood);
border: 1px solid var(--color-light-wood);
border-left: none;
border-radius: 0 8px 8px 0;
padding: 10px 0;
display: flex;
flex-direction: column;
gap: 15px;
align-items: center;
justify-content: flex-start;
cursor: pointer;
}
.left-panel-icon-btn {
color: var(--color-text-light);
font-size: 18px;
width: 35px;
height: 35px;
line-height: 35px;
text-align: center;
border-radius: 50%;
background-color: var(--color-light-wood);
transition: all 0.2s;
}
.left-panel-icon-btn:hover {
background-color: var(--color-accent);
color: var(--color-dark-wood);
}

.side-panel {
width: 0;
background-color: rgba(42, 33, 26, 0.98);
color: var(--color-text-light);
border-right: 2px solid var(--color-light-wood);
box-shadow: 5px 0 20px rgba(0,0,0,0.5);
height: 100%;
box-sizing: border-box;
display: flex;
flex-direction: column;
overflow: hidden;
opacity: 0;
transition: width 0.4s ease-in-out, opacity 0.3s ease-in-out 0.1s;
padding-left: 0;
padding-right: 0;
}
.side-panel.visible {
width: 350px;
opacity: 1;
}

.panel-header {
display: flex; justify-content: space-between; align-items: center;
border-bottom: 1px solid var(--color-light-wood); padding-bottom: 15px; margin: 20px 20px 15px 20px;
flex-shrink: 0;
min-width: 310px;
}
.panel-header h3 { margin: 0; font-family: var(--font-heading); color: var(--color-accent); font-size: 22px; }
.close-panel-btn {
background: none; border: none; color: var(--color-text-light); font-size: 24px;
cursor: pointer; padding: 0 5px; opacity: 0.7;
}
.close-panel-btn:hover { opacity: 1; color: var(--color-accent-hover); }

.side-panel-content {
flex-grow: 1; overflow-y: auto; padding: 0 20px 20px 20px;
min-width: 310px;
}
.data-stat { margin-bottom: 15px; font-size: 14px; padding-bottom: 10px; border-bottom: 1px solid var(--color-light-wood); }
#music-rankings-list li { display: flex; justify-content: space-between; padding: 8px 5px; border-radius: 4px; font-size: 13px; }
#music-rankings-list li:nth-child(odd) { background-color: rgba(255,255,255,0.03); }
#playlist-form { display: flex; gap: 10px; margin-bottom: 15px; }
#playlist-name-input { flex-grow: 1; padding: 8px; border: 1px solid var(--color-light-wood); background-color: #333; color: white; border-radius: 4px; }
#create-playlist-btn { padding: 8px 15px; background-color: var(--color-accent); color: var(--color-dark-wood); border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
#playlists-list { list-style: none; padding: 0; margin: 0; }
#playlists-list li { border-bottom: 1px solid var(--color-light-wood); padding: 12px 5px; }
#playlists-list .playlist-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; cursor: pointer; font-family: var(--font-heading); font-size: 18px; }
#playlists-list .playlist-header:hover { color: var(--color-accent); }
#playlists-list .playlist-controls { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
.playlist-start-btn { background-color: var(--success-color); color: white; }
.playlist-add-btn { background-color: var(--color-accent); color: var(--color-dark-wood); }
.playlist-delete-btn { background-color: var(--danger-color); color: white; }
.playlist-export-btn { background-color: #4a6c8b; color: white; }
.playlist-item-count { font-size: 12px; color: #aaa; font-style: italic; font-family: var(--font-body); }
.playlist-content { display: none; margin-top: 10px; padding-left: 10px; border-left: 2px solid var(--color-accent); max-height: 250px; overflow-y: auto; }
.playlist-content-item { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 8px; font-size: 12px;}
.playlist-content-item img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; flex-shrink: 0; border: 1px solid var(--color-light-wood); }
.playlist-content-item .item-details { flex-grow: 1; }
.playlist-content-item .item-name { font-weight: bold; margin-bottom: 4px; color: var(--color-accent); word-break: break-all; }
.playlist-content-item .songs { list-style: none; padding: 0; margin: 0; font-size: 11px; }
.playlist-item-delete-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 16px; padding: 0 5px; flex-shrink: 0; }
.playlist-item-delete-btn:hover { color: var(--danger-color); }

/* Danh sách chọn nhạc khi khóa tranh (trong panel) */
#music-search-input { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; border-radius: 4px; border: 1px solid var(--color-light-wood); background-color: #333; color: white; }
#all-music-list { list-style: none; padding: 0; margin: 0; max-height: calc(100vh - 150px); overflow-y: auto; font-size: 13px; }
#all-music-list li { padding: 6px; cursor: pointer; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#all-music-list li:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--color-accent); }
#all-music-list.loading li { pointer-events: none; opacity: 0.6; }


/* LỚP PHỦ GRID CHỌN ẢNH */
#image-grid-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26, 21, 16, 0.97); z-index: 1010; overflow-y: auto; padding: 20px; box-sizing: border-box; }
#image-grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
.grid-item {
padding-top: 75%; position: relative; cursor: pointer; border-radius: 8px;
overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; border: 4px solid var(--color-light-wood);
box-shadow: 0 4px 10px rgba(0,0,0,0.5); will-change: transform; transform: translateZ(0);
}
.grid-item:hover { transform: scale(1.05) translateZ(0); box-shadow: 0 6px 15px rgba(0,0,0,0.7); border-color: var(--color-accent); }
.grid-item-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(15px) brightness(0.7); transform: scale(1.1); }
.grid-item-main { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
#close-grid-btn { position: fixed; top: 20px; right: 20px; z-index: 1011; background: var(--color-dark-wood); color: var(--color-text-light); border: 1px solid var(--color-light-wood); width: 45px; height: 45px; border-radius: 50%; font-size: 24px; cursor: pointer; }
#playlist-mode-status { display: none; background-color: var(--color-accent); color: var(--color-dark-wood); padding: 8px; text-align: center; border-radius: 4px; font-size: 13px; font-weight: bold; }
#playlist-mode-status button { margin-left: 10px; padding: 3px 8px; background-color: var(--danger-color); color: white; border: none; border-radius: 3px; cursor: pointer; }

/* --- CÁC THÀNH PHẦN PHỤ --- */
#soundcloud-widget-container, #player { position: fixed; left: -9999px; top: -9999px; width: 1px; height: 1px; opacity: 0; }
.toast { visibility: hidden; min-width: 250px; background-color: var(--color-dark-wood); color: var(--color-accent); text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; opacity: 0; transition: all 0.5s; border: 1px solid var(--color-accent); }
.toast.show { visibility: visible; opacity: 1; bottom: 50px; }

/* TOOLTIP HƯỚNG DẪN */
#tutorial-tooltip {
display: block;
visibility: hidden;
opacity: 0;
position: fixed;
background-color: var(--color-accent);
color: var(--color-dark-wood);
padding: 10px 15px;
border-radius: 6px;
z-index: 9999;
font-size: 14px;
max-width: 250px;
pointer-events: none;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
transition: opacity 0.4s, visibility 0.4s;
}
body.tutorial-mode-active #tutorial-tooltip.visible {
visibility: visible;
opacity: 1;
}


/* PANEL TÙY CHỈNH GIAO DIỆN & GIỌNG NÓI */
.settings-group { margin-bottom: 20px; border-bottom: 1px solid var(--color-light-wood); padding-bottom: 15px; }
.settings-group:last-child { border-bottom: none; }
.settings-group h4 { margin: 0 0 10px 0; color: var(--color-accent); font-family: var(--font-heading); }
.settings-control { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
.settings-control label { font-size: 13px; opacity: 0.8; }
.settings-control input[type="text"], .settings-control input[type="password"], .settings-control input[type="color"], .settings-control select, .settings-control input[type="number"], .settings-control textarea {
width: 100%; padding: 6px; border: 1px solid var(--color-light-wood); background-color: #333;
color: white; border-radius: 4px; box-sizing: border-box; font-family: var(--font-body);
}
.settings-control textarea { resize: vertical; height: 80px;}
.settings-control input[type="color"] { padding: 2px; height: 30px; }
.settings-control-row { display: flex; align-items: center; gap: 10px; }
.settings-control-row label { flex-shrink: 0; min-width: 70px; }
.settings-control-row input[type="range"] { flex-grow: 1; }
.settings-control-row span { font-size: 12px; min-width: 40px; text-align: right; }
.settings-group .sub-settings { display: none; border-left: 2px solid var(--color-accent); padding-left: 15px; margin-left: -15px; margin-top: 10px; }


</style>
</head>
<body>

<!-- Giao diện khởi động mặc định là màn hình nhập liệu -->
<div id="main-content">
<div id="main-header">
</div>
<div id="main-content-body">
<div id="main-top-controls">
<button id="start-button" class="action-button">Bắt đầu</button>
<label id="import-button-label" for="import-file-input" class="action-button main-control-btn"><i class="fas fa-file-import"></i>Nhập Dữ liệu</label>
<input type="file" id="import-file-input" accept=".json">
<button id="export-main-button" class="action-button main-control-btn"><i class="fas fa-file-export"></i>Xuất Dữ liệu</button>
</div>

<h2>Dữ liệu Trưng bày</h2>
<div class="input-grid">
<div>
<label for="image-links"><b>Link ảnh tranh (mỗi link một dòng):</b></label>
<textarea id="image-links" placeholder="https://i.postimg.cc/.../01-Leonardo-da-Vinci-Mona-Lisa.jpg&#10;https://i.postimg.cc/.../02-Vincent-van-Gogh-The-Starry-Night.png..."></textarea>
</div>
<div>
<label for="music-links"><b>Nhạc (SoundCloud URL hoặc YouTube ID):</b></label>
<textarea id="music-links" placeholder="https://soundcloud.com/user/track-name&#10;GK-XGBDl5k4&#10;..."></textarea>
</div>
<div class="full-width-input">
<label for="image-descriptions"><b>Mô tả tranh (theo định dạng):</b></label>
<textarea id="image-descriptions" placeholder="1 - Tên Tranh (Tên Tiếng Việt) - Tên Họa Sĩ. Mô tả chi tiết cho bức tranh...&#10;&#10;2 - The Starry Night (Đêm đầy sao) - Vincent van Gogh. Là một trong những tác phẩm nổi tiếng nhất... (Lưu ý: Dùng 2 lần xuống dòng để tách đoạn)"></textarea>
</div>
<div>
<label for="artist-image-links"><b>Link ảnh họa sĩ (mỗi link một dòng):</b></label>
<textarea id="artist-image-links" placeholder="https://.../Leonardo-da-Vinci.jpg&#10;https://.../Vincent-van-Gogh.jpg..."></textarea>
</div>
<div>
<label for="artist-descriptions"><b>Mô tả họa sĩ (theo định dạng):</b></label>
<textarea id="artist-descriptions" placeholder="Leonardo da Vinci - (1452-1519) là một thiên tài toàn năng người Ý...&#10;Vincent van Gogh - (1853-1890) là một họa sĩ trường phái hậu ấn tượng người Hà Lan..."></textarea>
</div>
</div>
</div>
</div>

<div id="slideshow" class="slideshow-container">
<div id="left-panel">
<div id="artwork-wrapper">
<img id="frame-image" class="frame-image" src="" alt="Khung tranh">
<img id="slideshow-image" class="slideshow-image" src="" alt="Slideshow Image" crossorigin="anonymous">
</div>
</div>
<div id="description-container">
<div id="description-wrapper">
<div id="artwork-info">
<h2 id="artwork-title"></h2>
<h3 id="artwork-artist"></h3>
<hr id="desc-separator">
</div>
<div id="artwork-main-desc"></div>
<div id="ai-description-controls"></div>
<div id="artist-info-container">
<div id="artist-photo-wrapper">
<img id="artist-photo" src="" alt="Artist Portrait">
<div id="artist-tooltip"></div>
</div>
</div>
</div>
</div>

<!-- Panel bên trái -->
<div id="left-panel-wrapper" class="collapsed">
<div id="left-panel-container">
<!-- Panel Thống kê -->
<div id="data-panel" class="side-panel">
<div class="panel-header">
<h3>Dữ liệu Thống kê</h3>
<button class="close-panel-btn" data-panel-id="data-panel">&times;</button>
</div>
<div class="side-panel-content">
<div id="random-count" class="data-stat"></div>
<div id="image-stats" class="data-stat"></div>
<div id="music-total" class="data-stat"></div>
<div id="music-rankings">
<h4>Bảng xếp hạng nhạc được khoá:</h4>
<ul id="music-rankings-list"></ul>
</div>
</div>
</div>
<!-- Panel Bộ sưu tập -->
<div id="playlist-manager-panel" class="side-panel">
<div class="panel-header">
<h3>Quản lý Bộ sưu tập</h3>
<button class="close-panel-btn" data-panel-id="playlist-manager-panel">&times;</button>
</div>
<div class="side-panel-content">
<div id="playlist-form">
<input type="text" id="playlist-name-input" placeholder="Tên bộ sưu tập mới...">
<button id="create-playlist-btn">Tạo</button>
</div>
<div id="playlists-list-container">
<ul id="playlists-list"></ul>
</div>
</div>
</div>
<!-- Panel Tùy chỉnh Giao diện -->
<div id="settings-panel" class="side-panel">
<div class="panel-header">
<h3>Tùy Chỉnh Giao Diện</h3>
<button class="close-panel-btn" data-panel-id="settings-panel">&times;</button>
</div>
<div class="side-panel-content">
<div class="settings-group"><h4><i class="fas fa-palette"></i> Văn Bản &amp; Tiêu Đề</h4>
<div class="settings-control">
<label for="title-font-select">Font Tên Tranh & Chữ cái đầu</label>
<select id="title-font-select">
<option value="'Playfair Display', serif">Playfair Display</option>
<option value="'Libre Baskerville', serif">Libre Baskerville</option>
<option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
<option value="'Merriweather', serif">Merriweather</option>
<option value="'Lora', serif">Lora</option>
<option value="'EB Garamond', serif">EB Garamond</option>
<option value="'Cinzel', serif">Cinzel</option>
<option value="'Dancing Script', cursive">Dancing Script</option>
<option value="'Great Vibes', cursive">Great Vibes</option>
<option value="'Tangerine', cursive">Tangerine</option>
<option value="'Parisienne', cursive">Parisienne</option>
<option value="'Montserrat', sans-serif">Montserrat</option>
<option value="'Roboto Slab', serif">Roboto Slab</option>
</select>
</div>
<div class="settings-control-row" style="margin-top: 15px;">
<label for="title-length-threshold">Ngưỡng ký tự</label>
<input type="number" id="title-length-threshold" value="50" style="width: 80px;">
</div>
<div class="settings-control-row" style="margin-top: 5px;">
<label for="title-font-size-slider">Cỡ chữ (ngắn)</label>
<input type="range" id="title-font-size-slider" min="1.2" max="3.5" value="1.8" step="0.1">
<span id="title-font-size-value">1.8rem</span>
</div>
<div class="settings-control-row">
<label for="title-long-font-size-slider">Cỡ chữ (dài)</label>
<input type="range" id="title-long-font-size-slider" min="1.0" max="3.0" value="1.4" step="0.1">
<span id="title-long-font-size-value">1.4rem</span>
</div>
<div class="settings-control-row" style="margin-top: 15px;">
<label for="title-color-brightness-slider">Độ sáng màu</label>
<input type="range" id="title-color-brightness-slider" min="50" max="250" value="100" step="5">
<span id="title-color-brightness-value">100%</span>
</div>
<div class="settings-control" style="margin-top: 15px;">
<label for="artist-font-select">Font Tên Tác Giả</label>
<select id="artist-font-select">
<option value="'Montserrat', sans-serif">Montserrat</option>
<option value="'Playfair Display', serif">Playfair Display</option>
<option value="'Libre Baskerville', serif">Libre Baskerville</option>
<option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
<option value="'Merriweather', serif">Merriweather</option>
<option value="'Lora', serif">Lora</option>
<option value="'EB Garamond', serif">EB Garamond</option>
<option value="'Roboto Slab', serif">Roboto Slab</option>
</select>
</div>
<div class="settings-control-row">
<label for="artist-font-size-slider">Cỡ chữ</label>
<input type="range" id="artist-font-size-slider" min="0.8" max="2.0" value="1.1" step="0.05">
<span id="artist-font-size-value">1.1rem</span>
</div>
<div class="settings-control-row" style="margin-top: 15px;">
<label for="first-letter-size-slider">Chữ cái đầu</label>
<input type="range" id="first-letter-size-slider" min="2.5" max="8" value="4.5" step="0.1">
<span id="first-letter-size-value">4.5em</span>
</div>
<div class="settings-control-row" style="margin-top: 15px;">
<label for="header-spacing-slider">K/cách tiêu đề</label>
<input type="range" id="header-spacing-slider" min="0.1" max="2.0" value="0.3" step="0.1">
<span id="header-spacing-value">0.3em</span>
</div>
</div>
<div class="settings-group"><h4><i class="fas fa-align-left"></i> Khu Vực Mô Tả</h4>
<div class="settings-control">
<label for="desc-font-select">Font Chữ Mô Tả</label>
<select id="desc-font-select">
<option value="'Libre Baskerville', serif">Libre Baskerville</option>
<option value="'Lora', serif">Lora</option>
<option value="'Merriweather', serif">Merriweather</option>
<option value="'EB Garamond', serif">EB Garamond</option>
<option value="'Playfair Display', serif">Playfair Display</option>
<option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
<option value="'Montserrat', sans-serif">Montserrat</option>
<option value="'Roboto Slab', serif">Roboto Slab</option>
</select>
</div>
<div class="settings-control-row">
<label for="desc-font-size-slider">Cỡ chữ</label>
<input type="range" id="desc-font-size-slider" min="12" max="24" value="16" step="1">
<span id="desc-font-size-value">16px</span>
</div>
<div class="settings-control-row">
<label for="desc-line-height-slider">K/cách dòng</label>
<input type="range" id="desc-line-height-slider" min="1.2" max="2.8" value="1.8" step="0.1">
<span id="desc-line-height-value">1.8</span>
</div>
<div class="settings-control-row">
<label for="desc-text-color">Màu chữ</label>
<input type="color" id="desc-text-color" value="#dcd2b4">
</div>
</div>
<div class="settings-group"><h4><i class="fas fa-image"></i> Nền Tường</h4>
<div class="settings-control">
<label for="wall-texture-url">URL Hình nền</label>
<input type="text" id="wall-texture-url" placeholder="Dán link ảnh vào đây...">
</div>
</div>
<div class="settings-group"><h4><i class="fas fa-vector-square"></i> Khung Tranh (URL)</h4>
<div class="settings-control">
<label for="frame-url-input">URL Khung tranh</label>
<input type="text" id="frame-url-input" placeholder="Dán URL của ảnh khung vào đây">
</div>
<div class="settings-control-row">
<label for="frame-padding-slider">Độ dày viền</label>
<input type="range" id="frame-padding-slider" min="10" max="150" value="30" step="1">
<span id="frame-padding-value">30px</span>
</div>
</div>
<!-- YÊU CẦU 1: Thanh điều chỉnh soft edge -->
<div class="settings-group"><h4><i class="fas fa-border-style"></i> Hiệu ứng Tranh</h4>
<div class="settings-control-row">
<label for="soft-edge-slider">Làm mềm cạnh</label>
<input type="range" id="soft-edge-slider" min="0" max="100" value="0" step="1">
<span id="soft-edge-value">0px</span>
</div>
</div>

<div class="settings-group"><h4><i class="fas fa-magic"></i> Đổ bóng Khung tranh</h4>
<div class="settings-control-row"><label for="shadow-x-slider">Vị trí X</label><input type="range" id="shadow-x-slider" min="-50" max="50" value="0" step="1"><span id="shadow-x-value">0px</span></div>
<div class="settings-control-row"><label for="shadow-y-slider">Vị trí Y</label><input type="range" id="shadow-y-slider" min="-50" max="50" value="10" step="1"><span id="shadow-y-value">10px</span></div>
<div class="settings-control-row"><label for="shadow-blur-slider">Độ mờ</label><input type="range" id="shadow-blur-slider" min="0" max="100" value="25" step="1"><span id="shadow-blur-value">25px</span></div>
<div class="settings-control-row"><label for="shadow-spread-slider">Độ toả</label><input type="range" id="shadow-spread-slider" min="-50" max="50" value="0" step="1"><span id="shadow-spread-value">0px</span></div>
<div class="settings-control-row"><label for="shadow-color">Màu bóng</label><input type="color" id="shadow-color" value="#000000"></div>
</div>
<div class="settings-group"><h4><i class="fas fa-save"></i> Lưu & Tải Trạng Thái</h4><button id="export-ui-button" class="action-button" style="width: 100%;"><i class="fas fa-file-export"></i>Xuất Dữ liệu & Giao diện</button></div>
</div>
</div>
<!-- Panel chọn nhạc -->
<div id="music-selection-panel" class="side-panel">
<div class="panel-header">
<h3>Chọn Nhạc Cho Tranh</h3>
<button class="close-panel-btn" data-panel-id="music-selection-panel">&times;</button>
</div>
<div class="side-panel-content">
<input type="text" id="music-search-input" placeholder="Tìm kiếm nhạc...">
<ul id="all-music-list"></ul>
</div>
</div>
<!-- START: Panel Cài đặt Giọng nói -->
<div id="tts-settings-panel" class="side-panel">
    <div class="panel-header">
        <h3>Cài đặt Giọng nói</h3>
        <button class="close-panel-btn" data-panel-id="tts-settings-panel">&times;</button>
    </div>
    <div class="side-panel-content">
        <!-- Cài đặt chung -->
        <div class="settings-group">
            <h4><i class="fas fa-cogs"></i> Cài đặt chung</h4>
            <div class="settings-control">
                <label for="tts-method-select">Phương pháp đọc</label>
                <select id="tts-method-select">
                    <option value="google">Google Dịch & Web Audio</option>
                    <option value="responsivevoice">ResponsiveVoice</option>
                </select>
            </div>
            <div class="settings-control">
                <label for="tts-delay-input">Thời gian trễ trước khi đọc (giây)</label>
                <input type="number" id="tts-delay-input" min="0" max="30" value="2" step="0.5">
            </div>
             <div class="settings-control-row">
                <label for="tts-volume-slider">Âm lượng</label>
                <input type="range" id="tts-volume-slider" min="0" max="1" value="1" step="0.05">
                <span id="tts-volume-value">100%</span>
            </div>
        </div>
        <!-- Cài đặt API/Proxy -->
        <div class="settings-group">
            <h4><i class="fas fa-key"></i> API Keys / Proxy (cho Google Dịch)</h4>
             <div class="settings-control">
                <label for="tts-api-keys-textarea">Danh sách (mỗi key một dòng)</label>
                <textarea id="tts-api-keys-textarea" placeholder="https://api.allorigins.win/raw?url=...">https://api.allorigins.win/raw?url=</textarea>
                <small style="opacity: 0.7; font-size: 11px;">Hệ thống sẽ tự động chuyển key khi gặp lỗi.</small>
            </div>
        </div>
        <!-- Cài đặt giảm nhạc nền -->
         <div class="settings-group">
            <h4><i class="fas fa-volume-down"></i> Hiệu ứng Giảm Nhạc Nền</h4>
             <div class="settings-control-row">
                <label for="fade-end-volume-slider">Giảm còn</label>
                <input type="range" id="fade-end-volume-slider" min="0" max="100" value="20" step="1">
                <span id="fade-end-volume-value">20%</span>
            </div>
             <div class="settings-control">
                <label for="fade-duration-input">Thời gian chuyển đổi (giây)</label>
                <input type="number" id="fade-duration-input" min="0" max="30" value="3" step="0.5">
            </div>
        </div>

        <!-- Cài đặt riêng cho từng phương pháp -->
        <div id="responsivevoice-settings" class="sub-settings">
            <div class="settings-group">
                <h4><i class="fas fa-user-friends"></i> Tùy chỉnh ResponsiveVoice</h4>
                <div class="settings-control">
                    <label for="rv-voice-select">Giọng đọc</label>
                    <select id="rv-voice-select">
                        <option value="Vietnamese Female">Giọng Nữ (Tiếng Việt)</option>
                        <option value="Vietnamese Male">Giọng Nam (Tiếng Việt)</option>
                    </select>
                </div>
                <div class="settings-control-row">
                    <label for="rv-rate-slider">Tốc độ</label>
                    <input type="range" id="rv-rate-slider" min="0.5" max="1.5" value="1" step="0.1">
                    <span id="rv-rate-value">1.0x</span>
                </div>
                <div class="settings-control-row">
                    <label for="rv-pitch-slider">Cao độ</label>
                    <input type="range" id="rv-pitch-slider" min="0.5" max="1.5" value="1" step="0.1">
                    <span id="rv-pitch-value">1.0x</span>
                </div>
            </div>
        </div>

        <div id="google-audio-settings" class="sub-settings">
             <div class="settings-group">
                <h4><i class="fas fa-sliders-h"></i> Tùy chỉnh Google Dịch</h4>
                 <div class="settings-control-row">
                    <label for="ga-rate-slider">Tốc độ</label>
                    <input type="range" id="ga-rate-slider" min="0.5" max="1.5" value="1" step="0.05">
                    <span id="ga-rate-value">1.0x</span>
                </div>
             </div>
             <div class="settings-group">
                 <h4><i class="fas fa-wave-square"></i> Equalizer (EQ)</h4>
                  <div class="settings-control-row">
                    <label for="ga-bass-slider">Bass</label>
                    <input type="range" id="ga-bass-slider" min="-15" max="15" value="0" step="1">
                    <span id="ga-bass-value">0 dB</span>
                </div>
                 <div class="settings-control-row">
                    <label for="ga-mid-slider">Mid</label>
                    <input type="range" id="ga-mid-slider" min="-15" max="15" value="0" step="1">
                    <span id="ga-mid-value">0 dB</span>
                </div>
                 <div class="settings-control-row">
                    <label for="ga-treble-slider">Treble</label>
                    <input type="range" id="ga-treble-slider" min="-15" max="15" value="0" step="1">
                    <span id="ga-treble-value">0 dB</span>
                </div>
             </div>
        </div>
    </div>
</div>
<!-- END: Panel Cài đặt Giọng nói -->

<!-- START: Panel Cài đặt Gemini AI -->
<div id="gemini-settings-panel" class="side-panel">
    <div class="panel-header">
        <h3>Cài đặt Gemini AI</h3>
        <button class="close-panel-btn" data-panel-id="gemini-settings-panel">&times;</button>
    </div>
    <div class="side-panel-content">
        <div class="settings-group">
            <h4><i class="fas fa-key"></i> Xác thực API</h4>
            <div class="settings-control">
                <label for="gemini-api-key">API Key</label>
                <input type="password" id="gemini-api-key" placeholder="Nhập API Key của bạn tại đây">
            </div>
            <div class="settings-control">
                <label for="gemini-model">Tên Model</label>
                <input type="text" id="gemini-model" value="gemini-1.5-flash-latest">
                 <small style="opacity: 0.7; font-size: 11px;">Ví dụ: gemini-1.5-flash-latest</small>
            </div>
        </div>
        <div class="settings-group">
            <h4><i class="fas fa-comment-alt"></i> Tùy chỉnh Câu lệnh (Prompt)</h4>
             <div class="settings-control">
                <label for="gemini-prompt">Mẫu Prompt</label>
                <textarea id="gemini-prompt"></textarea>
                <small style="opacity: 0.7; font-size: 11px;">Dùng `{{TEN_TRANH}}` và `{{TAC_GIA}}` để chèn tự động. Ví dụ: "Hãy viết một bài mô tả lôi cuốn về tác phẩm {{TEN_TRANH}} của họa sĩ {{TAC_GIA}}."</small>
            </div>
        </div>
    </div>
</div>
<!-- END: Panel Cài đặt Gemini AI -->
</div>

<div id="left-panel-toggle-btn">
<button class="left-panel-icon-btn" data-panel-id="data-panel" title="Thống kê"><i class="fas fa-chart-bar"></i></button>
<button class="left-panel-icon-btn" data-panel-id="playlist-manager-panel" title="Bộ sưu tập"><i class="fas fa-list-alt"></i></button>
<button class="left-panel-icon-btn" data-panel-id="music-selection-panel" title="Danh sách nhạc (L)"><i class="fas fa-music"></i></button>
<button class="left-panel-icon-btn" data-panel-id="settings-panel" title="Giao diện"><i class="fas fa-paint-brush"></i></button>
<button class="left-panel-icon-btn" data-panel-id="tts-settings-panel" title="Cài đặt Giọng nói"><i class="fas fa-comment-dots"></i></button>
<button class="left-panel-icon-btn" data-panel-id="gemini-settings-panel" title="Mô tả AI"><i class="fas fa-robot"></i></button>
</div>
</div>


<div id="right-panel-wrapper">
<button id="panel-toggle-btn" title="Đóng/Mở bảng điều khiển"><i class="fas fa-chevron-right"></i></button>
<div id="right-panel">
<div id="playlist-mode-status"><span></span><button id="exit-playlist-mode-btn">Thoát</button></div>
<div class="slideshow-buttons">
<button id="change-button" class="action-button" title="Tác phẩm ngẫu nhiên (R)" data-help="Hiển thị một tác phẩm nghệ thuật ngẫu nhiên khác từ danh sách của bạn."><i class="fas fa-random"></i>Đổi mới</button>
<button id="back-button" class="action-button" title="Quay lại phiên trước" data-help="Quay lại tác phẩm và bản nhạc đã xem ngay trước đó."><i class="fas fa-history"></i>Quay lại</button>
<button id="select-image-grid-button" class="action-button" title="Xem toàn bộ tranh" data-help="Mở một lưới hiển thị tất cả các tác phẩm để bạn có thể chọn xem trực tiếp."><i class="fas fa-th-large"></i>Chọn Tranh</button>
<button id="lock-image-button" class="action-button" title="Giữ lại tranh này (P)" data-help="Khoá tác phẩm hiện tại. Khi khoá, chỉ có nhạc thay đổi khi bạn nhấn 'Đổi mới'. Mở bảng chọn nhạc bên trái để gán nhạc."><i class="fas fa-image"></i>Khoá Tranh</button>
<button id="lock-music-button" class="action-button" title="Gắn nhạc này với tranh (M)" data-help="Ghim bản nhạc đang phát vào tác phẩm này. Lần sau khi tác phẩm này xuất hiện, nó sẽ ưu tiên phát các bản nhạc đã được ghim."><i class="fas fa-music"></i>Khoá Nhạc</button>
<button id="toggle-tts-button" class="action-button" title="Bật/Tắt tự động đọc mô tả" data-help="Bật hoặc tắt chức năng tự động đọc mô tả của tác phẩm sau một khoảng thời gian trễ."><i class="fas fa-volume-up"></i>Tự Động Đọc</button>
<button id="auto-random-toggle" class="action-button" title="Tự động đổi mới khi hết nhạc" data-help="Khi bật, hệ thống sẽ tự động chuyển sang tác phẩm khác khi bản nhạc hiện tại kết thúc."><i class="fas fa-infinity"></i>Tự động</button>
<button id="sequential-music-toggle" class="action-button" title="Phát nhạc tuần tự" data-help="Khi bật, nhạc sẽ phát theo thứ tự trong danh sách của bạn thay vì ngẫu nhiên."><i class="fas fa-list-ol"></i>Tuần tự</button>
<button id="override-lock-toggle" class="action-button" title="Bỏ qua nhạc đã khoá" data-help="Tạm thời bỏ qua tất cả các bản nhạc đã được khoá và phát nhạc ngẫu nhiên từ danh sách chính."><i class="fas fa-ban"></i>Bỏ qua</button>
<button id="fullscreen-button" class="action-button" title="Toàn màn hình (F)" data-help="Chuyển sang chế độ xem toàn màn hình để có trải nghiệm tốt nhất. Nhấn F hoặc Esc để thoát."><i class="fas fa-expand"></i>Toàn màn</button>
<button id="edit-mode-toggle" class="action-button" title="Bật/Tắt chế độ chỉnh sửa" data-help="Cho phép chỉnh sửa trực tiếp tiêu đề, tác giả và mô tả của tác phẩm. Nhấn vào biểu tượng bút chì để sửa."><i class="fas fa-edit"></i>Chỉnh sửa</button>
<button id="tutorial-toggle-btn" class="action-button" title="Bật/Tắt Hướng dẫn" data-help="Bật/Tắt chế độ hướng dẫn. Khi bật, di chuột qua các nút sẽ hiển thị giải thích chi tiết chức năng."><i class="fas fa-question-circle"></i>Hướng dẫn</button>
<button id="pin-panels-toggle" class="action-button" title="Ghim/Bỏ ghim các bảng điều khiển" data-help="Giữ cho tất cả các bảng điều khiển luôn mở, ghi đè lên hành vi tự động ẩn."><i class="fas fa-thumbtack"></i>Ghim Bảng</button>
<button id="stop-button" class="action-button" title="Rời khỏi phòng trưng bày" data-help="Thoát khỏi phòng trưng bày và quay lại màn hình nhập liệu ban đầu."><i class="fas fa-times-circle"></i>Thoát</button>
<button id="delete-current-combo-btn" class="action-button delete-control" title="Xóa vĩnh viễn tranh và mô tả này" data-help="[CHỈ TRONG CHẾ ĐỘ SỬA] Xóa vĩnh viễn tác phẩm này khỏi dữ liệu của bạn. Không thể hoàn tác."><i class="fas fa-trash-alt"></i>Xóa Phiên Này</button>
</div>

<div id="status-panel">
<div id="lock-status-display"></div>
<div id="now-playing">
<button id="play-pause-btn" title="Tạm dừng / Phát nhạc"><i class="fas fa-pause"></i></button>
<a id="now-playing-link" href="#" target="_blank" title="Chưa có gì">
<span>Chưa có gì</span>
</a>
</div>
</div>
</div>
</div>
</div>

<div id="image-grid-overlay">
<button id="close-grid-btn">&times;</button>
<div id="image-grid-container"></div>
</div>

<div id="soundcloud-widget-container"></div>
<div id="player"></div>
<div id="toast" class="toast"></div>
<div id="tutorial-tooltip"></div>

<script src="https://w.soundcloud.com/player/api.js"></script>
<script>
// YouTube IFrame API Loader
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
const firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// DOM Elements
const imageLinksTextarea = document.getElementById('image-links');
const musicLinksTextarea = document.getElementById('music-links');
const descriptionTextarea = document.getElementById('image-descriptions');
const artistImageLinksTextarea = document.getElementById('artist-image-links');
const artistDescriptionsTextarea = document.getElementById('artist-descriptions');
const startButton = document.getElementById('start-button');
const stopButton = document.getElementById('stop-button');
const changeButton = document.getElementById('change-button');
const lockMusicButton = document.getElementById('lock-music-button');
const lockImageButton = document.getElementById('lock-image-button');
const fullscreenButton = document.getElementById('fullscreen-button');
const exportMainButton = document.getElementById('export-main-button');
const exportUiButton = document.getElementById('export-ui-button');
const importFileInput = document.getElementById('import-file-input');
const mainContent = document.getElementById('main-content');
const slideshow = document.getElementById('slideshow');
const slideshowImage = document.getElementById('slideshow-image');
const frameImage = document.getElementById('frame-image');
const artworkWrapper = document.getElementById('artwork-wrapper');
const soundcloudWidgetContainer = document.getElementById('soundcloud-widget-container');
const lockStatusDisplay = document.getElementById('lock-status-display');
const nowPlayingLink = document.getElementById('now-playing-link');
const nowPlayingSpan = nowPlayingLink.querySelector('span');
const toast = document.getElementById('toast');
const playPauseBtn = document.getElementById('play-pause-btn');
const descriptionContainer = document.getElementById('description-container');
const descriptionWrapper = document.getElementById('description-wrapper');
const artworkMainDesc = document.getElementById('artwork-main-desc');
const artworkTitle = document.getElementById('artwork-title');
const artworkArtist = document.getElementById('artwork-artist');
const artistInfoContainer = document.getElementById('artist-info-container');
const artistPhoto = document.getElementById('artist-photo');
const artistTooltip = document.getElementById('artist-tooltip');
const rightPanelWrapper = document.getElementById('right-panel-wrapper');
const panelToggleBtn = document.getElementById('panel-toggle-btn');
const playlistManagerPanel = document.getElementById('playlist-manager-panel');
const playlistNameInput = document.getElementById('playlist-name-input');
const createPlaylistBtn = document.getElementById('create-playlist-btn');
const playlistsList = document.getElementById('playlists-list');
const playlistModeStatus = document.getElementById('playlist-mode-status');
const exitPlaylistModeBtn = document.getElementById('exit-playlist-mode-btn');
const selectImageGridBtn = document.getElementById('select-image-grid-button');
const imageGridOverlay = document.getElementById('image-grid-overlay');
const imageGridContainer = document.getElementById('image-grid-container');
const closeGridBtn = document.getElementById('close-grid-btn');
const allMusicList = document.getElementById('all-music-list');
const musicSearchInput = document.getElementById('music-search-input');
const autoRandomToggle = document.getElementById('auto-random-toggle');
const overrideLockToggle = document.getElementById('override-lock-toggle');
const sequentialMusicToggle = document.getElementById('sequential-music-toggle');
const backButton = document.getElementById('back-button');
const editModeToggle = document.getElementById('edit-mode-toggle');
const deleteCurrentComboBtn = document.getElementById('delete-current-combo-btn');
const leftPanelIconButtons = document.querySelectorAll('.left-panel-icon-btn');
const musicSelectionPanel = document.getElementById('music-selection-panel');
const leftPanelWrapper = document.getElementById('left-panel-wrapper');
const tutorialToggleBtn = document.getElementById('tutorial-toggle-btn');
const tutorialTooltip = document.getElementById('tutorial-tooltip');
const pinPanelsToggle = document.getElementById('pin-panels-toggle');
const aiDescriptionControls = document.getElementById('ai-description-controls');


// State variables
let imageLinks = [], musicLinks = [];
let imageDescriptions = {}, artistData = {}, aiDescriptions = {};
let lockedTracks = {}, playlists = {};
let sessionImagePool = [], playlistImagePool = [], playlistOriginalItems = [];
let currentImage = '', currentTrack = '';
let isImageLocked = false, isMusicPlaying = true, isPanning = false, isTransitioning = false;
let soundcloudWidget = null, youtubePlayer = null;
let currentMusicSource = 'none';
let currentPlaylist = null;
let scale = 1, pan = {x: 0, y: 0}, startPan = {x: 0, y: 0};
let randomClickCount = 0, musicLockCounts = {};
let lockedMusicIndices = {};
let globalSequentialMusicIndex = 0;
let isAutoRandomEnabled = false, isLockOverrideEnabled = false, isSequentialMusicEnabled = false, isEditMode = false;
let isTutorialMode = false;
let previousState = { image: null, track: null };
let tooltipHideTimer;
let lastUsedPlaylist = null;
let arePanelsPinned = false;
let _isFadingInNewTrack = false;
let musicFadeInterval = null;
let currentMusicVolume = 100; // Track volume independently, 0-100 scale


// UI settings
let uiSettings = {
wallTexture: '',
descFont: "'Libre Baskerville', serif", descFontSize: "16px", descTextColor: "#dcd2b4",
frameUrl: '',
framePadding: 30,
shadow: { x: 0, y: 10, blur: 25, spread: 0, color: '#000000' },
titleFont: "'Playfair Display', serif",
titleFontSize: "1.8rem",
titleLongFontSize: "1.4rem",
titleLengthThreshold: 50,
artistFont: "'Montserrat', sans-serif", artistFontSize: "1.1rem",
firstLetterSize: "4.5em",
titleBrightness: 1,
softEdge: 0,
headerSpacing: 0.3,
descLineHeight: 1.8
};

// =================================================================================
// START: GEMINI AI MODULE
// =================================================================================
const geminiApiKeyInput = document.getElementById('gemini-api-key');
const geminiModelInput = document.getElementById('gemini-model');
const geminiPromptTextarea = document.getElementById('gemini-prompt');
const GEMINI_SETTINGS_KEY = 'galleryGeminiSettings';

function initializeGemini() {
    // Set default prompt
    const defaultPrompt = `Với vai trò là một nhà phê bình nghệ thuật am hiểu, hãy viết một bài mô tả thật sâu sắc, lôi cuốn và giàu cảm xúc về tác phẩm nghệ thuật có tên "{{TEN_TRANH}}" của họa sĩ {{TAC_GIA}}.

Hãy tập trung vào các yếu tố sau:
1.  **Bối cảnh ra đời**: Sơ lược về hoàn cảnh lịch sử, giai đoạn sự nghiệp của họa sĩ, hoặc câu chuyện đặc biệt đằng sau tác phẩm (nếu có).
2.  **Phân tích nghệ thuật**: Mô tả các kỹ thuật nổi bật (bố cục, màu sắc, ánh sáng, đường nét, chất liệu). Bầu không khí và cảm xúc chủ đạo của tác phẩm là gì?
3.  **Ý nghĩa và biểu tượng**: Giải mã những thông điệp, ý nghĩa ẩn dụ mà họa sĩ có thể đã gửi gắm.
4.  **Tác động và di sản**: Vị trí của tác phẩm trong lịch sử nghệ thuật và ảnh hưởng của nó.

Hãy dùng một ngôn ngữ văn học, giàu hình ảnh để khơi gợi trí tưởng tượng và kết nối cảm xúc của người xem với tác phẩm.`;
    geminiPromptTextarea.placeholder = defaultPrompt;

    // Load saved settings
    const savedSettings = localStorage.getItem(GEMINI_SETTINGS_KEY);
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        geminiApiKeyInput.value = settings.apiKey || '';
        geminiModelInput.value = settings.model || 'gemini-1.5-flash-latest';
        geminiPromptTextarea.value = settings.prompt || '';
    }

    // Save settings on change
    geminiApiKeyInput.addEventListener('change', saveGeminiSettings);
    geminiModelInput.addEventListener('change', saveGeminiSettings);
    geminiPromptTextarea.addEventListener('change', saveGeminiSettings);
}

function saveGeminiSettings() {
    const settings = {
        apiKey: geminiApiKeyInput.value,
        model: geminiModelInput.value,
        prompt: geminiPromptTextarea.value
    };
    localStorage.setItem(GEMINI_SETTINGS_KEY, JSON.stringify(settings));
}

async function generateAiDescription() {
    const apiKey = geminiApiKeyInput.value.trim();
    const model = geminiModelInput.value.trim();
    if (!apiKey || !model) {
        showToast("Vui lòng nhập API Key và Model của Gemini trong panel cài đặt.", 'warning');
        togglePanel('gemini-settings-panel', true);
        return;
    }

    const number = extractImageNumber(currentImage);
    const artworkData = imageDescriptions[number];
    if (!artworkData) {
        showToast("Không tìm thấy dữ liệu của tranh hiện tại.", 'error');
        return;
    }

    const promptTemplate = geminiPromptTextarea.value.trim() || geminiPromptTextarea.placeholder;
    const finalPrompt = promptTemplate
        .replace(/{{TEN_TRANH}}/g, artworkData.title)
        .replace(/{{TAC_GIA}}/g, artworkData.artist);

    const generateBtn = document.getElementById('generate-ai-btn');
    if(generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Đang tạo...`;
    }

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: finalPrompt }] }]
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || `Lỗi API: ${response.status}`);
        }

        const data = await response.json();
        const generatedText = data.candidates[0].content.parts[0].text;

        // Display the result for confirmation
        const tempDisplay = document.createElement('div');
        tempDisplay.id = 'ai-description-display';
        tempDisplay.innerHTML = `<p>${generatedText}</p>`;
        
        const saveButton = document.createElement('button');
        saveButton.className = 'ai-control-btn';
        saveButton.innerHTML = `<i class="fas fa-save"></i> Lưu mô tả AI`;
        saveButton.onclick = () => {
            saveAiDescription(generatedText);
            aiDescriptionControls.removeChild(tempDisplay);
        };
        
        const discardButton = document.createElement('button');
        discardButton.className = 'ai-control-btn';
        discardButton.style.backgroundColor = 'var(--danger-color)';
        discardButton.style.borderColor = 'var(--danger-color)';
        discardButton.style.color = 'white';
        discardButton.innerHTML = `<i class="fas fa-times"></i> Hủy bỏ`;
        discardButton.onclick = () => {
             aiDescriptionControls.removeChild(tempDisplay);
        };

        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '10px';
        buttonContainer.appendChild(saveButton);
        buttonContainer.appendChild(discardButton);
        tempDisplay.appendChild(buttonContainer);
        
        // Remove old temporary display if exists
        const oldDisplay = document.getElementById('ai-description-display');
        if(oldDisplay) aiDescriptionControls.removeChild(oldDisplay);

        aiDescriptionControls.appendChild(tempDisplay);


    } catch (error) {
        console.error("Lỗi Gemini API:", error);
        showToast(`Lỗi: ${error.message}`, 'error');
    } finally {
        if(generateBtn) {
            generateBtn.disabled = false;
            generateBtn.innerHTML = `<i class="fas fa-robot"></i> Tạo mô tả AI`;
        }
    }
}

function saveAiDescription(text) {
    if (!aiDescriptions[currentImage]) {
        aiDescriptions[currentImage] = {
            saved: [],
            displayIndex: -1 // -1 is original
        };
    }
    aiDescriptions[currentImage].saved.push(text);
    // Switch to the newly saved description
    aiDescriptions[currentImage].displayIndex = aiDescriptions[currentImage].saved.length - 1;
    updateArtworkDetails(currentImage);
    showToast("Đã lưu mô tả AI!");
}

function swapDescription() {
    if (!aiDescriptions[currentImage] || aiDescriptions[currentImage].saved.length === 0) return;
    
    const totalVersions = aiDescriptions[currentImage].saved.length + 1; // +1 for original
    let currentIndex = aiDescriptions[currentImage].displayIndex + 1; // map -1..n-1 to 0..n
    
    currentIndex = (currentIndex + 1) % totalVersions;
    
    aiDescriptions[currentImage].displayIndex = currentIndex - 1; // map back to -1..n-1
    updateArtworkDetails(currentImage);
}

// =================================================================================
// END: GEMINI AI MODULE
// =================================================================================


// =================================================================================
// START: TEXT-TO-SPEECH (TTS) MODULE
// =================================================================================

// --- TTS State & Settings ---
let isTtsEnabled = false;
const TTS_SETTINGS_KEY = 'galleryTtsSettings';
let ttsSettings = {
    method: 'google', // 'google' or 'responsivevoice'
    delay: 2, // seconds
    volume: 1.0,
    apiKeys: ['https://api.allorigins.win/raw?url='],
    currentApiKeyIndex: 0,
    fadeEndVolume: 20,
    fadeDuration: 3,
    rv: {
        voice: 'Vietnamese Female',
        rate: 1.0,
        pitch: 1.0
    },
    ga: {
        rate: 1.0,
        bass: 0,
        mid: 0,
        treble: 0
    }
};
let audioContext;
let currentAudioSources = [];
let ttsTimeoutId = null;

// --- TTS DOM Elements ---
const toggleTtsButton = document.getElementById('toggle-tts-button');
const ttsSettingsPanel = document.getElementById('tts-settings-panel');
const ttsMethodSelect = document.getElementById('tts-method-select');
const ttsDelayInput = document.getElementById('tts-delay-input');
const ttsVolumeSlider = document.getElementById('tts-volume-slider');
const ttsVolumeValue = document.getElementById('tts-volume-value');
const ttsApiKeysTextarea = document.getElementById('tts-api-keys-textarea');
const fadeEndVolumeSlider = document.getElementById('fade-end-volume-slider');
const fadeEndVolumeValue = document.getElementById('fade-end-volume-value');
const fadeDurationInput = document.getElementById('fade-duration-input');
const rvSettingsDiv = document.getElementById('responsivevoice-settings');
const gaSettingsDiv = document.getElementById('google-audio-settings');
const rvVoiceSelect = document.getElementById('rv-voice-select');
const rvRateSlider = document.getElementById('rv-rate-slider');
const rvRateValue = document.getElementById('rv-rate-value');
const rvPitchSlider = document.getElementById('rv-pitch-slider');
const rvPitchValue = document.getElementById('rv-pitch-value');
const gaRateSlider = document.getElementById('ga-rate-slider');
const gaRateValue = document.getElementById('ga-rate-value');
const gaBassSlider = document.getElementById('ga-bass-slider');
const gaBassValue = document.getElementById('ga-bass-value');
const gaMidSlider = document.getElementById('ga-mid-slider');
const gaMidValue = document.getElementById('ga-mid-value');
const gaTrebleSlider = document.getElementById('ga-treble-slider');
const gaTrebleValue = document.getElementById('ga-treble-value');

// --- Core TTS Functions ---

function initializeTTS() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    } catch (e) {
        console.error("Web Audio API is not supported in this browser.");
        document.querySelector('#tts-method-select option[value="google"]').disabled = true;
        ttsSettings.method = 'responsivevoice';
    }

    loadTtsSettings();
    updateTtsUi();
    setupTtsEventListeners();
}

function speak(text) {
    if (!isTtsEnabled || !text) return;
    stopSpeaking(); 

    // Music fade out is now triggered from updateDisplay
    if (ttsSettings.method === 'responsivevoice') {
        speakWithResponsiveVoice(text);
    } else if (ttsSettings.method === 'google' && audioContext) {
        speakWithGoogleAudio(text);
    }
}


function stopSpeaking() {
    responsiveVoice.cancel();
    if (currentAudioSources.length > 0) {
        currentAudioSources.forEach(source => {
            try { source.stop(); } catch(e) {}
        });
        currentAudioSources = [];
    }
    // Restore music volume with fade effect
    applyVolumeFadeInEffect();
}

function speakWithResponsiveVoice(text) {
    const params = {
        rate: ttsSettings.rv.rate,
        pitch: ttsSettings.rv.pitch,
        volume: ttsSettings.volume,
        onend: applyVolumeFadeInEffect // Use fade-in on end
    };
    responsiveVoice.speak(text, ttsSettings.rv.voice, params);
}

function speakWithGoogleAudio(text) {
    const chunks = splitText(text);
    playChunksSequentially(chunks);
}

function splitText(text) {
    if (text.length <= 200) return [text];
    const chunks = [];
    let currentChunk = text;
    while (currentChunk.length > 200) {
        let splitPos = currentChunk.lastIndexOf('.', 200);
        if (splitPos === -1) splitPos = currentChunk.lastIndexOf(',', 200);
        if (splitPos === -1) splitPos = currentChunk.lastIndexOf(' ', 200);
        if (splitPos === -1) splitPos = 200;

        chunks.push(currentChunk.substring(0, splitPos + 1));
        currentChunk = currentChunk.substring(splitPos + 1).trim();
    }
    if (currentChunk.length > 0) chunks.push(currentChunk);
    return chunks;
}


async function playChunksSequentially(chunks) {
    for (const chunk of chunks) {
        if (!isTtsEnabled) break;
        try {
            const audioBuffer = await fetchAudioChunk(chunk);
            if (!isTtsEnabled) break; // Check again after await
            await playAudioBuffer(audioBuffer);
        } catch (error) {
            console.error("Error playing chunk:", error);
            break; 
        }
    }
     if (isTtsEnabled) { 
        applyVolumeFadeInEffect();
    }
}

async function fetchAudioChunk(chunk) {
    const googleUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(chunk)}&tl=vi&client=tw-ob`;
    let attempts = 0;
    
    while(attempts < ttsSettings.apiKeys.length) {
        const proxyUrl = ttsSettings.apiKeys[ttsSettings.currentApiKeyIndex];
        const requestUrl = `${proxyUrl}${encodeURIComponent(googleUrl)}`;

        try {
            const response = await fetch(requestUrl);
            if (!response.ok) throw new Error(`Fetch failed with status: ${response.status}`);
            const arrayBuffer = await response.arrayBuffer();
            return await audioContext.decodeAudioData(arrayBuffer);
        } catch (error) {
            console.warn(`API key/proxy at index ${ttsSettings.currentApiKeyIndex} failed.`, error);
            switchToNextApiKey();
            attempts++;
        }
    }
    throw new Error("All API keys/proxies failed.");
}

function playAudioBuffer(audioBuffer) {
    return new Promise(resolve => {
        if (!isTtsEnabled) {
            resolve();
            return;
        }
        const audioSource = audioContext.createBufferSource();
        audioSource.buffer = audioBuffer;
        
        const bassFilter = audioContext.createBiquadFilter();
        bassFilter.type = 'lowshelf';
        bassFilter.frequency.value = 320;
        bassFilter.gain.value = ttsSettings.ga.bass;

        const midFilter = audioContext.createBiquadFilter();
        midFilter.type = 'peaking';
        midFilter.frequency.value = 1000;
        midFilter.Q.value = 1;
        midFilter.gain.value = ttsSettings.ga.mid;

        const trebleFilter = audioContext.createBiquadFilter();
        trebleFilter.type = 'highshelf';
        trebleFilter.frequency.value = 3200;
        trebleFilter.gain.value = ttsSettings.ga.treble;

        const gainNode = audioContext.createGain();
        gainNode.gain.value = ttsSettings.volume;

        audioSource.playbackRate.value = ttsSettings.ga.rate;

        audioSource.connect(bassFilter)
                   .connect(midFilter)
                   .connect(trebleFilter)
                   .connect(gainNode)
                   .connect(audioContext.destination);
        
        audioSource.onended = () => {
            const index = currentAudioSources.indexOf(audioSource);
            if (index > -1) currentAudioSources.splice(index, 1);
            resolve();
        };

        currentAudioSources.push(audioSource);
        audioSource.start(0);
    });
}

function switchToNextApiKey() {
    const oldIndex = ttsSettings.currentApiKeyIndex;
    ttsSettings.currentApiKeyIndex = (ttsSettings.currentApiKeyIndex + 1) % ttsSettings.apiKeys.length;
    showToast(`Proxy ${oldIndex + 1} lỗi, chuyển sang Proxy ${ttsSettings.currentApiKeyIndex + 1}.`, 'warning');
    saveTtsSettings();
}

// --- Music Volume Fading ---

/**
 * NEW: Smoothly fades music volume to a target level.
 * @param {number} targetVolume - Target volume (0-100).
 * @param {number} duration - Duration in milliseconds.
 * @param {Function} [onComplete] - Optional callback when fade is complete.
 */
function fadeMusicVolume(targetVolume, duration, onComplete) {
    if (musicFadeInterval) clearInterval(musicFadeInterval);
    
    const startVolume = currentMusicVolume;
    if (startVolume === targetVolume) {
        if (onComplete) onComplete();
        return;
    }

    const totalChange = targetVolume - startVolume;
    const updateInterval = 50; // ms
    const numSteps = duration / updateInterval;
    const step = totalChange / numSteps;

    musicFadeInterval = setInterval(() => {
        currentMusicVolume += step;
        
        // Check bounds
        if ((step > 0 && currentMusicVolume >= targetVolume) || (step < 0 && currentMusicVolume <= targetVolume)) {
            currentMusicVolume = targetVolume;
            clearInterval(musicFadeInterval);
            musicFadeInterval = null;
            if (onComplete) onComplete();
        }
        
        setMusicVolume(currentMusicVolume);
    }, updateInterval);
}

function setMusicVolume(volume) { // volume is 0-100
    try {
        const clampedVolume = Math.max(0, Math.min(100, volume));
        if (currentMusicSource === 'youtube' && youtubePlayer && typeof youtubePlayer.setVolume === 'function') {
            youtubePlayer.setVolume(clampedVolume);
        } else if (currentMusicSource === 'soundcloud' && soundcloudWidget) {
            soundcloudWidget.setVolume(clampedVolume / 100);
        }
    } catch(e) {
        console.warn("Could not set music volume.", e);
    }
}

function applyVolumeFadeOutEffect() {
    fadeMusicVolume(ttsSettings.fadeEndVolume, ttsSettings.fadeDuration * 1000);
}

function applyVolumeFadeInEffect() {
    fadeMusicVolume(100, ttsSettings.fadeDuration * 1000);
}


// --- UI and Event Handlers ---

function handleTtsToggle() {
    isTtsEnabled = !isTtsEnabled;
    toggleTtsButton.classList.toggle('active', isTtsEnabled);
    showToast(`Tự động đọc: ${isTtsEnabled ? 'Bật' : 'Tắt'}`);
    
    if (isTtsEnabled) {
        const textToSpeak = artworkMainDesc.innerText.trim();
        if (textToSpeak) {
             if (ttsTimeoutId) clearTimeout(ttsTimeoutId);
             applyVolumeFadeOutEffect(); // Start fade out immediately
             ttsTimeoutId = setTimeout(() => {
                speak(textToSpeak);
            }, ttsSettings.delay * 1000);
        }
    } else {
        if (ttsTimeoutId) clearTimeout(ttsTimeoutId);
        stopSpeaking(); // This will also trigger the fade-in
    }
}

function setupTtsEventListeners() {
    toggleTtsButton.addEventListener('click', handleTtsToggle);

    ttsMethodSelect.addEventListener('change', e => {
        ttsSettings.method = e.target.value;
        updateTtsUi();
        saveTtsSettings();
    });

    ttsDelayInput.addEventListener('change', e => {
        ttsSettings.delay = parseFloat(e.target.value);
        saveTtsSettings();
    });
    
    ttsApiKeysTextarea.addEventListener('change', e => {
        ttsSettings.apiKeys = e.target.value.split('\n').map(k => k.trim()).filter(Boolean);
        if(ttsSettings.apiKeys.length === 0) {
           ttsSettings.apiKeys = ['https://api.allorigins.win/raw?url=']; // Fallback
        }
        ttsSettings.currentApiKeyIndex = 0;
        saveTtsSettings();
    });

    fadeEndVolumeSlider.addEventListener('input', e => {
        const vol = parseInt(e.target.value);
        ttsSettings.fadeEndVolume = vol;
        fadeEndVolumeValue.textContent = `${vol}%`;
        saveTtsSettings();
    });

    fadeDurationInput.addEventListener('change', e => {
        ttsSettings.fadeDuration = parseFloat(e.target.value);
        saveTtsSettings();
    });

    const setupSlider = (slider, valueLabel, settingPath, transformFn) => {
        slider.addEventListener('input', e => {
            const value = parseFloat(e.target.value);
            let target = ttsSettings;
            const path = settingPath.split('.');
            for(let i = 0; i < path.length - 1; i++) {
                target = target[path[i]];
            }
            target[path[path.length - 1]] = value;
            valueLabel.textContent = transformFn(value);
            saveTtsSettings();
        });
    };

    setupSlider(ttsVolumeSlider, ttsVolumeValue, 'volume', v => `${Math.round(v * 100)}%`);
    setupSlider(rvRateSlider, rvRateValue, 'rv.rate', v => `${v.toFixed(1)}x`);
    setupSlider(rvPitchSlider, rvPitchValue, 'rv.pitch', v => `${v.toFixed(1)}x`);
    setupSlider(gaRateSlider, gaRateValue, 'ga.rate', v => `${v.toFixed(1)}x`);
    setupSlider(gaBassSlider, gaBassValue, 'ga.bass', v => `${v} dB`);
    setupSlider(gaMidSlider, gaMidValue, 'ga.mid', v => `${v} dB`);
    setupSlider(gaTrebleSlider, gaTrebleValue, 'ga.treble', v => `${v} dB`);
}

function saveTtsSettings() {
    localStorage.setItem(TTS_SETTINGS_KEY, JSON.stringify(ttsSettings));
}

function loadTtsSettings() {
    const savedSettings = localStorage.getItem(TTS_SETTINGS_KEY);
    if (savedSettings) {
        const parsed = JSON.parse(savedSettings);
        // Ensure fadeDuration is a number, not string, for calculations
        if (parsed.fadeDuration) parsed.fadeDuration = parseFloat(parsed.fadeDuration);
        ttsSettings = { ...ttsSettings, ...parsed };
    }
}

function updateTtsUi() {
    rvSettingsDiv.style.display = ttsSettings.method === 'responsivevoice' ? 'block' : 'none';
    gaSettingsDiv.style.display = ttsSettings.method === 'google' ? 'block' : 'none';

    ttsMethodSelect.value = ttsSettings.method;
    ttsDelayInput.value = ttsSettings.delay;
    ttsApiKeysTextarea.value = ttsSettings.apiKeys.join('\n');
    fadeEndVolumeSlider.value = ttsSettings.fadeEndVolume;
    fadeEndVolumeValue.textContent = `${ttsSettings.fadeEndVolume}%`;
    fadeDurationInput.value = ttsSettings.fadeDuration;
    
    ttsVolumeSlider.value = ttsSettings.volume;
    ttsVolumeValue.textContent = `${Math.round(ttsSettings.volume * 100)}%`;
    rvVoiceSelect.value = ttsSettings.rv.voice;
    rvRateSlider.value = ttsSettings.rv.rate;
    rvRateValue.textContent = `${ttsSettings.rv.rate.toFixed(1)}x`;
    rvPitchSlider.value = ttsSettings.rv.pitch;
    rvPitchValue.textContent = `${ttsSettings.rv.pitch.toFixed(1)}x`;
    gaRateSlider.value = ttsSettings.ga.rate;
    gaRateValue.textContent = `${ttsSettings.ga.rate.toFixed(1)}x`;
    gaBassSlider.value = ttsSettings.ga.bass;
    gaBassValue.textContent = `${ttsSettings.ga.bass} dB`;
    gaMidSlider.value = ttsSettings.ga.mid;
    gaMidValue.textContent = `${ttsSettings.ga.mid} dB`;
    gaTrebleSlider.value = ttsSettings.ga.treble;
    gaTrebleValue.textContent = `${ttsSettings.ga.treble} dB`;
}
// =================================================================================
// END: TEXT-TO-SPEECH (TTS) MODULE
// =================================================================================


// --- YouTube API Functions ---
function onYouTubeIframeAPIReady() {
youtubePlayer = new YT.Player('player', {
height: '1', width: '1',
playerVars: { 'autoplay': 1, 'controls': 0, 'loop': 0, 'origin': window.location.origin },
events: { 'onStateChange': onPlayerStateChange }
});
}
function onPlayerStateChange(event) {
if (event.data == YT.PlayerState.PLAYING) {
    if (_isFadingInNewTrack) {
        _isFadingInNewTrack = false;
        setMusicVolume(0);
        fadeMusicVolume(100, 1500);
    }
    isMusicPlaying = true;
    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
    const videoData = youtubePlayer.getVideoData();
    const title = cleanSongTitle(videoData.title || 'YouTube Video');
    nowPlayingSpan.textContent = title;
    nowPlayingLink.title = title;
} else if (event.data == YT.PlayerState.PAUSED) {
    isMusicPlaying = false;
    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
} else if (event.data == YT.PlayerState.ENDED) {
    if (isAutoRandomEnabled) triggerChangeContent();
    else { youtubePlayer.seekTo(0); youtubePlayer.playVideo(); }
}
}

// --- Core Functions ---
function startSlideshow() {
imageLinks = imageLinksTextarea.value.split('\n').filter(link => link.trim() !== '');
musicLinks = musicLinksTextarea.value.split('\n').filter(link => link.trim() !== '');
if (imageLinks.length === 0) {
alert('Vui lòng nhập link ảnh!'); return;
}
parseDescriptions();
parseArtistData();
sessionImagePool = [...imageLinks];
randomClickCount = 0;
initializeMusicLockCounts();
populateAllMusicList();

mainContent.style.display = 'none';
slideshow.style.display = 'flex';
changeContent(true);
}
function stopSlideshow() {
slideshow.style.display = 'none';
mainContent.style.display = 'flex';
if (soundcloudWidget) soundcloudWidget.pause();
if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') youtubePlayer.stopVideo();
isImageLocked = false;
updateLockImageButton();
document.querySelectorAll('.side-panel').forEach(p => p.classList.remove('visible'));
leftPanelWrapper.classList.add('collapsed');
stopPlaylistMode();
if (document.fullscreenElement) document.exitFullscreen();
resetImageTransform();

if (isTtsEnabled) stopSpeaking();
if (ttsTimeoutId) clearTimeout(ttsTimeoutId);
}

function changeContent(shouldChangeImage, specificImage = null, isRestoring = false) {
if (isTransitioning) return;
isTransitioning = true;

if (!isRestoring) {
previousState = { image: currentImage, track: currentTrack };
}

slideshowImage.classList.remove('visible');
frameImage.classList.remove('visible');
descriptionContainer.classList.remove('visible');

if (ttsTimeoutId) clearTimeout(ttsTimeoutId);
stopSpeaking();

setTimeout(() => {
descriptionWrapper.scrollTop = 0;

let nextImage = currentImage;
if (specificImage) {
nextImage = specificImage;
} else if (shouldChangeImage && imageLinks.length > 0) {
if (currentPlaylist) {
if (playlistImagePool.length === 0) {
playlistImagePool = [...playlistOriginalItems];
showToast(`Bộ sưu tập "${currentPlaylist}" đã chạy hết. Bắt đầu vòng mới!`);
}
const randomIndex = Math.floor(Math.random() * playlistImagePool.length);
nextImage = playlistImagePool.splice(randomIndex, 1)[0].image;
} else {
if (sessionImagePool.length === 0) {
sessionImagePool = [...imageLinks];
showToast("Đã chiếu hết tất cả tranh. Bắt đầu vòng mới!");
}
const randomIndex = Math.floor(Math.random() * sessionImagePool.length);
nextImage = sessionImagePool.splice(randomIndex, 1)[0];
}
}
currentImage = nextImage;

if (!isRestoring) {
let trackToPlay;
const playlistItem = currentPlaylist ? playlistOriginalItems.find(item => item.image === currentImage) : null;
const lockedForThisImage = (playlistItem?.lockedMusic?.length > 0) ? playlistItem.lockedMusic : lockedTracks[currentImage];

if (isLockOverrideEnabled) {
trackToPlay = musicLinks[Math.floor(Math.random() * musicLinks.length)];
} else if (isImageLocked && isSequentialMusicEnabled) {
trackToPlay = musicLinks[globalSequentialMusicIndex];
globalSequentialMusicIndex = (globalSequentialMusicIndex + 1) % musicLinks.length;
} else if (lockedForThisImage?.length > 0) {
const randomIndex = Math.floor(Math.random() * lockedForThisImage.length);
trackToPlay = lockedForThisImage[randomIndex];
} else if (musicLinks.length > 0) {
trackToPlay = musicLinks[Math.floor(Math.random() * musicLinks.length)];
}

if (trackToPlay && trackToPlay !== currentTrack) {
    currentTrack = trackToPlay;
    // NEW: Smooth transition logic
    fadeMusicVolume(0, 1000, () => {
        loadAndPlayTrack(currentTrack, true);
    });
} else if (trackToPlay && trackToPlay === currentTrack) {
    if (currentMusicSource === 'youtube') youtubePlayer.playVideo();
    if (currentMusicSource === 'soundcloud') soundcloudWidget.play();
}


} else {
loadAndPlayTrack(currentTrack);
}

const img = new Image();
img.crossOrigin = "anonymous";
img.onload = () => {
slideshowImage.src = img.src;
updateDisplay(currentImage);
setTimeout(() => { isTransitioning = false; }, 800);
};
img.onerror = () => {
console.error("Lỗi tải ảnh:", currentImage);
isTransitioning = false;
triggerChangeContent();
};
img.src = currentImage;

}, 500);
}

function updateDisplay(imageUrl) {
if (!imageUrl) return;
resetImageTransform();

updateArtworkDetails(imageUrl);
updateArtistInfo(imageUrl);
updateLockStatusDisplay(imageUrl);
getDominantColor(slideshowImage);

const frameUrl = uiSettings.frameUrl.trim();
if (frameUrl) {
frameImage.style.display = 'block';
frameImage.src = frameUrl;

const padding = uiSettings.framePadding;
const artNaturalWidth = slideshowImage.naturalWidth;
const artNaturalHeight = slideshowImage.naturalHeight;

const wrapperRect = artworkWrapper.getBoundingClientRect();
const wrapperAspectRatio = wrapperRect.width / wrapperRect.height;
const artAspectRatio = artNaturalWidth / artNaturalHeight;

let displayArtWidth, displayArtHeight;
if (wrapperAspectRatio > artAspectRatio) {
displayArtHeight = wrapperRect.height;
displayArtWidth = displayArtHeight * artAspectRatio;
} else {
displayArtWidth = wrapperRect.width;
displayArtHeight = displayArtWidth / artAspectRatio;
}

slideshowImage.style.width = `${displayArtWidth}px`;
slideshowImage.style.height = `${displayArtHeight}px`;

const frameWidth = displayArtWidth + padding * 2;
const frameHeight = displayArtHeight + padding * 2;

frameImage.style.width = `${frameWidth}px`;
frameImage.style.height = `${frameHeight}px`;
frameImage.classList.add('visible');
} else {
frameImage.style.display = 'none';
frameImage.src = '';
frameImage.classList.remove('visible');
slideshowImage.style.width = 'auto';
slideshowImage.style.height = 'auto';
}

slideshowImage.classList.add('visible');
descriptionContainer.classList.add('visible');

if (isTtsEnabled) {
    const textToSpeak = artworkMainDesc.innerText.trim();
    if(textToSpeak) {
        // NEW: Start fade out as soon as display updates
        applyVolumeFadeOutEffect();
        ttsTimeoutId = setTimeout(() => {
            speak(textToSpeak);
        }, ttsSettings.delay * 1000);
    }
}
}


// --- Audio Handling ---
async function loadAndPlayTrack(trackUrlOrId, shouldFadeIn = false) {
    if (!trackUrlOrId) return;
    
    _isFadingInNewTrack = shouldFadeIn;
    
    const trackInfo = await getTrackInfo(trackUrlOrId);
    nowPlayingLink.href = trackInfo.url;
    nowPlayingLink.title = trackInfo.name;
    nowPlayingSpan.textContent = trackInfo.name;
    
    if (trackInfo.source === 'youtube') {
        currentMusicSource = 'youtube';
        if (soundcloudWidget) soundcloudWidget.pause();
        if (youtubePlayer && typeof youtubePlayer.loadVideoById === 'function') {
            youtubePlayer.loadVideoById(trackUrlOrId);
            nowPlayingSpan.textContent = 'Đang tải YouTube...';
        }
    } else {
        currentMusicSource = 'soundcloud';
        if (youtubePlayer && typeof youtubePlayer.stopVideo === 'function') youtubePlayer.stopVideo();
        const soundcloudUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(trackUrlOrId)}&auto_play=true&visual=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false`;
        if (!soundcloudWidget) {
            soundcloudWidgetContainer.innerHTML = `<iframe id="sc-widget" scrolling="no" frameborder="no" allow="autoplay" src="${soundcloudUrl}"></iframe>`;
            soundcloudWidget = SC.Widget(document.getElementById('sc-widget'));
            soundcloudWidget.bind(SC.Widget.Events.READY, () => {
                soundcloudWidget.bind(SC.Widget.Events.PLAY, () => {
                    if (_isFadingInNewTrack) {
                        _isFadingInNewTrack = false;
                        setMusicVolume(0);
                        fadeMusicVolume(100, 1500);
                    }
                    isMusicPlaying = true;
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                });
                soundcloudWidget.bind(SC.Widget.Events.PAUSE, () => { isMusicPlaying = false; playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; });
                soundcloudWidget.bind(SC.Widget.Events.FINISH, () => {
                    if (isAutoRandomEnabled) triggerChangeContent(); else soundcloudWidget.play();
                });
            });
        } else {
            soundcloudWidget.load(trackUrlOrId, { auto_play: true });
        }
    }
    
    if (!shouldFadeIn) {
        currentMusicVolume = 100;
        setMusicVolume(100);
    }

    isMusicPlaying = true;
    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
}

function cleanSongTitle(title) {
if (!title) return '';
let cleanedTitle = title.replace(/\[[^\]]*\]|\([^)]*\)/g, '');
const junkKeywords = ['official music video', 'official video', 'music video', 'official audio', 'lyrics', 'lyric video', 'hd', '4k', 'hq', 'audio', 'visualizer', 'topic', 'vevo', 'remix', 'cover', 'ft.','feat', 'prod by'];
cleanedTitle = cleanedTitle.replace(new RegExp(`\\b(${junkKeywords.join('|')})\\b`, 'gi'), '');
cleanedTitle = cleanedTitle.replace(/[|｜-]/g, ' ').trim().replace(/\s+/g, ' ');
return cleanedTitle.charAt(0).toUpperCase() + cleanedTitle.slice(1);
}
async function getTrackInfo(trackUrlOrId) {
const cacheKey = `trackinfo_${trackUrlOrId}`;
const cached = sessionStorage.getItem(cacheKey);
if (cached) return JSON.parse(cached);
let result;
if (/^[a-zA-Z0-9_-]{11}$/.test(trackUrlOrId.trim())) { // Is YouTube ID
const videoUrl = `https://www.youtube.com/watch?v=${trackUrlOrId}`;
try {
const response = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(videoUrl)}`);
if (!response.ok) throw new Error('Network response failed');
const data = await response.json();
result = { name: cleanSongTitle(data.title) || `YT: ${trackUrlOrId}`, url: videoUrl, source: 'youtube' };
} catch (error) {
result = { name: `YouTube ID: ${trackUrlOrId}`, url: videoUrl, source: 'youtube' };
}
} else { // SoundCloud
try {
const response = await fetch(`https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(trackUrlOrId)}`);
const data = await response.json();
result = { name: cleanSongTitle(data.title) || 'SoundCloud Track', url: trackUrlOrId, source: 'soundcloud' };
} catch (e) {
const pathParts = trackUrlOrId.split('/');
const lastPart = pathParts.pop() || pathParts.pop();
result = { name: cleanSongTitle(lastPart) || 'SoundCloud Track', url: trackUrlOrId, source: 'soundcloud' };
}
}
sessionStorage.setItem(cacheKey, JSON.stringify(result));
return result;
}

// --- Data Parsing & Descriptions ---
function extractImageNumber(url) {
if (!url) return null;
try {
const filename = url.split('/').pop();
const numberPart = filename.match(/^(\d+)/);
return numberPart ? numberPart[1] : null;
} catch (e) { return null; }
}
function getImageNameFromUrl(url) {
try {
return decodeURIComponent(url.substring(url.lastIndexOf('/') + 1));
} catch { return 'Không rõ tên'; }
}
function parseDescriptions() {
imageDescriptions = {};
const lines = descriptionTextarea.value.split('\n').filter(line => line.trim() !== '');
lines.forEach(line => {
const initialParts = line.split(/-(.+)/s);
if (initialParts.length < 2) return;
const number = initialParts[0].trim();
const rest = initialParts[1].trim();
const descParts = rest.split(/\.\s*(.+)/s);
const header = descParts[0];
const description = descParts.length > 1 ? descParts[1].trim() : 'Không có mô tả.';
let title = header, artist = 'Họa sĩ không xác định';
const lastDashIndex = header.lastIndexOf('-');
if (lastDashIndex > -1) {
title = header.substring(0, lastDashIndex).trim();
artist = header.substring(lastDashIndex + 1).trim();
}
imageDescriptions[number] = { title, artist, description };
});
}

function updateArtworkDetails(imageUrl, isEditing = null) {
    const number = extractImageNumber(imageUrl);
    const data = imageDescriptions[number];
    const root = document.documentElement;
    aiDescriptionControls.innerHTML = ''; // Clear AI controls

    const setupAndReplace = (targetElement, field, value, isTextarea = false) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'inline-edit-wrapper';

        const input = document.createElement(isTextarea ? 'textarea' : 'input');
        if (!isTextarea) input.type = 'text';
        input.className = 'inline-edit-input';
        input.value = value;
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'save-edit-btn';
        saveBtn.textContent = 'Lưu';

        wrapper.appendChild(input);
        wrapper.appendChild(saveBtn);
        targetElement.innerHTML = '';
        targetElement.appendChild(wrapper);

        let isSaving = false;
        const doSave = () => {
            if (isSaving) return;
            isSaving = true;
            saveEdit(field, input);
        };
        
        saveBtn.addEventListener('click', doSave);
        input.addEventListener('blur', () => {
            setTimeout(() => {
                if (document.activeElement === saveBtn) return;
                doSave();
            }, 100);
        });
        input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' && !isTextarea) doSave(); });
        input.focus();
    };

    if (data) {
        const titleText = data.title;
        if (titleText.length > uiSettings.titleLengthThreshold) {
            root.style.setProperty('--artwork-title-size', uiSettings.titleLongFontSize);
        } else {
            root.style.setProperty('--artwork-title-size', uiSettings.titleFontSize);
        }

        if (isEditing === 'title') {
            setupAndReplace(artworkTitle, 'title', data.title);
        } else {
            const titleMatch = data.title.match(/(.*)\s*\((.*)\)/);
            artworkTitle.innerHTML = titleMatch ?
                `${titleMatch[1].trim()}<span class="vietnamese-title">(${titleMatch[2].trim()})</span>` :
                data.title;
        }

        if (isEditing === 'artist') {
            setupAndReplace(artworkArtist, 'artist', data.artist);
        } else {
            artworkArtist.textContent = data.artist;
        }
        
        // --- AI Description Logic ---
        const aiData = aiDescriptions[imageUrl];
        let descriptionToDisplay = data.description || 'Không có mô tả.';
        
        if (aiData && aiData.displayIndex > -1) {
            descriptionToDisplay = aiData.saved[aiData.displayIndex];
        }

        if (isEditing === 'description') {
            setupAndReplace(artworkMainDesc, 'description', descriptionToDisplay, true);
        } else {
            const paragraphs = descriptionToDisplay.split(/\n\s*\n/).filter(p => p.trim() !== '');
            artworkMainDesc.innerHTML = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
        }
        
        if (isEditMode) {
            if (isEditing !== 'title') artworkTitle.innerHTML += ` <i class="fas fa-pencil-alt edit-control" data-field="title"></i>`;
            if (isEditing !== 'artist') artworkArtist.innerHTML += ` <i class="fas fa-pencil-alt edit-control" data-field="artist"></i>`;
            if (isEditing !== 'description') {
                 const editIcon = document.createElement('i');
                 editIcon.className = 'fas fa-pencil-alt edit-control';
                 editIcon.dataset.field = 'description';
                 artworkMainDesc.appendChild(editIcon);
            }
        }
        
        // --- Render AI Controls ---
        const generateBtn = document.createElement('button');
        generateBtn.id = 'generate-ai-btn';
        generateBtn.className = 'ai-control-btn';
        generateBtn.innerHTML = `<i class="fas fa-robot"></i> Tạo mô tả AI`;
        generateBtn.onclick = generateAiDescription;
        aiDescriptionControls.appendChild(generateBtn);
        
        if (aiData && aiData.saved.length > 0) {
            const swapBtn = document.createElement('button');
            swapBtn.className = 'ai-control-btn';
            const currentView = aiData.displayIndex === -1 ? 'Gốc' : `AI ${aiData.displayIndex + 1}/${aiData.saved.length}`;
            swapBtn.innerHTML = `<i class="fas fa-sync-alt"></i> Hoán đổi (${currentView})`;
            swapBtn.onclick = swapDescription;
            aiDescriptionControls.appendChild(swapBtn);
        }

    } else {
        artworkTitle.innerHTML = 'Chưa có tiêu đề';
        artworkArtist.textContent = 'Họa sĩ không xác định';
        artworkMainDesc.innerHTML = '<p>Không có mô tả cho tác phẩm này.</p>';
        root.style.setProperty('--artwork-title-size', uiSettings.titleFontSize);
    }
}

function parseArtistData() {
artistData = {};
const photoLinks = artistImageLinksTextarea.value.split('\n').filter(link => link.trim());
const descriptions = artistDescriptionsTextarea.value.split('\n').filter(line => line.trim());
const photoMap = {};
photoLinks.forEach(link => {
const name = getImageNameFromUrl(link).split('.')[0].replace(/[-_]/g, ' ').trim();
photoMap[name.toLowerCase()] = link;
});
descriptions.forEach(line => {
const parts = line.split(/-(.+)/s);
if (parts.length >= 2) {
const name = parts[0].trim().replace(/[-_]/g, ' ').trim();
const desc = parts[1].trim();
const key = name.toLowerCase();
artistData[key] = { name, desc, photo: photoMap[key] || '' };
}
});
}
function updateArtistInfo(imageUrl) {
const number = extractImageNumber(imageUrl);
const artworkData = imageDescriptions[number];
if (!artworkData) {
artistInfoContainer.style.display = 'none'; return;
}
const artistName = artworkData.artist;
const data = artistData[artistName.toLowerCase()];
if (data && data.photo) {
artistPhoto.src = data.photo;
artistTooltip.textContent = `${data.name} - ${data.desc}`;
artistInfoContainer.style.display = 'flex';
setTimeout(() => artistInfoContainer.classList.add('visible'), 10);
} else {
artistInfoContainer.classList.remove('visible');
setTimeout(() => artistInfoContainer.style.display = 'none', 500);
}
}

// --- Lock Management & UI ---
function toggleImageLock() {
isImageLocked = !isImageLocked;
updateLockImageButton();
updateLockStatusDisplay(currentImage);
}
async function populateAllMusicList() {
allMusicList.innerHTML = '<li>Đang tải danh sách...</li>';
allMusicList.classList.add('loading');
const trackPromises = musicLinks.map(track => getTrackInfo(track));
const trackInfos = await Promise.all(trackPromises);
allMusicList.innerHTML = trackInfos.map((info, index) =>
`<li data-track="${musicLinks[index]}" title="${info.name}">${info.name}</li>`
).join('');
allMusicList.classList.remove('loading');
}
function updateLockImageButton() {
lockImageButton.innerHTML = isImageLocked ? '<i class="fas fa-unlock"></i>Mở khoá' : '<i class="fas fa-image"></i>Khoá Tranh';
lockImageButton.classList.toggle('locked', isImageLocked);
}
async function updateLockStatusDisplay(imageUrl) {
const modeClass = isImageLocked ? 'locked' : 'free';
const modeText = isImageLocked ? 'CHẾ ĐỘ KHOÁ TRANH' : 'CHẾ ĐỘ TỰ DO';
let content = `<div class="status-mode ${modeClass}">${modeText}</div>`;
const lockedForThisImage = lockedTracks[imageUrl];
if (lockedForThisImage?.length > 0) {
content += `<h4>Nhạc đã khoá cho tranh này:</h4><ul id="locked-songs-list">`;
for (const track of lockedForThisImage) {
const info = await getTrackInfo(track);
content += `<li data-url="${track}"><span class="song-name" title="${info.name}"><i class="fas fa-music" style="margin-right: 8px; color: var(--color-accent);"></i> ${info.name}</span><button class="unlock-song-btn">Mở khoá</button></li>`;
}
content += `</ul>`;
} else if (isImageLocked) {
content += `<p style="font-style: italic; font-size: 12px;">Chưa có nhạc nào được khoá.</p>`;
}
lockStatusDisplay.innerHTML = content;
}
lockStatusDisplay.addEventListener('click', function(e) {
const unlockButton = e.target.closest('.unlock-song-btn');
if (unlockButton) {
const li = unlockButton.closest('li');
const trackUrlToUnlock = li.dataset.url;
if (confirm(`Bạn có chắc muốn mở khóa bài hát này khỏi tranh hiện tại không?`)) {
const tracks = lockedTracks[currentImage];
const index = tracks ? tracks.indexOf(trackUrlToUnlock) : -1;
if (index > -1) {
tracks.splice(index, 1);
if (tracks.length === 0) delete lockedTracks[currentImage];
showToast(`Đã mở khoá bài hát!`);
updateLockStatusDisplay(currentImage);
renderPlaylistManager();
}
}
return;
}

const songItem = e.target.closest('li[data-url]');
if (songItem) {
const trackToPlay = songItem.dataset.url;
if (trackToPlay && trackToPlay !== currentTrack) {
    currentTrack = trackToPlay;
    fadeMusicVolume(0, 1000, () => loadAndPlayTrack(currentTrack, true));
}
}
});
function lockCurrentMusic() {
if (!currentImage || !currentTrack) return;
if (!lockedTracks[currentImage]) lockedTracks[currentImage] = [];
if (!lockedTracks[currentImage].includes(currentTrack)) {
lockedTracks[currentImage].push(currentTrack);
musicLockCounts[currentTrack] = (musicLockCounts[currentTrack] || 0) + 1;
showToast(`Đã khoá nhạc cho tranh này!`);
updateLockStatusDisplay(currentImage);
} else {
showToast(`Nhạc này đã được khoá trước đó.`);
}
}

// --- Fullscreen, Zoom & Pan ---
function applyImageTransform() {
const transformString = `translate3d(${pan.x}px, ${pan.y}px, 0) scale(${scale})`;
slideshowImage.style.transform = transformString;
}

function resetImageTransform() {
scale = 1;
pan = { x: 0, y: 0 };
slideshowImage.style.transform = 'translate3d(0, 0, 0) scale(1)';
}

function toggleFullscreen() { if (!document.fullscreenElement) slideshow.requestFullscreen(); else document.exitFullscreen(); }

// --- Import / Export ---
function exportState() {
if (imageLinksTextarea.value.trim() === '') { alert('Không có dữ liệu để xuất!'); return; }
const state = {
imageLinks: imageLinksTextarea.value,
musicLinks: musicLinksTextarea.value,
imageDescriptions: descriptionTextarea.value,
artistImageLinks: artistImageLinksTextarea.value,
artistDescriptions: artistDescriptionsTextarea.value,
lockedTracks: lockedTracks,
playlists: playlists,
aiDescriptions: aiDescriptions,
uiSettings: uiSettings
};
const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state, null, 2));
const a = document.createElement('a');
a.href = dataStr;
a.download = `trangthai-trienlam-${new Date().toISOString().slice(0,10)}.json`;
a.click();
showToast("Đã xuất dữ liệu và giao diện thành công!");
}

function processImportedData(state) {
try {
imageLinksTextarea.value = state.imageLinks || '';
musicLinksTextarea.value = state.musicLinks || '';
descriptionTextarea.value = state.imageDescriptions || '';
artistImageLinksTextarea.value = state.artistImageLinks || '';
artistDescriptionsTextarea.value = state.artistDescriptions || '';
lockedTracks = state.lockedTracks || {};
playlists = state.playlists || {};
aiDescriptions = state.aiDescriptions || {};

if (state.uiSettings) {
const defaultSettings = {
titleFont: "'Playfair Display', serif", titleFontSize: "1.8rem",
titleLongFontSize: "1.4rem", titleLengthThreshold: 50,
artistFont: "'Montserrat', sans-serif", artistFontSize: "1.1rem",
firstLetterSize: "4.5em",
frameUrl: '', framePadding: 30,
titleBrightness: 1, softEdge: 0,
headerSpacing: 0.3, descLineHeight: 1.8
};
const combinedSettings = { ...defaultSettings, ...uiSettings, ...state.uiSettings };
applyUiSettings(combinedSettings);
}
return true;
} catch (error) {
console.error("Lỗi xử lý dữ liệu:", error);
return false;
}
}
function importState(event) {
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = function(e) {
try {
const state = JSON.parse(e.target.result);
if (processImportedData(state)) {
showToast("Đã nhập dữ liệu thành công!");
} else {
throw new Error("Dữ liệu không hợp lệ.");
}
} catch (error) {
alert("Lỗi khi đọc tệp tin: " + error.message);
}
};
reader.readAsText(file);
importFileInput.value = '';
}

function exportPlaylist(playlistName) {
if (!playlists[playlistName]) {
alert("Không tìm thấy bộ sưu tập!");
return;
}
const playlistData = playlists[playlistName];
const imagesInPlaylist = playlistData.map(item => item.image);
const filteredLockedTracks = {};
Object.keys(lockedTracks).forEach(image => {
if (imagesInPlaylist.includes(image)) {
filteredLockedTracks[image] = lockedTracks[image];
}
});
const state = {
imageLinks: imagesInPlaylist.join('\n'),
lockedTracks: filteredLockedTracks,
playlists: { [playlistName]: playlistData },
musicLinks: musicLinksTextarea.value,
imageDescriptions: descriptionTextarea.value,
artistImageLinks: artistImageLinksTextarea.value,
artistDescriptions: artistDescriptionsTextarea.value,
aiDescriptions: aiDescriptions, // also export AI descriptions
uiSettings: uiSettings
};
const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state, null, 2));
const a = document.createElement('a');
a.href = dataStr;
a.download = `bosuutap-${playlistName.replace(/\s/g, '_')}-${new Date().toISOString().slice(0,10)}.json`;
a.click();
showToast(`Đã xuất bộ sưu tập "${playlistName}" thành công!`);
}


// --- Event Listeners ---
startButton.addEventListener('click', startSlideshow);
stopButton.addEventListener('click', stopSlideshow);
function triggerChangeContent() {
if (!isImageLocked && !currentPlaylist) randomClickCount++;
changeContent(!isImageLocked);
}
changeButton.addEventListener('click', triggerChangeContent);

lockImageButton.addEventListener('click', toggleImageLock);
lockMusicButton.addEventListener('click', lockCurrentMusic);
fullscreenButton.addEventListener('click', toggleFullscreen);
playPauseBtn.addEventListener('click', () => {
if (currentMusicSource === 'soundcloud' && soundcloudWidget) soundcloudWidget.toggle();
else if (currentMusicSource === 'youtube' && youtubePlayer?.getPlayerState) {
const state = youtubePlayer.getPlayerState();
if (state === YT.PlayerState.PLAYING) youtubePlayer.pauseVideo(); else youtubePlayer.playVideo();
}
});
exportMainButton.addEventListener('click', exportState);
exportUiButton.addEventListener('click', exportState);
importFileInput.addEventListener('change', importState);

document.addEventListener('mousemove', (e) => {
if (arePanelsPinned) return;

if (e.clientX < 40 && leftPanelWrapper.classList.contains('collapsed')) {
leftPanelWrapper.classList.remove('collapsed');
}
if (!rightPanelWrapper.classList.contains('collapsed') && e.clientX < window.innerWidth - rightPanelWrapper.offsetWidth - 20) {
rightPanelWrapper.classList.add('collapsed');
}
});
leftPanelWrapper.addEventListener('mouseleave', () => {
if (arePanelsPinned) return;
if (!leftPanelWrapper.querySelector('.side-panel.visible')) {
leftPanelWrapper.classList.add('collapsed');
}
});

function togglePanel(panelId, forceShow = null) {
const targetPanel = document.getElementById(panelId);
if (!targetPanel) return;
const isCurrentlyVisible = targetPanel.classList.contains('visible');

if (forceShow === false || (isCurrentlyVisible && forceShow !== true)) {
targetPanel.classList.remove('visible');
const anyVisible = leftPanelWrapper.querySelector('.side-panel.visible');
if (!anyVisible && !arePanelsPinned) {
setTimeout(() => leftPanelWrapper.classList.add('collapsed'), 100);
}
} else if (forceShow === true || !isCurrentlyVisible) {
document.querySelectorAll('.side-panel.visible').forEach(p => {
if(p.id !== panelId) p.classList.remove('visible');
});
targetPanel.classList.add('visible');
leftPanelWrapper.classList.remove('collapsed');
if (panelId === 'data-panel') updateDataPanel();
if (panelId === 'playlist-manager-panel') renderPlaylistManager();
}
}
leftPanelIconButtons.forEach(btn => {
btn.addEventListener('click', (e) => {
e.stopPropagation();
togglePanel(btn.dataset.panelId);
});
});
document.querySelectorAll('.close-panel-btn').forEach(btn => {
btn.addEventListener('click', () => togglePanel(btn.dataset.panelId, false));
});


createPlaylistBtn.addEventListener('click', () => {
const name = playlistNameInput.value.trim();
if (name && !playlists[name]) {
playlists[name] = [];
playlistNameInput.value = '';
renderPlaylistManager();
showToast(`Đã tạo bộ sưu tập "${name}"!`);
} else if (playlists[name]) showToast("Bộ sưu tập đã tồn tại!");
});

exitPlaylistModeBtn.addEventListener('click', () => { stopPlaylistMode(); showToast("Đã thoát chế độ bộ sưu tập."); });
selectImageGridBtn.addEventListener('click', openImageGrid);
closeGridBtn.addEventListener('click', closeImageGrid);
imageGridContainer.addEventListener('click', (e) => {
const item = e.target.closest('.grid-item');
if (item) {
closeImageGrid();
changeContent(true, item.dataset.src);
}
});
allMusicList.addEventListener('click', (e) => {
const li = e.target.closest('li');
if(li && li.dataset.track) {
    currentTrack = li.dataset.track;
    fadeMusicVolume(0, 1000, () => loadAndPlayTrack(currentTrack, true));
}
});

slideshowImage.addEventListener('mousedown', (e) => {
if (e.button !== 0) return;
e.preventDefault();
slideshowImage.dataset.dragStartX = e.clientX;
slideshowImage.dataset.dragStartY = e.clientY;
if (scale > 1) {
isPanning = true;
startPan = { x: e.clientX - pan.x, y: e.clientY - pan.y };
}
});
slideshowImage.addEventListener('click', (e) => {
const startX = parseFloat(slideshowImage.dataset.dragStartX);
const startY = parseFloat(slideshowImage.dataset.dragStartY);
const distance = Math.hypot(e.clientX - startX, e.clientY - startY);
if (distance < 5 && scale === 1) {
triggerChangeContent();
}
});
artworkWrapper.addEventListener('wheel', (e) => {
e.preventDefault();
const scaleAmount = 0.1;
scale -= e.deltaY * (scaleAmount / 100);
scale = Math.min(Math.max(1, scale), 5);
if (scale === 1) { resetImageTransform(); }
else { applyImageTransform(); }
});

window.addEventListener('mouseup', (e) => { if (e.button === 0) isPanning = false; });
window.addEventListener('mousemove', (e) => {
if (!isPanning) return;
e.preventDefault();
pan.x = e.clientX - startPan.x;
pan.y = e.clientY - startPan.y;
applyImageTransform();
});
panelToggleBtn.addEventListener('click', () => {
if (arePanelsPinned) {
pinPanelsToggle.click();
}
rightPanelWrapper.classList.toggle('collapsed');
});
document.addEventListener('mousemove', (e) => {
if (arePanelsPinned) return;
if (rightPanelWrapper.classList.contains('collapsed') && e.clientX > window.innerWidth - 10) {
rightPanelWrapper.classList.remove('collapsed');
}
});
rightPanelWrapper.addEventListener('mouseleave', () => {
if (arePanelsPinned) return;
rightPanelWrapper.classList.add('collapsed');
});

autoRandomToggle.addEventListener('click', () => {
isAutoRandomEnabled = !isAutoRandomEnabled;
autoRandomToggle.classList.toggle('active', isAutoRandomEnabled);
showToast(`Tự động chuyển tiếp: ${isAutoRandomEnabled ? 'Bật' : 'Tắt'}`);
});
overrideLockToggle.addEventListener('click', () => {
isLockOverrideEnabled = !isLockOverrideEnabled;
overrideLockToggle.classList.toggle('active', isLockOverrideEnabled);
showToast(`Bỏ qua nhạc khoá: ${isLockOverrideEnabled ? 'Bật' : 'Tắt'}`);
});
sequentialMusicToggle.addEventListener('click', () => {
isSequentialMusicEnabled = !isSequentialMusicEnabled;
sequentialMusicToggle.classList.toggle('active', isSequentialMusicEnabled);
showToast(`Phát nhạc tuần tự: ${isSequentialMusicEnabled ? 'Bật' : 'Tắt'}`);
if (isSequentialMusicEnabled) { lockedMusicIndices = {}; globalSequentialMusicIndex = 0; }
});
backButton.addEventListener('click', () => {
if (previousState.image) {
const tempState = { image: currentImage, track: currentTrack };
currentImage = previousState.image;
currentTrack = previousState.track;
previousState = tempState;
changeContent(false, currentImage, true);
showToast("Đã quay lại phiên trước.");
} else {
showToast("Không có lịch sử để quay lại.");
}
});

document.addEventListener('keydown', (event) => {
if (['INPUT', 'TEXTAREA', 'SELECT'].includes(event.target.tagName)) return;

if (slideshow.style.display !== 'flex') return;
const key = event.key.toLowerCase();

switch (key) {
case 'f': event.preventDefault(); toggleFullscreen(); break;
case 'r': event.preventDefault(); triggerChangeContent(); break;
case 'p': event.preventDefault(); toggleImageLock(); break;
case 'm': event.preventDefault(); lockCurrentMusic(); break;
case 's':
event.preventDefault();
const playlistNames = Object.keys(playlists);
const targetPlaylist = lastUsedPlaylist || (playlistNames.length > 0 ? playlistNames[playlistNames.length - 1] : null);
if (targetPlaylist) {
addToPlaylist(targetPlaylist);
} else {
showToast("Chưa có bộ sưu tập nào để lưu vào.");
}
break;
case 'l':
event.preventDefault();
const musicPanel = document.getElementById('music-selection-panel');
const isVisible = musicPanel.classList.contains('visible');
togglePanel('music-selection-panel', !isVisible);
break;
}
});


pinPanelsToggle.addEventListener('click', () => {
arePanelsPinned = !arePanelsPinned;
pinPanelsToggle.classList.toggle('active', arePanelsPinned);
if (arePanelsPinned) {
leftPanelWrapper.classList.remove('collapsed');
rightPanelWrapper.classList.remove('collapsed');
}
showToast(`Ghim bảng điều khiển: ${arePanelsPinned ? 'Bật' : 'Tắt'}`);
});

function setupSettingsPanel() {
const root = document.documentElement;
const controls = {
titleFontSelect: document.getElementById('title-font-select'),
titleFontSizeSlider: document.getElementById('title-font-size-slider'),
titleFontSizeValue: document.getElementById('title-font-size-value'),
titleLongFontSizeSlider: document.getElementById('title-long-font-size-slider'),
titleLongFontSizeValue: document.getElementById('title-long-font-size-value'),
titleLengthThreshold: document.getElementById('title-length-threshold'),
artistFontSelect: document.getElementById('artist-font-select'),
artistFontSizeSlider: document.getElementById('artist-font-size-slider'),
artistFontSizeValue: document.getElementById('artist-font-size-value'),
firstLetterSizeSlider: document.getElementById('first-letter-size-slider'),
firstLetterSizeValue: document.getElementById('first-letter-size-value'),
frameUrlInput: document.getElementById('frame-url-input'),
framePaddingSlider: document.getElementById('frame-padding-slider'),
framePaddingValue: document.getElementById('frame-padding-value'),
wallTextureUrl: document.getElementById('wall-texture-url'), descFontSelect: document.getElementById('desc-font-select'),
descFontSizeSlider: document.getElementById('desc-font-size-slider'), descFontSizeValue: document.getElementById('desc-font-size-value'),
descTextColor: document.getElementById('desc-text-color'),
shadowX: document.getElementById('shadow-x-slider'), shadowY: document.getElementById('shadow-y-slider'),
shadowBlur: document.getElementById('shadow-blur-slider'), shadowSpread: document.getElementById('shadow-spread-slider'),
shadowColor: document.getElementById('shadow-color'),
shadowXValue: document.getElementById('shadow-x-value'), shadowYValue: document.getElementById('shadow-y-value'),
shadowBlurValue: document.getElementById('shadow-blur-value'), shadowSpreadValue: document.getElementById('shadow-spread-value'),
titleColorBrightnessSlider: document.getElementById('title-color-brightness-slider'),
titleColorBrightnessValue: document.getElementById('title-color-brightness-value'),
softEdgeSlider: document.getElementById('soft-edge-slider'),
softEdgeValue: document.getElementById('soft-edge-value'),
headerSpacingSlider: document.getElementById('header-spacing-slider'),
headerSpacingValue: document.getElementById('header-spacing-value'),
descLineHeightSlider: document.getElementById('desc-line-height-slider'),
descLineHeightValue: document.getElementById('desc-line-height-value'),
};

const updateUiSetting = (key, value, cssPropOrVar = null, target = root.style, transformFn = null) => {
    const keys = key.split('.');
    if (keys.length > 1) {
        if (!uiSettings[keys[0]]) uiSettings[keys[0]] = {};
        uiSettings[keys[0]][keys[1]] = value;
    } else {
        uiSettings[key] = value;
    }

    if (cssPropOrVar) {
        const finalValue = transformFn ? transformFn(value) : value;
        if (cssPropOrVar.startsWith('--')) {
            target.setProperty(cssPropOrVar, finalValue);
        } else {
            target[cssPropOrVar] = finalValue;
        }
    }
};

const applyFrameShadow = () => {
const s = uiSettings.shadow;
const shadowValue = `${s.x}px ${s.y}px ${s.blur}px ${s.spread}px ${s.color}`;
frameImage.style.boxShadow = shadowValue;
};

controls.titleFontSelect.addEventListener('change', (e) => {
updateUiSetting('titleFont', e.target.value, '--artwork-title-font');
});
controls.titleFontSizeSlider.addEventListener('input', (e) => { const size = `${e.target.value}rem`; controls.titleFontSizeValue.textContent = size; updateUiSetting('titleFontSize', size); updateArtworkDetails(currentImage); });
controls.titleLongFontSizeSlider.addEventListener('input', (e) => { const size = `${e.target.value}rem`; controls.titleLongFontSizeValue.textContent = size; updateUiSetting('titleLongFontSize', size); updateArtworkDetails(currentImage); });
controls.titleLengthThreshold.addEventListener('change', (e) => { updateUiSetting('titleLengthThreshold', parseInt(e.target.value, 10)); updateArtworkDetails(currentImage); });

controls.titleColorBrightnessSlider.addEventListener('input', (e) => {
    const brightness = parseInt(e.target.value, 10);
    controls.titleColorBrightnessValue.textContent = `${brightness}%`;
    const brightnessValue = brightness / 100;
    updateUiSetting('titleBrightness', brightnessValue);
    applyFinalColor(); 
});

controls.softEdgeSlider.addEventListener('input', (e) => {
const size = parseInt(e.target.value, 10);
controls.softEdgeValue.textContent = `${size}px`;
updateUiSetting('softEdge', size, '--soft-edge-size', root.style, val => `${val}px`);
});

controls.headerSpacingSlider.addEventListener('input', (e) => {
const spacing = `${e.target.value}em`;
controls.headerSpacingValue.textContent = spacing;
updateUiSetting('headerSpacing', parseFloat(e.target.value), '--header-spacing', root.style, val => `${val}em`);
});
controls.descLineHeightSlider.addEventListener('input', (e) => {
const height = e.target.value;
controls.descLineHeightValue.textContent = height;
updateUiSetting('descLineHeight', parseFloat(height), '--desc-line-height');
});


controls.artistFontSelect.addEventListener('change', (e) => updateUiSetting('artistFont', e.target.value, '--artwork-artist-font'));
controls.artistFontSizeSlider.addEventListener('input', (e) => { const size = `${e.target.value}rem`; controls.artistFontSizeValue.textContent = size; updateUiSetting('artistFontSize', size, '--artwork-artist-size'); });
controls.firstLetterSizeSlider.addEventListener('input', (e) => { const size = `${e.target.value}em`; controls.firstLetterSizeValue.textContent = size; updateUiSetting('firstLetterSize', size, '--first-letter-size'); });

controls.frameUrlInput.addEventListener('change', (e) => { updateUiSetting('frameUrl', e.target.value); updateDisplay(currentImage); });
controls.framePaddingSlider.addEventListener('input', (e) => {
const padding = parseInt(e.target.value, 10);
controls.framePaddingValue.textContent = `${padding}px`;
updateUiSetting('framePadding', padding);
updateDisplay(currentImage);
});

controls.wallTextureUrl.addEventListener('change', (e) => updateUiSetting('wallTexture', e.target.value.trim(), '--wall-texture', root.style, val => val ? `url('${val}')` : 'none'));

controls.descFontSelect.addEventListener('change', (e) => updateUiSetting('descFont', e.target.value, '--artwork-desc-font'));
controls.descFontSizeSlider.addEventListener('input', (e) => { const size = `${e.target.value}px`; controls.descFontSizeValue.textContent = size; updateUiSetting('descFontSize', size, '--artwork-desc-size'); });
controls.descTextColor.addEventListener('input', (e) => updateUiSetting('descTextColor', e.target.value, '--color-desc-text'));

['X', 'Y', 'Blur', 'Spread'].forEach(prop => {
const key = prop.toLowerCase();
controls[`shadow${prop}`].addEventListener('input', (e) => {
updateUiSetting(`shadow.${key}`, e.target.value);
controls[`shadow${prop}Value`].textContent = `${e.target.value}px`;
applyFrameShadow();
});
});
controls.shadowColor.addEventListener('input', (e) => {
updateUiSetting('shadow.color', e.target.value);
applyFrameShadow();
});
}

function applyUiSettings(settings) {
uiSettings = {...uiSettings, ...settings};
const root = document.documentElement;

root.style.setProperty('--wall-texture', uiSettings.wallTexture ? `url('${uiSettings.wallTexture}')` : 'none');
root.style.setProperty('--artwork-title-font', uiSettings.titleFont);
root.style.setProperty('--artwork-title-size', uiSettings.titleFontSize);
root.style.setProperty('--artwork-artist-font', uiSettings.artistFont);
root.style.setProperty('--artwork-artist-size', uiSettings.artistFontSize);
root.style.setProperty('--first-letter-size', uiSettings.firstLetterSize);
applyFinalColor();
root.style.setProperty('--soft-edge-size', `${uiSettings.softEdge}px`);
root.style.setProperty('--header-spacing', `${uiSettings.headerSpacing}em`);
root.style.setProperty('--desc-line-height', uiSettings.descLineHeight);
root.style.setProperty('--artwork-desc-font', uiSettings.descFont);
root.style.setProperty('--artwork-desc-size', uiSettings.descFontSize);
root.style.setProperty('--color-desc-text', uiSettings.descTextColor);


const s = uiSettings.shadow;
const shadowValue = `${s.x}px ${s.y}px ${s.blur}px ${s.spread}px ${s.color}`;
frameImage.style.boxShadow = shadowValue;

document.getElementById('title-font-select').value = uiSettings.titleFont;
document.getElementById('title-font-size-slider').value = parseFloat(uiSettings.titleFontSize); document.getElementById('title-font-size-value').textContent = uiSettings.titleFontSize;
document.getElementById('title-long-font-size-slider').value = parseFloat(uiSettings.titleLongFontSize); document.getElementById('title-long-font-size-value').textContent = uiSettings.titleLongFontSize;
document.getElementById('title-length-threshold').value = uiSettings.titleLengthThreshold;
document.getElementById('artist-font-select').value = uiSettings.artistFont;
document.getElementById('artist-font-size-slider').value = parseFloat(uiSettings.artistFontSize); document.getElementById('artist-font-size-value').textContent = uiSettings.artistFontSize;
document.getElementById('first-letter-size-slider').value = parseFloat(uiSettings.firstLetterSize); document.getElementById('first-letter-size-value').textContent = uiSettings.firstLetterSize;
document.getElementById('wall-texture-url').value = uiSettings.wallTexture;
document.getElementById('desc-font-select').value = uiSettings.descFont;
document.getElementById('desc-font-size-slider').value = parseInt(uiSettings.descFontSize); document.getElementById('desc-font-size-value').textContent = uiSettings.descFontSize;
document.getElementById('desc-text-color').value = uiSettings.descTextColor;
document.getElementById('frame-url-input').value = uiSettings.frameUrl;
document.getElementById('frame-padding-slider').value = uiSettings.framePadding; document.getElementById('frame-padding-value').textContent = `${uiSettings.framePadding}px`;
document.getElementById('shadow-x-slider').value = s.x; document.getElementById('shadow-x-value').textContent = `${s.x}px`;
document.getElementById('shadow-y-slider').value = s.y; document.getElementById('shadow-y-value').textContent = `${s.y}px`;
document.getElementById('shadow-blur-slider').value = s.blur; document.getElementById('shadow-blur-value').textContent = `${s.blur}px`;
document.getElementById('shadow-spread-slider').value = s.spread; document.getElementById('shadow-spread-value').textContent = `${s.spread}px`;
document.getElementById('shadow-color').value = s.color;
document.getElementById('title-color-brightness-slider').value = uiSettings.titleBrightness * 100;
document.getElementById('title-color-brightness-value').textContent = `${Math.round(uiSettings.titleBrightness * 100)}%`;
document.getElementById('soft-edge-slider').value = uiSettings.softEdge;
document.getElementById('soft-edge-value').textContent = `${uiSettings.softEdge}px`;
document.getElementById('header-spacing-slider').value = uiSettings.headerSpacing;
document.getElementById('header-spacing-value').textContent = `${uiSettings.headerSpacing}em`;
document.getElementById('desc-line-height-slider').value = uiSettings.descLineHeight;
document.getElementById('desc-line-height-value').textContent = uiSettings.descLineHeight;
}
setupSettingsPanel();

// --- Hàm lấy màu chủ đạo & Đồng bộ màu ---
function parseColor(colorStr) {
    if (colorStr.startsWith('rgb')) {
        const [r, g, b] = colorStr.match(/\d+/g).map(Number);
        return { r, g, b };
    } else if (colorStr.startsWith('#')) {
        let hex = colorStr.slice(1);
        if (hex.length === 3) {
            hex = hex.split('').map(c => c + c).join('');
        }
        const bigint = parseInt(hex, 16);
        return {
            r: (bigint >> 16) & 255,
            g: (bigint >> 8) & 255,
            b: bigint & 255
        };
    }
    return { r: 197, g: 165, b: 106 }; // fallback
}

function applyFinalColor() {
    const root = document.documentElement;
    const baseColorStr = getComputedStyle(root).getPropertyValue('--dynamic-artwork-color').trim();
    const baseColor = parseColor(baseColorStr);
    const factor = uiSettings.titleBrightness;

    const finalColor = {
        r: Math.round(Math.min(255, baseColor.r * factor)),
        g: Math.round(Math.min(255, baseColor.g * factor)),
        b: Math.round(Math.min(255, baseColor.b * factor))
    };

    root.style.setProperty('--final-dynamic-color', `rgb(${finalColor.r}, ${finalColor.g}, ${finalColor.b})`);
}

function getDominantColor(imgEl) {
try {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const w = canvas.width = imgEl.naturalWidth;
const h = canvas.height = imgEl.naturalHeight;
ctx.drawImage(imgEl, 0, 0, w, h);
const data = ctx.getImageData(0, 0, w, h).data;
const colorCounts = {};
let maxCount = 0;
let dominantColor = { r: 197, g: 165, b: 106 };
for (let i = 0; i < data.length; i += 8) {
const r = data[i], g = data[i+1], b = data[i+2];
if ((r > 240 && g > 240 && b > 240) || (r < 15 && g < 15 && b < 15)) continue;
const rgbKey = `${r},${g},${b}`;
colorCounts[rgbKey] = (colorCounts[rgbKey] || 0) + 1;
if (colorCounts[rgbKey] > maxCount) {
maxCount = colorCounts[rgbKey];
dominantColor = { r, g, b };
}
}
let finalR = dominantColor.r, finalG = dominantColor.g, finalB = dominantColor.b;
let luminance = (0.299 * finalR + 0.587 * finalG + 0.114 * finalB) / 255;
if (luminance < 0.3) {
const [h, s, l] = rgbToHsl(finalR, finalG, finalB);
const newL = Math.min(l + 0.35, 1.0);
[finalR, finalG, finalB] = hslToRgb(h, s, newL);
}
let finalLuminance = (0.299 * finalR + 0.587 * finalG + 0.114 * finalB) / 255;
const dynamicColor = `rgb(${finalR}, ${finalG}, ${finalB})`;

if (finalLuminance < 0.4) {
document.documentElement.style.setProperty('--dynamic-artwork-color', '#FFFFFF');
} else {
document.documentElement.style.setProperty('--dynamic-artwork-color', dynamicColor);
}
applyFinalColor();

} catch (e) {
console.warn("Không thể xử lý màu của ảnh (lỗi CORS):", e);
document.documentElement.style.setProperty('--dynamic-artwork-color', 'var(--color-accent-hover)');
applyFinalColor();
}
}
function rgbToHsl(r, g, b) { r /= 255; g /= 255; b /= 255; const max = Math.max(r, g, b), min = Math.min(r, g, b); let h, s, l = (max + min) / 2; if (max === min) { h = s = 0; } else { const d = max - min; s = l > 0.5 ? d / (2 - max - min) : d / (max + min); switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h /= 6; } return [h, s, l]; }
function hslToRgb(h, s, l) { let r, g, b; if (s === 0) { r = g = b = l; } else { const hue2rgb = (p, q, t) => { if (t < 0) t += 1; if (t > 1) t -= 1; if (t < 1/6) return p + (q - p) * 6 * t; if (t < 1/2) return q; if (t < 2/3) return p + (q - p) * (2/3 - t) * 6; return p; }; const q = l < 0.5 ? l * (1 + s) : l + s - l * s; const p = 2 * l - q; r = hue2rgb(p, q, h + 1/3); g = hue2rgb(p, q, h); b = hue2rgb(p, q, h - 1/3); } return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)]; }

// --- Logic chỉnh sửa ---
editModeToggle.addEventListener('click', () => {
isEditMode = !isEditMode;
document.body.classList.toggle('edit-mode-active', isEditMode);
editModeToggle.classList.toggle('active', isEditMode);
showToast(`Chế độ chỉnh sửa: ${isEditMode ? 'Bật' : 'Tắt'}`);
updateArtworkDetails(currentImage);
});

descriptionContainer.addEventListener('click', (e) => {
    if (e.target.classList.contains('edit-control')) {
        const field = e.target.dataset.field;
        updateArtworkDetails(currentImage, field);
    }
});

function saveEdit(field, inputElement) {
    if (!inputElement) return;
    const newValue = inputElement.value.trim();
    const number = extractImageNumber(currentImage);
    if (imageDescriptions[number]) {
        // When editing, we assume user is editing the currently displayed version
        const aiData = aiDescriptions[currentImage];
        if (aiData && aiData.displayIndex > -1) {
            // It's an AI description
            aiData.saved[aiData.displayIndex] = newValue;
        } else if (field === 'description') {
            // It's the original description
             imageDescriptions[number][field] = newValue;
        } else {
            // Title or Artist
             imageDescriptions[number][field] = newValue;
        }
    }
    updateDescriptionTextarea();
    updateArtworkDetails(currentImage);
}
function updateDescriptionTextarea() {
const lines = Object.entries(imageDescriptions).map(([number, data]) => {
return `${number} - ${data.title} - ${data.artist}. ${data.description}`;
});
descriptionTextarea.value = lines.join('\n\n');
}
deleteCurrentComboBtn.addEventListener('click', () => {
if (!currentImage || !confirm(`BẠN CÓ CHẮC MUỐN XÓA VĨNH VIỄN tranh "${getImageNameFromUrl(currentImage)}"? Hành động này không thể hoàn tác.`)) return;
const imgIndex = imageLinks.indexOf(currentImage);
if (imgIndex > -1) imageLinks.splice(imgIndex, 1);
imageLinksTextarea.value = imageLinks.join('\n');
sessionImagePool = sessionImagePool.filter(link => link !== currentImage);
const number = extractImageNumber(currentImage);
if (number && imageDescriptions[number]) {
delete imageDescriptions[number];
updateDescriptionTextarea();
}
if (aiDescriptions[currentImage]) {
    delete aiDescriptions[currentImage];
}
Object.keys(playlists).forEach(name => {
playlists[name] = playlists[name].filter(item => item.image !== currentImage);
});
showToast("Đã xóa phiên thành công!");
triggerChangeContent();
});

// LOGIC CHẾ ĐỘ HƯỚNG DẪN
tutorialToggleBtn.addEventListener('click', () => {
isTutorialMode = !isTutorialMode;
document.body.classList.toggle('tutorial-mode-active', isTutorialMode);
tutorialToggleBtn.classList.toggle('active', isTutorialMode);
showToast(`Chế độ hướng dẫn: ${isTutorialMode ? 'Bật' : 'Tắt'}`);
});
document.addEventListener('mouseover', (e) => {
if (!isTutorialMode) return;
const target = e.target.closest('[data-help]');
if (target) {
clearTimeout(tooltipHideTimer);
const helpText = target.getAttribute('data-help');
const rect = target.getBoundingClientRect();
tutorialTooltip.textContent = helpText;
const top = rect.bottom + 8;
const left = rect.left + (rect.width / 2) - (tutorialTooltip.offsetWidth / 2);
tutorialTooltip.style.top = `${top}px`;
tutorialTooltip.style.left = `${Math.max(5, left)}px`;
tutorialTooltip.classList.add('visible');
}
});
document.addEventListener('mouseout', (e) => {
if (!isTutorialMode) return;
const target = e.target.closest('[data-help]');
if (target) {
tooltipHideTimer = setTimeout(() => {
tutorialTooltip.classList.remove('visible');
}, 5000);
}
});

// --- Các hàm phức tạp ---
async function renderPlaylistManager() {playlistsList.innerHTML = ''; const sortedNames = Object.keys(playlists).sort(); if (sortedNames.length === 0) { playlistsList.innerHTML = '<li>Chưa có bộ sưu tập nào.</li>'; return; } for (const name of sortedNames) { const items = playlists[name]; const li = document.createElement('li'); let contentHtml = ''; if (items.length > 0) { for(const item of items) { const imageName = getImageNameFromUrl(item.image); let songsHtml = 'Chưa có nhạc khóa'; if (item.lockedMusic && item.lockedMusic.length > 0) { songsHtml = '<ul class="songs">'; for (const song of item.lockedMusic) { const songInfo = await getTrackInfo(song); songsHtml += `<li title="${songInfo.name}">🎵 ${songInfo.name}</li>`; } songsHtml += '</ul>'; } contentHtml += `<div class="playlist-content-item"><img src="${item.image}" alt="thumbnail"><div class="item-details"><div class="item-name" title="${imageName}">${imageName}</div>${songsHtml}</div><button class="playlist-item-delete-btn" data-playlist-name="${name}" data-image-src="${item.image}" title="Xóa tranh này khỏi bộ sưu tập">❌</button></div>`; } } else { contentHtml = '<p style="font-size:12px; font-style:italic; margin-top: 10px;">Bộ sưu tập này trống.</p>'; } li.innerHTML = `<div class="playlist-header" data-name="${name}"><span>${name}</span><span class="playlist-item-count">${items.length} mục</span></div><div class="playlist-content">${contentHtml}</div><div class="playlist-controls"><button class="playlist-start-btn action-button" data-name="${name}">Trình chiếu</button><button class="playlist-add-btn action-button" data-name="${name}">Thêm Tranh</button><button class="playlist-export-btn action-button" data-name="${name}">Xuất</button><button class="playlist-delete-btn action-button" data-name="${name}">Xoá</button></div>`; playlistsList.appendChild(li); }}
function addToPlaylist(name) {
if (!currentImage) {
showToast("Không có tranh nào để thêm!");
return;
}
if (!playlists[name]) return;
lastUsedPlaylist = name;

const currentLocks = lockedTracks[currentImage] ? [...lockedTracks[currentImage]] : [];
const existingItemIndex = playlists[name].findIndex(item => item.image === currentImage);

if (existingItemIndex > -1) {
playlists[name][existingItemIndex].lockedMusic = currentLocks;
showToast(`Đã cập nhật nhạc khoá cho tranh trong bộ sưu tập "${name}".`);
} else {
playlists[name].push({ image: currentImage, lockedMusic: currentLocks });
showToast(`Đã thêm vào bộ sưu tập "${name}"!`);
}
renderPlaylistManager();
}
function startPlaylist(name) { if (!playlists[name] || playlists[name].length === 0) { showToast(`Bộ sưu tập "${name}" rỗng!`); return; } currentPlaylist = name; playlistOriginalItems = playlists[name]; playlistImagePool = [...playlistOriginalItems]; togglePanel('playlist-manager-panel', false); playlistModeStatus.style.display = 'block'; playlistModeStatus.querySelector('span').textContent = `Bộ sưu tập: ${name}`; changeContent(true); }
function stopPlaylistMode() { currentPlaylist = null; playlistModeStatus.style.display = 'none'; }
function initializeMusicLockCounts() { musicLockCounts = {}; musicLinks.forEach(link => { musicLockCounts[link] = 0; }); Object.values(lockedTracks).forEach(trackArray => { trackArray.forEach(trackUrl => { if (musicLockCounts.hasOwnProperty(trackUrl)) musicLockCounts[trackUrl]++; }); }); }
async function updateDataPanel() { document.getElementById('random-count').innerHTML = `<strong>Số lần đổi mới:</strong> ${randomClickCount}`; document.getElementById('image-stats').innerHTML = `<strong>Tranh còn lại:</strong> ${sessionImagePool.length} / ${imageLinks.length}`; document.getElementById('music-total').innerHTML = `<strong>Tổng số nhạc:</strong> ${musicLinks.length}`; const promises = Object.entries(musicLockCounts).map(async ([url, count]) => { const info = await getTrackInfo(url); return { name: info.name, count: count }; }); const rankedMusic = (await Promise.all(promises)).sort((a, b) => b.count - a.count); const rankingsList = document.getElementById('music-rankings-list'); rankingsList.innerHTML = ''; if(rankedMusic.length > 0) { rankedMusic.forEach(track => { rankingsList.innerHTML += `<li><span class="rank-name" title="${track.name}">${track.name}</span> <span class="rank-count">${track.count} lần</span></li>`; }); } else { rankingsList.innerHTML = '<li>Chưa có dữ liệu.</li>'; } }
function showToast(message, type = 'info') { 
    toast.textContent = message;
    toast.className = "toast show"; 
    if (type === 'warning') toast.style.borderColor = 'var(--warning-color)';
    else if (type === 'error') toast.style.borderColor = 'var(--danger-color)';
    else toast.style.borderColor = 'var(--color-accent)';

    setTimeout(() => { 
        toast.className = toast.className.replace("show", ""); 
    }, 3000); 
}
function openImageGrid() { imageGridContainer.innerHTML = ''; imageLinks.forEach(link => { const gridItem = document.createElement('div'); gridItem.className = 'grid-item'; gridItem.dataset.src = link; gridItem.innerHTML = `<div class="grid-item-bg" style="background-image: url('${link}')"></div><img class="grid-item-main" src="${link}" loading="lazy" alt="grid image">`; imageGridContainer.appendChild(gridItem); }); imageGridOverlay.style.display = 'block'; }
function closeImageGrid() { imageGridOverlay.style.display = 'none'; }
playlistsList.addEventListener('click', (e) => { const target = e.target; const header = target.closest('.playlist-header'); const button = target.closest('button.action-button, button.playlist-item-delete-btn'); if (button) { const playlistName = button.dataset.name || button.dataset.playlistName; if (!playlistName) return; if (button.classList.contains('playlist-add-btn')) addToPlaylist(playlistName); else if (button.classList.contains('playlist-delete-btn')) { if (confirm(`Bạn có chắc muốn xoá TOÀN BỘ bộ sưu tập "${playlistName}" không?`)) { delete playlists[playlistName]; renderPlaylistManager(); showToast(`Đã xoá bộ sưu tập "${playlistName}"!`); } } else if (button.classList.contains('playlist-start-btn')) startPlaylist(playlistName); else if (button.classList.contains('playlist-export-btn')) { exportPlaylist(playlistName); } else if (button.classList.contains('playlist-item-delete-btn')) { const imageSrc = button.dataset.imageSrc; const playlist = playlists[playlistName]; const itemIndex = playlist.findIndex(item => item.image === imageSrc); if (itemIndex > -1) { playlist.splice(itemIndex, 1); showToast(`Đã xóa tranh khỏi bộ sưu tập "${playlistName}".`); renderPlaylistManager(); } } } else if (header) { const content = header.nextElementSibling; if (content && content.classList.contains('playlist-content')) { content.style.display = content.style.display === 'block' ? 'none' : 'block'; } } });
musicSearchInput.addEventListener('keyup', () => { const searchTerm = musicSearchInput.value.toLowerCase(); allMusicList.querySelectorAll('li').forEach(item => { item.style.display = item.textContent.toLowerCase().includes(searchTerm) ? '' : 'none'; }); });

async function handleSharedPlaylist() {
const params = new URLSearchParams(window.location.search);
const playlistUrl = params.get('playlist');

if (playlistUrl) {
try {
const response = await fetch(playlistUrl);
if (!response.ok) {
throw new Error(`Network response was not ok: ${response.statusText}`);
}
const data = await response.json();

if(processImportedData(data)) {
showToast("Đã tải bộ sưu tập được chia sẻ thành công!");
startSlideshow();
} else {
throw new Error("Dữ liệu trong tệp JSON không hợp lệ.");
}

} catch (error) {
console.error('Failed to load shared playlist:', error);
showToast("Đã xảy ra lỗi khi tải bộ sưu tập được chia sẻ. Vui lòng kiểm tra lại đường link.", 'error');
}
}
}

document.addEventListener('DOMContentLoaded', () => {
handleSharedPlaylist();
setupSettingsPanel();
initializeTTS();
initializeGemini();
});

</script>
</body>
</html>
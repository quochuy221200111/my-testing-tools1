
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr·ª£ l√Ω So·∫°n th·∫£o C√¢u l·ªánh AI (Pro - Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --button-bg: #e9ecef;
            --button-hover-bg: #ced4da;
            --accent-color: #007bff;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --font-size-base: 13px;
            --ai-panel-opacity: 0.98;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0 0 200px 0;
            font-size: var(--font-size-base);
            line-height: 1.4;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            box-sizing: border-box;
        }

        /* HEADER */
        .header-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 10px;
            padding-bottom: 5px;
            background: var(--surface-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tabs { display: flex; border-bottom: none; margin-bottom: 0; }
        .tab-button { padding: 8px 16px; cursor: pointer; border: none; background-color: transparent; font-size: 14px; font-weight: bold; color: #6c757d; border-bottom: 3px solid transparent; transition: color 0.2s; }
        .tab-button.active { color: var(--accent-color); border-bottom: 3px solid var(--accent-color); }
        #prompt-view-controls { display: flex; gap: 8px; padding-right: 10px; align-items: center; }
        .main-button { background-color: var(--button-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 6px 12px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s; white-space: nowrap; }
        .main-button:hover { background-color: var(--button-hover-bg); }
        .icon-btn { padding: 6px 8px; font-size: 14px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* SESSIONS LAYOUT */
        .sessions-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .session { border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--surface-color); padding: 10px; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 6px var(--shadow-color); flex: 1 1 calc(25% - 20px); min-width: 300px; max-width: 100%; position: relative; transition: border-color 0.2s; }
        .session.pinned { border-color: #a1d2ff; box-shadow: 0 0 5px rgba(0, 123, 255, 0.3); }
        .session.last-active { border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
        .session-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 5px; gap: 10px; }
        .session-title-input { font-size: 1.1em; font-weight: bold; color: var(--accent-color); border: 1px dashed transparent; background: transparent; flex-grow: 1; min-width: 0; padding: 2px 5px; }
        .session-title-input:focus { border-color: var(--accent-color); background: #fff; color: #000; }
        .copy-success-icon { display: none; color: #28a745; font-size: 1.2em; margin-right: 5px; animation: fadeInOut 1.5s forwards; }
        @keyframes fadeInOut { 0% { opacity: 0; transform: scale(0.5); } 20% { opacity: 1; transform: scale(1.2); } 80% { opacity: 1; transform: scale(1); } 100% { opacity: 0; } }
        .session-controls { display: flex; align-items: center; gap: 2px; }
        .session-controls button { font-size: 11px; padding: 4px 8px; margin-left: 2px; }
        .pin-session-btn.pinned { background-color: #ffc107; border-color: #ffc107; }
        
        /* ROWS PROMPT */
        .prompt-row { display: flex; flex-direction: column; margin-bottom: 5px; position: relative; }
        .prompt-row.collapsed .row-content { display: none; }
        .row-header { display: flex; align-items: center; font-weight: bold; font-size: 0.95em; margin-bottom: 2px; cursor: pointer; padding: 2px 0; user-select: none; }
        .row-header::before { content: '‚ñº'; margin-right: 5px; font-size: 0.7em; transition: transform 0.2s; color: #888; }
        .prompt-row.collapsed .row-header::before { transform: rotate(-90deg); }
        .row-controls { margin-left: auto; display: flex; align-items: center; gap: 8px; }
        .row-controls button, .row-controls label { background: none; border: none; cursor: pointer; font-size: 1.1em; color: #666; padding: 0 4px; display: flex; align-items: center; }
        .action-btn { font-size: 11px !important; padding: 2px 6px; background: #f0f0f0 !important; border-radius: 3px !important; border: 1px solid #ddd !important; white-space: nowrap; }
        .action-btn:hover { background: #e0e0e0 !important; }

        textarea, input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; background-color: #ffffff; font-family: inherit; font-size: var(--font-size-base); box-sizing: border-box; resize: vertical; min-height: 32px; transition: height 0.1s ease-out; }
        textarea:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus { outline: none; border-color: var(--accent-color); }
        .row-code textarea { max-height: 150px !important; min-height: 60px; overflow-y: scroll !important; font-family: "Consolas", "Monaco", "Courier New", monospace; background-color: #f1f3f5; font-size: 12px; white-space: pre; color: #333; }
        
        /* Suggestions Popup */
        .suggestions-popup { display: none; position: absolute; top: 25px; right: 0; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; z-index: 200; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.15); width: 320px; max-width: 90vw; font-size: 12px; }
        .suggestion-item { display: flex; align-items: center; margin-bottom: 5px; border-bottom: 1px dashed #eee; padding: 4px; cursor: grab; background-color: white; }
        .suggestion-item:active { cursor: grabbing; }
        .suggestion-item:hover { background-color: #f8f9fa; }
        .suggestion-item-text { flex-grow: 1; cursor: pointer; }
        
        /* Storage View Layout */
        .storage-view-container { display: flex; gap: 15px; height: calc(100vh - 60px); }
        .storage-column { flex: 1; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; background-color: var(--surface-color); display: flex; flex-direction: column; min-width: 0; max-height: 100%; }
        .storage-column h3 { margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .storage-column-content { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .storage-item { border: 1px solid #eee; border-radius: 4px; padding: 8px; margin-bottom: 8px; background: #fdfdfd; }
        .item-header-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .item-name-input { flex: 1; font-weight: bold; border: none; border-bottom: 1px dashed #ccc; background: transparent; padding: 2px; font-size: 0.95em; }
        .item-time { font-size: 10px; color: #888; margin-right: 5px; white-space: nowrap; }
        .btn-sm { padding: 2px 6px; font-size: 11px; background: #eee; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; }
        .btn-delete { color: #dc3545; }
        .btn-download { color: var(--accent-color); }
        .history-content { font-size: 11px; color: #555; max-height: 60px; overflow: hidden; text-overflow: ellipsis; white-space: pre-wrap; cursor: pointer; background: #f1f1f1; padding: 4px; border-radius: 3px; font-family: monospace; }
        .history-content.expanded { max-height: 300px; overflow-y: auto; }
        .note-content-area { width: 100%; height: 100px; resize: none; margin-top: 5px; font-size: 12px; overflow-y: auto; }
        #file-upload, #import-file-input { display: none; }
        .shortcut-hint { font-size: 11px; color: #888; margin-right: 10px; font-weight: normal; }
        
        /* Modal Settings */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .modal { background: white; padding: 20px; border-radius: 8px; width: 500px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
        .modal h3 { margin-top: 0; }
        .modal h4 { margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 15px; }
        .setting-row label { flex-shrink: 0; }
        .key-input { width: 80px; text-align: center; font-weight: bold; }
        .number-input, .text-input-long { flex-grow: 1; }

        /* Gist Sync Status */
        #gist-sync-status {
            font-size: 11px;
            color: #666;
            margin-right: 10px;
            font-weight: normal;
        }
        #gist-sync-status a {
            color: var(--accent-color);
            text-decoration: underline;
            cursor: pointer;
        }
        .help-text { font-size: 11px; color: #666; margin-top: -5px; margin-bottom: 10px; }


        /* VOICE AI PANEL */
        #voice-ai-panel { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 800px; z-index: 1001; background-color: rgba(245, 245, 245, var(--ai-panel-opacity)); backdrop-filter: blur(5px); border: 1px solid var(--border-color); border-radius: 12px 12px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; transition: transform 0.3s ease-in-out, opacity 0.3s; transform-origin: bottom center; opacity: 0; visibility: hidden; height: 45vh; min-height: 150px; }
        #voice-ai-panel.visible { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; }
        #voice-ai-panel.collapsed { transform: translateX(-50%) translateY(calc(100% - 35px)); }
        .ai-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 5px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); background-color: rgba(255,255,255, 0.7); border-radius: 12px 12px 0 0; }
        .ai-panel-header #ai-status { font-weight: bold; color: var(--accent-color); font-size: 14px; }
        .ai-panel-toggle-btn { padding: 5px; cursor: pointer; font-size: 20px; background: none; border: none; }
        .ai-panel-toggle-btn.collapse-btn::before { content: '‚ñº'; }
        #voice-ai-panel.collapsed .ai-panel-toggle-btn.collapse-btn::before { content: '‚ñ≤'; }
        .ai-panel-content { display: flex; flex-grow: 1; gap: 10px; padding: 10px; min-height: 0; }
        .ai-panel-left, .ai-panel-right { display: flex; flex-direction: column; flex-basis: 50%; min-width: 0; }
        #ai-interactive-editor { width: 100%; flex-grow: 1; font-size: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; line-height: 1.6; background: #fff; overflow-y: auto; resize: none; }
        #ai-interactive-editor:empty:before { content: "D√°n vƒÉn b·∫£n ho·∫∑c b·∫Øt ƒë·∫ßu ghi √¢m ƒë·ªÉ AI x·ª≠ l√Ω..."; color: #aaa; }
        #ai-live-transcript-container { padding: 8px; border: 1px dashed var(--border-color); border-radius: 8px; background-color: #fafafa; margin-bottom: 10px; display: none; font-size: 14px; color: #555; text-align: center; }
        #ai-actions-list { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex-grow: 1; padding-right: 5px; }
        .ai-action-item { display: flex; align-items: center; gap: 5px; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; }
        .ai-action-item .name { flex-grow: 1; font-weight: 500; font-size: 13px; }
        .action-control-btn { background: none; border: 1px solid var(--border-color); color: #555; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .action-control-btn.run { color: #28a745; border-color: #28a745; }
        #add-ai-action-btn { background-color: #f8f9fa; color: var(--accent-color); border: 1px dashed var(--accent-color); margin-top: 10px; width: 100%; }
        .ai-panel-footer { padding: 10px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; align-items: center; }
        .ai-panel-footer-controls { display: flex; gap: 10px; }
        .ai-btn { padding: 8px 16px; font-size: 14px; cursor: pointer; border: none; border-radius: 6px; color: white; font-weight: 500; }
        #ai-start-button { background-color: #dc3545; }
        #ai-stop-button { background-color: #6c757d; }
        #ai-insert-button { background-color: #28a745; }
        .review-block { display: inline; background-color: #fffbdd; padding: 2px 0; }
        .review-block del { color: #d50000; text-decoration: none; background-color: #ffcdd2; padding: 2px 4px; border-radius: 3px; }
        .review-block .suggestions-container { display: inline-block; margin-left: 8px; font-style: italic; color: #555; }
        .suggestion-item { display: inline-block; padding: 2px 6px; margin: 0 4px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid transparent; font-style: normal; }
        .suggestion-item:hover { background-color: #e0e0e0; }
        .suggestion-item.best { text-decoration: underline; font-weight: bold; }
        .suggestion-item.original { color: #757575; }
        .suggestion-item.selected { background-color: var(--accent-color); color: white; }
        #ai-prompt-modal .modal { width: 700px; }
        #ai-prompt-modal .help-text { font-size: 12px; color: #666; margin-top: -10px; margin-bottom: 15px; }
        #ai-prompt-modal textarea { width: 100%; min-height: 120px; font-family: monospace; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-controls">
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'prompt-view')">So·∫°n th·∫£o Prompt</button>
            <button class="tab-button" onclick="openTab(event, 'storage-view')">L∆∞u tr·ªØ & Ghi ch√∫</button>
        </div>
        <div id="prompt-view-controls">
            <span id="gist-sync-status">S·∫µn s√†ng.</span>
            <span class="shortcut-hint" id="shortcut-display">Alt+1 (Copy), Alt+2 (Upload), Alt+3 (Focus)</span>
            <button class="main-button" id="import-sessions-btn" title="Nh·∫≠p v√† th√™m c√°c phi√™n t·ª´ file .json">Nh·∫≠p Phi√™n</button>
            <button class="main-button" id="export-sessions-btn" title="Ch·ªâ xu·∫•t t·∫•t c·∫£ c√°c phi√™n hi·ªán t·∫°i ra file .json">Xu·∫•t Phi√™n</button>
            <button class="main-button" id="import-data-btn" title="Nh·∫≠p to√†n b·ªô d·ªØ li·ªáu t·ª´ file backup (ghi ƒë√®)">Nh·∫≠p Backup</button>
            <button class="main-button" id="export-data-btn" title="Xu·∫•t to√†n b·ªô d·ªØ li·ªáu ra file backup">Xu·∫•t Backup</button>
            <button class="main-button icon-btn" id="settings-btn" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
            <button class="main-button" id="add-session-btn" title="Th√™m phi√™n m·ªõi v√†o ƒë·∫ßu">+ Th√™m Phi√™n</button>
            <button class="main-button" id="collapse-all-sessions-btn">Thu/M·ªü t·∫•t c·∫£</button>
        </div>
    </div>
    <div id="prompt-view" class="tab-content active">
        <div class="sessions-container" id="sessions-container"></div>
    </div>
    <div id="storage-view" class="tab-content">
        <div class="storage-view-container">
            <div class="storage-column">
                <h3><span>T·ªáp ƒë√£ l∆∞u</span><label for="file-upload" class="main-button" style="font-weight: normal;">+ T·∫£i l√™n</label></h3>
                <input type="file" id="file-upload" multiple>
                <div class="storage-column-content" id="file-list"></div>
            </div>
            <div class="storage-column">
                <h3>L·ªãch s·ª≠ Sao ch√©p</h3>
                <div class="storage-column-content" id="history-list"></div>
            </div>
            <div class="storage-column">
                <h3><span>Ghi ch√∫</span><button class="main-button" id="add-note-btn">+ Th√™m</button></h3>
                <div class="storage-column-content" id="notes-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal C√†i ƒë·∫∑t -->
<div class="modal-overlay" id="settings-modal">
    <div class="modal">
        <h3>C√†i ƒë·∫∑t</h3>
        
        <!-- START: C·∫§U H√åNH GIST T√çCH H·ª¢P -->
        <h4>ƒê·ªìng b·ªô Cloud (GitHub Gist)</h4>
        <p class="help-text">ƒê·ªìng b·ªô d·ªØ li·ªáu tab "So·∫°n th·∫£o Prompt" tr√™n nhi·ªÅu thi·∫øt b·ªã.</p>
        <div class="setting-row">
            <label for="gist-id-setting">Gist ID:</label>
            <input type="text" id="gist-id-setting" class="text-input-long" placeholder="ID c·ªßa Gist">
        </div>
        <div class="setting-row">
            <label for="gist-token-setting">GitHub Token:</label>
            <input type="password" id="gist-token-setting" class="text-input-long" placeholder="Personal Access Token (classic)">
        </div>
        <div style="text-align: right; margin-top: 5px;">
            <button class="main-button btn-delete" id="clear-gist-config-btn" style="font-size: 11px;">X√≥a C·∫•u h√¨nh</button>
        </div>
        <!-- END: C·∫§U H√åNH GIST T√çCH H·ª¢P -->

        <h4>Ph√≠m t·∫Øt</h4>
        <p class="help-text">Nh·∫≠p 1 k√Ω t·ª± (k·∫øt h·ª£p v·ªõi ph√≠m Alt).</p>
        <div class="setting-row"><label>Sao ch√©p (Copy):</label><input type="text" maxlength="1" id="key-copy" class="key-input"></div>
        <div class="setting-row"><label>T·∫£i file (Code):</label><input type="text" maxlength="1" id="key-upload" class="key-input"></div>
        <div class="setting-row"><label>Chuy·ªÉn √¥ (Focus):</label><input type="text" maxlength="1" id="key-focus" class="key-input"></div>
        <div class="setting-row"><label>Ghi √¢m (Voice):</label><input type="text" maxlength="1" id="key-voice" class="key-input"></div>
        
        <h4>Hi·ªÉn th·ªã</h4>
        <div class="setting-row">
            <label for="char-limit-input" title="ƒê·∫∑t 0 ƒë·ªÉ t·∫Øt. N·ªôi dung √¥ s·∫Ω ƒë∆∞·ª£c thu g·ªçn n·∫øu d√†i h∆°n gi√° tr·ªã n√†y.">Gi·ªõi h·∫°n k√Ω t·ª± hi·ªÉn th·ªã:</label>
            <input type="number" id="char-limit-input" class="number-input" min="0" step="50">
        </div>

        <h4>C√†i ƒë·∫∑t AI & Gi·ªçng n√≥i</h4>
        <div class="setting-row"><label for="gemini-key">Gemini API Key:</label><input type="password" id="gemini-key" class="text-input-long" placeholder="D√°n API Key c·ªßa b·∫°n"></div>
        <div class="setting-row"><label for="gemini-model">T√™n Model:</label><input type="text" id="gemini-model" class="text-input-long" value="gemini-1.5-pro-latest"></div>
        <div class="setting-row"><label for="ai-panel-opacity">ƒê·ªô trong su·ªët Panel (%):</label><input type="number" id="ai-panel-opacity" class="number-input" min="10" max="100" value="98"></div>
        
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="main-button" id="cancel-settings">H·ªßy</button>
            <button class="main-button" id="save-settings" style="background:var(--accent-color); color:white; border:none;">L∆∞u</button>
        </div>
    </div>
</div>

<input type="file" id="import-sessions-file-input" accept=".json" style="display: none;">
<input type="file" id="import-file-input" accept=".json" style="display: none;">


<!-- VOICE AI PANEL -->
<div id="voice-ai-panel">
    <div class="ai-panel-header" id="ai-panel-header">
        <span id="ai-status">S·∫µn s√†ng.</span>
        <button class="ai-panel-toggle-btn collapse-btn" id="ai-panel-collapse-btn" title="Thu g·ªçn/M·ªü r·ªông"></button>
    </div>
    <div class="ai-panel-content">
        <div class="ai-panel-left">
             <div id="ai-live-transcript-container">
                <span id="ai-live-transcript"></span>
            </div>
            <div id="ai-interactive-editor" contenteditable="true"></div>
        </div>
        <div class="ai-panel-right">
             <div id="ai-actions-list"></div>
             <button id="add-ai-action-btn" class="main-button">‚ûï Th√™m h√†nh ƒë·ªông m·ªõi</button>
        </div>
    </div>
    <div class="ai-panel-footer">
        <div class="ai-panel-footer-controls">
            <button id="ai-start-button" class="ai-btn" title="B·∫Øt ƒë·∫ßu ghi √¢m">üéôÔ∏è B·∫Øt ƒë·∫ßu</button>
            <button id="ai-stop-button" class="ai-btn" title="D·ª´ng ghi √¢m">‚èπÔ∏è D·ª´ng</button>
            <button id="ai-insert-button" class="ai-btn" title="Ch√®n k·∫øt qu·∫£ v√†o √¥ ƒëang focus tr√™n trang">Ch√®n v√†o trang</button>
        </div>
    </div>
</div>

<!-- Modal AI Action -->
<div id="ai-prompt-modal" class="modal-overlay">
    <div class="modal">
        <h3 id="ai-modal-title">Ch·ªânh s·ª≠a h√†nh ƒë·ªông</h3>
        <input type="hidden" id="ai-modal-action-id">
        <label for="ai-modal-action-name">T√™n h√†nh ƒë·ªông:</label>
        <input type="text" id="ai-modal-action-name" style="width:100%; box-sizing: border-box;">
        <label for="ai-modal-action-prompt">C√¢u l·ªánh (Prompt):</label>
        <textarea id="ai-modal-action-prompt"></textarea>
        <p class="help-text">Prompt ph·∫£i y√™u c·∫ßu AI tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON. B·∫°n c√≥ th·ªÉ d√πng bi·∫øn: <code>{{SUGGESTION_COUNT}}</code>.</p>
        
        <label for="ai-modal-action-renderer">M√£ ngu·ªìn x·ª≠ l√Ω hi·ªÉn th·ªã (Renderer - N√¢ng cao):</label>
        <textarea id="ai-modal-action-renderer" placeholder="ƒê·ªÉ tr·ªëng n·∫øu mu·ªën d√πng tr√¨nh x·ª≠ l√Ω m·∫∑c ƒë·ªãnh..."></textarea>
        <p class="help-text">
            <b>C·∫¢NH B√ÅO:</b> Vi·∫øt m·ªôt h√†m Javascript nh·∫≠n 2 tham s·ªë: <code>(editor, jsonData)</code>.
        </p>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button id="ai-modal-cancel-btn" class="main-button">H·ªßy</button>
            <button id="ai-modal-save-btn" class="main-button" style="background:var(--accent-color); color:white; border:none;">L∆∞u</button>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- START: BI·∫æN V√Ä DOM ELEMENTS CH√çNH ---
    const sessionsContainer = document.getElementById('sessions-container');
    const addSessionBtn = document.getElementById('add-session-btn');
    const collapseAllBtn = document.getElementById('collapse-all-sessions-btn');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const saveSettingsBtn = document.getElementById('save-settings');
    const cancelSettingsBtn = document.getElementById('cancel-settings');
    const shortcutDisplay = document.getElementById('shortcut-display');
    const exportDataBtn = document.getElementById('export-data-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFileInput = document.getElementById('import-file-input');
    const exportSessionsBtn = document.getElementById('export-sessions-btn');
    const importSessionsBtn = document.getElementById('import-sessions-btn');
    const importSessionsFileInput = document.getElementById('import-sessions-file-input');
    
    let sessions = [];
    let files = [];
    let history = [];
    let notes = [];
    let suggestions = [];
    let shortcuts = { copy: '1', upload: '2', focus: '3', voice: 'v' };
    let settings = { maxCharDisplay: 0 };
    let lastActiveSessionId = null;
    let lastFocusedElement = null;
    // --- END: BI·∫æN V√Ä DOM ELEMENTS CH√çNH ---

    // --- START: BI·∫æN V√Ä LOGIC CHO ƒê·ªíNG B·ªò GISTHUB ---
    const gistStatusSpan = document.getElementById('gist-sync-status');
    const clearGistConfigBtn = document.getElementById('clear-gist-config-btn');
    
    const GIST_FILENAME = 'prompt_sessions.json';
    let GIST_ID = '';
    let GITHUB_TOKEN = '';
    let gistDebounceTimer;

    function updateGistStatus(message, isError = false) {
        if (isError) {
            gistStatusSpan.innerHTML = `<span style="color: #dc3545;">L·ªói: ${message}</span>`;
        } else {
            gistStatusSpan.innerHTML = message;
        }
    }

    function clearGistConfig() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c·∫•u h√¨nh ƒë·ªìng b·ªô Gist kh√¥ng? D·ªØ li·ªáu phi√™n s·∫Ω ch·ªâ ƒë∆∞·ª£c l∆∞u tr√™n thi·∫øt b·ªã n√†y.')) {
            localStorage.removeItem('promptGistId');
            localStorage.removeItem('promptGistToken');
            alert('ƒê√£ x√≥a c·∫•u h√¨nh Gist. Trang s·∫Ω ƒë∆∞·ª£c t·∫£i l·∫°i.');
            location.reload();
        }
    }
    clearGistConfigBtn.addEventListener('click', clearGistConfig);

    async function loadSessionsFromGist() {
        if (!GIST_ID || !GITHUB_TOKEN) return;
        updateGistStatus('ƒêang t·∫£i t·ª´ Cloud...');
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            if (!response.ok) {
                if (response.status === 404) {
                     updateGistStatus(`Kh√¥ng t√¨m th·∫•y Gist.`, true);
                     return null;
                }
                throw new Error(`HTTP: ${response.status}`);
            }
            const data = await response.json();
            if (data.files && data.files[GIST_FILENAME]) {
                const gistContent = data.files[GIST_FILENAME].content;
                sessions = JSON.parse(gistContent);
                updateGistStatus(`ƒê·ªìng b·ªô l√∫c ${new Date().toLocaleTimeString()}.`);
            } else {
                updateGistStatus('Cloud tr·ªëng, s·∫µn s√†ng l∆∞u.');
                sessions = JSON.parse(localStorage.getItem('promptSessions') || '[]');
                if (sessions.length > 0) {
                    saveDataToGist(); 
                }
            }
        } catch (error) {
            updateGistStatus(`L·ªói t·∫£i: ${error.message}`, true);
            return null;
        }
        return true;
    }

    async function saveDataToGist() {
        if (!GIST_ID || !GITHUB_TOKEN) return;
        updateGistStatus('ƒêang l∆∞u l√™n Cloud...');
        try {
            const contentToSave = JSON.stringify(sessions, null, 2);
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, { 
                method: 'PATCH', 
                headers: { 
                    'Authorization': `token ${GITHUB_TOKEN}`, 
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json' 
                }, 
                body: JSON.stringify({ 
                    files: { 
                        [GIST_FILENAME]: { content: contentToSave } 
                    } 
                }) 
            });
            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(errorData.message || 'Unknown API error');
            }
            updateGistStatus(`ƒê√£ l∆∞u l√∫c ${new Date().toLocaleTimeString()}.`);
        } catch (error) { 
            updateGistStatus(`L·ªói l∆∞u: ${error.message}`, true); 
        }
    }
    // --- END: LOGIC ƒê·ªíNG B·ªò GISTHUB ---

    // --- START: LOGIC PANEL AI GI·ªåNG N√ìI ---
    // (To√†n b·ªô logic AI kh√¥ng thay ƒë·ªïi)
    const aiPanel = document.getElementById('voice-ai-panel');
    const aiPanelHeader = document.getElementById('ai-panel-header');
    const aiPanelCollapseBtn = document.getElementById('ai-panel-collapse-btn');
    const aiEditor = document.getElementById('ai-interactive-editor');
    const aiStatusDiv = document.getElementById('ai-status');
    const aiLiveTranscriptContainer = document.getElementById('ai-live-transcript-container');
    const aiLiveTranscriptDiv = document.getElementById('ai-live-transcript');
    const aiActionsListDiv = document.getElementById('ai-actions-list');
    const aiModal = document.getElementById('ai-prompt-modal');
    const aiStartButton = document.getElementById('ai-start-button');
    const aiStopButton = document.getElementById('ai-stop-button');
    const aiInsertButton = document.getElementById('ai-insert-button');
    const addAiActionButton = document.getElementById('add-ai-action-btn');
    let aiActions = [];

    function toggleAiPanel(show) {
        if (show) { aiPanel.classList.add('visible'); } 
        else { aiPanel.classList.remove('visible'); if (window.webkitSpeechRecognition && recognition && isListening) { recognition.stop(); } }
    }
    aiPanelHeader.addEventListener('click', (e) => { if (e.target.closest('.ai-panel-header')) { aiPanel.classList.toggle('collapsed'); } });
    function renderAiActions() {
        aiActionsListDiv.innerHTML = '';
        aiActions.forEach((action, index) => {
            const item = document.createElement('div');
            item.className = 'ai-action-item';
            item.innerHTML = `<span class="name">${escapeHtml(action.name)}</span><button class="action-control-btn edit" data-id="${index}">S·ª≠a</button><button class="action-control-btn delete" data-id="${index}">X√≥a</button><button class="action-control-btn run" data-id="${index}">Th·ª±c thi</button>`;
            aiActionsListDiv.appendChild(item);
        });
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition; let isListening = false;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'vi-VN';
        let fullTranscript = '';
        recognition.onstart = () => { isListening = true; aiStatusDiv.textContent = 'üî¥ ƒêang l·∫Øng nghe...'; aiLiveTranscriptContainer.style.display = 'block'; };
        recognition.onend = () => { isListening = false; aiStatusDiv.textContent = 'ƒê√£ d·ª´ng ghi √¢m.'; aiLiveTranscriptContainer.style.display = 'none'; };
        recognition.onresult = (event) => {
            let interimTranscript = ''; let finalTranscriptForEditor = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcriptPart = event.results[i][0].transcript;
                if (event.results[i].isFinal) { fullTranscript += transcriptPart + '. '; finalTranscriptForEditor += transcriptPart + '. '; } 
                else { interimTranscript += transcriptPart; }
            }
            aiLiveTranscriptDiv.innerHTML = escapeHtml(fullTranscript) + `<span style="color: grey;">${escapeHtml(interimTranscript)}</span>`;
            if (finalTranscriptForEditor) { aiEditor.innerText += finalTranscriptForEditor; }
        };
        aiStartButton.onclick = () => { fullTranscript = ''; recognition.start(); };
        aiStopButton.onclick = () => { if(isListening) recognition.stop(); }
    } else { aiStartButton.disabled = true; aiStopButton.disabled = true; aiStatusDiv.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Speech Recognition."; }
    aiActionsListDiv.addEventListener('click', (e) => {
        const id = e.target.dataset.id;
        if (e.target.classList.contains('run')) executeAiAction(id);
        else if (e.target.classList.contains('edit')) openAiPromptModal(id);
        else if (e.target.classList.contains('delete')) {
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√†nh ƒë·ªông "${aiActions[id].name}"?`)) { aiActions.splice(id, 1); saveData('promptAiActions', aiActions); renderAiActions(); }
        }
    });
    addAiActionButton.onclick = () => openAiPromptModal();
    async function executeAiAction(id) {
        const apiKey = document.getElementById('gemini-key').value; const model = document.getElementById('gemini-model').value; const textToProcess = aiEditor.innerText; const action = aiActions[id];
        if (!apiKey || !textToProcess.trim()) { alert('Vui l√≤ng nh·∫≠p API Key v√† n·ªôi dung vƒÉn b·∫£n trong panel AI.'); return; }
        aiStatusDiv.textContent = 'ü§ñ AI ƒëang suy nghƒ©...'; aiEditor.innerHTML = '<div style="text-align:center; color: #aaa;">ƒêang x·ª≠ l√Ω...</div>';
        let processedPrompt = action.prompt.replace('{{SUGGESTION_COUNT}}', "2");
        const fullPrompt = `${processedPrompt}\n\nVƒÉn b·∫£n g·ªëc:\n"""\n${textToProcess}\n"""`;
        const apiURL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        try {
            const response = await fetch(apiURL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] }) });
            const responseData = await response.json();
            if (!response.ok) throw new Error(responseData.error ? responseData.error.message : 'Unknown API error');
            let resultText = responseData.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
            const resultJson = JSON.parse(resultText);
            if (action.renderer && action.renderer.trim() !== "") { const customRenderer = new Function('editor', 'jsonData', action.renderer); customRenderer(aiEditor, resultJson); aiStatusDiv.textContent = '‚úÖ Hi·ªÉn th·ªã b·∫±ng renderer t√πy ch·ªânh.'; } 
            else {
                if (resultJson.summary) { aiEditor.innerHTML = `<strong>N·ªôi dung t√≥m t·∫Øt:</strong><br>${resultJson.summary.replace(/\n/g, '<br>')}`; aiStatusDiv.textContent = '‚úÖ ƒê√£ t√≥m t·∫Øt xong!'; } 
                else if (resultJson.changes) { renderInteractiveChanges(textToProcess, resultJson.changes); aiStatusDiv.textContent = '‚úÖ Xong! Nh·∫•p v√†o c√°c g·ª£i √Ω ƒë·ªÉ s·ª≠a.'; } 
                else { throw new Error("AI kh√¥ng tr·∫£ v·ªÅ JSON c√≥ key 'summary' ho·∫∑c 'changes'."); }
            }
        } catch (error) { aiStatusDiv.textContent = `‚ùå L·ªói x·ª≠ l√Ω AI: ${error.message}`; aiEditor.innerHTML = textToProcess; console.error(error); }
    }
    function renderInteractiveChanges(originalText, changes) {
        let html = escapeHtml(originalText);
        changes.reverse().forEach((change) => {
            const originalPhrase = escapeHtml(change.original_phrase);
            let suggestionsHtml = `<span class="suggestions-container">(<span class="suggestion-item best" data-value="${escapeHtml(change.best_suggestion)}">${escapeHtml(change.best_suggestion)}</span>`;
            (change.alternatives || []).forEach(alt => { suggestionsHtml += `<span class="suggestion-item" data-value="${escapeHtml(alt)}">${escapeHtml(alt)}</span>`; });
            suggestionsHtml += `<span class="suggestion-item original selected" data-value="${originalPhrase}">(Gi·ªØ l·∫°i)</span>)</span>`;
            const replacementHtml = `<span class="review-block" data-original="${originalPhrase}" data-selected-text="${originalPhrase}"><del>${originalPhrase}</del>${suggestionsHtml}</span>`;
            const pos = html.lastIndexOf(originalPhrase);
            if (pos !== -1) { html = html.substring(0, pos) + replacementHtml + html.substring(pos + originalPhrase.length); }
        });
        aiEditor.innerHTML = html;
    }
    aiEditor.addEventListener('click', (e) => {
        if (e.target.classList.contains('suggestion-item')) {
            const clickedSuggestion = e.target; const reviewBlock = clickedSuggestion.closest('.review-block'); const container = clickedSuggestion.closest('.suggestions-container');
            if (reviewBlock && container) { container.querySelectorAll('.suggestion-item').forEach(item => item.classList.remove('selected')); clickedSuggestion.classList.add('selected'); reviewBlock.dataset.selectedText = clickedSuggestion.dataset.value; }
        }
    });
    aiInsertButton.onclick = () => {
        let finalString = '';
        aiEditor.childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE) finalString += node.textContent;
            else if (node.nodeType === Node.ELEMENT_NODE && node.classList.contains('review-block')) finalString += node.dataset.selectedText;
            else if (node.nodeType === Node.ELEMENT_NODE) finalString += node.innerText || '';
        });
        finalString = finalString.replace(/\s+/g, ' ').trim();
        if (lastFocusedElement && (lastFocusedElement.tagName === 'TEXTAREA' || lastFocusedElement.tagName === 'INPUT')) {
            const start = lastFocusedElement.selectionStart; const end = lastFocusedElement.selectionEnd; const text = lastFocusedElement.value; const before = text.substring(0, start); const after = text.substring(end);
            lastFocusedElement.value = before + finalString + after;
            lastFocusedElement.selectionStart = lastFocusedElement.selectionEnd = start + finalString.length;
            lastFocusedElement.dispatchEvent(new Event('input', { bubbles: true }));
            lastFocusedElement.focus(); toggleAiPanel(false); alert("ƒê√£ ch√®n k·∫øt qu·∫£!");
        } else { alert("Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu ƒë·ªÉ ch√®n vƒÉn b·∫£n."); }
    };
    function openAiPromptModal(id = null) {
        const modalId = document.getElementById('ai-modal-action-id'); const modalName = document.getElementById('ai-modal-action-name'); const modalPrompt = document.getElementById('ai-modal-action-prompt'); const modalRenderer = document.getElementById('ai-modal-action-renderer'); const modalTitle = document.getElementById('ai-modal-title');
        if (id !== null) { modalTitle.textContent = "Ch·ªânh s·ª≠a h√†nh ƒë·ªông"; modalId.value = id; modalName.value = aiActions[id].name; modalPrompt.value = aiActions[id].prompt; modalRenderer.value = aiActions[id].renderer || ""; } 
        else { modalTitle.textContent = "Th√™m h√†nh ƒë·ªông m·ªõi"; modalId.value = -1; modalName.value = ''; modalPrompt.value = `Ph√¢n t√≠ch vƒÉn b·∫£n... Y√äU C·∫¶U: Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON c√≥ c·∫•u tr√∫c sau:\n{"changes": [{"original_phrase": "...", "best_suggestion": "...", "alternatives": ["...", "..."]}]}`; modalRenderer.value = ''; }
        aiModal.style.display = 'flex';
    }
    document.getElementById('ai-modal-cancel-btn').onclick = () => aiModal.style.display = 'none';
    document.getElementById('ai-modal-save-btn').onclick = () => {
        const id = document.getElementById('ai-modal-action-id').value; const name = document.getElementById('ai-modal-action-name').value; const prompt = document.getElementById('ai-modal-action-prompt').value; const renderer = document.getElementById('ai-modal-action-renderer').value;
        if (!name || !prompt) { alert("T√™n v√† c√¢u l·ªánh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng."); return; }
        const newAction = { name, prompt, renderer };
        if (id == -1) aiActions.push(newAction);
        else aiActions[id] = newAction;
        saveData('promptAiActions', aiActions); renderAiActions(); aiModal.style.display = 'none';
    };
    function toggleVoiceRecognition() {
        if (!SpeechRecognition) { alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ t√≠nh nƒÉng gi·ªçng n√≥i."); return; }
        lastFocusedElement = document.activeElement; toggleAiPanel(true); aiPanel.classList.remove('collapsed');
        setTimeout(() => { if (!isListening) { aiStartButton.click(); } else { aiStopButton.click(); } }, 100);
    }
    // --- END: LOGIC PANEL AI GI·ªåNG N√ìI ---
    
    function escapeHtml(text) {
        if (typeof text !== 'string') return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function getFormattedTime() {
        const now = new Date();
        return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')} ${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}`;
    }
    
    function loadLocalData(sessionsAlreadyLoaded = false) {
        try {
            if (!sessionsAlreadyLoaded) {
                 sessions = JSON.parse(localStorage.getItem('promptSessions') || '[]');
            }
            files = JSON.parse(localStorage.getItem('promptFiles') || '[]');
            history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
            notes = JSON.parse(localStorage.getItem('promptNotes') || '[]');
            suggestions = JSON.parse(localStorage.getItem('promptSuggestions') || '["L√† m·ªôt chuy√™n gia", "H√†nh ƒë·ªông nh∆∞ m·ªôt", "Vi·∫øt code"]');
            
            const savedShortcuts = JSON.parse(localStorage.getItem('promptShortcuts'));
            if (savedShortcuts) shortcuts = {...shortcuts, ...savedShortcuts};
            
            const savedSettings = JSON.parse(localStorage.getItem('promptSettings'));
            if (savedSettings) settings = savedSettings;
            
            document.getElementById('gemini-key').value = localStorage.getItem('geminiApiKey') || '';
            document.getElementById('gemini-model').value = localStorage.getItem('geminiModel') || 'gemini-1.5-pro-latest';
            const opacity = localStorage.getItem('aiPanelOpacity') || 98;
            document.getElementById('ai-panel-opacity').value = opacity;
            document.documentElement.style.setProperty('--ai-panel-opacity', opacity / 100);

            aiActions = JSON.parse(localStorage.getItem('promptAiActions') || '[]');
            if(aiActions.length === 0) {
                 aiActions.push({ name: "S·ª≠a l·ªói Ng·ªØ ph√°p", prompt: `Ph√¢n t√≠ch vƒÉn b·∫£n... Y√äU C·∫¶U: Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON c√≥ c·∫•u tr√∫c sau:\n{"changes": [{"original_phrase": "...", "best_suggestion": "...", "alternatives": ["...", "..."]}]}`, renderer: "" });
                 aiActions.push({ name: "T√≥m t·∫Øt 3 √Ω ch√≠nh", prompt: `T√≥m t·∫Øt vƒÉn b·∫£n th√†nh 3 √Ω ch√≠nh. Y√äU C·∫¶U: Ch·ªâ tr·∫£ l·ªùi b·∫±ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON c√≥ c·∫•u tr√∫c sau: {"summary": "- √ù 1\\n- √ù 2\\n- √ù 3"}`, renderer: "" });
                 saveData('promptAiActions', aiActions);
            }

        } catch (e) { console.error("Load error", e); }

        if (sessions.length === 0) { for(let i=0; i<3; i++) sessions.push(createNewSessionData(`Phi√™n l√†m vi·ªác ${i+1}`)); }
        if (notes.length === 0) { notes.push({ id: Date.now(), title: 'Ghi ch√∫ 1', content: '', timestamp: getFormattedTime() }); }

        updateShortcutDisplay();
    }
    
    function saveData(key, data) {
        // Lu√¥n l∆∞u b·∫£n sao v√†o localStorage l√†m backup
        localStorage.setItem(key, JSON.stringify(data));

        if (key === 'promptSessions' && GIST_ID && GITHUB_TOKEN) {
             clearTimeout(gistDebounceTimer);
             gistDebounceTimer = setTimeout(saveDataToGist, 2500); 
        }
    }

    function renderAll() {
        renderSessions();
        renderFileList();
        renderHistoryList();
        renderNotes();
        renderAiActions();
    }
    
    exportDataBtn.addEventListener('click', () => {
        const allData = { sessions, files, history, notes, suggestions, shortcuts, settings,
            geminiApiKey: localStorage.getItem('geminiApiKey'),
            geminiModel: localStorage.getItem('geminiModel'),
            aiPanelOpacity: localStorage.getItem('aiPanelOpacity'),
            promptAiActions: aiActions
        };
        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.download = `prompt_pro_backup_${new Date().toISOString().slice(0, 10)}.json`;
        a.href = URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);
    });

    importDataBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (confirm("GHI ƒê√à D·ªÆ LI·ªÜU? H√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i v√† thay th·∫ø b·∫±ng d·ªØ li·ªáu t·ª´ file backup. KH√îNG TH·ªÇ ho√†n t√°c.")) {
                    sessions = importedData.sessions || [];
                    files = importedData.files || [];
                    history = importedData.history || [];
                    notes = importedData.notes || [];
                    suggestions = importedData.suggestions || [];
                    aiActions = importedData.promptAiActions || [];
                    if (importedData.shortcuts) shortcuts = {...shortcuts, ...importedData.shortcuts};
                    if (importedData.settings) settings = importedData.settings;
                    localStorage.setItem('geminiApiKey', importedData.geminiApiKey || '');
                    localStorage.setItem('geminiModel', importedData.geminiModel || 'gemini-1.5-pro-latest');
                    localStorage.setItem('aiPanelOpacity', importedData.aiPanelOpacity || '98');
                    saveData('promptSessions', sessions); saveData('promptFiles', files); saveData('promptHistory', history); saveData('promptNotes', notes); saveData('promptSuggestions', suggestions); saveData('promptShortcuts', shortcuts); saveData('promptSettings', settings); saveData('promptAiActions', aiActions);
                    alert("D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c nh·∫≠p th√†nh c√¥ng! Trang s·∫Ω t·∫£i l·∫°i.");
                    location.reload();
                }
            } catch (error) { alert("L·ªói: File backup kh√¥ng h·ª£p l·ªá."); console.error("Import error:", error); } 
            finally { importFileInput.value = ''; }
        };
        reader.readAsText(file);
    });

    exportSessionsBtn.addEventListener('click', () => {
        if (!sessions || sessions.length === 0) { alert("Kh√¥ng c√≥ phi√™n n√†o ƒë·ªÉ xu·∫•t."); return; }
        const blob = new Blob([JSON.stringify(sessions, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.download = `prompt_pro_sessions_${new Date().toISOString().slice(0, 10)}.json`;
        a.href = URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);
    });
    
    importSessionsBtn.addEventListener('click', () => importSessionsFileInput.click());
    importSessionsFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedSessions = JSON.parse(event.target.result);
                if (!Array.isArray(importedSessions)) { throw new Error("File kh√¥ng ch·ª©a danh s√°ch phi√™n h·ª£p l·ªá."); }
                if (confirm(`B·∫°n c√≥ mu·ªën TH√äM ${importedSessions.length} phi√™n m·ªõi v√†o d·ªØ li·ªáu hi·ªán t·∫°i kh√¥ng?`)) {
                    sessions = sessions.concat(importedSessions);
                    saveData('promptSessions', sessions);
                    renderSessions();
                    alert("ƒê√£ nh·∫≠p th√™m c√°c phi√™n m·ªõi th√†nh c√¥ng!");
                }
            } catch (error) { alert("L·ªói: File kh√¥ng h·ª£p l·ªá. " + error.message); console.error("Session Import error:", error); } 
            finally { importSessionsFileInput.value = ''; }
        };
        reader.readAsText(file);
    });

    function updateShortcutDisplay() {
        shortcutDisplay.textContent = `Alt+${shortcuts.copy} (Copy), Alt+${shortcuts.upload} (Code), Alt+${shortcuts.focus} (Focus), Alt+${shortcuts.voice} (Voice)`;
    }

    settingsBtn.addEventListener('click', () => {
        // Populate settings from current state
        document.getElementById('gist-id-setting').value = localStorage.getItem('promptGistId') || '';
        document.getElementById('gist-token-setting').value = localStorage.getItem('promptGistToken') || '';
        document.getElementById('key-copy').value = shortcuts.copy;
        document.getElementById('key-upload').value = shortcuts.upload;
        document.getElementById('key-focus').value = shortcuts.focus;
        document.getElementById('key-voice').value = shortcuts.voice;
        document.getElementById('char-limit-input').value = settings.maxCharDisplay || 0;
        settingsModal.style.display = 'flex';
    });

    cancelSettingsBtn.addEventListener('click', () => settingsModal.style.display = 'none');

    saveSettingsBtn.addEventListener('click', () => {
        const newGistId = document.getElementById('gist-id-setting').value.trim();
        const newGistToken = document.getElementById('gist-token-setting').value.trim();
        
        const configChanged = newGistId !== GIST_ID || newGistToken !== GITHUB_TOKEN;

        localStorage.setItem('promptGistId', newGistId);
        localStorage.setItem('promptGistToken', newGistToken);

        const k1 = document.getElementById('key-copy').value.trim().toLowerCase();
        const k2 = document.getElementById('key-upload').value.trim().toLowerCase();
        const k3 = document.getElementById('key-focus').value.trim().toLowerCase();
        const k4 = document.getElementById('key-voice').value.trim().toLowerCase();
        if(k1 && k2 && k3 && k4) { shortcuts = { copy: k1, upload: k2, focus: k3, voice: k4 }; saveData('promptShortcuts', shortcuts); updateShortcutDisplay(); }
        
        const charLimit = parseInt(document.getElementById('char-limit-input').value, 10);
        settings.maxCharDisplay = isNaN(charLimit) || charLimit < 0 ? 0 : charLimit;
        saveData('promptSettings', settings);

        localStorage.setItem('geminiApiKey', document.getElementById('gemini-key').value);
        localStorage.setItem('geminiModel', document.getElementById('gemini-model').value);
        const opacity = document.getElementById('ai-panel-opacity').value;
        localStorage.setItem('aiPanelOpacity', opacity);
        document.documentElement.style.setProperty('--ai-panel-opacity', opacity / 100);

        settingsModal.style.display = 'none';
        
        if (configChanged) {
            alert('C·∫•u h√¨nh ƒë·ªìng b·ªô ƒë√£ thay ƒë·ªïi. Trang s·∫Ω ƒë∆∞·ª£c t·∫£i l·∫°i ƒë·ªÉ √°p d·ª•ng.');
            location.reload();
        } else {
             renderSessions();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.altKey) {
            const key = e.key.toLowerCase();
            if (key === shortcuts.voice.toLowerCase()) { e.preventDefault(); toggleVoiceRecognition(); return; }
            if (e.target.closest('#voice-ai-panel')) return;

            if (key === shortcuts.copy.toLowerCase() || key === shortcuts.upload.toLowerCase() || key === shortcuts.focus.toLowerCase()) {
                e.preventDefault();
                const targetSessionEl = lastActiveSessionId ? document.querySelector(`.session[data-session-id="${lastActiveSessionId}"]`) : document.querySelector('.session');
                if (!targetSessionEl) return;
                if (key === shortcuts.copy.toLowerCase()) copySessionContent(targetSessionEl);
                else if (key === shortcuts.upload.toLowerCase()) targetSessionEl.querySelector('.row-code .upload-code-btn')?.click();
                else if (key === shortcuts.focus.toLowerCase()) {
                    const inputs = [...targetSessionEl.querySelectorAll('textarea, input.session-title-input')];
                    let currentFocusIndex = inputs.findIndex(input => input === document.activeElement);
                    inputs[(currentFocusIndex + 1) % inputs.length]?.focus();
                }
            }
        }
    });

    document.addEventListener('focusin', (e) => {
        const sessionEl = e.target.closest('.session');
        if (sessionEl) {
            lastActiveSessionId = parseFloat(sessionEl.dataset.sessionId);
            document.querySelectorAll('.session').forEach(s => s.classList.remove('last-active'));
            sessionEl.classList.add('last-active');
        }
        if (!e.target.closest('#voice-ai-panel')) { lastFocusedElement = e.target; }
    });

    // --- C√ÅC H√ÄM G·ªêC ---
    function createNewSessionData(defaultTitle) {
        return { id: Date.now() + Math.random(), customTitle: defaultTitle || 'Phi√™n m·ªõi', isPinned: false, rows: [{ id: 1, title: '1. L·ªánh t·ªïng qu√°t', content: '', type: 'general' },{ id: 2, title: '2. Y√™u c·∫ßu chi ti·∫øt', content: '1. ', type: 'numbered', isNumbered: true },{ id: 3, title: '3. V√≠ d·ª•', content: '', type: 'example' },{ id: 4, title: '4. L∆∞u √Ω', content: '1. ', type: 'numbered', isNumbered: true },{ id: 5, title: '5. Code c·∫ßn s·ª≠a', content: '', type: 'code' }] };
    }
    function renderSessions() {
        sessions.sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0));
        sessionsContainer.innerHTML = '';
        sessions.forEach((session, index) => { sessionsContainer.appendChild(createSessionElement(session, index)); });
        attachSessionEvents();
    }
    function createSessionElement(session, index) {
        const div = document.createElement('div');
        div.className = `session ${session.isPinned ? 'pinned' : ''}`;
        if (session.id === lastActiveSessionId) div.classList.add('last-active');
        div.dataset.sessionId = session.id;
        let rowsHtml = session.rows.map(row => createRowHtml(row)).join('');
        const moveControls = `<button class="main-button move-btn" data-dir="up" title="Di chuy·ªÉn l√™n/tr√°i">‚Üê</button><button class="main-button move-btn" data-dir="down" title="Di chuy·ªÉn xu·ªëng/ph·∫£i">‚Üí</button>`;
        const pinBtnClass = `main-button pin-session-btn ${session.isPinned ? 'pinned' : ''}`;
        div.innerHTML = `<div class="session-header"><input type="text" class="session-title-input" value="${escapeHtml(session.customTitle)}" spellcheck="false" placeholder="T√™n phi√™n..."><span class="copy-success-icon">‚úî</span><div class="session-controls"><button class="${pinBtnClass}" title="Ghim phi√™n n√†y">üìå</button>${moveControls}<button class="main-button copy-all-btn">Sao ch√©p</button><button class="main-button delete-session-btn" style="color:#dc3545;">X√≥a</button></div></div><div class="rows-container">${rowsHtml}</div>`;
        return div;
    }
    function createRowHtml(row) {
        let controls = ''; let contentVal = row.content || ''; let placeholder = ''; let extraClass = ''; let spellcheck = 'false';
        if(row.isNumbered && !contentVal.trim()) contentVal = "1. ";
        if (row.type === 'general') { controls = `<button class="toggle-suggestions-btn" title="G·ª£i √Ω">+</button><div class="suggestions-popup"><div class="suggestion-list"></div><div style="display:flex; gap:5px; margin-top:5px;"><input type="text" class="add-new-sug-input" placeholder="Th√™m..." spellcheck="false"><button class="save-sug-btn">L∆∞u</button></div></div>`; placeholder = "Nh·∫≠p l·ªánh t·ªïng qu√°t..."; } 
        else if (row.type === 'numbered' && row.title.includes('Y√™u c·∫ßu chi ti·∫øt')) { controls = `<button class="action-btn supreme-numbering-btn" title="ƒê√°nh s·ªë to√†n b·ªô">ƒê√°nh s·ªë All</button><button class="action-btn supreme-unnumbering-btn" title="B·ªè s·ªë to√†n b·ªô">B·ªè s·ªë All</button><button class="action-btn selective-numbering-btn" title="ƒê√°nh s·ªë ch·ªçn l·ªçc">ƒê√°nh s·ªë Ch·ªçn</button><button class="action-btn selective-unnumbering-btn" title="B·ªè s·ªë ch·ªçn l·ªçc">B·ªè s·ªë Ch·ªçn</button><button class="action-btn renumber-btn" title="ƒê√°nh s·ªë l·∫°i">‚Üª</button><label><input type="checkbox" class="numbering-chk" ${row.isNumbered?'checked':''}> S·ªë</label>`; } 
        else if (row.type === 'numbered') { controls = `<button class="action-btn renumber-btn" title="ƒê√°nh s·ªë l·∫°i">‚Üª</button><label><input type="checkbox" class="numbering-chk" ${row.isNumbered?'checked':''}> S·ªë</label>`; } 
        else if (row.type === 'code') { controls = `<button class="upload-code-btn" title="T·∫£i file">üìÇ</button>`; extraClass = 'collapsed'; } 
        else if (row.type === 'example') { placeholder = "V√≠ d·ª•..."; }
        return `<div class="prompt-row row-${row.type} ${extraClass}" data-row-id="${row.id}"><div class="row-header"><span>${escapeHtml(row.title)}</span><div class="row-controls">${controls}</div></div><div class="row-content"><textarea data-row-type="${row.type}" placeholder="${placeholder}" spellcheck="${spellcheck}">${escapeHtml(contentVal)}</textarea></div></div>`;
    }
    function truncateTextarea(textarea) {
        const limit = settings.maxCharDisplay; if (!limit || limit <= 0) return; 
        const fullText = textarea.dataset.fullText || textarea.value;
        if (!textarea.dataset.fullText && fullText.length > limit) { textarea.value = fullText.substring(0, limit) + '...'; textarea.dataset.fullText = fullText; textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight + 2) + 'px'; }
    }
    function expandTextarea(textarea) {
        if (textarea.dataset.fullText) { textarea.value = textarea.dataset.fullText; textarea.removeAttribute('data-full-text'); textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight + 2) + 'px'; }
    }
    function attachSessionEvents() {
        document.querySelectorAll('textarea').forEach(tx => {
            if (tx.closest('#voice-ai-panel')) return;
            truncateTextarea(tx);
            tx.addEventListener('focus', () => expandTextarea(tx));
            tx.addEventListener('blur', () => truncateTextarea(tx));
            if(!tx.closest('.row-code')) { tx.style.height = 'auto'; tx.style.height = (tx.scrollHeight + 2) + 'px'; tx.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight + 2) + 'px'; updateSessionData(this); }); } 
            else { tx.addEventListener('input', () => updateSessionData(tx) ); }
        });
        document.querySelectorAll('.session-title-input').forEach(inp => { inp.addEventListener('change', (e) => { const sessId = parseFloat(e.target.closest('.session').dataset.sessionId); const sess = sessions.find(s => s.id === sessId); if(sess) { sess.customTitle = e.target.value; saveData('promptSessions', sessions); } }); });
        document.querySelectorAll('.pin-session-btn').forEach(btn => { btn.addEventListener('click', (e) => { const sessId = parseFloat(e.target.closest('.session').dataset.sessionId); const sess = sessions.find(s => s.id === sessId); if (sess) { sess.isPinned = !sess.isPinned; saveData('promptSessions', sessions); renderSessions(); } }); });
        document.querySelectorAll('.move-btn').forEach(btn => { btn.addEventListener('click', (e) => { const sessEl = e.target.closest('.session'); const sessId = parseFloat(sessEl.dataset.sessionId); const index = sessions.findIndex(s => s.id === sessId); if(index === -1) return; const dir = e.target.dataset.dir; if (dir === 'up' && index > 0) [sessions[index], sessions[index-1]] = [sessions[index-1], sessions[index]]; else if (dir === 'down' && index < sessions.length - 1) [sessions[index], sessions[index+1]] = [sessions[index+1], sessions[index]]; else return; saveData('promptSessions', sessions); renderSessions(); }); });
        document.querySelectorAll('.row-header').forEach(header => { header.addEventListener('click', (e) => { if(!e.target.closest('.row-controls')) header.parentElement.classList.toggle('collapsed'); }); });
        document.querySelectorAll('.delete-session-btn').forEach(btn => { btn.addEventListener('click', (e) => { if(confirm("X√≥a phi√™n n√†y?")) { const sessId = parseFloat(e.target.closest('.session').dataset.sessionId); sessions = sessions.filter(s => s.id !== sessId); saveData('promptSessions', sessions); renderSessions(); } }); });
        document.querySelectorAll('.copy-all-btn').forEach(btn => { btn.addEventListener('click', (e) => copySessionContent(e.target.closest('.session'))); });
        document.querySelectorAll('.upload-code-btn').forEach(btn => { btn.addEventListener('click', () => { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.onchange = e => { const f = e.target.files[0]; if(f) { const reader = new FileReader(); reader.onload = ev => { const ta = btn.closest('.prompt-row').querySelector('textarea'); expandTextarea(ta); ta.value = ev.target.result; ta.dispatchEvent(new Event('input')); btn.closest('.prompt-row').classList.remove('collapsed'); }; reader.readAsText(f); } }; fileInput.click(); }); });
        document.querySelectorAll('.toggle-suggestions-btn').forEach(btn => { btn.addEventListener('click', e => { const popup = e.target.closest('.prompt-row').querySelector('.suggestions-popup'); const isVisible = popup.style.display === 'block'; document.querySelectorAll('.suggestions-popup').forEach(p => p.style.display = 'none'); if(!isVisible) { renderSuggestions(popup); popup.style.display = 'block'; } }); });
        document.querySelectorAll('.supreme-numbering-btn').forEach(btn => { btn.addEventListener('click', (e) => { const ta = e.target.closest('.prompt-row').querySelector('textarea'); expandTextarea(ta); let counter = 1; ta.value = ta.value.split('\n').map(line => { const trimmedLine = line.trim(); if (trimmedLine === '') return ''; return `${counter++}. ${trimmedLine.replace(/^\d+\.\s*/, '')}`; }).join('\n'); ta.dispatchEvent(new Event('input')); }); });
        document.querySelectorAll('.supreme-unnumbering-btn').forEach(btn => { btn.addEventListener('click', (e) => { const ta = e.target.closest('.prompt-row').querySelector('textarea'); expandTextarea(ta); ta.value = ta.value.split('\n').map(line => line.replace(/^\s*\d+\.\s*/, '')).join('\n'); ta.dispatchEvent(new Event('input')); }); });
        document.querySelectorAll('.selective-numbering-btn').forEach(btn => { btn.addEventListener('mousedown', (e) => { e.preventDefault(); const ta = e.target.closest('.prompt-row').querySelector('textarea'); expandTextarea(ta); const {selectionStart: start, selectionEnd: end, value: fullText} = ta; if (start === end) return; const before = fullText.substring(0, start), selected = fullText.substring(start, end), after = fullText.substring(end); const beforeLines = before.trimEnd().split('\n'); let lastNumber = 0; for (let i = beforeLines.length - 1; i >= 0; i--) { const match = beforeLines[i].match(/^\s*(\d+)\./); if (match) { lastNumber = parseInt(match[1], 10); break; } } let counter = lastNumber + 1; const numberedSelected = selected.split('\n').map(line => { if (line.trim() === '') return line; return `${counter++}. ${line.trim().replace(/^\d+\.\s*/, '')}`; }).join('\n'); ta.value = before + numberedSelected + after; ta.dispatchEvent(new Event('input')); ta.focus(); ta.selectionStart = start; ta.selectionEnd = before.length + numberedSelected.length; }); });
        document.querySelectorAll('.selective-unnumbering-btn').forEach(btn => { btn.addEventListener('mousedown', (e) => { e.preventDefault(); const ta = e.target.closest('.prompt-row').querySelector('textarea'); expandTextarea(ta); const {selectionStart: start, selectionEnd: end, value: fullText} = ta; if (start === end) return; const before = fullText.substring(0, start), selected = fullText.substring(start, end), after = fullText.substring(end); const unnumberedSelected = selected.split('\n').map(line => line.replace(/^\s*\d+\.\s*/, '')).join('\n'); ta.value = before + unnumberedSelected + after; ta.dispatchEvent(new Event('input')); ta.focus(); ta.selectionStart = start; ta.selectionEnd = before.length + unnumberedSelected.length; }); });
        document.querySelectorAll('.renumber-btn').forEach(btn => { btn.addEventListener('click', e => { const ta = e.target.closest('.prompt-row').querySelector('textarea'); expandTextarea(ta); ta.value = renumberContent(ta.value); ta.dispatchEvent(new Event('input')); }); });
        document.querySelectorAll('.numbering-chk').forEach(chk => { chk.addEventListener('change', function() { updateSessionData(this); }); });
        document.querySelectorAll('textarea[data-row-type="numbered"]').forEach(ta => { if(!ta.closest('#voice-ai-panel')) ta.addEventListener('keydown', handleNumberedInput); });
    }
    function renumberContent(text) { let counter = 1; return text.split('\n').map(line => { if (line.trim() === '') return line; const match = line.match(/^(\s*)(\d+)\.(.*)/); if (match) return `${match[1]}${counter++}.${match[3]}`; const trimmedLine = line.trim(); return trimmedLine ? `${counter++}. ${trimmedLine}` : line; }).join('\n'); }
    function updateSessionData(el) { const sessEl = el.closest('.session'), rowEl = el.closest('.prompt-row'); if(!sessEl || !rowEl) return; const sessId = parseFloat(sessEl.dataset.sessionId), rowId = parseInt(rowEl.dataset.rowId); const sess = sessions.find(s => s.id === sessId); if (!sess) return; const row = sess.rows.find(r => r.id === rowId); if (!row) return; if(el.tagName === 'TEXTAREA') { expandTextarea(el); row.content = el.value; } if(el.type === 'checkbox') row.isNumbered = el.checked; saveData('promptSessions', sessions); }
    function handleNumberedInput(e) { if (e.key !== 'Enter') return; const el = e.target; if(!el.closest('.prompt-row').querySelector('.numbering-chk')?.checked) return; e.preventDefault(); expandTextarea(el); const {selectionStart: cursorPos, value: text} = el, before = text.substring(0, cursorPos), after = text.substring(cursorPos); const currentLine = before.split('\n').pop(), match = currentLine.match(/^(\s*)(\d+)\.\s*/); if (match) { if (currentLine.trim() === match[0].trim()) { const lines = before.split('\n'); lines.pop(); let newBefore = lines.join('\n'); el.value = newBefore + '\n' + after; el.value = renumberContent(el.value); el.selectionStart = el.selectionEnd = newBefore.length + 1; el.dispatchEvent(new Event('input')); return; } const insert = `\n${match[1]}${parseInt(match[2]) + 1}. `; el.value = before + insert + after; el.selectionStart = el.selectionEnd = cursorPos + insert.length; } else { el.value = before + '\n' + after; el.selectionStart = el.selectionEnd = cursorPos + 1; } const oldLength = el.value.length, oldCursorPos = el.selectionStart; el.value = renumberContent(el.value); el.selectionStart = el.selectionEnd = oldCursorPos + (el.value.length - oldLength); el.dispatchEvent(new Event('input')); }
    function copySessionContent(sessionEl) { const sessId = parseFloat(sessionEl.dataset.sessionId); const sess = sessions.find(s => s.id === sessId); if(!sess) return; let text = ''; sess.rows.forEach(row => { let content = (row.content || '').trim(); if(!content || (row.isNumbered && !content.split('\n').filter(line => !line.trim().match(/^\d+\.\s*$/)).join('').trim())) return; if(row.type === 'general') text += content + '\n\n'; else if(row.type === 'code') text += '```\n' + content + '\n```\n\n'; else text += content + '\n\n'; }); navigator.clipboard.writeText(text.trim()).then(() => { const tick = sessionEl.querySelector('.copy-success-icon'); tick.style.display = 'inline-block'; setTimeout(() => { tick.style.display = 'none'; }, 1500); addToHistory(text.trim(), `B·∫£n sao: ${sess.customTitle}`); }); }
    function renderSuggestions(popup) { const list = popup.querySelector('.suggestion-list'); list.innerHTML = ''; suggestions.forEach((s, idx) => { const div = document.createElement('div'); div.className = 'suggestion-item'; div.dataset.id = idx; div.innerHTML = `<span class="suggestion-item-text">${escapeHtml(s)}</span> <span class="btn-delete" style="cursor:pointer; color:red;">&times;</span>`; div.querySelector('.suggestion-item-text').onclick = () => { const ta = popup.closest('.prompt-row').querySelector('textarea'); expandTextarea(ta); ta.value = ta.value.trim() ? (ta.value.trim() + ' ' + s) : s; ta.dispatchEvent(new Event('input')); popup.style.display = 'none'; }; div.querySelector('.btn-delete').onclick = () => { suggestions.splice(idx, 1); saveData('promptSuggestions', suggestions); renderSuggestions(popup); }; list.appendChild(div); }); new Sortable(list, { animation: 150, onEnd: (evt) => { const [movedItem] = suggestions.splice(evt.oldIndex, 1); suggestions.splice(evt.newIndex, 0, movedItem); saveData('promptSuggestions', suggestions); } }); const input = popup.querySelector('.add-new-sug-input'), saveBtn = popup.querySelector('.save-sug-btn'); const newSaveBtn = saveBtn.cloneNode(true); saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn); newSaveBtn.addEventListener('click', () => { if(input.value.trim()) { suggestions.unshift(input.value.trim()); saveData('promptSuggestions', suggestions); input.value = ''; renderSuggestions(popup); } }); }
    document.getElementById('file-upload').addEventListener('change', (e) => { Array.from(e.target.files).forEach(f => { const reader = new FileReader(); reader.onload = ev => { files.push({ id: Date.now() + Math.random(), name: f.name, content: ev.target.result, timestamp: getFormattedTime() }); saveData('promptFiles', files); renderFileList(); }; reader.readAsDataURL(f); }); e.target.value = ''; });
    function renderFileList() { const container = document.getElementById('file-list'); container.innerHTML = ''; files.forEach((f, idx) => { const div = document.createElement('div'); div.className = 'storage-item'; div.innerHTML = `<div class="item-header-row"><input type="text" class="item-name-input" value="${escapeHtml(f.name)}" spellcheck="false"><span class="item-time">${f.timestamp || ''}</span><button class="btn-sm btn-download" title="T·∫£i v·ªÅ">‚¨á</button><button class="btn-sm btn-delete" title="X√≥a">‚úï</button></div>`; div.querySelector('.item-name-input').onchange = (e) => { files[idx].name = e.target.value; saveData('promptFiles', files); }; div.querySelector('.btn-delete').onclick = () => { if(confirm('X√≥a file n√†y?')) { files.splice(idx, 1); saveData('promptFiles', files); renderFileList(); } }; div.querySelector('.btn-download').onclick = () => { const a = document.createElement('a'); a.href = f.content; a.download = f.name; a.click(); }; container.appendChild(div); }); }
    function addToHistory(text, defaultTitle) { history.unshift({ id: Date.now(), title: defaultTitle || new Date().toLocaleString(), content: text, timestamp: getFormattedTime() }); if(history.length > 50) history.pop(); saveData('promptHistory', history); renderHistoryList(); }
    function renderHistoryList() { const container = document.getElementById('history-list'); container.innerHTML = ''; history.forEach((h, idx) => { const div = document.createElement('div'); div.className = 'storage-item'; div.innerHTML = `<div class="item-header-row"><input type="text" class="item-name-input" value="${escapeHtml(h.title)}" spellcheck="false"><span class="item-time">${h.timestamp || ''}</span><button class="btn-sm btn-delete">‚úï</button></div><div class="history-content" title="Click ƒë·ªÉ m·ªü r·ªông">${escapeHtml(h.content.substring(0, 100))}${h.content.length>100?'...':''}</div>`; div.querySelector('.item-name-input').onchange = (e) => { history[idx].title = e.target.value; saveData('promptHistory', history); }; div.querySelector('.btn-delete').onclick = () => { history.splice(idx, 1); saveData('promptHistory', history); renderHistoryList(); }; const contentDiv = div.querySelector('.history-content'); contentDiv.onclick = () => { contentDiv.classList.toggle('expanded'); contentDiv.textContent = contentDiv.classList.contains('expanded') ? h.content : h.content.substring(0, 100) + (h.content.length>100?'...':''); }; container.appendChild(div); }); }
    document.getElementById('add-note-btn').onclick = () => { notes.unshift({ id: Date.now(), title: 'Ghi ch√∫ m·ªõi', content: '', timestamp: getFormattedTime() }); saveData('promptNotes', notes); renderNotes(); };
    function renderNotes() { const container = document.getElementById('notes-container'); container.innerHTML = ''; notes.forEach((n, idx) => { const div = document.createElement('div'); div.className = 'storage-item'; div.innerHTML = `<div class="item-header-row"><input type="text" class="item-name-input" value="${escapeHtml(n.title)}" placeholder="T√™n ghi ch√∫" spellcheck="false"><span class="item-time">${n.timestamp || ''}</span><button class="btn-sm btn-delete">‚úï</button></div><textarea class="note-content-area" placeholder="N·ªôi dung..." spellcheck="false">${escapeHtml(n.content)}</textarea>`; div.querySelector('.item-name-input').onchange = (e) => { notes[idx].title = e.target.value; saveData('promptNotes', notes); }; div.querySelector('textarea').oninput = (e) => { notes[idx].content = e.target.value; saveData('promptNotes', notes); }; div.querySelector('.btn-delete').onclick = () => { if(confirm('X√≥a ghi ch√∫ n√†y?')) { notes.splice(idx, 1); saveData('promptNotes', notes); renderNotes();} }; container.appendChild(div); }); }
    addSessionBtn.addEventListener('click', () => { const newSession = createNewSessionData(`Phi√™n ${new Date().toLocaleTimeString()}`); const lastPinnedIndex = sessions.map(s => s.isPinned).lastIndexOf(true); sessions.splice(lastPinnedIndex === -1 ? 0 : lastPinnedIndex + 1, 0, newSession); saveData('promptSessions', sessions); renderSessions(); window.scrollTo(0,0); });
    collapseAllBtn.addEventListener('click', () => { const allRows = document.querySelectorAll('#prompt-view .prompt-row'); const hasExpanded = [...allRows].some(r => !r.classList.contains('collapsed')); allRows.forEach(r => r.classList.toggle('collapsed', hasExpanded)); });
    window.openTab = (evt, tabId) => { document.querySelectorAll('.tab-content, .tab-button').forEach(el => el.classList.remove('active')); document.getElementById(tabId).classList.add('active'); evt.currentTarget.classList.add('active'); };
    document.addEventListener('click', (e) => { if (!e.target.closest('.suggestions-popup, .toggle-suggestions-btn')) { document.querySelectorAll('.suggestions-popup').forEach(p => p.style.display = 'none'); } });

    async function initializeApp() {
        GIST_ID = localStorage.getItem('promptGistId') || '';
        GITHUB_TOKEN = localStorage.getItem('promptGistToken') || '';

        let loadedFromGist = false;
        if (GIST_ID && GITHUB_TOKEN) {
            const result = await loadSessionsFromGist();
            if (result !== null) { loadedFromGist = true; }
        } else {
            updateGistStatus('Ch∆∞a c·∫•u h√¨nh ƒë·ªìng b·ªô.');
        }

        loadLocalData(loadedFromGist);
        renderAll();
    }
    
    initializeApp();
});
</script>
</body>
</html>

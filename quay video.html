
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hệ Thống Kiểm Định Video & Hình Ảnh</title>
    <!-- Thư viện hỗ trợ tạo file ZIP và lưu file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* --- GLOBAL STYLES --- */
        :root {
            --color-primary: #007bff;
            --color-secondary: #6c757d;
            --color-danger: #dc3545;
            --color-success: #28a745;
            --color-dark: #343a40;
            --color-light-gray: #f8f9fa;
            --color-border: #dee2e6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f9;
        }
        .section-container {
            max-width: 800px;
            margin: 25px auto;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.1);
            border: 1px solid #eef;
        }
        h1, h2, h3 {
            color: var(--color-dark);
            border-bottom: 2px solid #eef;
            padding-bottom: 10px;
            text-align: center;
        }
        h1 { color: #0056b3; }

        /* --- SHARED BUTTON & FORM STYLES --- */
        button, a.btn {
            padding: 12px 20px;
            font-size: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
            text-decoration: none;
            display: inline-block;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- VIDEO RECORDER STYLES (SECTION 1) --- */
        .video-recorder .form-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .video-recorder input[type="text"], .video-recorder select { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        .video-recorder .btn-add { background-color: #28a745; color: white; }
        .video-recorder .btn-record { background-color: #1a73e8; color: white; }
        .video-recorder .btn-stop { background-color: #dc3545; color: white; }
        .video-recorder .btn-download { background-color: #1e8e3e; color: white; }
        .video-recorder .btn-delete-item { background-color: #6c757d; color: white; }
        .video-recorder .btn-delete-all { background-color: #c82333; color: white; width: 100%; margin-top: 10px; }
        .video-recorder video { width: 100%; border-radius: 8px; background-color: #000; margin-bottom: 15px; }
        .video-recorder .item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px; }
        .video-recorder .item-name { font-weight: 500; word-break: break-word; }
        .video-recorder .item-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .video-recorder .status-bar { text-align: center; font-weight: bold; padding: 10px; border-radius: 5px; margin-top: 15px; display: none; }
        .video-recorder .status-recording { background-color: #ffe0e3; color: #dc3545; }
        .video-recorder .status-processing { background-color: #cce5ff; color: #004085; }
        .video-recorder .status-error { background-color: #fff3cd; color: #856404; }

        /* --- PHOTO CAPTURE STYLES (SECTION 2) --- */
        .photo-capture .action-button {
            padding: 15px 25px; font-size: 1.2rem; margin-top: 10px; margin-right: 10px;
        }
        .photo-capture .start-button { background-color: var(--color-success); color: white; }
        .photo-capture .download-button { background-color: var(--color-primary); color: white; }
        
        /* --- CAMERA MODAL STYLES --- */
        #camera-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 10000;
            display: none; flex-direction: column; justify-content: flex-start;
            align-items: center; gap: 15px; padding-top: 20px;
            box-sizing: border-box; overflow-y: auto;
        }
        #camera-modal #camera-video {
            width: 90%; max-width: 600px; height: auto;
            border: 2px solid white; border-radius: 8px;
        }
        #camera-modal #modal-actions { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        #camera-modal #modal-actions button { padding: 12px 25px; font-size: 1.2rem; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; }
        #camera-modal #capture-btn { background-color: var(--color-primary); color: white; }
        #camera-modal #close-btn { background-color: var(--color-danger); color: white; }
        #camera-modal #error-message {
            color: yellow; background-color: rgba(255, 0, 0, 0.5);
            padding: 10px; border-radius: 5px; text-align: center;
            max-width: 90%; display: none;
        }
        #camera-modal #photo-grid-container { width: 100%; max-width: 90%; margin-top: 15px; }
        #camera-modal #photo-grid-container h3 { color: white; text-align: center; border-bottom: 1px solid #555; padding-bottom: 10px; }
        #camera-modal #photo-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; padding-bottom: 20px;
        }
        #camera-modal .photo-box {
            position: relative; border: 2px dashed #aaa; background-color: rgba(255, 255, 255, 0.1);
            aspect-ratio: 1 / 1; display: flex; align-items: center;
            justify-content: center; border-radius: 5px; overflow: hidden;
        }
        #camera-modal .photo-box span { font-size: 3rem; color: #888; }
        #camera-modal .photo-box img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <h1>Hệ Thống Kiểm Định Video & Hình Ảnh</h1>

    <!-- =================================================================== -->
    <!-- PHẦN 1: HỆ THỐNG QUAY VIDEO                                          -->
    <!-- =================================================================== -->
    <div class="section-container video-recorder">
        <h2>Phần 1: Hệ Thống Quay Video (Không Âm Thanh)</h2>
        <div class="setup-section">
            <h3>1. Thiết lập hạng mục</h3>
            <div class="form-group">
                <input type="text" id="item-name-input" placeholder="Nhập tên hạng mục (ví dụ: Kiểm tra động cơ)">
                <button id="add-item-btn" class="btn-add">Thêm</button>
            </div>
            <div class="form-group">
                <label for="compression-level" style="flex-shrink: 0; align-self: center;">Mức nén video:</label>
                <select id="compression-level">
                    <option value="high">Chất lượng cao (720p)</option>
                    <option value="medium" selected>Trung bình (480p)</option>
                    <option value="max">Nén tối đa (360p)</option>
                </select>
            </div>
            <button id="delete-all-btn" class="btn-delete-all">Xóa Toàn Bộ Dữ Liệu Video</button>
        </div>
        <video id="video-preview" playsinline autoplay muted style="display: none;"></video>
        <div id="status-bar" class="status-bar"></div>
        <div class="list-section">
            <h3>2. Danh sách quay</h3>
            <div id="inspection-list"></div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- PHẦN 2: HỆ THỐNG CHỤP ẢNH                                             -->
    <!-- =================================================================== -->
    <div class="section-container photo-capture">
        <h2>Phần 2: Hệ Thống Chụp Ảnh</h2>
        <p>Nhấn "Mở Camera" để mở lớp phủ camera. Bạn có thể chụp liên tục. Nếu không hoạt động, hãy chắc chắn bạn đã cấp quyền và đang dùng HTTPS.</p>
        <button id="open-btn" class="action-button start-button">Mở Camera Chụp Ảnh</button>
        <button id="download-zip-btn" class="action-button download-button">Tải Tất Cả Ảnh (ZIP)</button>
    </div>

    <!-- MODAL CHO CHỨC NĂNG CHỤP ẢNH (NẰM NGOÀI CÙNG) -->
    <div id="camera-modal">
        <div id="error-message"></div>
        <video id="camera-video" playsinline></video>
        <canvas id="camera-canvas" style="display: none;"></canvas>
        <div id="modal-actions">
            <button id="capture-btn">Chụp</button>
            <button id="close-btn">Đóng</button>
        </div>
        <div id="photo-grid-container">
            <h3>Ảnh Đã Chụp</h3>
            <div id="photo-grid">
                <!-- Các ô ảnh sẽ được tạo bởi JavaScript -->
            </div>
        </div>
    </div>

<script>
    // ====================================================================== //
    // LOGIC CHO PHẦN 1: HỆ THỐNG QUAY VIDEO                                  //
    // ====================================================================== //
    (function() {
        const STORAGE_KEY = 'inspectionVideoApp_items_muted';

        const itemNameInput = document.getElementById('item-name-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const deleteAllBtn = document.getElementById('delete-all-btn');
        const compressionSelect = document.getElementById('compression-level');
        const videoEl = document.getElementById('video-preview');
        const itemListDiv = document.getElementById('inspection-list');
        const statusBar = document.getElementById('status-bar');

        let inspectionItems = [];
        let mediaRecorder, stream, recordedChunks = [];
        let currentlyRecordingIndex = null;

        const compressionPresets = {
            high: { width: { ideal: 1280 }, height: { ideal: 720 }, bitrate: 2500000 },
            medium: { width: { ideal: 854 }, height: { ideal: 480 }, bitrate: 1000000 },
            max: { width: { ideal: 640 }, height: { ideal: 360 }, bitrate: 500000 }
        };

        function saveItemsToLocalStorage() {
            const savableItems = inspectionItems.map(item => ({ name: item.name, status: item.status === 'done' ? 'new' : item.status }));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(savableItems));
        }

        function loadItemsFromLocalStorage() {
            const storedItems = localStorage.getItem(STORAGE_KEY);
            if (storedItems) {
                inspectionItems = JSON.parse(storedItems);
                inspectionItems.forEach(item => { if (item.status === 'recording' || item.status === 'done') item.status = 'new'; });
            }
        }

        function renderItems() {
            itemListDiv.innerHTML = '';
            if (inspectionItems.length === 0) {
                itemListDiv.innerHTML = '<p style="text-align: center; color: #888;">Chưa có hạng mục nào.</p>';
                return;
            }
            inspectionItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                
                let actionsHtml = '';
                const isAnotherRecording = currentlyRecordingIndex !== null && currentlyRecordingIndex !== index;

                switch (item.status) {
                    case 'recording':
                        actionsHtml = `<button class="btn-stop" data-index="${index}">Dừng</button>`;
                        break;
                    case 'done':
                        actionsHtml = `<a class="btn btn-download" href="${item.videoUrl}" download="${sanitizeFileName(item.name)}.${item.fileExtension}">Tải Lại</a>`;
                        break;
                    default:
                        actionsHtml = `<button class="btn-record" data-index="${index}" ${isAnotherRecording ? 'disabled' : ''}>Quay</button>`;
                }

                itemDiv.innerHTML = `
                    <span class="item-name">${item.name}</span>
                    <div class="item-actions">
                        ${actionsHtml}
                        <button class="btn-delete-item" data-index="${index}">Xóa</button>
                    </div>
                `;
                itemListDiv.appendChild(itemDiv);
            });
        }

        async function startRecording(index) {
            currentlyRecordingIndex = index;
            const item = inspectionItems[index];
            item.status = 'recording';
            renderItems();
            
            const preset = compressionPresets[compressionSelect.value];
            const mediaConstraints = {
                video: {
                    width: preset.width,
                    height: preset.height,
                    facingMode: { exact: "environment" }
                },
                audio: false
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(mediaConstraints);
                videoEl.srcObject = stream;
                videoEl.style.display = 'block';
                
                statusBar.textContent = `Đang quay: ${item.name} (Không có âm thanh)`;
                statusBar.className = 'status-bar status-recording';
                statusBar.style.display = 'block';

                let mimeType = 'video/mp4';
                if (!MediaRecorder.isTypeSupported('video/mp4')) mimeType = 'video/webm';
                
                mediaRecorder = new MediaRecorder(stream, { mimeType, videoBitsPerSecond: preset.bitrate });
                mediaRecorder.ondataavailable = e => e.data.size > 0 && recordedChunks.push(e.data);
                mediaRecorder.onstop = () => handleStop(index);
                mediaRecorder.start();

            } catch (err) {
                statusBar.textContent = 'LỖI: Không thể truy cập camera sau. Vui lòng kiểm tra quyền và thiết bị.';
                statusBar.className = 'status-bar status-error';
                statusBar.style.display = 'block';
                videoEl.style.display = 'none';
                item.status = 'new';
                currentlyRecordingIndex = null;
                renderItems();
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
        }

        function handleStop(index) {
            const fileExtension = mediaRecorder.mimeType.includes('mp4') ? 'mp4' : 'webm';
            const videoBlob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
            recordedChunks = [];

            const item = inspectionItems[index];
            const fileName = sanitizeFileName(item.name);

            autoDownloadBackup(videoBlob, `${fileName}_BACKUP.${fileExtension}`);
            
            item.status = 'done';
            item.videoUrl = URL.createObjectURL(videoBlob);
            item.fileExtension = fileExtension;

            currentlyRecordingIndex = null;
            stream.getTracks().forEach(track => track.stop());
            videoEl.style.display = 'none';
            
            statusBar.textContent = `Đã quay xong! File backup (không tiếng) đã được tự động tải về.`;
            statusBar.className = 'status-bar status-processing';

            saveItemsToLocalStorage();
            renderItems();
        }

        function autoDownloadBackup(blob, fileName) {
            const a = document.createElement('a');
            a.style.display = 'none';
            const url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        function sanitizeFileName(name) {
            return name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_.-]/g, '');
        }

        addItemBtn.addEventListener('click', () => {
            const name = itemNameInput.value.trim();
            if (name) {
                inspectionItems.push({ name: name, status: 'new' });
                itemNameInput.value = '';
                saveItemsToLocalStorage();
                renderItems();
            } else {
                alert('Vui lòng nhập tên hạng mục.');
            }
        });

        deleteAllBtn.addEventListener('click', () => {
            if (confirm('CẢNH BÁO: Bạn có chắc chắn muốn xóa TOÀN BỘ danh sách hạng mục video không?')) {
                inspectionItems = [];
                saveItemsToLocalStorage();
                renderItems();
            }
        });

        itemListDiv.addEventListener('click', (e) => {
            const target = e.target;
            const index = parseInt(target.dataset.index, 10);
            if (target.matches('.btn-record')) startRecording(index);
            else if (target.matches('.btn-stop')) stopRecording();
            else if (target.matches('.btn-delete-item')) {
                if (confirm(`Bạn có muốn xóa hạng mục "${inspectionItems[index].name}"?`)) {
                    inspectionItems.splice(index, 1);
                    saveItemsToLocalStorage();
                    renderItems();
                }
            }
        });

        loadItemsFromLocalStorage();
        renderItems();
    })();

    // ====================================================================== //
    // LOGIC CHO PHẦN 2: HỆ THỐNG CHỤP ẢNH                                    //
    // ====================================================================== //
    (function() {
        const photoGrid = document.getElementById('photo-grid');
        const NUM_BOXES = 20;
        let photoBoxes = [];
        let capturedImageBlobs = [];

        function initializeGrid() {
            photoGrid.innerHTML = '';
            photoBoxes = [];
            for (let i = 0; i < NUM_BOXES; i++) {
                const box = document.createElement('div');
                box.className = 'photo-box empty';
                box.innerHTML = `<span>+</span>`;
                photoGrid.appendChild(box);
                photoBoxes.push(box);
            }
        }

        function findFirstEmptyBox() {
            return photoBoxes.find(box => box.classList.contains('empty'));
        }

        async function addPhotoToGrid(imageBlob) {
            capturedImageBlobs.push(imageBlob);
            const emptyBox = findFirstEmptyBox();
            if (emptyBox) {
                emptyBox.innerHTML = '';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(imageBlob);
                emptyBox.appendChild(img);
                emptyBox.classList.remove('empty');
                img.onload = () => {
                    URL.revokeObjectURL(img.src);
                }
            } else {
                alert("Đã hết ô trống để thêm ảnh!");
            }
        }

        const camera = {
            modal: document.getElementById('camera-modal'),
            video: document.getElementById('camera-video'),
            canvas: document.getElementById('camera-canvas'),
            openBtn: document.getElementById('open-btn'),
            closeBtn: document.getElementById('close-btn'),
            captureBtn: document.getElementById('capture-btn'),
            errorMsg: document.getElementById('error-message'),
            stream: null
        };

        async function startCamera() {
            camera.errorMsg.style.display = 'none';
            try {
                if (camera.stream) stopCamera();
                camera.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }
                });
                camera.video.srcObject = camera.stream;
                await camera.video.play();
                camera.modal.style.display = 'flex';
            } catch (err) {
                console.error("Camera Error:", err);
                let message = `Lỗi không thể truy cập camera: ${err.name}.`;
                if (window.location.protocol !== 'https:') {
                    message += '<br><b>Gợi ý:</b> Tính năng này thường yêu cầu trang web chạy trên HTTPS.';
                } else {
                    message += '<br><b>Gợi ý:</b> Vui lòng kiểm tra lại bạn đã cấp quyền truy cập camera cho trang web này trong cài đặt của trình duyệt.';
                }
                camera.errorMsg.innerHTML = message;
                camera.errorMsg.style.display = 'block';
                camera.modal.style.display = 'flex';
            }
        }

        function stopCamera() {
            if (camera.stream) {
                camera.stream.getTracks().forEach(track => track.stop());
                camera.stream = null;
            }
            camera.video.srcObject = null;
            camera.modal.style.display = 'none';
        }

        function capturePhoto() {
            if (!camera.video.videoWidth) return;
            const ctx = camera.canvas.getContext('2d');
            camera.canvas.width = camera.video.videoWidth;
            camera.canvas.height = camera.video.videoHeight;
            ctx.drawImage(camera.video, 0, 0, camera.canvas.width, camera.canvas.height);
            camera.canvas.toBlob(blob => {
                addPhotoToGrid(blob);
            }, 'image/jpeg', 0.9);
        }

        camera.openBtn.addEventListener('click', startCamera);
        camera.closeBtn.addEventListener('click', stopCamera);
        camera.captureBtn.addEventListener('click', capturePhoto);

        const downloadZipBtn = document.getElementById('download-zip-btn');
        async function downloadAllAsZip() {
            if (capturedImageBlobs.length === 0) {
                alert("Chưa có ảnh nào để tải về!");
                return;
            }
            downloadZipBtn.textContent = "Đang nén file...";
            downloadZipBtn.disabled = true;

            const zip = new JSZip();
            capturedImageBlobs.forEach((blob, index) => {
                zip.file(`photo_${index + 1}.jpeg`, blob);
            });

            try {
                const zipBlob = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 9 }
                });
                saveAs(zipBlob, "captured-images.zip");
            } catch (err) {
                console.error("Lỗi khi tạo file zip:", err);
                alert("Đã có lỗi xảy ra trong quá trình nén file.");
            } finally {
                downloadZipBtn.textContent = "Tải Tất Cả Ảnh (ZIP)";
                downloadZipBtn.disabled = false;
            }
        }
        downloadZipBtn.addEventListener('click', downloadAllAsZip);

        document.addEventListener('DOMContentLoaded', initializeGrid);
    })();
</script>
</body>
</html>

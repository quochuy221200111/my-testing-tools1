
<!DOCTYPE html>
<html>
<head>
<title>S·∫Øp x·∫øp ·∫£nh - Giao di·ªán m·ªõi (ƒê√£ n√¢ng c·∫•p Pro)</title>
<meta charset="UTF-8">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
    /* === CSS CHUNG === */
    body { font-family: sans-serif; margin: 0; background-color: #f4f4f4; color: #333; }
    h3 { margin: 0 0 10px 0; font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    textarea { width: 100%; box-sizing: border-box; }

    /* === Y√äU C·∫¶U 1: THU G·ªåN GIAO DI·ªÜN === */
    button, label.custom-file-label, select { padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background-color 0.2s; white-space: nowrap; text-align: center; }
    button:hover, label.custom-file-label:hover { opacity: 0.85; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    input[type="file"].custom-file-input { display: none; }

    /* === B·ªê C·ª§C T·ªîNG TH·ªÇ === */
    .page-wrapper { display: flex; height: 100vh; gap: 15px; transition: margin-left 0.3s ease-in-out; }
    
    /* === Y√äU C·∫¶U 3: CSS CHO THANH C√îNG C·ª§ T·ª∞ ƒê·ªòNG CU·ªòN === */
    #toolbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 450px; /* ƒê·ªô r·ªông c·ªßa thanh c√¥ng c·ª• */
        height: 100vh;
        background-color: #fff;
        border-right: 1px solid #ddd;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        z-index: 2000;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        padding: 8px;
        box-sizing: border-box;
    }
    #toolbar.visible {
        transform: translateX(0);
    }
    .page-wrapper.toolbar-pinned {
        margin-left: 450px; /* ƒê·∫©y n·ªôi dung ch√≠nh sang ph·∫£i khi toolbar ƒë∆∞·ª£c ghim */
    }
    .toolbar-content {
        overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu n·ªôi dung qu√° d√†i */
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: 100%;
    }
    /* N√∫t ghim thanh c√¥ng c·ª• */
    #pin-toolbar-btn {
        position: absolute;
        top: 10px;
        right: -30px; /* N·∫±m ngay b√™n ngo√†i thanh c√¥ng c·ª• */
        width: 30px;
        height: 30px;
        border-radius: 0 5px 5px 0;
        border-left: none;
        font-size: 18px;
        line-height: 30px;
        padding: 0;
        background-color: #6c757d;
    }
    /* === K·∫æT TH√öC CSS Y√äU C·∫¶U 3 === */

    .main-column { flex: 1; display: flex; flex-direction: column; min-width: 500px; overflow-y: hidden; transition: all 0.3s ease; }
    .main-content { padding: 15px; overflow-y: auto; flex-grow: 1; }

    .preview-column {
        width: 50%; max-width: 50%; flex-shrink: 0; background-color: #e9ecef;
        padding: 15px; display: flex; flex-direction: column; position: sticky;
        top: 0; height: 100vh; box-sizing: border-box; transition: all 0.3s ease;
    }
    .page-wrapper.preview-hidden .preview-column { display: none; }
    
    /* === Y√äU C·∫¶U M·ªöI: CSS cho ch·∫ø ƒë·ªô ·∫©n l∆∞·ªõi ·∫£nh === */
    .page-wrapper.grid-hidden .main-column {
        display: none;
    }
    .page-wrapper.grid-hidden .preview-column {
        width: 100%;
        max-width: 100%;
    }

    /* === THANH C√îNG C·ª§ (ƒê√É THU G·ªåN) === */
    .control-wrapper { display: flex; gap: 10px; width: 100%; }
    .control-area { flex: 1; display: flex; }
    .control-group { display: flex; flex-direction: column; gap: 5px; padding: 8px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #fcfcfc; width: 100%; }
    .action-buttons, .name-options { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .action-buttons > * { flex-grow: 1; }
    .action-buttons label { display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 13px; }

    #paste-zone { padding: 6px; border: 2px dashed #ccc; border-radius: 4px; text-align: center; color: #666; background-color: #fafafa; transition: background-color 0.2s, border-color 0.2s; font-size: 13px; }
    #paste-zone.drag-over { background-color: #e0e0e0; border-color: #007bff; }

    #name-list { 
        resize: vertical; min-height: 40px; height: 80px; padding: 5px; 
        border: 1px solid #ccc; border-radius: 4px; 
        font-family: monospace; line-height: 1.5; white-space: pre; font-size: 12px;
    }
    #range-inputs-container { display: flex; gap: 5px; align-items: center; }
    #range-inputs-container input[type="number"] { width: 45px; padding: 3px; font-size: 12px; }
    
    /* === Y√äU C·∫¶U M·ªöI: CSS CHO THANH TI·∫æN TR√åNH GI·ªÆA M√ÄN H√åNH === */
    #progress-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: none; /* S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅu khi·ªÉn b·∫±ng JS */
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
        color: white;
    }
    .progress-bar-container {
        width: 50%;
        max-width: 500px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #progress-text {
        margin: 0 0 10px 0;
        font-size: 1.1em;
        color: #333;
    }
    #upload-progress, #download-progress {
        width: 100%;
        height: 15px;
        display: block; /* Hi·ªÉn th·ªã trong container */
        margin-top: 8px;
    }
    #upload-progress::-webkit-progress-bar, #download-progress::-webkit-progress-bar { background-color: #eee; border-radius: 5px; }
    #upload-progress::-webkit-progress-value { background-color: #28a745; border-radius: 5px; transition: width 0.1s linear; }
    #download-progress::-webkit-progress-value { background-color: #007bff; border-radius: 5px; transition: width 0.1s linear; }
    /* ============================================================= */

    /* === Y√äU C·∫¶U 1: THU G·ªåN KHU V·ª∞C CH·∫æ ƒê·ªò S·ªê LI·ªÜU === */
    #numeric-mode-controls .control-group { gap: 8px; }
    #numeric-mode-controls h3 { font-size: 1em; text-align: center; margin-bottom: 5px; }
    #numeric-mode-controls .options-container { display: flex; flex-direction: column; gap: 8px; }
    #numeric-mode-controls .option-row { display: flex; align-items: center; gap: 8px; }
    #numeric-mode-controls label { white-space: nowrap; font-size: 13px; }
    #numeric-mode-controls select { padding: 4px 8px; font-size: 12px; }
    #numeric-mode-controls textarea { min-height: 40px !important; font-size: 12px; }
    #numeric-mode-controls .action-row { display:flex; gap: 8px; }
    #numeric-mode-controls .action-row button { flex: 1; }
    
    /* === Y√äU C·∫¶U 1 & 2: CSS CHO C√ÄI ƒê·∫∂T V√Ä GHI CH√ö === */
    .hotkey-setting { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 5px; }
    .hotkey-setting label { font-size: 13px; white-space: nowrap; }
    .hotkey-setting input { width: 100px; text-align: center; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; }
    #local-note-area { min-height: 80px; resize: vertical; font-size: 13px; }

    /* === XEM TR∆Ø·ªöC ·∫¢NH === */
    #large-preview-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; background-color: #333; border-radius: 8px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); overflow: hidden; min-height: 0; position: relative; cursor: grab; user-select: none; }
    #large-preview-container:active { cursor: grabbing; }
    #large-preview-img { max-width: 100%; max-height: 100%; object-fit: contain; transform-origin: center center; will-change: transform; pointer-events: none; user-select: none; -webkit-user-drag: none; }
    .preview-placeholder { color: #ccc; font-size: 1.2em; pointer-events: none; }
    .preview-controls { display: flex; justify-content: space-between; margin-bottom: 5px; align-items: center; flex-wrap: wrap; gap: 5px; }
    #preview-name-input { flex-grow: 1; margin: 0 10px; padding: 4px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 13px; }
    .rotate-controls { display: flex; gap: 5px; }
    #suggestion-buttons-container { margin-top: 10px; }
    #suggestion-buttons { display:flex; flex-wrap:wrap; gap:5px; }
    #suggestion-buttons button.suggestion-selected { background-color: #28a745; border: 2px solid #1e7e34; font-weight: bold; }

    /* === Y√äU C·∫¶U 3: CSS CHO G·ª¢I √ù CHI TI·∫æT === */
    #fine-grained-suggestions { margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; display:flex; flex-wrap:wrap; gap:4px; min-height: 25px; }
    #fine-grained-suggestions button { font-size: 11px; padding: 3px 6px; background-color: #6c757d; }

    /* === PHOTO GRID === */
    .photo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .photo-grid.dense-mode { grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; }
    .photo-grid.dense-mode .name-container input[type="text"] { font-size: 9px; padding: 1px 2px; height: 20px; }
    .photo-wrapper.hidden-by-filter { display: none; }
    .photo-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; }
    .img-container { position: relative; width: 100%; padding-top: 75%; overflow: hidden; border-radius: 4px; background-color: #eee; cursor: pointer; transition: outline 0.2s ease-in-out, border 0.2s; }
    
    /* === Y√äU C·∫¶U M·ªöI: CSS cho vi·ªÅn ·∫£nh === */
    .photo-wrapper.is-tall .img-container { border: 3px solid red; } /* ·∫¢nh d·ªçc */
    .photo-wrapper.is-small .img-container { border: 3px solid #007bff; } /* ·∫¢nh dung l∆∞·ª£ng nh·ªè */

    .photo-item { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border: none; pointer-events: none; }
    .delete-btn, .exclude-numeric-btn, .replace-btn { position: absolute; z-index: 10; width: 22px; height: 22px; background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 22px; text-align: center; padding: 0; opacity: 0; transition: opacity 0.2s; }
    .delete-btn { top: 4px; right: 4px; }
    .exclude-numeric-btn { top: 4px; left: 4px; display: none; }
    body.numeric-mode .exclude-numeric-btn { display: block; }

    /* === Y√äU C·∫¶U M·ªöI: CSS cho n√∫t v√† panel thay th·∫ø ·∫£nh === */
    .replace-btn { bottom: 4px; left: 4px; font-size: 16px; }
    .replace-panel {
        display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
        position: absolute;
        bottom: 30px; /* Hi·ªán l√™n tr√™n n√∫t b·∫•m */
        left: 4px;
        z-index: 20;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        flex-direction: column;
        gap: 5px;
    }
    .replace-panel button { width: 100%; font-size: 12px; }
    /* ======================================================== */

    .photo-wrapper:hover .delete-btn, .photo-wrapper:hover .exclude-numeric-btn, .photo-wrapper:hover .replace-btn { opacity: 1; }
    .name-container { display: flex; align-items: center; width: 100%; margin-top: 5px; }
    .name-container input[type="text"] { flex: 1; padding: 3px 4px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 3px; min-width: 0; font-size: 10.5px; height: 24px; }

    /* === SORTABLE & EFFECTS === */
    .ghost-class { opacity: 0.4; background-color: #c0e0ff; border: 2px dashed #007bff; }
    .drag-class { opacity: 0.8; transform: scale(1.05); } 
    .selected-photo .img-container { outline: 3px solid #007bff; outline-offset: 2px; }
    @keyframes yellow-flash { from { outline: 4px solid gold; } to { outline: 4px solid transparent; } }
    .newly-added .img-container { animation: yellow-flash 1.5s ease-out; }
</style>
</head>
<body id="page-body">

<!-- === Y√äU C·∫¶U M·ªöI: THANH TI·∫æN TR√åNH T·∫¢I L√äN (OVERLAY) === -->
<div id="progress-overlay">
    <div class="progress-bar-container">
        <p id="progress-text">ƒêang x·ª≠ l√Ω...</p>
        <progress id="upload-progress" value="0" max="100"></progress>
        <progress id="download-progress" value="0" max="100" style="display:none;"></progress>
    </div>
</div>


<!-- THANH C√îNG C·ª§ -->
<div id="toolbar">
    <button id="pin-toolbar-btn" title="Ghim/B·ªè ghim thanh c√¥ng c·ª• (T·ª± ƒë·ªông l∆∞u)">üìå</button>
    <div class="toolbar-content">
        <div class="control-wrapper">
            <div class="control-area">
                <div class="control-group">
                    <div class="action-buttons">
                        <label for="photo-input" class="custom-file-label">T·∫£i ·∫£nh/ZIP</label>
                        <div id="paste-zone">Ho·∫∑c k√©o th·∫£ / d√°n ·∫£nh</div>
                        <button id="clear-btn" style="background-color: #dc3545;">X√≥a t·∫•t c·∫£</button>
                        <button id="delete-selected-btn" style="background-color: #ffc107; color: #333;">X√≥a ƒë√£ ch·ªçn</button>
                        <button id="download-all-btn">T·∫£i t·∫•t c·∫£</button>
                        <button id="undo-btn">Ho√†n t√°c</button>
                        <button id="grid-toggle-btn" style="background-color: #6c757d;">Ch·∫ø ƒë·ªô l∆∞·ªõi x2</button>
                        <button id="toggle-preview-btn">·∫®n Preview</button>
                        <button id="hide-all-images-btn" style="background-color: #6c757d;">·∫®n/Hi·ªán L∆∞·ªõi ·∫¢nh</button>
                        <button id="highlight-tall-btn">·∫¢nh d·ªçc</button>
                        <button id="numeric-filter-btn" style="background-color: #17a2b8;">Ch·∫ø ƒë·ªô S·ªë li·ªáu</button>
                        <button id="prev-image-btn" title="Chuy·ªÉn ƒë·∫øn ·∫£nh ph√≠a tr∆∞·ªõc">·∫¢nh Tr∆∞·ªõc</button>
                        <button id="next-image-btn" title="Chuy·ªÉn ƒë·∫øn ·∫£nh k·∫ø ti·∫øp">·∫¢nh Sau</button>
                        <label><input type="checkbox" id="lock-toggle"> Kh√≥a</label>
                        <label><input type="checkbox" id="smart-select-toggle"> B·∫≠t ch·ªçn s·ªë</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="control-wrapper">
             <div class="control-area">
                <div class="control-group">
                    <div class="name-options">
                        <textarea id="name-list" placeholder="Danh s√°ch t√™n..."></textarea>
                        <div style="display:flex; flex-direction:column; gap: 5px; align-self: flex-end; width: 100%;">
                            <div id="range-name-options">
                                <label><input type="checkbox" id="range-name-toggle"> Ch√®n t√™n theo kho·∫£ng</label>
                                <div id="range-inputs-container" style="display: none;">
                                    <label for="name-range-start">T·ª´:</label>
                                    <input type="number" id="name-range-start" value="1" min="1">
                                    <label for="name-range-end">ƒê·∫øn:</label>
                                    <input type="number" id="name-range-end" value="10" min="1">
                                    <label title="S·ª≠ d·ª•ng d√≤ng ƒë·∫ßu ti√™n trong danh s√°ch t√™n cho t·∫•t c·∫£ ·∫£nh trong kho·∫£ng ƒë√£ ch·ªçn"><input type="checkbox" id="apply-single-name-toggle"> D√πng 1 t√™n</label>
                                </div>
                            </div>
                            <button id="assign-names-btn">Ch√®n t√™n t·ª´ danh s√°ch</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="numeric-mode-controls" class="control-wrapper" style="display: none;">
            <div class="control-group" style="width:100%;">
                <h3 style="text-align:center;">T√πy ch·ªçn Ch·∫ø ƒë·ªô S·ªë li·ªáu</h3>
                <div class="options-container">
                    <div class="option-row">
                        <label for="suggestion-count-select">S·ªë g·ª£i √Ω m·ªói ·∫£nh:</label>
                        <select id="suggestion-count-select">
                            <option value="1">1</option>
                            <option value="3" selected>3</option> <option value="5">5</option> <option value="7">7</option> <option value="9">9</option>
                        </select>
                        <textarea id="numeric-name-suggestions" placeholder="D√°n danh s√°ch t√™n g·ª£i √Ω v√†o ƒë√¢y..." style="flex-grow:1;"></textarea>
                    </div>
                     <div class="option-row">
                         <label for="numeric-filtered-names-list">Danh s√°ch t√™n ·∫£nh ƒëang hi·ªÉn th·ªã:</label>
                         <textarea id="numeric-filtered-names-list" readonly placeholder="T√™n c√°c ·∫£nh ƒë√£ l·ªçc s·∫Ω hi·ªán ·ªü ƒë√¢y..." style="flex-grow:1; background-color: #e9ecef;"></textarea>
                     </div>
                    <div class="action-row">
                        <button id="apply-numeric-suggestions-btn">G√°n T√™n G·ª£i √ù</button>
                        <button id="download-numeric-btn" style="background-color: #28a745;">T·∫£i ·∫£nh ƒë√£ l·ªçc</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <h3>Ghi ch√∫ (T·ª± ƒë·ªông l∆∞u)</h3>
            <textarea id="local-note-area" placeholder="Ghi ch√∫ nhanh c·ªßa b·∫°n..."></textarea>
        </div>
        
        <div class="control-group">
            <h3>C√†i ƒë·∫∑t ph√≠m t·∫Øt (T·ª± ƒë·ªông l∆∞u)</h3>
            <div id="hotkey-settings">
                 <div class="hotkey-setting">
                    <label for="hotkey-next-image">Chuy·ªÉn ·∫£nh ti·∫øp theo:</label>
                    <input type="text" id="hotkey-next-image" data-action="nextImage">
                </div>
                <div class="hotkey-setting">
                    <label for="hotkey-prev-image">Chuy·ªÉn ·∫£nh ph√≠a tr∆∞·ªõc:</label>
                    <input type="text" id="hotkey-prev-image" data-action="prevImage">
                </div>
                <div class="hotkey-setting">
                    <label for="hotkey-edit-name">S·ª≠a t√™n ·∫£nh (preview):</label>
                    <input type="text" id="hotkey-edit-name" data-action="editName">
                </div>
                <div class="hotkey-setting">
                    <label for="hotkey-rotate-left">Xoay tr√°i:</label>
                    <input type="text" id="hotkey-rotate-left" data-action="rotateLeft">
                </div>
                 <div class="hotkey-setting">
                    <label for="hotkey-rotate-right">Xoay ph·∫£i:</label>
                    <input type="text" id="hotkey-rotate-right" data-action="rotateRight">
                </div>
                <div class="hotkey-setting">
                    <label for="hotkey-pin-toolbar">Ghim/B·ªè ghim thanh c√¥ng c·ª•:</label>
                    <input type="text" id="hotkey-pin-toolbar" data-action="pinToolbar">
                </div>
                <div class="hotkey-setting">
                    <label for="hotkey-voice-input">Nh·∫≠p li·ªáu b·∫±ng gi·ªçng n√≥i:</label>
                    <input type="text" id="hotkey-voice-input" data-action="voiceInput">
                </div>
                 <!-- === T√çNH NƒÇNG M·ªöI: PH√çM T·∫ÆT D·ªäCH VƒÇN B·∫¢N === -->
                <div class="hotkey-setting">
                    <label for="hotkey-translate-name">D·ªãch t√™n sang Ti·∫øng Anh:</label>
                    <input type="text" id="hotkey-translate-name" data-action="translateName">
                </div>
            </div>
        </div>
    </div>
</div>


<div class="page-wrapper" id="page-wrapper">
    <div class="main-column">
        <div class="main-content" id="main-content">
            <div id="photo-grid-main" class="photo-grid"></div>
        </div>
    </div>

    <div class="preview-column">
        <div class="preview-controls">
            <h3>Xem tr∆∞·ªõc ·∫£nh</h3>
            <input type="text" id="preview-name-input" placeholder="S·ª≠a t√™n t·∫°i ƒë√¢y..." style="display: none;">
            <div class="rotate-controls">
                <button id="rotate-left-btn" title="Xoay tr√°i 90 ƒë·ªô">‚Ü∫</button>
                <button id="rotate-right-btn" title="Xoay ph·∫£i 90 ƒë·ªô">‚Üª</button>
                <button id="flip-horizontal-btn" title="L·∫≠t ngang">‚Üî</button>
                <button id="flip-vertical-btn" title="L·∫≠t d·ªçc">‚Üï</button>
                <button id="voice-input-btn" title="K√≠ch ho·∫°t nh·∫≠p li·ªáu gi·ªçng n√≥i (d√πng ph√≠m t·∫Øt)">üé§</button>
            </div>
            <button id="capture-btn" title="Copy v√πng hi·ªÉn th·ªã v√†o Clipboard (T·ª∑ l·ªá 3:4)">üìã</button>
        </div>
        <div id="large-preview-container">
            <span id="preview-placeholder" class="preview-placeholder">Ch·ªçn ·∫£nh ƒë·ªÉ xem. LƒÉn chu·ªôt ƒë·ªÉ Zoom, Gi·ªØ chu·ªôt tr√°i ƒë·ªÉ K√©o.</span>
            <img id="large-preview-img" src="" alt="" draggable="false">
        </div>
        <div id="suggestion-buttons-container" style="display: none;">
            <h4>Ch·ªçn t√™n ch√≠nh th·ª©c:</h4>
            <div id="suggestion-buttons"></div>
            <div id="fine-grained-suggestions"></div>
        </div>
    </div>
</div>
<input type="file" id="photo-input" multiple accept="image/*,.zip,application/octet-stream" class="custom-file-input">

<script>
// --- C√°c bi·∫øn to√†n c·ª•c ---
const photoInput = document.getElementById('photo-input');
const clearBtn = document.getElementById('clear-btn');
const assignNamesBtn = document.getElementById('assign-names-btn');
const downloadAllBtn = document.getElementById('download-all-btn');
const undoBtn = document.getElementById('undo-btn');
const lockToggle = document.getElementById('lock-toggle');
const pasteZone = document.getElementById('paste-zone');
const mainContentEl = document.getElementById('main-content');
const nameListTextArea = document.getElementById('name-list');
const rangeNameToggle = document.getElementById('range-name-toggle');
const rangeInputsContainer = document.getElementById('range-inputs-container');
const largePreviewImg = document.getElementById('large-preview-img');
const largePreviewContainer = document.getElementById('large-preview-container');
const previewPlaceholder = document.getElementById('preview-placeholder');
const smartSelectToggle = document.getElementById('smart-select-toggle');
const gridToggleBtn = document.getElementById('grid-toggle-btn');
const captureBtn = document.getElementById('capture-btn');
const rotateLeftBtn = document.getElementById('rotate-left-btn');
const rotateRightBtn = document.getElementById('rotate-right-btn');
const pageWrapper = document.getElementById('page-wrapper');
const pageBody = document.getElementById('page-body');
const previewNameInput = document.getElementById('preview-name-input');
const highlightTallBtn = document.getElementById('highlight-tall-btn');
const flipHorizontalBtn = document.getElementById('flip-horizontal-btn');
const flipVerticalBtn = document.getElementById('flip-vertical-btn');
const togglePreviewBtn = document.getElementById('toggle-preview-btn');
const numericFilterBtn = document.getElementById('numeric-filter-btn');
const numericModeControls = document.getElementById('numeric-mode-controls');
const numericNameSuggestions = document.getElementById('numeric-name-suggestions');
const applyNumericSuggestionsBtn = document.getElementById('apply-numeric-suggestions-btn');
const downloadNumericBtn = document.getElementById('download-numeric-btn');
const suggestionButtonsContainer = document.getElementById('suggestion-buttons-container');
const suggestionButtons = document.getElementById('suggestion-buttons');
const numericFilteredNamesList = document.getElementById('numeric-filtered-names-list');
const suggestionCountSelect = document.getElementById('suggestion-count-select');
const fineGrainedSuggestionsContainer = document.getElementById('fine-grained-suggestions');
const toolbar = document.getElementById('toolbar');
const pinToolbarBtn = document.getElementById('pin-toolbar-btn');
const localNoteArea = document.getElementById('local-note-area');
const hotkeySettingsContainer = document.getElementById('hotkey-settings');
const deleteSelectedBtn = document.getElementById('delete-selected-btn');
const applySingleNameToggle = document.getElementById('apply-single-name-toggle');
const nextImageBtn = document.getElementById('next-image-btn');
const prevImageBtn = document.getElementById('prev-image-btn');
const hideAllImagesBtn = document.getElementById('hide-all-images-btn');
const progressOverlay = document.getElementById('progress-overlay');
const progressText = document.getElementById('progress-text');
const uploadProgress = document.getElementById('upload-progress');
const downloadProgress = document.getElementById('download-progress');
const voiceInputBtn = document.getElementById('voice-input-btn');
let recognition = null;
let isRecognizing = false;
let lastFocusedInputForVoice = null;


let photoGrid = document.getElementById('photo-grid-main');
let sortableInstance = null;
let photoIdCounter = 0;
const photoDataMap = new Map();
let history = [];
let currentState = null;
let lastSelectedWrapper = null;
let lastFocusedInput = null;
let isDownloading = false;
let draggedItems = [];
let imgScale = 1;
let imgTranslate = { x: 0, y: 0 };
let isPanning = false;
let startPan = { x: 0, y: 0 };

let hotkeys = {
    nextImage: 'CapsLock',
    prevImage: 'Shift',
    editName: 'F2',
    rotateLeft: 'ArrowLeft',
    rotateRight: 'ArrowRight',
    pinToolbar: 'KeyP',
    voiceInput: 'Backquote',
    translateName: 'KeyT' // Ph√≠m T cho Translate
};

// --- C√°c h√†m ti·ªán √≠ch ---
function removeLeadingOrderPrefix(filename) { return filename.replace(/^\d+\.\s+/, ''); }
function getMimeTypeFromName(name, originalType) { if (!name) return originalType; const lowerName = name.toLowerCase(); if (lowerName.endsWith('.jpg') || lowerName.endsWith('.jpeg')) return 'image/jpeg'; if (lowerName.endsWith('.png')) return 'image/png'; if (lowerName.endsWith('.gif')) return 'image/gif'; if (lowerName.endsWith('.webp')) return 'image/webp'; if (lowerName.endsWith('.bmp')) return 'image/bmp'; return originalType; }
function syncInputAttributes() { mainContentEl.querySelectorAll('input[type="text"]').forEach(input => input.setAttribute('value', input.value)); mainContentEl.querySelectorAll('textarea').forEach(textarea => textarea.textContent = textarea.value); mainContentEl.querySelectorAll('input[type="checkbox"]').forEach(input => { if (input.checked) input.setAttribute('checked', 'checked'); else input.removeAttribute('checked'); }); }
function saveState() { syncInputAttributes(); const stateHTML = mainContentEl.innerHTML; if (stateHTML !== currentState) { if (currentState !== null) history.push(currentState); if (history.length > 50) history.shift(); currentState = stateHTML; } }
function updateCurrentState() { syncInputAttributes(); currentState = mainContentEl.innerHTML; }
function restoreStateFromHistory() { if (history.length > 0) { const stateToRestore = history.pop(); mainContentEl.innerHTML = stateToRestore; currentState = stateToRestore; reInitializeApp(); } else { alert('Kh√¥ng c√≥ h√†nh ƒë·ªông n√†o ƒë·ªÉ ho√†n t√°c.'); } }
function processImageRotation(file) { return new Promise((resolve) => { resolve(file); }); }
async function transformCurrentImage(transformParams) { if (!lastSelectedWrapper) return; const id = lastSelectedWrapper.getAttribute('data-photo-id'); if (!id || !photoDataMap.has(id)) return; saveState(); const { blob } = photoDataMap.get(id); const bitmap = await createImageBitmap(blob); const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const { degrees = 0, flipH = false, flipV = false } = transformParams; if (Math.abs(degrees) === 90) { canvas.width = bitmap.height; canvas.height = bitmap.width; } else { canvas.width = bitmap.width; canvas.height = bitmap.height; } ctx.translate(canvas.width / 2, canvas.height / 2); if (degrees) ctx.rotate(degrees * Math.PI / 180); ctx.scale(flipH ? -1 : 1, flipV ? -1 : 1); ctx.drawImage(bitmap, -bitmap.width / 2, -bitmap.height / 2); canvas.toBlob((newBlob) => { if (!newBlob) return; photoDataMap.set(id, { ...photoDataMap.get(id), blob: newBlob }); const newUrl = URL.createObjectURL(newBlob); lastSelectedWrapper.querySelector('.photo-item').src = newUrl; largePreviewImg.src = newUrl; largePreviewImg.setAttribute('data-current-src', newUrl); resetZoom(); updateCurrentState(); }, blob.type || 'image/jpeg', 0.95); }
function resetZoom() { imgScale = 1; imgTranslate = { x: 0, y: 0 }; updateTransform(); }
function updateTransform() { largePreviewImg.style.transform = `translate(${imgTranslate.x}px, ${imgTranslate.y}px) scale(${imgScale})`; }
function showFineGrainedSuggestions(baseText) { fineGrainedSuggestionsContainer.innerHTML = ''; const match = baseText.match(/(-?\d+\.?\d*)/); if (!match) return; const num = parseFloat(match[0]); if (isNaN(num)) return; const unit = baseText.substring(match[0].length).trim(); const parts = match[0].split('.'); const precision = parts.length > 1 ? parts[1].length : 0; const step = Math.pow(10, -precision); const fragment = document.createDocumentFragment(); for(let i = -3; i <= 3; i++) { if (i === 0) continue; const newNum = (num + i * step).toFixed(precision); const btn = document.createElement('button'); btn.textContent = `${newNum}${unit}`; btn.onclick = () => { if(lastSelectedWrapper) { const nameInput = lastSelectedWrapper.querySelector('.name-container input[type="text"]'); const currentPrefix = nameInput.value.match(/^\d+\.\s+/); const newName = (currentPrefix ? currentPrefix[0] : '') + btn.textContent; nameInput.value = newName; previewNameInput.value = newName; syncNameListFromInputs(); updateSuggestionButtons(lastSelectedWrapper); saveState(); updateCurrentState(); } }; fragment.appendChild(btn); } fineGrainedSuggestionsContainer.appendChild(fragment); }
function updateSuggestionButtons(wrapper) { fineGrainedSuggestionsContainer.innerHTML = ''; if (pageBody.classList.contains('numeric-mode') && wrapper && wrapper.dataset.suggestions) { suggestionButtons.innerHTML = ''; const suggestions = JSON.parse(wrapper.dataset.suggestions); const nameInput = wrapper.querySelector('.name-container input[type="text"]'); const currentNameWithoutPrefix = removeLeadingOrderPrefix(nameInput.value); suggestions.forEach(suggestionText => { if (suggestionText) { const btn = document.createElement('button'); btn.textContent = suggestionText; btn.title = `Ch·ªçn "${suggestionText}" l√†m t√™n ch√≠nh th·ª©c`; if (suggestionText === currentNameWithoutPrefix) { btn.classList.add('suggestion-selected'); } btn.onclick = () => { const currentPrefix = nameInput.value.match(/^\d+\.\s+/); const newName = (currentPrefix ? currentPrefix[0] : '') + suggestionText; nameInput.value = newName; previewNameInput.value = newName; suggestionButtons.querySelectorAll('button').forEach(b => b.classList.remove('suggestion-selected')); btn.classList.add('suggestion-selected'); syncNameListFromInputs(); saveState(); updateCurrentState(); }; btn.addEventListener('focus', () => showFineGrainedSuggestions(suggestionText)); suggestionButtons.appendChild(btn); } }); suggestionButtonsContainer.style.display = suggestionButtons.children.length > 0 ? 'block' : 'none'; } else { suggestionButtonsContainer.style.display = 'none'; } }
function updatePreview(wrapper) { const selectedWrappers = photoGrid.querySelectorAll('.photo-wrapper.selected-photo'); if (selectedWrappers.length === 1) { const singleWrapper = selectedWrappers[0]; const id = singleWrapper.getAttribute('data-photo-id'); if (id && photoDataMap.has(id)) { const data = photoDataMap.get(id); const imgSrc = URL.createObjectURL(data.blob); const oldSrc = largePreviewImg.getAttribute('data-current-src'); if (oldSrc && oldSrc.startsWith('blob:')) { URL.revokeObjectURL(oldSrc); } largePreviewImg.src = imgSrc; largePreviewImg.alt = singleWrapper.querySelector('input[type="text"]').value; largePreviewImg.setAttribute('data-current-src', imgSrc); resetZoom(); previewPlaceholder.style.display = 'none'; largePreviewImg.style.display = 'block'; previewNameInput.value = singleWrapper.querySelector('input[type="text"]').value; previewNameInput.style.display = 'block'; updateSuggestionButtons(singleWrapper); } else { largePreviewImg.src = ""; largePreviewImg.alt = ""; largePreviewImg.removeAttribute('data-current-src'); largePreviewImg.style.display = 'none'; previewPlaceholder.style.display = 'block'; previewPlaceholder.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ·∫£nh."; previewNameInput.value = ''; previewNameInput.style.display = 'none'; suggestionButtonsContainer.style.display = 'none'; fineGrainedSuggestionsContainer.innerHTML = ''; } } else { largePreviewImg.src = ""; largePreviewImg.alt = ""; largePreviewImg.removeAttribute('data-current-src'); largePreviewImg.style.display = 'none'; previewPlaceholder.style.display = 'block'; previewPlaceholder.textContent = "Ch·ªçn ·∫£nh ƒë·ªÉ xem. LƒÉn chu·ªôt ƒë·ªÉ Zoom, Gi·ªØ chu·ªôt tr√°i ƒë·ªÉ K√©o."; previewNameInput.value = ''; previewNameInput.style.display = 'none'; suggestionButtonsContainer.style.display = 'none'; fineGrainedSuggestionsContainer.innerHTML = ''; } }
function createPhotoElement(id, processedBlob, originalName, fileSize) { const wrapper = document.createElement('div'); wrapper.className = 'photo-wrapper newly-added'; wrapper.setAttribute('data-photo-id', id); if (fileSize && fileSize < 40000) { wrapper.classList.add('is-small'); } const imgContainer = document.createElement('div'); imgContainer.className = 'img-container'; const img = document.createElement('img'); img.className = 'photo-item'; img.src = URL.createObjectURL(processedBlob); img.draggable = false; const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.title = 'X√≥a ·∫£nh n√†y'; const excludeBtn = document.createElement('button'); excludeBtn.className = 'exclude-numeric-btn'; excludeBtn.innerHTML = '&#10007;'; excludeBtn.title = 'Lo·∫°i tr·ª´ kh·ªèi ch·∫ø ƒë·ªô xem s·ªë li·ªáu'; const replaceBtn = document.createElement('button'); replaceBtn.className = 'replace-btn'; replaceBtn.innerHTML = '&#8635;'; replaceBtn.title = 'Thay th·∫ø ·∫£nh'; const replacePanel = document.createElement('div'); replacePanel.className = 'replace-panel'; replacePanel.innerHTML = `<button class="replace-from-file-btn" title="Thay th·∫ø b·∫±ng ·∫£nh t·ª´ m·ªôt file">T·ª´ File</button><button class="replace-from-clipboard-btn" title="Thay th·∫ø b·∫±ng ·∫£nh ƒëang c√≥ trong clipboard">T·ª´ Clipboard</button>`; const nameContainer = document.createElement('div'); nameContainer.className = 'name-container'; const nameInput = document.createElement('input'); nameInput.type = 'text'; const nameWithoutExtension = originalName.replace(/\.[^/.]+$/, ""); nameInput.value = nameWithoutExtension; imgContainer.appendChild(img); imgContainer.appendChild(deleteBtn); imgContainer.appendChild(excludeBtn); imgContainer.appendChild(replaceBtn); nameContainer.appendChild(nameInput); wrapper.appendChild(imgContainer); wrapper.appendChild(replacePanel); wrapper.appendChild(nameContainer); photoDataMap.set(id, { blob: processedBlob, originalName: originalName }); setTimeout(() => wrapper.classList.remove('newly-added'), 1500); return wrapper; }
function syncNameListFromInputs() { const allNameInputs = photoGrid.querySelectorAll('.name-container input[type="text"]'); const namesArray = Array.from(allNameInputs).map(input => removeLeadingOrderPrefix(input.value.trim())); nameListTextArea.value = namesArray.join('\n'); }
function updateNumberingAndSync() { const wrappers = photoGrid.querySelectorAll('.photo-wrapper'); wrappers.forEach((wrapper, index) => { const nameInput = wrapper.querySelector('.name-container input[type="text"]'); if (nameInput) { const currentName = removeLeadingOrderPrefix(nameInput.value); nameInput.value = `${index + 1}. ${currentName}`; } }); syncNameListFromInputs(); }
async function processAndDisplayFiles(filesArray) { if (filesArray.length === 0) return; saveState(); progressOverlay.style.display = 'flex'; uploadProgress.style.display = 'block'; downloadProgress.style.display = 'none'; progressText.textContent = `ƒêang t·∫£i ${filesArray.length} ·∫£nh...`; uploadProgress.value = 0; uploadProgress.max = filesArray.length; const selectedWrappers = photoGrid.querySelectorAll('.photo-wrapper.selected-photo'); const insertionPoint = selectedWrappers.length === 1 ? selectedWrappers[0] : null; const fragment = document.createDocumentFragment(); let lastAddedElement = null; for (let i = 0; i < filesArray.length; i++) { const file = filesArray[i]; if (!file || (!file.type.startsWith('image/') && file.type !== 'application/octet-stream')) { uploadProgress.value = i + 1; continue; }; try { let processedBlob = await processImageRotation(file); const originalName = file.name || `image_${Date.now()}.jpg`; if (processedBlob.type === 'application/octet-stream') { const correctedType = getMimeTypeFromName(originalName, processedBlob.type); if (correctedType !== processedBlob.type) { processedBlob = new Blob([processedBlob], { type: correctedType }); } } const id = `photo-${photoIdCounter++}`; const wrapper = createPhotoElement(id, processedBlob, originalName, file.size); fragment.appendChild(wrapper); lastAddedElement = wrapper; } catch (error) { console.error("L·ªói x·ª≠ l√Ω ·∫£nh:", error); } uploadProgress.value = i + 1; } if (insertionPoint) { insertionPoint.after(fragment); } else { photoGrid.appendChild(fragment); } updateNumberingAndSync(); if (lastAddedElement) { document.querySelectorAll('.selected-photo').forEach(el => el.classList.remove('selected-photo')); lastAddedElement.classList.add('selected-photo'); lastSelectedWrapper = lastAddedElement; lastAddedElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); updatePreview(lastAddedElement); } updateCurrentState(); setTimeout(() => { progressOverlay.style.display = 'none'; uploadProgress.value = 0; }, 500); }
async function handleFiles(files) { const imageFiles = []; const zipFiles = []; for (const file of files) { if (file.type.startsWith('image/') || file.type === 'application/octet-stream') { imageFiles.push(file); } else if (file.name.toLowerCase().endsWith('.zip')) { zipFiles.push(file); } } if (imageFiles.length > 0) { await processAndDisplayFiles(imageFiles); } for (const zipFile of zipFiles) { await handleZipFile(zipFile); } }
async function handleZipFile(file) { try { progressOverlay.style.display = 'flex'; progressText.textContent = `ƒêang gi·∫£i n√©n file ${file.name}...`; uploadProgress.value = 0; const zip = await JSZip.loadAsync(file); const imagePromises = []; const imageEntries = []; zip.forEach((relativePath, zipEntry) => { const isImage = /\.(jpe?g|png|gif|webp|bmp)$/i.test(zipEntry.name); const isHiddenFile = zipEntry.name.startsWith('__MACOSX/') || zipEntry.name.includes('/.'); if (!zipEntry.dir && isImage && !isHiddenFile) { imageEntries.push(zipEntry); } }); uploadProgress.max = imageEntries.length; progressText.textContent = `ƒêang tr√≠ch xu·∫•t ${imageEntries.length} ·∫£nh t·ª´ ${file.name}...`; for (let i = 0; i < imageEntries.length; i++) { const zipEntry = imageEntries[i]; const promise = zipEntry.async('blob').then(blob => { const correctedType = getMimeTypeFromName(zipEntry.name, blob.type); const file = new File([blob], zipEntry.name, { type: correctedType }); return file; }); imagePromises.push(promise); uploadProgress.value = i + 1; } const extractedFiles = await Promise.all(imagePromises); await processAndDisplayFiles(extractedFiles); } catch (error) { console.error("L·ªói khi x·ª≠ l√Ω file ZIP:", error); alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi gi·∫£i n√©n file ZIP. Vui l√≤ng ki·ªÉm tra console."); progressOverlay.style.display = 'none'; } }
function generateZip(elementsToZip, zipName = 'photos.zip') { if (isDownloading) return alert('Qu√° tr√¨nh t·∫£i xu·ªëng ƒëang di·ªÖn ra.'); if (elementsToZip.length === 0) return alert('Kh√¥ng c√≥ ·∫£nh n√†o ƒë·ªÉ t·∫£i xu·ªëng.'); isDownloading = true; progressOverlay.style.display = 'flex'; downloadProgress.style.display = 'block'; uploadProgress.style.display = 'none'; progressText.textContent = 'ƒêang n√©n file...'; downloadProgress.value = 0; const zip = new JSZip(); elementsToZip.forEach(wrapper => { const id = wrapper.getAttribute('data-photo-id'); const nameInput = wrapper.querySelector('.name-container input[type="text"]'); if (id && photoDataMap.has(id)) { const { blob } = photoDataMap.get(id); const fullFileName = nameInput.value.trim() || `image_${id}`; const extension = blob.type.split('/')[1] || 'jpg'; const finalZipName = `${fullFileName.replace(/[<>:"/\\|?*]+/g, '_')}.${extension}`; zip.file(finalZipName, blob); } }); zip.generateAsync({ type: "blob" }, (metadata) => { downloadProgress.value = metadata.percent; progressText.textContent = `ƒêang n√©n file... ${metadata.percent.toFixed(0)}%`; }) .then((content) => saveAs(content, zipName)) .catch(err => { console.error("L·ªói:", err); alert("L·ªói khi t·∫°o file ZIP."); }) .finally(() => { setTimeout(() => { progressOverlay.style.display = 'none'; }, 1000); isDownloading = false; reInitializeApp(); }); }
function initializeSortable(isDraggable) { if (sortableInstance) sortableInstance.destroy(); if (photoGrid) { sortableInstance = new Sortable(photoGrid, { group: 'shared-photos', animation: 150, ghostClass: 'ghost-class', dragClass: 'drag-class', draggable: '.photo-wrapper', sort: isDraggable, onStart: function(evt) { const allSelected = Array.from(photoGrid.querySelectorAll('.selected-photo')); if (!evt.item.classList.contains('selected-photo')) { draggedItems = []; } else { draggedItems = allSelected.filter(item => item !== evt.item); } draggedItems.forEach(item => item.style.display = 'none'); }, onEnd: function(evt) { draggedItems.forEach(item => item.style.display = ''); let referenceNode = evt.item; draggedItems.forEach(item => { referenceNode.parentNode.insertBefore(item, referenceNode.nextSibling); referenceNode = item; }); draggedItems = []; saveState(); updateNumberingAndSync(); updateCurrentState(); }, }); } }
function reInitializeApp() { photoGrid = document.getElementById('photo-grid-main'); photoGrid.querySelectorAll('.photo-item').forEach(img => { if (img.src && img.src.startsWith('blob:')) { URL.revokeObjectURL(img.src); } }); photoGrid.querySelectorAll('.photo-wrapper').forEach(wrapper => { const id = wrapper.getAttribute('data-photo-id'); const img = wrapper.querySelector('.photo-item'); if (id && img && photoDataMap.has(id)) { const data = photoDataMap.get(id); if(data && data.blob) { img.src = URL.createObjectURL(data.blob); } } }); gridToggleBtn.textContent = photoGrid.classList.contains('dense-mode') ? 'L∆∞·ªõi th∆∞·ªùng' : 'L∆∞·ªõi x2'; document.getElementById('lock-toggle').checked = false; initializeSortable(true); const selectedEl = photoGrid.querySelector('.selected-photo'); lastSelectedWrapper = selectedEl || null; updatePreview(lastSelectedWrapper); syncNameListFromInputs(); }
function navigateImage(direction) { const visibleWrappers = Array.from(photoGrid.querySelectorAll('.photo-wrapper:not(.hidden-by-filter)')); if (visibleWrappers.length === 0) return; const currentSelected = photoGrid.querySelector('.photo-wrapper.selected-photo'); let currentIndex = -1; if (currentSelected) { currentIndex = visibleWrappers.indexOf(currentSelected); } let nextIndex; if (direction === 'next') { nextIndex = (currentIndex + 1) % visibleWrappers.length; } else { nextIndex = (currentIndex - 1 + visibleWrappers.length) % visibleWrappers.length; } const nextWrapper = visibleWrappers[nextIndex]; if (nextWrapper) { if (currentSelected) currentSelected.classList.remove('selected-photo'); nextWrapper.classList.add('selected-photo'); lastSelectedWrapper = nextWrapper; updatePreview(lastSelectedWrapper); nextWrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } }
function saveHotkeys() { localStorage.setItem('photoSorterHotkeys', JSON.stringify(hotkeys)); }
function loadHotkeys() { const savedHotkeys = localStorage.getItem('photoSorterHotkeys'); if (savedHotkeys) { hotkeys = JSON.parse(savedHotkeys); } for (const action in hotkeys) { const input = document.querySelector(`#hotkey-settings input[data-action="${action}"]`); if (input) { input.value = hotkeys[action]; } } }
function setToolbarPinned(isPinned) { pageWrapper.classList.toggle('toolbar-pinned', isPinned); toolbar.classList.toggle('visible', isPinned); localStorage.setItem('toolbarPinned', isPinned); pinToolbarBtn.textContent = isPinned ? 'üìå' : '‚Üí'; if(isPinned) { pinToolbarBtn.title = 'B·ªè ghim thanh c√¥ng c·ª•'; } else { pinToolbarBtn.title = 'Ghim thanh c√¥ng c·ª•'; } }

// === H√ÄM D·ªäCH VƒÇN B·∫¢N (M·ªöI) ===
async function translateFocusedInput() {
    const activeInput = document.activeElement;
    if (!activeInput || !activeInput.matches('.name-container input[type="text"], #preview-name-input')) {
        alert('Vui l√≤ng ch·ªçn m·ªôt √¥ t√™n ·∫£nh ƒë·ªÉ d·ªãch.');
        return;
    }

    const originalValue = activeInput.value;
    // Regex ƒë·ªÉ t√°ch (1. prefix)(n·ªôi dung c·∫ßn d·ªãch)( suffix 5kg)
    const partsRegex = /^(\d+\.\s*)(.*?)([\s\d.,]+[a-zA-Z%¬∞]*)?$/;
    const match = originalValue.match(partsRegex);

    let prefix = '';
    let textToTranslate = '';
    let suffix = '';

    if (match) {
        prefix = match[1] || '';
        textToTranslate = match[2] || '';
        suffix = match[3] || '';
    } else {
        // Fallback n·∫øu regex kh√¥ng kh·ªõp, ch·ªâ t√°ch prefix ƒë∆°n gi·∫£n
        const simplePrefixMatch = originalValue.match(/^(\d+\.\s*)/);
        if (simplePrefixMatch) {
            prefix = simplePrefixMatch[0];
            textToTranslate = originalValue.substring(prefix.length);
        } else {
            textToTranslate = originalValue;
        }
    }

    if (!textToTranslate.trim()) {
        alert('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ d·ªãch.');
        return;
    }

    const sourceLang = 'vi';
    const targetLang = 'en';
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(textToTranslate)}`;

    activeInput.value = 'ƒêang d·ªãch...';
    activeInput.disabled = true;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('L·ªói m·∫°ng khi d·ªãch.');
        }
        const data = await response.json();
        const translatedText = data?.[0]?.[0]?.[0];

        if (translatedText) {
            const finalValue = `${prefix}${translatedText}${suffix}`.replace(/\s+/g, ' ').trim();
            activeInput.value = finalValue;
            activeInput.dispatchEvent(new Event('input', { bubbles: true }));
        } else {
            throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£ d·ªãch h·ª£p l·ªá.');
        }
    } catch (error) {
        console.error('L·ªói d·ªãch:', error);
        alert('ƒê√£ x·∫£y ra l·ªói khi d·ªãch. Vui l√≤ng th·ª≠ l·∫°i.');
        activeInput.value = originalValue; // Kh√¥i ph·ª•c gi√° tr·ªã c≈© n·∫øu l·ªói
    } finally {
        activeInput.disabled = false;
        activeInput.focus();
    }
}


// === H√ÄM CHUY·ªÇN ƒê·ªîI S·ªê T·ª™ CH·ªÆ ===
function convertVietnameseNumberWordsToDigits(text) {
    const numberMap = { 'kh√¥ng': '0', 'linh': '0', 'l·∫ª': '0', 'm·ªôt': '1', 'm·ªët': '1', 'hai': '2', 'ba': '3', 'b·ªën': '4', 't∆∞': '4', 'nƒÉm': '5', 'lƒÉm': '5', 's√°u': '6', 'b·∫£y': '7', 'b·∫©y': '7', 't√°m': '8', 'ch√≠n': '9', 'm∆∞·ªùi': '10', };
    let processedText = ` ${text.toLowerCase()} `.replace(/ ph·∫©y /g, '.');
    const words = processedText.split(' ');
    const resultWords = words.map(word => numberMap[word] || word);
    return resultWords.join(' ').replace(/\s+/g, ' ').trim();
}


// === NH·∫¨P LI·ªÜU GI·ªåNG N√ìI ===
function initializeSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        console.warn("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API.");
        voiceInputBtn.disabled = true;
        voiceInputBtn.title = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ t√≠nh nƒÉng n√†y.";
        const voiceHotkeyInput = document.getElementById('hotkey-voice-input');
        if(voiceHotkeyInput) voiceHotkeyInput.disabled = true;
        return;
    }
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'vi-VN';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onstart = () => { isRecognizing = true; voiceInputBtn.textContent = 'üî¥'; voiceInputBtn.style.backgroundColor = '#dc3545'; voiceInputBtn.title = 'ƒêang l·∫Øng nghe...'; };
    recognition.onresult = (event) => {
        const rawTranscript = event.results[0][0].transcript;
        const processedTranscript = convertVietnameseNumberWordsToDigits(rawTranscript);
        if (lastFocusedInputForVoice && processedTranscript) {
            const target = lastFocusedInputForVoice;
            const start = target.selectionStart;
            const end = target.selectionEnd;
            const currentValue = target.value;
            const newValue = currentValue.substring(0, start) + processedTranscript + currentValue.substring(end);
            target.value = newValue;
            const newCursorPos = start + processedTranscript.length;
            target.setSelectionRange(newCursorPos, newCursorPos);
            target.dispatchEvent(new Event('input', { bubbles: true }));
            target.focus();
        }
    };
    recognition.onspeechend = () => { recognition.stop(); };
    recognition.onend = () => { isRecognizing = false; voiceInputBtn.textContent = 'üé§'; voiceInputBtn.style.backgroundColor = ''; voiceInputBtn.title = 'K√≠ch ho·∫°t nh·∫≠p li·ªáu gi·ªçng n√≥i (d√πng ph√≠m t·∫Øt)'; };
    recognition.onerror = (event) => { console.error('L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i:', event.error); if (event.error === 'not-allowed' || event.error === 'service-not-allowed') { alert('Quy·ªÅn truy c·∫≠p micro ƒë√£ b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn trong c√†i ƒë·∫∑t tr√¨nh duy·ªát v√† s·ª≠ d·ª•ng trang web qua HTTPS.'); } };
}

function startVoiceRecognition() {
    if (!recognition || isRecognizing) { return; }
    if (document.activeElement && (document.activeElement.matches('input[type="text"]') || document.activeElement.tagName === 'TEXTAREA')) {
         lastFocusedInputForVoice = document.activeElement;
         recognition.start();
    } else { alert('Vui l√≤ng ch·ªçn m·ªôt √¥ nh·∫≠p t√™n ho·∫∑c √¥ ghi ch√∫ ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·∫≠p li·ªáu b·∫±ng gi·ªçng n√≥i.'); }
}

// === EVENT LISTENERS ===
largePreviewContainer.addEventListener('wheel', (e) => { if (!largePreviewImg.src || largePreviewImg.style.display === 'none') return; e.preventDefault(); const delta = e.deltaY * -0.001; const newScale = Math.min(Math.max(1, imgScale + delta * 5), 10); imgScale = newScale; if (imgScale === 1) imgTranslate = {x: 0, y: 0}; updateTransform(); });
largePreviewContainer.addEventListener('mousedown', (e) => { if (imgScale <= 1 || !largePreviewImg.src || e.button !== 0) return; isPanning = true; startPan = { x: e.clientX - imgTranslate.x, y: e.clientY - imgTranslate.y }; largePreviewContainer.style.cursor = 'grabbing'; });
document.addEventListener('mousemove', (e) => { if (!isPanning) return; e.preventDefault(); imgTranslate.x = e.clientX - startPan.x; imgTranslate.y = e.clientY - startPan.y; updateTransform(); });
document.addEventListener('mouseup', () => { if (isPanning) { isPanning = false; largePreviewContainer.style.cursor = 'grab'; } });
rotateLeftBtn.addEventListener('click', () => transformCurrentImage({ degrees: -90 }));
rotateRightBtn.addEventListener('click', () => transformCurrentImage({ degrees: 90 }));
flipHorizontalBtn.addEventListener('click', () => transformCurrentImage({ flipH: true }));
flipVerticalBtn.addEventListener('click', () => transformCurrentImage({ flipV: true }));
captureBtn.addEventListener('click', async () => { /* ... */ });
photoInput.addEventListener('change', (event) => { handleFiles(Array.from(event.target.files)); event.target.value = ''; });
document.addEventListener('paste', async (event) => { const files = Array.from(event.clipboardData?.items || []).filter(item => item.kind === 'file' && (item.type.startsWith('image/') || item.type === 'application/octet-stream')).map(item => item.getAsFile()); if (files.length > 0) { event.preventDefault(); await handleFiles(files); } });
pasteZone.addEventListener('dragover', e => { e.preventDefault(); pasteZone.classList.add('drag-over'); });
pasteZone.addEventListener('dragleave', e => { e.preventDefault(); pasteZone.classList.remove('drag-over'); });
pasteZone.addEventListener('drop', async e => { e.preventDefault(); pasteZone.classList.remove('drag-over'); await handleFiles(Array.from(e.dataTransfer.files)); });
clearBtn.addEventListener('click', () => { if (photoGrid.children.length > 0 && confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ ·∫£nh kh√¥ng?')) { saveState(); photoGrid.innerHTML = ''; photoDataMap.forEach(data => URL.revokeObjectURL(data.blob)); photoDataMap.clear(); photoIdCounter = 0; lastSelectedWrapper = null; updateCurrentState(); updatePreview(null); syncNameListFromInputs(); } });
assignNamesBtn.addEventListener('click', () => { saveState(); const nameList = nameListTextArea.value.trim().split('\n').filter(Boolean); if (nameList.length === 0) return; const wrappers = Array.from(photoGrid.querySelectorAll('.photo-wrapper')); if (rangeNameToggle.checked) { const start = parseInt(document.getElementById('name-range-start').value, 10); const end = parseInt(document.getElementById('name-range-end').value, 10); if (applySingleNameToggle.checked) { const singleName = nameList[0].trim(); for (let i = start - 1; i < Math.min(end, wrappers.length); i++) { const wrapper = wrappers[i]; if (wrapper) { wrapper.querySelector('.name-container input[type="text"]').value = `${i + 1}. ${singleName}`; } } } else { let nameIndex = 0; for (let i = start - 1; i < Math.min(end, wrappers.length); i++) { if (nameIndex >= nameList.length) break; const wrapper = wrappers[i]; if(wrapper) { wrapper.querySelector('.name-container input[type="text"]').value = `${i + 1}. ${nameList[nameIndex].trim()}`; } nameIndex++; } } } else { wrappers.forEach((wrapper, index) => { if (nameList[index]) wrapper.querySelector('.name-container input[type="text"]').value = `${index + 1}. ${nameList[index].trim()}`; }); } updateCurrentState(); syncNameListFromInputs(); });
rangeNameToggle.addEventListener('change', (e) => { rangeInputsContainer.style.display = e.target.checked ? 'flex' : 'none'; });
downloadAllBtn.addEventListener('click', () => generateZip(Array.from(photoGrid.querySelectorAll('.photo-wrapper')), 'all_photos.zip'));
undoBtn.addEventListener('click', restoreStateFromHistory);
lockToggle.addEventListener('change', (e) => { initializeSortable(!e.target.checked); });
gridToggleBtn.addEventListener('click', () => { photoGrid.classList.toggle('dense-mode'); gridToggleBtn.textContent = photoGrid.classList.contains('dense-mode') ? 'L∆∞·ªõi th∆∞·ªùng' : 'L∆∞·ªõi x2'; });
deleteSelectedBtn.addEventListener('click', () => { const selectedWrappers = photoGrid.querySelectorAll('.photo-wrapper.selected-photo'); if (selectedWrappers.length === 0) { alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ·∫£nh ƒë·ªÉ x√≥a.'); return; } const isNumericMode = pageBody.classList.contains('numeric-mode'); const confirmMessage = isNumericMode ? `B·∫°n c√≥ ch·∫Øc mu·ªën ·∫©n ${selectedWrappers.length} ·∫£nh ƒë√£ ch·ªçn kh·ªèi Ch·∫ø ƒë·ªô S·ªë li·ªáu kh√¥ng?` : `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a vƒ©nh vi·ªÖn ${selectedWrappers.length} ·∫£nh ƒë√£ ch·ªçn kh√¥ng?`; if (confirm(confirmMessage)) { saveState(); if (isNumericMode) { selectedWrappers.forEach(wrapper => { wrapper.dataset.numericIgnored = 'true'; wrapper.querySelector('.exclude-numeric-btn').innerHTML = '&#9733;'; wrapper.classList.remove('selected-photo'); }); applyNumericFilter(); } else { selectedWrappers.forEach(wrapper => { const id = wrapper.getAttribute('data-photo-id'); if (id && photoDataMap.has(id)) { photoDataMap.delete(id); } wrapper.remove(); }); updateNumberingAndSync(); } lastSelectedWrapper = null; updateCurrentState(); updatePreview(null); } });
hideAllImagesBtn.addEventListener('click', () => { pageWrapper.classList.toggle('grid-hidden'); });
nextImageBtn.addEventListener('click', () => navigateImage('next'));
prevImageBtn.addEventListener('click', () => navigateImage('prev'));
voiceInputBtn.addEventListener('click', startVoiceRecognition);

document.addEventListener('keydown', (e) => {
    if (e.target.closest('#hotkey-settings')) return;
    if (e.ctrlKey && e.key === 'z') { e.preventDefault(); restoreStateFromHistory(); return; } 
    if (e.key === 'Delete' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) { e.preventDefault(); deleteSelectedBtn.click(); }

    const action = Object.keys(hotkeys).find(key => hotkeys[key] === e.code || hotkeys[key] === e.key);
    if (action) {
        let actionHandled = true;
        switch (action) {
            case 'nextImage': navigateImage('next'); break;
            case 'prevImage': navigateImage('prev'); break;
            case 'editName': 
                if (lastSelectedWrapper && previewNameInput.style.display !== 'none') {
                    previewNameInput.focus();
                    handleNameInputFocus(previewNameInput);
                }
                break;
            case 'rotateLeft': rotateLeftBtn.click(); break;
            case 'rotateRight': rotateRightBtn.click(); break;
            case 'pinToolbar': pinToolbarBtn.click(); break;
            case 'voiceInput': startVoiceRecognition(); break;
            case 'translateName': translateFocusedInput(); break; // <-- K√≠ch ho·∫°t d·ªãch
            default: actionHandled = false;
        }
        if(actionHandled) { e.preventDefault(); }
    }
});

previewNameInput.addEventListener('input', () => { if (lastSelectedWrapper) { const gridInput = lastSelectedWrapper.querySelector('.name-container input[type="text"]'); if (gridInput) { gridInput.value = previewNameInput.value; syncNameListFromInputs(); clearTimeout(previewNameInput.saveTimeout); previewNameInput.saveTimeout = setTimeout(() => { saveState(); updateCurrentState(); }, 500); } } });

function handleNameInputFocus(target) {
    if (!smartSelectToggle.checked) {
        const fullValue = target.value;
        const prefixMatch = fullValue.match(/^\d+\.\s+/);
        const startIndex = prefixMatch ? prefixMatch[0].length : 0;
        setTimeout(() => target.setSelectionRange(startIndex, fullValue.length), 0);
        return;
    }
    const fullValue = target.value;
    const prefixMatch = fullValue.match(/^\d+\.\s*/);
    const prefixLength = prefixMatch ? prefixMatch[0].length : 0;
    const namePart = fullValue.substring(prefixLength);
    const numericMatch = namePart.match(/-?\d+(\.\d+)?/);
    if (numericMatch) {
        const numericValue = numericMatch[0];
        const startIndexInNamePart = numericMatch.index;
        const absoluteStartIndex = prefixLength + startIndexInNamePart;
        const absoluteEndIndex = absoluteStartIndex + numericValue.length;
        setTimeout(() => target.setSelectionRange(absoluteStartIndex, absoluteEndIndex), 0);
    } else {
        setTimeout(() => target.setSelectionRange(prefixLength, fullValue.length), 0);
    }
}

document.addEventListener('focusin', (event) => {
    const target = event.target;
    if (target.matches('input[type="text"], textarea')) {
        lastFocusedInputForVoice = target;
        if (target.matches('.name-container input[type="text"], #preview-name-input')) {
            handleNameInputFocus(target);
        }
    }
});

highlightTallBtn.addEventListener('click', () => { pageWrapper.classList.toggle('highlight-tall-active'); if (pageWrapper.classList.contains('highlight-tall-active')) { highlightTallBtn.style.backgroundColor = '#28a745'; photoGrid.querySelectorAll('.photo-wrapper').forEach(wrapper => { const id = wrapper.getAttribute('data-photo-id'); const data = photoDataMap.get(id); if(data){ const img = new Image(); img.onload = () => { if (img.naturalHeight > img.naturalWidth) { wrapper.classList.add('is-tall'); } URL.revokeObjectURL(img.src); }; img.src = URL.createObjectURL(data.blob); } }); } else { highlightTallBtn.style.backgroundColor = ''; photoGrid.querySelectorAll('.is-tall').forEach(el => el.classList.remove('is-tall')); } });
togglePreviewBtn.addEventListener('click', () => { pageWrapper.classList.toggle('preview-hidden'); togglePreviewBtn.textContent = pageWrapper.classList.contains('preview-hidden') ? 'Hi·ªán Preview' : '·∫®n Preview'; });
function updateNumericFilteredNamesList() { const filteredElements = Array.from(photoGrid.querySelectorAll('.photo-wrapper:not(.hidden-by-filter)')); const names = filteredElements.map(el => el.querySelector('.name-container input').value); numericFilteredNamesList.value = names.join('\n'); }
function applyNumericFilter() { const wrappers = photoGrid.querySelectorAll('.photo-wrapper'); const nameRegex = /\d/; wrappers.forEach(wrapper => { const nameInput = wrapper.querySelector('.name-container input[type="text"]'); const hasNumber = nameRegex.test(removeLeadingOrderPrefix(nameInput.value)); const isIgnored = wrapper.dataset.numericIgnored === 'true'; if (hasNumber && !isIgnored) { wrapper.classList.remove('hidden-by-filter'); } else { wrapper.classList.add('hidden-by-filter'); } }); updateNumericFilteredNamesList(); }
numericFilterBtn.addEventListener('click', () => { pageBody.classList.toggle('numeric-mode'); if (pageBody.classList.contains('numeric-mode')) { numericFilterBtn.style.backgroundColor = '#28a745'; numericModeControls.style.display = 'flex'; applyNumericFilter(); } else { numericFilterBtn.style.backgroundColor = '#17a2b8'; numericModeControls.style.display = 'none'; photoGrid.querySelectorAll('.hidden-by-filter').forEach(el => el.classList.remove('hidden-by-filter')); } updatePreview(lastSelectedWrapper); });
downloadNumericBtn.addEventListener('click', () => { const filteredElements = Array.from(photoGrid.querySelectorAll('.photo-wrapper:not(.hidden-by-filter)')); generateZip(filteredElements, 'numeric_photos.zip'); });
applyNumericSuggestionsBtn.addEventListener('click', () => { saveState(); const visibleWrappers = Array.from(photoGrid.querySelectorAll('.photo-wrapper:not(.hidden-by-filter)')); const suggestionsList = numericNameSuggestions.value.trim().split('\n').filter(Boolean); const suggestionCount = parseInt(suggestionCountSelect.value, 10); const numItems = visibleWrappers.length; if (suggestionsList.length < numItems * suggestionCount) { return alert(`Danh s√°ch t√™n g·ª£i √Ω kh√¥ng ƒë·ªß. C·∫ßn ${numItems * suggestionCount} d√≤ng cho ${numItems} ·∫£nh v·ªõi ${suggestionCount} g·ª£i √Ω m·ªói ·∫£nh.`); } let namesChanged = false; visibleWrappers.forEach((wrapper, index) => { const itemSuggestions = []; for (let i = 0; i < suggestionCount; i++) { const suggestionIndex = index + (numItems * i); if(suggestionsList[suggestionIndex]){ itemSuggestions.push(suggestionsList[suggestionIndex].trim()); } } wrapper.dataset.suggestions = JSON.stringify(itemSuggestions); if (suggestionCount === 1 && itemSuggestions.length > 0) { const nameInput = wrapper.querySelector('.name-container input[type="text"]'); const currentPrefix = nameInput.value.match(/^\d+\.\s+/); const newName = (currentPrefix ? currentPrefix[0] : '') + itemSuggestions[0]; if (nameInput.value !== newName) { nameInput.value = newName; namesChanged = true; } } }); if (namesChanged) { syncNameListFromInputs(); if (lastSelectedWrapper) { previewNameInput.value = lastSelectedWrapper.querySelector('.name-container input[type="text"]').value; } } alert(`ƒê√£ g√°n g·ª£i √Ω cho ${numItems} ·∫£nh.` + (suggestionCount === 1 ? ' C√°c t√™n ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông √°p d·ª•ng.' : '')); if(lastSelectedWrapper) updateSuggestionButtons(lastSelectedWrapper); updateCurrentState(); });
async function replaceImageForWrapper(wrapper, newFile) { if (!wrapper || !newFile || (!newFile.type.startsWith('image/') && newFile.type !== 'application/octet-stream')) return; saveState(); const id = wrapper.getAttribute('data-photo-id'); if (!id) return; let processedBlob = await processImageRotation(newFile); if (processedBlob.type === 'application/octet-stream') { const originalName = newFile.name; const correctedType = getMimeTypeFromName(originalName, processedBlob.type); if (correctedType !== processedBlob.type) { processedBlob = new Blob([processedBlob], { type: correctedType }); } } photoDataMap.set(id, { ...photoDataMap.get(id), blob: processedBlob }); const newUrl = URL.createObjectURL(processedBlob); wrapper.querySelector('.photo-item').src = newUrl; wrapper.classList.toggle('is-small', newFile.size < 40000); if (pageWrapper.classList.contains('highlight-tall-active')) { const img = new Image(); img.onload = () => { wrapper.classList.toggle('is-tall', img.naturalHeight > img.naturalWidth); URL.revokeObjectURL(img.src); }; img.src = newUrl; } if (wrapper.classList.contains('selected-photo')) { updatePreview(wrapper); } updateCurrentState(); }
mainContentEl.addEventListener('click', async (event) => { const target = event.target; const wrapper = target.closest('.photo-wrapper'); document.querySelectorAll('.replace-panel').forEach(panel => { if (!panel.contains(target) && !panel.previousElementSibling.contains(target)) { panel.style.display = 'none'; } }); if (wrapper) { if (target.classList.contains('delete-btn')) { saveState(); const wasSelected = wrapper.classList.contains('selected-photo'); if (lastSelectedWrapper === wrapper) lastSelectedWrapper = null; wrapper.remove(); updateNumberingAndSync(); updateCurrentState(); if (wasSelected) updatePreview(null); return; } if (target.classList.contains('exclude-numeric-btn')) { wrapper.dataset.numericIgnored = wrapper.dataset.numericIgnored === 'true' ? 'false' : 'true'; target.innerHTML = wrapper.dataset.numericIgnored === 'true' ? '&#9733;' : '&#10007;'; if (pageBody.classList.contains('numeric-mode')) { applyNumericFilter(); } saveState(); return; } if (target.classList.contains('replace-btn')) { const panel = wrapper.querySelector('.replace-panel'); panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex'; return; } if (target.classList.contains('replace-from-file-btn')) { const fileInput = document.createElement('input'); fileInput.type = 'file'; fileInput.accept = 'image/*,application/octet-stream'; fileInput.onchange = (e) => { if (e.target.files.length > 0) { replaceImageForWrapper(wrapper, e.target.files[0]); } }; fileInput.click(); wrapper.querySelector('.replace-panel').style.display = 'none'; return; } if (target.classList.contains('replace-from-clipboard-btn')) { try { const clipboardItems = await navigator.clipboard.read(); const imageItem = clipboardItems.find(item => item.types.some(type => type.startsWith('image/') || type === 'application/octet-stream')); if (imageItem) { const imageType = imageItem.types.find(type => type.startsWith('image/') || type === 'application/octet-stream'); const blob = await imageItem.getType(imageType); const file = new File([blob], "clipboard_image.png", { type: blob.type }); await replaceImageForWrapper(wrapper, file); } else { alert('Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o trong clipboard.'); } } catch (err) { console.error('L·ªói khi ƒë·ªçc clipboard:', err); alert('Kh√¥ng th·ªÉ truy c·∫≠p clipboard. Vui l√≤ng ƒë·∫£m b·∫£o b·∫°n ƒë√£ c·∫•p quy·ªÅn v√† ƒëang s·ª≠ d·ª•ng k·∫øt n·ªëi an to√†n (HTTPS).'); } wrapper.querySelector('.replace-panel').style.display = 'none'; return; } if (target.closest('.img-container')) { if (!event.ctrlKey && !event.shiftKey) { document.querySelectorAll('.selected-photo').forEach(w => w.classList.remove('selected-photo')); wrapper.classList.add('selected-photo'); } else if (event.ctrlKey) { wrapper.classList.toggle('selected-photo'); } else if (event.shiftKey && lastSelectedWrapper) { const wrappers = Array.from(photoGrid.querySelectorAll('.photo-wrapper:not(.hidden-by-filter)')); const [start, end] = [wrappers.indexOf(lastSelectedWrapper), wrappers.indexOf(wrapper)].sort((a,b)=>a-b); for (let i = start; i <= end; i++) wrappers[i].classList.add('selected-photo'); } lastSelectedWrapper = wrapper.classList.contains('selected-photo') ? wrapper : (photoGrid.querySelector('.selected-photo') || null); updatePreview(lastSelectedWrapper); } } });
mainContentEl.addEventListener('input', (event) => { const target = event.target; if (target.matches('.name-container input[type="text"]')) { const wrappers = Array.from(photoGrid.querySelectorAll('.photo-wrapper')); const index = wrappers.indexOf(target.closest('.photo-wrapper')); const allInputs = photoGrid.querySelectorAll('.name-container input[type="text"]'); const names = Array.from(allInputs).map(inp => removeLeadingOrderPrefix(inp.value.trim())); nameListTextArea.value = names.join('\n'); if (index >= 0) { const lineHeight = 18; const scrollPos = index * lineHeight; nameListTextArea.scrollTop = scrollPos; } if (target.closest('.photo-wrapper').classList.contains('selected-photo')) { previewNameInput.value = target.value; } } if (target.matches('.name-container input[type="text"], #name-list, #local-note-area')) { clearTimeout(target.saveTimeout); target.saveTimeout = setTimeout(() => { saveState(); updateCurrentState(); }, 500); } });
localNoteArea.addEventListener('input', () => { localStorage.setItem('localNote', localNoteArea.value); });
hotkeySettingsContainer.addEventListener('keydown', (e) => { const input = e.target; if (input.tagName === 'INPUT') { e.preventDefault(); const keyValue = e.code.startsWith('Key') || e.code.startsWith('Digit') || e.code.startsWith('Arrow') ? e.code : e.key; input.value = keyValue; const action = input.dataset.action; if (action) { hotkeys[action] = keyValue; saveHotkeys(); } } });
pinToolbarBtn.addEventListener('click', () => { const isCurrentlyPinned = pageWrapper.classList.contains('toolbar-pinned'); setToolbarPinned(!isCurrentlyPinned); });
document.addEventListener('mousemove', (e) => { if (!pageWrapper.classList.contains('toolbar-pinned')) { if (e.clientX < 15) { toolbar.classList.add('visible'); } } });
toolbar.addEventListener('mouseleave', () => { if (!pageWrapper.classList.contains('toolbar-pinned')) { toolbar.classList.remove('visible'); } });
function initializeApp() {
    loadHotkeys();
    initializeSpeechRecognition();
    const savedNote = localStorage.getItem('localNote');
    if (savedNote) { localNoteArea.value = savedNote; }
    const isPinned = localStorage.getItem('toolbarPinned') === 'true';
    setToolbarPinned(isPinned);
    reInitializeApp();
    saveState();
}

initializeApp();

</script>
</body>
</html>

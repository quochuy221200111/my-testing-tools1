<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghi Chú Đám Mây An Toàn</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f5f5f7; color: #1d1d1f; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #0071e3; margin-top: 0; }
        .config-section { background-color: #eef7ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #cce5ff; }
        .config-section p { margin-top: 0; }
        .config-section label { display: block; margin-bottom: 10px; font-weight: 500; }
        .config-section input { width: 95%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; font-family: monospace; }
        textarea { width: 100%; height: 60vh; padding: 15px; border: 1px solid #dcdcdc; border-radius: 8px; font-size: 16px; line-height: 1.6; box-sizing: border-box; resize: vertical; }
        .status-bar { margin-top: 15px; font-size: 14px; color: #6e6e73; text-align: center; }
        .button-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; }
        button { background-color: #0071e3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 500; }
        button:hover { background-color: #0077ed; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ghi Chú Đám Mây</h1>
        <div id="config-section" class="config-section">
            <p>Lần đầu sử dụng, hãy dán Token và Gist ID của bạn vào đây. Thông tin sẽ được lưu an toàn trên trình duyệt này.</p>
            <label for="gist-id-input">GIST_ID:</label>
            <input type="text" id="gist-id-input" placeholder="Dán Gist ID của bạn vào đây">
            <label for="token-input">GITHUB_TOKEN:</label>
            <input type="password" id="token-input" placeholder="Dán GitHub Token (ghp_...) vào đây">
            <button onclick="saveConfig()">Lưu Cấu Hình và Bắt Đầu</button>
        </div>
        <div id="editor-section" class="hidden">
            <textarea id="editor" placeholder="Đang tải ghi chú..."></textarea>
            <div class="button-container">
                <button onclick="saveNote()">Lưu Ngay</button>
                <button onclick="loadNote()">Tải Lại</button>
                <button onclick="copyNote()" style="background-color:#1a73e8;">Sao Chép</button>
                <button onclick="pasteNote()" style="background-color:#1a73e8;">Dán</button>
                <button onclick="clearConfig()" style="background-color:#6e6e73;">Xóa Cấu Hình</button>
            </div>
            <div id="status" class="status-bar">Sẵn sàng.</div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const statusDiv = document.getElementById('status');
        const configSection = document.getElementById('config-section');
        const editorSection = document.getElementById('editor-section');
        const gistIdInput = document.getElementById('gist-id-input');
        const tokenInput = document.getElementById('token-input');
        
        const FILENAME = 'note.txt';
        let GIST_ID = '';
        let GITHUB_TOKEN = '';

        function updateStatus(message, isError = false) { statusDiv.textContent = message; statusDiv.style.color = isError ? '#d93025' : '#6e6e73'; }

        function saveConfig() {
            const gistId = gistIdInput.value.trim();
            const token = tokenInput.value.trim();
            if (!gistId || !token) { alert('Vui lòng nhập cả Gist ID và GitHub Token.'); return; }
            localStorage.setItem('githubNoteGistId', gistId);
            localStorage.setItem('githubNoteToken', token);
            initializeApp();
        }

        function clearConfig() {
            if (confirm('Bạn có chắc muốn xóa cấu hình khỏi trình duyệt này không?')) {
                localStorage.removeItem('githubNoteGistId');
                localStorage.removeItem('githubNoteToken');
                location.reload();
            }
        }

        async function loadNote() {
            updateStatus('Đang tải ghi chú...');
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, { headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}` } });
                if (response.status === 401) throw new Error('Token không hợp lệ hoặc đã hết hạn.');
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.status}`);
                const data = await response.json();
                editor.value = data.files[FILENAME]?.content || '';
                updateStatus(`Cập nhật lần cuối lúc ${new Date().toLocaleTimeString()}.`);
            } catch (error) { updateStatus(`Lỗi khi tải: ${error.message}`, true); }
        }

        async function saveNote() {
            updateStatus('Đang lưu...');
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ files: { [FILENAME]: { content: editor.value } } }) });
                if (response.status === 401) throw new Error('Token không hợp lệ hoặc đã hết hạn.');
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.status}`);
                updateStatus(`Đã lưu thành công lúc ${new Date().toLocaleTimeString()}.`);
            } catch (error) { updateStatus(`Lỗi khi lưu: ${error.message}`, true); }
        }

        async function copyNote() {
            if (!navigator.clipboard) {
                updateStatus('Trình duyệt của bạn không hỗ trợ sao chép.', true);
                return;
            }
            try {
                await navigator.clipboard.writeText(editor.value);
                updateStatus('Đã sao chép vào clipboard!');
            } catch (err) {
                updateStatus('Không thể sao chép.', true);
                console.error('Lỗi khi sao chép: ', err);
            }
        }

        async function pasteNote() {
            if (!navigator.clipboard) {
                updateStatus('Trình duyệt của bạn không hỗ trợ dán.', true);
                return;
            }
            try {
                const text = await navigator.clipboard.readText();
                editor.value = text;
                updateStatus('Đã dán từ clipboard!');
                // Tự động lưu sau khi dán
                saveNote();
            } catch (err) {
                updateStatus('Không thể dán. Hãy chắc chắn bạn đã cấp quyền truy cập clipboard.', true);
                console.error('Lỗi khi dán: ', err);
            }
        }
        
        function initializeApp() {
            GIST_ID = localStorage.getItem('githubNoteGistId');
            GITHUB_TOKEN = localStorage.getItem('githubNoteToken');
            if (GIST_ID && GITHUB_TOKEN) {
                configSection.classList.add('hidden');
                editorSection.classList.remove('hidden');
                loadNote();
                let debounceTimer;
                editor.addEventListener('input', () => {
                    updateStatus('Nội dung đã thay đổi...');
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(saveNote, 3000);
                });
            } else {
                configSection.classList.remove('hidden');
                editorSection.classList.add('hidden');
            }
        }
        initializeApp();
    </script>
</body>
</html>

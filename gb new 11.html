
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>B√°o C√°o Ki·ªÉm ƒê·ªãnh S·∫£n Ph·∫©m ƒêa Phi√™n</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/unrar-js@1.0.1/unrar.min.js"></script>

<style>
:root {
--color-unchecked: #fee;
--color-checked: #e6ffed;
--color-unchecked-border: #f88;
--color-checked-border: #8f8;
--color-primary: #007bff;
--color-secondary: #6c757d;
--color-danger: #dc3545;
--color-success: #28a745;
--color-dark: #343a40;
--color-light-gray: #f8f9fa;
--header-height: 110px; /* Chi·ªÅu cao d·ª± ki·∫øn ban ƒë·∫ßu */
}

body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
margin: 0;
padding-top: var(--header-height);
padding-bottom: 200px;
background-color: var(--color-light-gray);
transition: padding-top 0.3s;
}

/* --- N√∫t ·∫®n/Hi·ªán Menu --- */
#toggle-menu-btn {
position: fixed;
top: 10px;
right: 10px;
z-index: 10001; /* Cao h∆°n m·ªçi th·ª© */
background-color: var(--color-primary);
color: white;
border: 2px solid white;
border-radius: 5px;
padding: 5px 10px;
cursor: pointer;
font-size: 20px;
box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* --- Thanh Tabs --- */
#tabs-container {
position: fixed;
top: 0;
left: 0;
right: 50px; /* Ch·ª´a ch·ªó cho n√∫t menu */
min-height: 40px;
background: #e9ecef;
display: flex;
align-items: center;
padding: 0 5px;
gap: 5px;
overflow-x: auto;
white-space: nowrap;
border-bottom: 1px solid #ccc;
z-index: 1000;
transition: transform 0.3s;
box-sizing: border-box;
}
.tab-item {
padding: 8px 15px;
background: #ccc;
border-radius: 5px 5px 0 0;
cursor: grab;
font-weight: bold;
color: #555;
position: relative;
user-select: none;
border: 1px solid #bbb;
border-bottom: none;
transition: background-color 0.2s, color 0.2s, opacity 0.2s;
}
.tab-item.active {
background: white;
color: var(--color-primary);
border-bottom: 2px solid white;
z-index: 1001;
cursor: default;
}
.tab-item.dragging {
opacity: 0.5;
background: #d0eaff;
}
.tab-item.drag-over {
border-left: 2px solid var(--color-primary);
}
.tab-item input {
border: 1px solid #007bff;
padding: 5px;
font-size: 13px;
font-weight: bold;
}
.tab-close {
margin-left: 8px;
color: #888;
font-size: 12px;
cursor: pointer;
}
.tab-close:hover { color: red; }
#add-tab-btn {
padding: 5px 10px;
background: var(--color-success);
color: white;
border: none;
border-radius: 3px;
cursor: pointer;
font-weight: bold;
font-size: 16px;
}

/* --- Thanh ƒëi·ªÅu khi·ªÉn --- */
#controls {
position: fixed;
top: 40px; /* N·∫±m d∆∞·ªõi Tabs */
left: 0;
right: 0;
background-color: white;
z-index: 999;
padding: 10px 15px;
border-bottom: 2px solid #ddd;
display: flex;
gap: 10px;
align-items: center;
flex-wrap: wrap;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
transition: transform 0.3s;
box-sizing: border-box;
}

/* Class ƒë·ªÉ ·∫©n header khi toggle */
body.header-hidden {
padding-top: 10px !important;
}
body.header-hidden #tabs-container,
body.header-hidden #controls {
transform: translateY(-150%); /* ƒê·∫©y l√™n tr√™n m√†n h√¨nh */
}

.control-group {
display: flex;
gap: 8px;
align-items: center;
border-left: 1px solid #eee;
padding-left: 8px;
}
.control-group:first-child {
    border-left: none;
    padding-left: 0;
}


#controls button, #controls .file-input-label {
padding: 8px 12px;
border: 1px solid #ccc;
background-color: #f0f0f0;
cursor: pointer;
border-radius: 5px;
font-size: 12px;
font-weight: 500;
transition: background-color 0.2s, opacity 0.2s;
display: flex;
align-items: center;
justify-content: center;
}
#controls button:hover, #controls .file-input-label:hover {
background-color: #e0e0e0;
}
#controls button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

#controls #exportZip { background-color: var(--color-primary); color: white; border-color: var(--color-primary); font-weight: bold; }
#controls #exportZipNoVideo { background-color: #0056b3; color: white; }
#controls #exportOnlyVideos { background-color: #5a2c82; color: white; }
#controls #clearAll { background-color: var(--color-danger); color: white; border-color: var(--color-danger); }

/* N√∫t m·ªõi */
#addManualImageBtn { background-color: #17a2b8; color: white; }
#toggleSelectModeBtn.active { background-color: #ffc107; color: black; font-weight: bold; }
#exportSelectedBtn { background-color: #fd7e14; color: white; }
#moveSelectedUpBtn, #moveSelectedDownBtn { font-size: 18px; padding: 5px 12px; background-color: #e9ecef; }
/* [Y√äU C·∫¶U 1] N√∫t ch·ª•p nhanh */
#quickShotBtn { background-color: #6f42c1; color: white; font-weight: bold; }

/* [Y√äU C·∫¶U 3] N√∫t d·ªãch */
#translateToEnBtn, #translateToZhBtn, #revertTranslationBtn {
    background-color: #343a40;
    color: white;
}
#revertTranslationBtn { background-color: #6c757d; }


h2 {
padding: 0 15px;
margin-top: 25px;
margin-bottom: 15px;
border-bottom: 1px solid #ccc;
padding-bottom: 10px;
}

/* --- 1. ·∫¢nh Chi Ti·∫øt S·∫£n Ph·∫©m --- */
#boxes-container {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 10px;
padding: 0 15px;
}
.box {
position: relative;
border: 2px solid var(--color-unchecked-border);
background-color: var(--color-unchecked);
text-align: center;
aspect-ratio: 1 / 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
border-radius: 5px;
overflow: hidden;
transition: background-color 0.3s, border-color 0.3s, box-shadow 0.2s;
}
.box.selected {
border: 3px solid #0056b3;
box-shadow: 0 0 15px rgba(0, 86, 179, 0.7);
}
/* [Y√äU C·∫¶U 1] CSS CHO √î ·∫¢NH ƒê∆Ø·ª¢C FOCUS */
.box.last-shot-focus {
    border: 4px solid #ff8c00; /* Vi·ªÅn m√†u cam ƒë·∫≠m n·ªïi b·∫≠t */
    box-shadow: 0 0 15px rgba(255, 140, 0, 0.8);
}
.multi-select-mode .box .thumbnail {
cursor: pointer;
}
.box.has-photo {
background-color: var(--color-checked);
border-color: var(--color-checked-border);
}
.thumbnail { width: 90%; height: 65%; object-fit: cover; cursor: pointer; border: 1px solid #ddd; margin-bottom: 4px; border-radius: 3px; }
.description {
margin: 0;
word-break: break-word;
font-size: 9px;
font-weight: bold;
width: 100%;
padding: 2px 4px;
user-select: text;
outline: none;
}
.description[contenteditable="true"] { cursor: text; background-color: rgba(255, 255, 255, 0.7); }
.add-box-btn, .delete-box-btn { position: absolute; width: 22px; height: 22px; color: white; border: 1px solid white; border-radius: 50%; font-size: 16px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: transform 0.2s; }
.add-box-btn:hover, .delete-box-btn:hover { transform: scale(1.1); }
.add-box-btn { top: -5px; left: -5px; background-color: var(--color-primary); }
.delete-box-btn { top: -5px; right: -5px; background-color: var(--color-danger); line-height: 22px; }

/* --- 2. ·∫¢nh & Video Factory --- */
.factory-controls { padding: 0 15px; display: flex; gap: 10px; margin-bottom: 15px; }
.factory-controls button { flex: 1; padding: 15px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 8px; cursor: pointer; }
#addFactoryPhotoBtn { background-color: var(--color-dark); }
#addFactoryVideoBtn { background-color: #5a2c82; }

#factory-media-container { padding: 0 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
.factory-media-item { position: relative; }
.factory-media-item img, .factory-media-item video { width: 100%; height: auto; display: block; border-radius: 8px; border: 2px solid #ccc; }
.delete-factory-media-btn { position: absolute; top: 5px; right: 5px; background-color: var(--color-danger); z-index: 5;}


/* --- 3. X√°c nh·∫≠n Ki·ªÉm ƒë·ªãnh --- */
#inspection-section { padding: 0 15px; margin-top: 20px; }
.item-code-manager { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
.item-code-manager h3 { margin-top: 0; }
.item-code-input-group { display: flex; gap: 10px; }
.item-code-input-group input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
.item-code-input-group button { padding: 8px 12px; background: var(--color-primary); color: white; border: none; border-radius: 5px; font-weight: bold; }
#item-codes-display { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
.item-code-tag { background: #e9ecef; padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 8px; }
.item-code-tag button { background: none; border: none; color: var(--color-danger); font-weight: bold; cursor: pointer; padding: 0; line-height: 1; }
.inspection-row h4, .inspection-row h5 { margin-top: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
.inspection-row h4:first-child { margin-top: 0; }
.input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
.input-group label { display: flex; flex-direction: column; flex: 1; min-width: 80px; }
.input-group label span { font-weight: 500; margin-bottom: 3px; color: #555; font-size: 14px; }
.input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
.checkbox-group { display: flex; flex-direction: column; gap: 8px; }
.tick-label { display: block; padding: 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, border-color 0.3s; background-color: var(--color-unchecked); border: 2px solid var(--color-unchecked-border); }
.tick-label.checked { background-color: var(--color-checked); border-color: var(--color-checked-border); }
.tick-label input[type="checkbox"] { display: none; }
.tick-label span { font-size: 14px; }
.add-aql-frame-btn { background-color: #0277bd; color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; display: block; width: 100%; margin-top: 15px; }

/* B·∫£ng AQL */
.aql-table-container { overflow-x: auto; }
.aql-results-table { width: 100%; border-collapse: collapse; margin-top: 10px; background-color: #f1f8ff; border: 1px solid #b3e5fc; border-radius: 8px; font-size: 14px; }
.aql-results-table th, .aql-results-table td { border: 1px solid #b3e5fc; padding: 8px; text-align: center; vertical-align: middle; }
.aql-results-table thead th { background-color: #0277bd; color: white; font-weight: bold; }
.aql-results-table tbody tr:nth-child(even) { background-color: #e3f2fd; }
.aql-results-table input[type="text"], .aql-results-table input[type="number"] { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box; text-align: center; }
.aql-results-table input[readonly] { background-color: #e9ecef; border: none; font-weight: bold; }
.aql-results-table .aql-test-description { text-align: left; }
.delete-aql-row-btn { background-color: #ffcdd2; color: #c62828; border: 1px solid #c62828; border-radius: 50%; width: 25px; height: 25px; line-height: 25px; text-align: center; cursor: pointer; font-weight: bold; }
.open-aql-btn { background-color: #ffc107; color: black; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 5px; }


.defect-photos-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
.defect-photo-item { position: relative; }
.defect-photo-item img { width: 100%; height: auto; border-radius: 5px; }
.add-defect-photo-btn { display: block; width: 100%; margin-top: 15px; padding: 10px; background-color: var(--color-danger); color: white; border: none; border-radius: 5px; font-weight: bold; }


/* --- 4. ·∫¢nh Ghi Ch√∫ --- */
#note-controls { padding: 0 15px; display: flex; gap: 10px; margin-bottom: 15px; }
#note-controls .file-input-label, #note-controls button { flex: 1; display: block; width: auto; margin: 0; padding: 15px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 8px; cursor: pointer; text-align: center; }
#addNotePhotoBtnLabel { background-color: var(--color-success); }
#noteZipInputLabel { background-color: #ff9800; }

#note-photos-container { padding: 0 15px 15px 15px; display: flex; flex-direction: column; gap: 15px; }
.note-photo-item { position: relative; }
.note-photo-item img { width: 100%; height: auto; max-width: 100%; display: block; border-radius: 8px; border: 2px solid #ccc; }
.delete-note-photo-btn { position: absolute; top: 5px; right: 5px; background-color: var(--color-danger); }

/* [Y√äU C·∫¶U 2] V√πng ghi ch√∫ */
#notes-section {
    padding: 0 15px;
    margin-top: 20px;
}
#local-notes {
    width: 100%;
    min-height: 150px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    font-size: 1rem;
    font-family: inherit;
}


/* --- Ti·ªán √≠ch & Zoom --- */
.hidden { display: none !important; }

/* Overlay ti·∫øn tr√¨nh chung (ch·∫∑n thao t√°c) */
#progress-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 12000; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; }
#progress-bar { width: 80%; max-width: 400px; }
#progress-text { margin-top: 10px; font-size: 16px; font-weight: bold; }

/* Container ch·ª©a c√°c thanh ti·∫øn tr√¨nh video (Kh√¥ng ch·∫∑n thao t√°c) */
#video-queue-container { position: fixed; bottom: 10px; left: 10px; width: 300px; z-index: 9999; display: flex; flex-direction: column-reverse; gap: 10px; pointer-events: none; }
.video-progress-item { background-color: rgba(0, 0, 0, 0.85); color: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); pointer-events: auto; display: flex; flex-direction: column; gap: 5px; border-left: 5px solid var(--color-primary); }
.video-progress-item p { margin: 0; font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.video-progress-item.finished { border-left-color: var(--color-success); opacity: 0; transition: opacity 1s ease-out 2s; }
.video-progress-item.error { border-left-color: var(--color-danger); }


/* Zoom */
.zoom-icon { position: absolute; bottom: 30px; right: 5px; width: 20px; height: 20px; background-color: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 5; border: 1px solid white; }
#zoom-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 10000; overflow: hidden; touch-action: none; }
#zoom-image { max-width: 100%; max-height: 100%; transform-origin: center center; transition: transform 0.1s ease-out; cursor: grab; }
.zoom-close-btn { position: absolute; top: 15px; right: 25px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 10001; }
.zoom-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; font-size: 40px; cursor: pointer; padding: 10px; z-index: 10001; user-select: none; }
#zoom-prev { left: 15px; }
#zoom-next { right: 15px; }

/* [Y√äU C·∫¶U 1] MODAL CH·ª§P NHANH */
#quick-shot-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 14000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 15px;
}
#quick-shot-video {
    width: 90%;
    max-width: 600px;
    height: auto;
    border: 2px solid white;
    border-radius: 10px;
}
#quick-shot-canvas {
    display: none; /* Canvas d√πng ƒë·ªÉ x·ª≠ l√Ω, kh√¥ng c·∫ßn hi·ªÉn th·ªã */
}
#quick-shot-actions {
    display: flex;
    gap: 20px;
}
#quick-shot-actions button {
    padding: 12px 25px;
    font-size: 1.2rem;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    cursor: pointer;
}
#do-quick-shot-btn {
    background-color: var(--color-danger);
    color: white;
}
#close-quick-shot-btn {
    background-color: var(--color-secondary);
    color: white;
}


/* MODAL AQL */
#aql-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 10001; display: none; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; }
#aql-modal-content { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
#aql-modal-content h1 { text-align: center; color: #0056b3; margin-top:0; margin-bottom: 25px; font-size: 1.5rem; }
.aql-calculator-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
@media (min-width: 768px) { .aql-calculator-grid { grid-template-columns: 1fr 1.2fr; } }
.aql-input-section, .aql-result-section { padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; }
.aql-input-section h2, .aql-result-section h2 { margin-top: 0; color: #1a73e8; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; font-size: 1.2em; }
.aql-form-group { margin-bottom: 15px; }
.aql-form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
.aql-form-group input, .aql-form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
.aql-result-summary { display: flex; justify-content: space-around; text-align: center; background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
.aql-result-summary .label { font-size: 0.9em; color: #555; }
.aql-result-summary .value { font-size: 1.4em; font-weight: bold; color: #0056b3; }
.aql-result-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
.aql-result-table th, .aql-result-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
.aql-result-table th { background-color: #1a73e8; color: white; font-weight: bold; }
.aql-result-table .accept { color: var(--color-success); font-weight: bold; }
.aql-result-table .reject { color: var(--color-danger); font-weight: bold; }
.aql-modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
#aqlApplyBtn { background-color: var(--color-success); color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
#aqlCloseBtn { background-color: var(--color-secondary); color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }

/* G∆Ø∆†NG CH·ª§P NHANH - ƒê√É C·∫¨P NH·∫¨T */
#next-shot-mirror {
    position: fixed; /* Lu√¥n c·ªë ƒë·ªãnh tr√™n m√†n h√¨nh d√π cu·ªôn trang */
    bottom: 20px; /* C√°ch ƒë√°y m√†n h√¨nh 20px */
    left: 50%; /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
    width: 175px;
    height: 175px;
    /* D·ªãch chuy·ªÉn v·ªÅ b√™n tr√°i 50% chi·ªÅu r·ªông c·ªßa n√≥ ƒë·ªÉ th·ª±c s·ª± ·ªü gi·ªØa */
    /* Xoay 90 ƒë·ªô ƒë·ªÉ ph√π h·ª£p khi c·∫ßm ƒëi·ªán tho·∫°i d·ªçc ch·ª•p ·∫£nh ngang */
    transform: translateX(-50%) rotate(90deg);
    background-color: #ffffff;
    border: 3px solid #007bff; /* M√†u vi·ªÅn ch√≠nh */
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.25);
    z-index: 2000; /* N·ªïi l√™n tr√™n h·∫ßu h·∫øt c√°c ph·∫ßn t·ª≠ kh√°c */
    cursor: pointer; /* Bi·∫øn con tr·ªè th√†nh h√¨nh b√†n tay, b√°o hi·ªáu c√≥ th·ªÉ click */
    display: flex; /* D√πng flexbox ƒë·ªÉ cƒÉn ch·ªânh n·ªôi dung b√™n trong */
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* ·∫®n g∆∞∆°ng ƒëi khi c√≥ class n√†y */
#next-shot-mirror.hidden {
    display: none !important;
}

/* V√¥ hi·ªáu h√≥a g∆∞∆°ng (m·ªù ƒëi v√† kh√¥ng click ƒë∆∞·ª£c) */
#next-shot-mirror.disabled {
    opacity: 0.3;
    pointer-events: none;
}

/* CSS cho ·∫£nh v√† m√¥ t·∫£ b√™n trong */
#next-shot-thumbnail {
    width: 90%;
    height: 70%;
    object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh l·∫•p ƒë·∫ßy m√† kh√¥ng b·ªã m√©o */
    border: 1px solid #ccc;
    border-radius: 5px;
}

#next-shot-description {
    margin-top: 8px;
    font-size: 13px;
    font-weight: bold;
    text-align: center;
    /* Gi·ªõi h·∫°n m√¥ t·∫£ trong 2 d√≤ng */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* N√∫t b·∫≠t/t·∫Øt g∆∞∆°ng (gi·ªØ l·∫°i t·ª´ m√£ g·ªëc ƒë·ªÉ ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông) */
#toggle-mirror-btn { 
    position: absolute; 
    top: -5px; 
    left: -5px; 
    width: 28px; 
    height: 28px; 
    background-color: #f44336; 
    color: white; 
    border: 2px solid white; 
    border-radius: 50%; 
    font-size: 14px; 
    font-weight: bold; 
    line-height: 24px; 
    text-align: center; 
    cursor: pointer; 
    z-index: 2001; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.3); 
    pointer-events: all !important; 
}


/* B·∫¢NG T√çNH SAI S·ªê */
#tolerance-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 11000; display: none; justify-content: center; align-items: center; color: white; flex-direction: row; gap: 20px; padding: 20px; box-sizing: border-box; }
#tolerance-modal-content { display: contents; }
#tolerance-photo-container { flex: 1; max-width: 45%; }
#tolerance-photo-container img { width: 100%; height: auto; border-radius: 8px; border: 2px solid #fff; }
#tolerance-calculator-container { flex: 1; display: flex; flex-direction: column; gap: 15px; }
#tolerance-edit-container { text-align: center; }
#tolerance-edit-container label { display: block; margin-bottom: 5px; font-weight: bold; }
#tolerance-value-input { width: 80%; padding: 8px; font-size: 1.2rem; text-align: center; border-radius: 5px; border: 2px solid var(--color-primary); }
#tolerance-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 1.2rem; }
#tolerance-table th, #tolerance-table td { border: 1px solid #555; padding: 10px; }
#tolerance-table th { background-color: var(--color-primary); }
#tolerance-table tr:first-child td { font-weight: bold; font-size: 1.5rem; color: #ffeb3b; }
#tolerance-table tr:nth-child(even) { background-color: #333; }
.tolerance-header { font-weight: bold; color: #4caf50; }
#close-tolerance-modal-btn { position: absolute; top: 15px; right: 25px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 11001; }
@media (orientation: portrait) {
#tolerance-modal-overlay { flex-direction: column; }
#tolerance-photo-container { max-width: 80%; margin-bottom: 20px; }
}

/* MODAL C·∫ÆT ·∫¢NH */
#crop-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 13000;
    display: none;
    justify-content: center;
    align-items: center;
    -webkit-user-select: none; /* Safari */
    -ms-user-select: none; /* IE 10+ */
    user-select: none;
}
#crop-container {
    position: relative;
    max-width: 95vw;
    max-height: 80vh;
}
#crop-image-preview {
    max-width: 100%;
    max-height: 100%;
    display: block;
}
#crop-box {
    position: absolute;
    box-sizing: border-box;
    border: 2px dashed white;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    cursor: move;
}
.crop-handle {
    position: absolute;
    width: 12px; height: 12px;
    background-color: white;
    border: 1px solid black;
    border-radius: 50%;
}
.crop-handle.nw { top: -6px; left: -6px; cursor: nwse-resize; }
.crop-handle.ne { top: -6px; right: -6px; cursor: nesw-resize; }
.crop-handle.sw { bottom: -6px; left: -6px; cursor: nesw-resize; }
.crop-handle.se { bottom: -6px; right: -6px; cursor: nwse-resize; }

.crop-handle.n { top: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
.crop-handle.s { bottom: -6px; left: 50%; transform: translateX(-50%); cursor: ns-resize; }
.crop-handle.w { top: 50%; left: -6px; transform: translateY(-50%); cursor: ew-resize; }
.crop-handle.e { top: 50%; right: -6px; transform: translateY(-50%); cursor: ew-resize; }


#crop-actions {
    position: absolute;
    bottom: -60px; /* TƒÉng kho·∫£ng c√°ch */
    left: 50%;
    transform: translateX(-50%);
    display: flex; gap: 15px;
}
#crop-actions button {
    padding: 12px 25px; /* TƒÉng k√≠ch th∆∞·ªõc n√∫t */
    font-size: 16px;
    font-weight: bold;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
#confirm-crop-btn { background-color: var(--color-success); }
#cancel-crop-btn { background-color: var(--color-danger); }
</style>
</head>
<body>

<!-- N√∫t ·∫®n/Hi·ªán Menu -->
<button id="toggle-menu-btn" title="·∫®n/Hi·ªán Menu">‚ò∞</button>

<!-- Thanh Tabs qu·∫£n l√Ω phi√™n -->
<div id="tabs-container">
<!-- Tabs s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JS -->
<button id="add-tab-btn" title="Th√™m phi√™n m·ªõi">+</button>
</div>

<!-- Thanh ƒëi·ªÅu khi·ªÉn -->
<div id="controls">
<div class="control-group">
<label for="zipFileInput" class="file-input-label">Nh·∫≠p SP (ZIP/RAR)</label>
<button id="exportZip">Xu·∫•t ZIP (Full)</button>
<button id="exportZipNoVideo">Xu·∫•t ZIP (Kh√¥ng Video)</button>
<button id="exportOnlyVideos">Ch·ªâ Xu·∫•t Video</button>
</div>
<div class="control-group">
<button id="undoBtn" disabled title="Ho√†n t√°c">‚Ü∂</button>
<button id="redoBtn" disabled title="L√†m l·∫°i">‚Ü∑</button>
</div>
<div class="control-group">
<button id="scrollToTop" title="Cu·ªôn l√™n ƒë·∫ßu">‚Üë‚Üë</button>
<button id="scrollToEnd" title="Cu·ªôn xu·ªëng cu·ªëi">‚Üì‚Üì</button>
</div>
<div class="control-group">
<button id="addManualImageBtn" title="Th√™m ·∫£nh t·ª´ m√°y v√† s·ª≠a">Th√™m & S·ª≠a ·∫¢nh</button>
<!-- [Y√äU C·∫¶U 1] N√∫t Ch·ª•p Nhanh M·ªõi -->
<button id="quickShotBtn" title="Ch·ª•p ·∫£nh nhanh kh√¥ng c·∫ßn x√°c nh·∫≠n">üì∑ Ch·ª•p Nhanh</button>
<button id="toggleToleranceBtn">ƒê·ªëi chi·∫øu: B·∫≠t</button>
</div>
<!-- C√°c n√∫t ch·ªçn v√† ƒëi·ªÅu h∆∞·ªõng nhi·ªÅu ·∫£nh -->
<div class="control-group">
<button id="toggleSelectModeBtn" title="B·∫≠t/t·∫Øt ch·∫ø ƒë·ªô ch·ªçn nhi·ªÅu ·∫£nh">Ch·ªçn Nhi·ªÅu ·∫¢nh</button>
<button id="exportSelectedBtn" class="hidden" title="Xu·∫•t file ZIP ch·ªâ ch·ª©a c√°c ·∫£nh ƒë√£ ch·ªçn">Xu·∫•t m·ª•c ƒë√£ ch·ªçn</button>
<button id="moveSelectedUpBtn" class="hidden" title="Di chuy·ªÉn nh√≥m ƒë√£ ch·ªçn l√™n tr√™n">‚Üë</button>
<button id="moveSelectedDownBtn" class="hidden" title="Di chuy·ªÉn nh√≥m ƒë√£ ch·ªçn xu·ªëng d∆∞·ªõi">‚Üì</button>
</div>
<!-- [Y√äU C·∫¶U 3] Nh√≥m n√∫t d·ªãch -->
<div class="control-group">
    <button id="translateToEnBtn" title="D·ªãch t√™n t·∫•t c·∫£ ·∫£nh sang Ti·∫øng Anh">D·ªãch sang Ti·∫øng Anh</button>
    <button id="translateToZhBtn" title="D·ªãch t√™n t·∫•t c·∫£ ·∫£nh sang Ti·∫øng Trung">D·ªãch sang Ti·∫øng Trung</button>
    <button id="revertTranslationBtn" title="Kh√¥i ph·ª•c l·∫°i t√™n ·∫£nh g·ªëc" class="hidden">Kh√¥i ph·ª•c g·ªëc</button>
</div>
<div class="control-group">
<button id="clearAll" title="X√≥a d·ªØ li·ªáu phi√™n n√†y">X√≥a Phi√™n</button>
</div>
<input type="file" id="zipFileInput" class="hidden" accept=".zip,.rar">
<input type="file" id="manualImageInput" class="hidden" accept="image/*">
</div>

<!-- Khu v·ª±c hi·ªÉn th·ªã ti·∫øn tr√¨nh -->
<div id="progress-overlay">
<progress id="progress-bar" value="0" max="100"></progress>
<p id="progress-text">ƒêang x·ª≠ l√Ω...</p>
</div>

<!-- Container ch·ª©a ti·∫øn tr√¨nh video -->
<div id="video-queue-container"></div>

<!-- Modal Ph√≥ng to ·∫¢nh -->
<div id="zoom-overlay">
<span class="zoom-close-btn">&times;</span>
<button id="zoom-prev" class="zoom-nav">&lt;</button>
<img id="zoom-image" src="" alt="Zoomed Image">
<button id="zoom-next" class="zoom-nav">&gt;</button>
</div>

<!-- [Y√äU C·∫¶U 1] Modal Ch·ª•p Nhanh -->
<div id="quick-shot-modal">
    <video id="quick-shot-video" playsinline></video>
    <canvas id="quick-shot-canvas"></canvas>
    <div id="quick-shot-actions">
        <button id="do-quick-shot-btn">Ch·ª•p</button>
        <button id="close-quick-shot-btn">ƒê√≥ng</button>
    </div>
</div>


<!-- 1. ·∫¢nh Chi Ti·∫øt S·∫£n Ph·∫©m -->
<h2>1. ·∫¢nh Chi Ti·∫øt S·∫£n Ph·∫©m</h2>
<div id="boxes-container"></div>

<!-- 2. ·∫¢nh & Video Factory -->
<h2>2. ·∫¢nh & Video Factory</h2>
<div class="factory-controls">
<button id="addFactoryPhotoBtn">Th√™m ·∫¢nh Factory</button>
<button id="addFactoryVideoBtn">Quay/Th√™m Video Factory</button>
</div>
<div id="factory-media-container"></div>
<input type="file" id="factoryPhotoInput" multiple accept="image/*" capture="camera" class="hidden">
<input type="file" id="factoryVideoInput" multiple accept="video/*" capture="user" class="hidden">

<!-- 3. X√°c Nh·∫≠n Ki·ªÉm ƒê·ªãnh -->
<h2>3. X√°c Nh·∫≠n Ki·ªÉm ƒê·ªãnh</h2>
<section id="inspection-section">
<div class="item-code-manager">
<h3>C√°c M√£ H√†ng Ki·ªÉm Tra</h3>
<div class="item-code-input-group">
<input type="text" id="itemCodeInput" placeholder="Nh·∫≠p t√™n m√£ h√†ng...">
<button id="addItemCodeBtn">+</button>
</div>
<div id="item-codes-display"></div>
</div>
<div id="inspection-rows-container"></div>
</section>

<!-- 4. ·∫¢nh Ghi Ch√∫ -->
<h2>4. ·∫¢nh Ghi Ch√∫</h2>
<div id="note-controls">
<label id="addNotePhotoBtnLabel" for="notePhotoInput" class="file-input-label">Th√™m ·∫¢nh Ghi Ch√∫</label>
<label id="noteZipInputLabel" for="noteZipInput" class="file-input-label">Import Ghi Ch√∫ (ZIP/RAR)</label>
</div>
<div id="note-photos-container"></div>
<input type="file" id="notePhotoInput" multiple accept="image/*" class="hidden">
<input type="file" id="noteZipInput" accept=".zip,.rar" class="hidden">

<!-- [Y√äU C·∫¶U 2] Ghi Ch√∫ Kinh Nghi·ªám S·∫£n Ph·∫©m -->
<section id="notes-section">
    <h2>5. Ghi Ch√∫ / Kinh Nghi·ªám S·∫£n Ph·∫©m</h2>
    <textarea id="local-notes" placeholder="Nh·∫≠p ghi ch√∫, b√†i h·ªçc kinh nghi·ªám cho s·∫£n ph·∫©m/phi√™n l√†m vi·ªác n√†y... D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông tr√™n tr√¨nh duy·ªát n√†y."></textarea>
</section>


<!-- MODAL T√çNH AQL -->
<div id="aql-modal-overlay">
<div id="aql-modal-content">
<h1>C√¥ng C·ª• T√≠nh Ti√™u Chu·∫©n AQL</h1>
<div class="aql-calculator-grid">
<div class="aql-input-section">
<h2>Th√¥ng s·ªë ƒë·∫ßu v√†o</h2>
<div class="aql-form-group">
<label for="aqlOrderQuantity">S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng (Order Quantity):</label>
<input type="number" id="aqlOrderQuantity" value="1000" min="2">
</div>
<div class="aql-form-group">
<label for="aqlInspectionLevel">C·∫•p ƒë·ªô ki·ªÉm tra (Inspection Level):</label>
<select id="aqlInspectionLevel">
<option value="I">General Inspection I</option>
<option value="II" selected>General Inspection II</option>
<option value="III">General Inspection III</option>
<option value="S-1">Special Inspection S-1</option>
<option value="S-2">Special Inspection S-2</option>
<option value="S-3">Special Inspection S-3</option>
<option value="S-4">Special Inspection S-4</option>
</select>
</div>
<div class="aql-form-group">
<label for="aqlCritical">L·ªói nghi√™m tr·ªçng (Critical Defects):</label>
<select id="aqlCritical">
<option value="0" selected>AQL 0 (Not allowed)</option>
<option value="0.065">AQL 0.065</option>
</select>
</div>
<div class="aql-form-group">
<label for="aqlMajor">L·ªói n·∫∑ng (Major Defects):</label>
<select id="aqlMajor">
<option value="2.5" selected>AQL 2.5</option>
<option value="0.065">AQL 0.065</option><option value="0.10">AQL 0.10</option><option value="0.15">AQL 0.15</option><option value="0.25">AQL 0.25</option><option value="0.40">AQL 0.40</option><option value="0.65">AQL 0.65</option><option value="1.0">AQL 1.0</option><option value="1.5">AQL 1.5</option><option value="4.0">AQL 4.0</option><option value="6.5">AQL 6.5</option>
</select>
</div>
<div class="aql-form-group">
<label for="aqlMinor">L·ªói nh·∫π (Minor Defects):</label>
<select id="aqlMinor">
<option value="4.0" selected>AQL 4.0</option>
<option value="0.065">AQL 0.065</option><option value="0.10">AQL 0.10</option><option value="0.15">AQL 0.15</option><option value="0.25">AQL 0.25</option><option value="0.40">AQL 0.40</option><option value="0.65">AQL 0.65</option><option value="1.0">AQL 1.0</option><option value="1.5">AQL 1.5</option><option value="2.5">AQL 2.5</option><option value="6.5">AQL 6.5</option>
</select>
</div>
</div>
<div class="aql-result-section">
<h2>K·∫øt qu·∫£ ki·ªÉm tra</h2>
<div class="aql-result-summary">
<div>
<div class="label">M√£ C·ª° M·∫´u</div>
<div class="value" id="aql-result-code-letter">J</div>
</div>
<div>
<div class="label">C·ª° M·∫´u (S·ªë l∆∞·ª£ng)</div>
<div class="value" id="aql-result-sample-size">80</div>
</div>
</div>
<table class="aql-result-table">
<thead><tr><th>Lo·∫°i l·ªói</th><th>M·ª©c AQL</th><th>Ch·∫•p nh·∫≠n (Ac)</th><th>T·ª´ ch·ªëi (Re)</th></tr></thead>
<tbody>
<tr><td>L·ªói nghi√™m tr·ªçng</td><td id="aql-critical-aql-result">0</td><td class="accept" id="aql-critical-ac">0</td><td class="reject" id="aql-critical-re">1</td></tr>
<tr><td>L·ªói n·∫∑ng</td><td id="aql-major-aql-result">2.5</td><td class="accept" id="aql-major-ac">5</td><td class="reject" id="aql-major-re">6</td></tr>
<tr><td>L·ªói nh·∫π</td><td id="aql-minor-aql-result">4.0</td><td class="accept" id="aql-minor-ac">7</td><td class="reject" id="aql-minor-re">8</td></tr>
</tbody>
</table>
</div>
</div>
<div class="aql-modal-actions">
<button id="aqlCloseBtn">ƒê√≥ng</button>
<button id="aqlApplyBtn">√Åp d·ª•ng & ƒê√≥ng</button>
</div>
</div>
</div>

<!-- HTML C·ª¶A G∆Ø∆†NG CH·ª§P NHANH -->
<div id="next-shot-mirror" class="hidden">
    <!-- N√∫t b·∫≠t/t·∫Øt g∆∞∆°ng (t√πy ch·ªçn) -->
    <div id="toggle-mirror-btn" title="·∫®n/Hi·ªán G∆∞∆°ng">üëÅ</div>
    
    <!-- N∆°i hi·ªÉn th·ªã ·∫£nh xem tr∆∞·ªõc c·ªßa √¥ ti·∫øp theo -->
    <img id="next-shot-thumbnail" src="" alt="Next Shot Thumbnail">
    
    <!-- N∆°i hi·ªÉn th·ªã m√¥ t·∫£ c·ªßa √¥ ·∫£nh ti·∫øp theo -->
    <p id="next-shot-description"></p>
</div>


<div id="tolerance-modal-overlay">
<span id="close-tolerance-modal-btn">&times;</span>
<div id="tolerance-modal-content">
<div id="tolerance-photo-container">
<img id="tolerance-photo" src="" alt="·∫¢nh ƒëo l∆∞·ªùng">
</div>
<div id="tolerance-calculator-container">
<div id="tolerance-edit-container">
<label for="tolerance-value-input">Ch·ªânh s·ª≠a gi√° tr·ªã ƒëo:</label>
<input type="text" id="tolerance-value-input">
</div>
<table id="tolerance-table">
<thead>
<tr>
<th>Ti√™u chu·∫©n</th>
<th>-</th>
<th>+</th>
</tr>
</thead>
<tbody id="tolerance-table-body"></tbody>
</table>
</div>
</div>
</div>

<div id="crop-modal-overlay">
    <div id="crop-container">
        <img id="crop-image-preview" src="">
        <div id="crop-box">
            <div class="crop-handle nw"></div>
            <div class="crop-handle ne"></div>
            <div class="crop-handle sw"></div>
            <div class="crop-handle se"></div>
            <div class="crop-handle n"></div>
            <div class="crop-handle s"></div>
            <div class="crop-handle w"></div>
            <div class="crop-handle e"></div>
        </div>
    </div>
    <div id="crop-actions">
        <button id="cancel-crop-btn">H·ªßy</button>
        <button id="confirm-crop-btn">X√°c nh·∫≠n</button>
    </div>
</div>


<script>
// --- QU·∫¢N L√ù TABS & SESSION ---
const DB_NAME = `QCAppDB_MultiSessions`;
const DB_VERSION = 1;
const STORE_STATE = 'appState';

let db;
let historyStack = [];
let historyIndex = -1;
let isRestoringState = false;
let isToleranceModeActive = true;
let currentToleranceSourceBox = null;
let activeSessionId = null;

let isMultiSelectMode = false;
let selectedBoxIds = new Set();
let currentlyFocusedBox = null;
let currentZoomBoxId = null;
// [Y√äU C·∫¶U 1] Bi·∫øn m·ªõi ƒë·ªÉ theo d√µi √¥ ·∫£nh ƒë∆∞·ª£c focus ƒë·ªÉ ch·ª•p ti·∫øp
let lastInteractedBoxId = null; 
// [Y√äU C·∫¶U 3] Bi·∫øn l∆∞u tr·ªØ b·∫£n d·ªãch g·ªëc
let originalDescriptions = {};


// Kh·ªüi t·∫°o danh s√°ch Tabs
let sessions = JSON.parse(localStorage.getItem('qc_sessions')) || [{ id: `session_${Date.now()}`, name: 'Phi√™n 1' }];
if (sessions.length === 0) sessions = [{ id: `session_${Date.now()}`, name: 'Phi√™n 1' }];

// --- C√ÅC H√ÄM TI·ªÜN √çCH ---
function compressImage(file, maxSizeKB = 500) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = event => {
const img = new Image();
img.src = event.target.result;
img.onload = () => {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
let width = img.width;
let height = img.height;
const max_dim = 1280;

if (width > height) {
if (width > max_dim) { height *= max_dim / width; width = max_dim; }
} else {
if (height > max_dim) { width *= max_dim / height; height = max_dim; }
}
canvas.width = width;
canvas.height = height;
ctx.drawImage(img, 0, 0, width, height);
canvas.toBlob(blob => {
if (blob.size / 1024 > maxSizeKB) {
canvas.toBlob(resolve, 'image/jpeg', 0.7);
} else {
resolve(blob);
}
}, 'image/jpeg', 0.85);
};
img.onerror = reject;
};
reader.onerror = reject;
});
}

function showProgress(text, value, max) {
const overlay = document.getElementById('progress-overlay');
const bar = document.getElementById('progress-bar');
const p = document.getElementById('progress-text');
overlay.style.display = 'flex';
p.textContent = text;
if (max !== undefined) {
bar.value = value;
bar.max = max;
} else {
bar.removeAttribute('value');
}
}

function hideProgress() {
document.getElementById('progress-overlay').style.display = 'none';
}

function blobToDataURL(blob) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = () => resolve(reader.result);
reader.onerror = reject;
reader.readAsDataURL(blob);
});
}

// --- QU·∫¢N L√ù L·ªäCH S·ª¨ (UNDO/REDO) ---
function updateHistoryButtons() {
document.getElementById('undoBtn').disabled = historyIndex <= 0;
document.getElementById('redoBtn').disabled = historyIndex >= historyStack.length - 1;
}

function captureState() {
if (isRestoringState) return;
clearTimeout(window.captureTimeout);
window.captureTimeout = setTimeout(() => {
const state = getCurrentState();
if (historyIndex < historyStack.length - 1) {
historyStack = historyStack.slice(0, historyIndex + 1);
}
historyStack.push(state);
historyIndex++;
updateHistoryButtons();
saveStateToDB(state);
}, 500);
}


// --- LOGIC C∆† S·ªû D·ªÆ LI·ªÜU & SESSION ---
function initDB() {
return new Promise((resolve, reject) => {
const request = indexedDB.open(DB_NAME, DB_VERSION);
request.onupgradeneeded = event => {
const db = event.target.result;
if (!db.objectStoreNames.contains(STORE_STATE)) {
db.createObjectStore(STORE_STATE);
}
};
request.onsuccess = event => { db = event.target.result; resolve(db); };
request.onerror = event => { console.error("L·ªói DB:", event.target.error); reject(event.target.error); };
});
}

function saveStateToDB(state) {
if (!db || !state || !activeSessionId) return;
try {
const transaction = db.transaction([STORE_STATE], 'readwrite');
transaction.objectStore(STORE_STATE).put(state, activeSessionId);
} catch (e) {
console.error("Kh√¥ng th·ªÉ l∆∞u tr·∫°ng th√°i:", e);
}
}

function loadStateFromDB(sessionId) {
    return new Promise((resolve) => {
        if (!db) { resolve(); return; }
        const transaction = db.transaction([STORE_STATE], 'readonly');
        const request = transaction.objectStore(STORE_STATE).get(sessionId);
        request.onsuccess = async (event) => {
            const savedState = event.target.result;
            if (savedState) {
                historyStack = [savedState];
                historyIndex = 0;
                await rebuildUI(savedState);
                updateHistoryButtons();
            } else {
                resetApplicationState(false);
                const currentSession = sessions.find(s => s.id === activeSessionId);
                const sessionName = currentSession ? currentSession.name : "M√É M·∫∂C ƒê·ªäNH";
                createItemCodeTag(sessionName);
                createInspectionRow(sessionName, {}, true);
                captureState();
            }
            // [Y√äU C·∫¶U 2] T·∫£i ghi ch√∫ cho phi√™n
            loadNotesForSession(sessionId);
            resolve();
        };
        request.onerror = () => {
            loadNotesForSession(sessionId);
            resolve();
        };
    });
}

// H√†m reset giao di·ªán
function resetApplicationState(shouldCapture = true) {
document.getElementById('boxes-container').innerHTML = '';
document.getElementById('factory-media-container').innerHTML = '';
document.getElementById('note-photos-container').innerHTML = '';
document.getElementById('item-codes-display').innerHTML = '';
document.getElementById('inspection-rows-container').innerHTML = '';
document.getElementById('itemCodeInput').value = '';
document.getElementById('local-notes').value = ''; // [Y√äU C·∫¶U 2]

// [Y√äU C·∫¶U 1] Reset c·∫£ bi·∫øn focus
lastInteractedBoxId = null;

historyStack = [];
historyIndex = -1;
updateHistoryButtons();

if (shouldCapture) captureState();
}

// --- LOGIC TABS UI ---
let draggedTab = null;
function renderTabs() {
    const container = document.getElementById('tabs-container');
    const addBtn = document.getElementById('add-tab-btn');
    Array.from(container.getElementsByClassName('tab-item')).forEach(el => el.remove());

    sessions.forEach(session => {
        const tab = document.createElement('div');
        tab.className = `tab-item ${session.id === activeSessionId ? 'active' : ''}`;
        tab.dataset.sessionId = session.id;
        tab.draggable = true;

        const tabName = document.createElement('span');
        tabName.textContent = session.name;
        tab.appendChild(tabName);

        tab.addEventListener('click', () => switchSession(session.id));
        tab.addEventListener('dblclick', () => {
            if (tab.classList.contains('active')) {
                editTabName(tab, session.id);
            }
        });

        tab.addEventListener('dragstart', (e) => {
            draggedTab = tab;
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => tab.classList.add('dragging'), 0);
        });

        tab.addEventListener('dragend', () => {
            tab.classList.remove('dragging');
            draggedTab = null;
        });

        tab.addEventListener('dragover', (e) => {
            e.preventDefault();
            const target = e.target.closest('.tab-item');
            if (target && draggedTab !== target) {
                 document.querySelectorAll('.tab-item.drag-over').forEach(t => t.classList.remove('drag-over'));
                target.classList.add('drag-over');
            }
        });
        
        tab.addEventListener('dragleave', (e) => {
             e.target.closest('.tab-item')?.classList.remove('drag-over');
        });


        tab.addEventListener('drop', (e) => {
            e.preventDefault();
            document.querySelectorAll('.tab-item.drag-over').forEach(t => t.classList.remove('drag-over'));
            const targetTab = e.target.closest('.tab-item');
            if (draggedTab && targetTab && draggedTab !== targetTab) {
                const draggedId = draggedTab.dataset.sessionId;
                const targetId = targetTab.dataset.sessionId;
                const draggedIndex = sessions.findIndex(s => s.id === draggedId);
                const targetIndex = sessions.findIndex(s => s.id === targetId);

                const [removed] = sessions.splice(draggedIndex, 1);
                sessions.splice(targetIndex, 0, removed);
                
                localStorage.setItem('qc_sessions', JSON.stringify(sessions));
                renderTabs();
            }
        });

        if (sessions.length > 1) {
            const close = document.createElement('span');
            close.className = 'tab-close';
            close.innerHTML = '&times;';
            close.onclick = (e) => {
                e.stopPropagation();
                deleteSession(session.id);
            };
            tab.appendChild(close);
        }
        container.insertBefore(tab, addBtn);
    });
}

function editTabName(tabElement, sessionId) {
    const nameSpan = tabElement.querySelector('span:not(.tab-close)');
    const currentName = nameSpan.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentName;
    
    nameSpan.style.display = 'none';
    tabElement.insertBefore(input, nameSpan);
    input.focus();
    input.select();

    const saveName = () => {
        const newName = input.value.trim();
        if (newName && newName !== currentName) {
            const session = sessions.find(s => s.id === sessionId);
            if(session) session.name = newName;
            localStorage.setItem('qc_sessions', JSON.stringify(sessions));
            nameSpan.textContent = newName;
        }
        input.remove();
        nameSpan.style.display = '';
    };

    input.addEventListener('blur', saveName);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') input.blur();
        if (e.key === 'Escape') {
            input.value = currentName; 
            input.blur();
        }
    });
}


async function switchSession(sessionId) {
    if (sessionId === activeSessionId) return;
    
    // [Y√äU C·∫¶U 2] L∆∞u ghi ch√∫ c·ªßa phi√™n hi·ªán t·∫°i tr∆∞·ªõc khi chuy·ªÉn
    saveNotesForSession(activeSessionId);

    activeSessionId = sessionId;
    localStorage.setItem('active_qc_session', sessionId);
    renderTabs();
    await loadStateFromDB(sessionId);
}

function createNewSession() {
const name = prompt("Nh·∫≠p t√™n phi√™n l√†m vi·ªác m·ªõi:", `Phi√™n ${sessions.length + 1}`);
if (name) {
const id = `session_${Date.now()}`;
sessions.push({ id, name });
localStorage.setItem('qc_sessions', JSON.stringify(sessions));
switchSession(id);
}
}

async function deleteSession(sessionId) {
    const sessionToDelete = sessions.find(s => s.id === sessionId);
    if (!sessionToDelete) return;
    
    if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phi√™n "${sessionToDelete.name}"? M·ªôt b·∫£n sao l∆∞u s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫£i v·ªÅ.`)) {
        showProgress("ƒêang t·∫°o b·∫£n sao l∆∞u...", 0, 100);
        const transaction = db.transaction([STORE_STATE], 'readonly');
        const request = transaction.objectStore(STORE_STATE).get(sessionId);
        request.onsuccess = async (event) => {
            const stateToBackup = event.target.result;
            if (stateToBackup) {
                 await generateZipFromState(stateToBackup, sessionToDelete.name, true); 
            } else {
                console.log("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao l∆∞u cho phi√™n n√†y.");
            }
            
            hideProgress();
            sessions = sessions.filter(s => s.id !== sessionId);
            localStorage.setItem('qc_sessions', JSON.stringify(sessions));
            localStorage.removeItem(`notes_${sessionId}`); // [Y√äU C·∫¶U 2] X√≥a ghi ch√∫ li√™n quan
            const deleteTransaction = db.transaction([STORE_STATE], 'readwrite');
            deleteTransaction.objectStore(STORE_STATE).delete(sessionId);

            if (activeSessionId === sessionId) {
                switchSession(sessions[0]?.id || null);
                 if (!sessions.length) { 
                    createNewSession();
                 }
            } else {
                renderTabs();
            }
        };
        request.onerror = (e) => {
            hideProgress();
            console.error("L·ªói khi t·∫£i d·ªØ li·ªáu ƒë·ªÉ sao l∆∞u:", e);
            alert("Kh√¥ng th·ªÉ t·∫°o b·∫£n sao l∆∞u. H·ªßy x√≥a phi√™n.");
        };
    }
}


// --- THU TH·∫¨P & T√ÅI T·∫†O GIAO DI·ªÜN ---
function getCurrentState() {
const detailPhotos = Array.from(document.querySelectorAll('#boxes-container .box')).map(box => ({
id: box.id,
baseDescription: box.dataset.baseDescription,
imageBlob: box.imageBlob || null,
isCameraCaptured: box.dataset.isCameraCaptured === 'true',
skipTolerance: box.dataset.skipTolerance === 'true'
}));

const factoryMedia = Array.from(document.querySelectorAll('.factory-media-item')).map(item => ({
id: item.id,
mediaBlob: item.mediaBlob || null,
type: item.dataset.type
}));

const notePhotos = Array.from(document.querySelectorAll('.note-photo-item')).map(item => ({
id: item.id,
imageBlob: item.imageBlob || null
}));
const itemCodes = Array.from(document.querySelectorAll('.item-code-tag')).map(tag => tag.dataset.code);
const inspectionData = {};
itemCodes.forEach(code => {
const row = document.querySelector(`.inspection-row[data-code="${code}"]`);
if (!row) return;
const inputs = {};
row.querySelectorAll('.main-inputs input[type="text"], .main-inputs input[type="number"]').forEach(input => { inputs[input.name] = input.value; });
const checkboxes = {};
row.querySelectorAll('input[type="checkbox"]').forEach(checkbox => { checkboxes[checkbox.name] = checkbox.checked; });
const defectPhotos = Array.from(row.querySelectorAll('.defect-photo-item')).map(item => ({ imageBlob: item.imageBlob }));
const aqlFrames = Array.from(row.querySelectorAll('.aql-tests-tbody tr')).map(tr => ({
description: tr.querySelector('.aql-test-description').value,
orderQty: tr.dataset.orderQty || '',
sampleSize: tr.querySelector('input[name="aql_check_qty"]').value,
criticalAc: tr.querySelector('input[name="critical_standard"]').value,
majorAc: tr.querySelector('input[name="major_standard"]').value,
minorAc: tr.querySelector('input[name="minor_standard"]').value,
inspectionLevel: tr.dataset.inspectionLevel,
criticalAql: tr.dataset.criticalAql,
majorAql: tr.dataset.majorAql,
minorAql: tr.dataset.minorAql
}));
inspectionData[code] = { inputs, checkboxes, defectPhotos, aqlFrames };
});
// [Y√äU C·∫¶U 1] L∆∞u l·∫°i ID c·ªßa √¥ ƒë∆∞·ª£c focus
return { detailPhotos, factoryMedia, notePhotos, itemCodes, inspectionData, lastInteractedBoxId };
}

async function rebuildUI(state) {
isRestoringState = true;
// Clear UI
document.getElementById('boxes-container').innerHTML = '';
document.getElementById('factory-media-container').innerHTML = '';
document.getElementById('note-photos-container').innerHTML = '';
document.getElementById('item-codes-display').innerHTML = '';
document.getElementById('inspection-rows-container').innerHTML = '';
originalDescriptions = {}; // [Y√äU C·∫¶U 3] Reset b·∫£n d·ªãch
document.getElementById('revertTranslationBtn').classList.add('hidden');


if (state.detailPhotos) {
for (const data of state.detailPhotos) {
const box = createDetailBox(data.baseDescription, data.id);
if (data.skipTolerance) {
box.dataset.skipTolerance = 'true';
}

if (data.imageBlob) {
box.imageBlob = data.imageBlob;
if (data.isCameraCaptured) {
box.dataset.isCameraCaptured = 'true';
}
}
updateBoxAppearance(box);
document.getElementById('boxes-container').appendChild(box);
}
}
renumberDetailBoxes();

if (state.factoryMedia) {
for (const data of state.factoryMedia) {
if(data.mediaBlob) {
const item = await createFactoryMediaItem(data.mediaBlob, data.type, data.id);
document.getElementById('factory-media-container').appendChild(item);
}
}
}

if (state.notePhotos) {
for (const data of state.notePhotos) {
if (data.imageBlob) {
const item = await createNotePhotoItem(data.imageBlob, data.id);
document.getElementById('note-photos-container').appendChild(item);
}
}
}

if (state.itemCodes) {
for (const code of state.itemCodes) {
createItemCodeTag(code);
const data = state.inspectionData[code] || {};
createInspectionRow(code, data);
}
}
isRestoringState = false;

// [Y√äU C·∫¶U 1] Kh√¥i ph·ª•c l·∫°i tr·∫°ng th√°i focus sau khi t·∫£i
if (state.lastInteractedBoxId) {
    // D√πng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render ho√†n to√†n
    setTimeout(() => setLastInteractedBox(state.lastInteractedBoxId), 0);
} else {
    updateNextShotMirror();
}
}


// --- [Y√äU C·∫¶U 1] H√ÄM M·ªöI ƒê·ªÇ QU·∫¢N L√ù FOCUS ---
/**
 * ƒê·∫∑t √¥ ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh l√†m ti√™u ƒëi·ªÉm ch·ª•p ·∫£nh ti·∫øp theo.
 * @param {string} boxId ID c·ªßa ph·∫ßn t·ª≠ .box
 */
function setLastInteractedBox(boxId) {
    // B·ªè class focus kh·ªèi √¥ c≈© (n·∫øu c√≥)
    if (lastInteractedBoxId) {
        document.getElementById(lastInteractedBoxId)?.classList.remove('last-shot-focus');
    }
    
    // C·∫≠p nh·∫≠t bi·∫øn tr·∫°ng th√°i global
    lastInteractedBoxId = boxId;
    const newFocusBox = document.getElementById(boxId);
    
    if (newFocusBox) {
        // Th√™m class focus cho √¥ m·ªõi
        newFocusBox.classList.add('last-shot-focus');
    }
    
    // C·∫≠p nh·∫≠t g∆∞∆°ng xem tr∆∞·ªõc ngay l·∫≠p t·ª©c
    updateNextShotMirror();
}


// --- C√ÅC H√ÄM T·∫†O PH·∫¶N T·ª¨ GIAO DI·ªÜN ---
function updateBoxAppearance(box) {
const thumbnail = box.querySelector('.thumbnail');
if (!thumbnail) return;
if (box.dataset.isCameraCaptured === 'true') {
box.classList.add('has-photo');
} else {
box.classList.remove('has-photo');
}
if (box.imageBlob && box.imageBlob.size > 0) {
blobToDataURL(box.imageBlob).then(url => { thumbnail.src = url; }).catch(console.error);
} else {
thumbnail.src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
}
}

function createDetailBox(baseDescription, id = `box-${Date.now()}`, isNew = false) {
const box = document.createElement('div');
box.className = 'box';
box.id = id;
box.dataset.baseDescription = baseDescription;
box.imageBlob = null;
if (isNew) {
box.dataset.skipTolerance = 'true';
}

const addButton = document.createElement('div');
addButton.className = 'add-box-btn';
addButton.textContent = '+';
addButton.onclick = (e) => { e.stopPropagation(); const newBox = createDetailBox("M√¥ t·∫£ m·ªõi", undefined, true); box.insertAdjacentElement('afterend', newBox); renumberDetailBoxes(); captureState(); };
box.appendChild(addButton);

const deleteButton = document.createElement('div');
deleteButton.className = 'delete-box-btn';
deleteButton.innerHTML = '&times;';
deleteButton.onclick = (e) => {
e.stopPropagation();
if (isMultiSelectMode && selectedBoxIds.has(box.id)) {
if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedBoxIds.size} √¥ ·∫£nh ƒë√£ ch·ªçn?`)) {
selectedBoxIds.forEach(idToDelete => document.getElementById(idToDelete)?.remove());
selectedBoxIds.clear();
toggleMultiSelectMode(false);
renumberDetailBoxes();
captureState();
}
} else {
if (confirm('X√≥a √¥ ·∫£nh n√†y?')) {
box.remove();
renumberDetailBoxes();
captureState();
}
}
};
box.appendChild(deleteButton);

const thumbnail = document.createElement('img');
thumbnail.className = 'thumbnail';
box.appendChild(thumbnail);

const p = document.createElement('p');
p.className = 'description';
p.textContent = baseDescription;
p.contentEditable = true;
p.onfocus = () => {
    currentlyFocusedBox = box;
    const textNode = p.firstChild;
    if (textNode && textNode.nodeType === Node.TEXT_NODE) {
        const fullText = textNode.textContent;
        const match = fullText.match(/^(\d+\.\s*)/);
        const startIndex = match ? match[0].length : 0;
        setTimeout(() => {
            const range = document.createRange();
            range.setStart(textNode, startIndex);
            range.setEnd(textNode, fullText.length);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }, 0);
    }
};
p.onblur = () => { 
    const newDesc = p.textContent.replace(/^\d+\.?\s*/, ''); 
    box.dataset.baseDescription = newDesc; 
    renumberDetailBoxes(); 
    captureState(); 
};
p.onkeydown = e => { if (e.key === 'Enter') { e.preventDefault(); p.blur(); } };
box.appendChild(p);

const zoomIcon = document.createElement('div');
zoomIcon.className = 'zoom-icon';
zoomIcon.innerHTML = '&#128269;';
zoomIcon.onclick = (e) => { e.stopPropagation(); if(box.imageBlob) showZoom(box.id); };
box.appendChild(zoomIcon);

const input = document.createElement('input');
input.type = 'file'; input.accept = 'image/*'; input.capture = 'camera'; input.className = 'hidden';

input.onchange = async () => {
const file = input.files[0];
if (!file) return;
showProgress('ƒêang n√©n ·∫£nh...', 0, 1);
try {
const compressedBlob = await compressImage(file);
box.imageBlob = compressedBlob;
box.dataset.isCameraCaptured = 'true';

// [Y√äU C·∫¶U 1] ƒê·∫∑t √¥ n√†y l√†m focus m·ªõi
setLastInteractedBox(box.id);

updateBoxAppearance(box);
captureState();

if (isToleranceModeActive && box.dataset.skipTolerance !== 'true') {
const fullDescription = box.querySelector('.description').textContent;
const measurementRegex = /(\d+\.?\d*)\s*(cm|mm|kg|g|s|m)\b/i;
const match = fullDescription.match(measurementRegex);
if (match) {
const value = parseFloat(match[1]);
const unit = match[2];
showToleranceCalculator(value, unit, compressedBlob, box);
}
}
} catch (error) { console.error("L·ªói n√©n ·∫£nh:", error); }
finally { hideProgress(); }
};
box.appendChild(input);

thumbnail.onclick = () => {
if (isMultiSelectMode) {
toggleBoxSelection(box);
} else {
input.click();
}
};

// [Y√äU C·∫¶U 1] Th√™m s·ª± ki·ªán click ƒë·ªÉ ch·ªß ƒë·ªông ch·ªçn focus
box.addEventListener('click', (e) => {
    // Ch·ªâ ho·∫°t ƒë·ªông khi kh√¥ng ·ªü ch·∫ø ƒë·ªô ch·ªçn nhi·ªÅu v√† kh√¥ng click v√†o n√∫t con
    if (!isMultiSelectMode && e.target.classList.contains('box')) {
        setLastInteractedBox(box.id);
    }
});


updateBoxAppearance(box);
return box;
}

function renumberDetailBoxes() {
document.querySelectorAll('#boxes-container .box').forEach((box, index) => {
const p = box.querySelector('.description');
if (p) {
p.textContent = `${index + 1}. ${box.dataset.baseDescription}`;
}
});
updateNextShotMirror();
}

async function createFactoryMediaItem(mediaBlob, type, id = `factory-${Date.now()}`) {
const item = document.createElement('div');
item.className = 'factory-media-item';
item.id = id;
item.mediaBlob = mediaBlob;
item.dataset.type = type;
const mediaURL = URL.createObjectURL(mediaBlob);
let mediaElement;
if (type === 'image') {
mediaElement = document.createElement('img');
mediaElement.src = mediaURL;
} else {
mediaElement = document.createElement('video');
mediaElement.src = mediaURL;
mediaElement.controls = true;
mediaElement.playsInline = true;
mediaElement.muted = true;
}
item.appendChild(mediaElement);
const deleteBtn = document.createElement('div');
deleteBtn.className = 'delete-box-btn delete-factory-media-btn';
deleteBtn.innerHTML = '&times;';
deleteBtn.onclick = (e) => { e.stopPropagation(); if(confirm(`X√≥a ${type === 'image' ? '·∫£nh' : 'video'} n√†y?`)) { item.remove(); captureState(); URL.revokeObjectURL(mediaURL); } };
item.appendChild(deleteBtn);
if (type === 'image') {
const zoomIcon = document.createElement('div');
zoomIcon.className = 'zoom-icon';
zoomIcon.innerHTML = '&#128269;';
zoomIcon.onclick = (e) => { e.stopPropagation(); showZoom(item.id); }; 
item.appendChild(zoomIcon);
}
return item;
}

async function createNotePhotoItem(imageBlob, id = `note-${Date.now()}`) {
const item = document.createElement('div');
item.className = 'note-photo-item';
item.id = id;
item.imageBlob = imageBlob;
const img = document.createElement('img');
img.src = await blobToDataURL(imageBlob);
item.appendChild(img);
const deleteBtn = document.createElement('div');
deleteBtn.className = 'delete-box-btn delete-note-photo-btn';
deleteBtn.innerHTML = '&times;';
deleteBtn.onclick = (e) => { e.stopPropagation(); if(confirm('X√≥a ·∫£nh ghi ch√∫ n√†y?')) { item.remove(); captureState(); } };
item.appendChild(deleteBtn);
const zoomIcon = document.createElement('div');
zoomIcon.className = 'zoom-icon';
zoomIcon.innerHTML = '&#128269;';
zoomIcon.onclick = (e) => { e.stopPropagation(); showZoom(img.src); };
item.appendChild(zoomIcon);
return item;
}

async function createDefectPhotoItem(imageBlob) {
const item = document.createElement('div');
item.className = 'defect-photo-item';
item.imageBlob = imageBlob;
const img = document.createElement('img');
img.src = await blobToDataURL(imageBlob);
item.appendChild(img);
const deleteBtn = document.createElement('div');
deleteBtn.className = 'delete-box-btn';
deleteBtn.innerHTML = '&times;';
deleteBtn.onclick = (e) => { e.stopPropagation(); if(confirm('X√≥a ·∫£nh l·ªói n√†y?')) { item.remove(); captureState(); } };
item.appendChild(deleteBtn);
const zoomIcon = document.createElement('div');
zoomIcon.className = 'zoom-icon';
zoomIcon.innerHTML = '&#128269;';
zoomIcon.onclick = (e) => { e.stopPropagation(); showZoom(img.src); };
item.appendChild(zoomIcon);
return item;
}

function createItemCodeTag(code) {
const display = document.getElementById('item-codes-display');
const tag = document.createElement('div');
tag.className = 'item-code-tag';
tag.dataset.code = code;
tag.textContent = code;
const removeBtn = document.createElement('button');
removeBtn.innerHTML = '&times;';
removeBtn.onclick = () => {
if (confirm(`X√≥a m√£ h√†ng "${code}" v√† to√†n b·ªô d·ªØ li·ªáu li√™n quan?`)) {
tag.remove();
document.querySelector(`.inspection-row[data-code="${code}"]`)?.remove();
captureState();
}
};
tag.appendChild(removeBtn);
display.appendChild(tag);
}

function createAqlTableRowHTML(data = {}) {
    const description = data.description || "Ki·ªÉm tra ngo·∫°i quan";
    const sampleSize = data.sampleSize || "";
    const criticalAc = data.criticalAc || "0";
    const majorAc = data.majorAc || "";
    const minorAc = data.minorAc || "";
    const orderQty = data.orderQty || "";
    const datasetAttributes = ['inspectionLevel', 'criticalAql', 'majorAql', 'minorAql'].map(key => data[key] ? `data-${key.toLowerCase()}="${data[key]}"` : '').join(' ');

    return `
        <tr data-orderqty="${orderQty}" ${datasetAttributes}>
            <td>
                <input type="text" class="aql-test-description" placeholder="M√¥ t·∫£ b√†i test..." value="${description}">
                <button class="open-aql-btn">T√≠nh AQL</button>
            </td>
            <td><input type="number" name="aql_check_qty" value="${sampleSize}" readonly title="S·ªë l∆∞·ª£ng ki·ªÉm"></td>
            <td><input type="number" name="critical_standard" value="${criticalAc}" readonly title="Critical (Ac)"></td>
            <td><input type="number" name="major_standard" value="${majorAc}" readonly title="Major (Ac)"></td>
            <td><input type="number" name="minor_standard" value="${minorAc}" readonly title="Minor (Ac)"></td>
            <td><button class="delete-aql-row-btn" title="X√≥a b√†i test n√†y">&times;</button></td>
        </tr>`;
}

function createInspectionRow(code, data = {}, createDefaultTests = false) {
const container = document.getElementById('inspection-rows-container');
const row = document.createElement('div');
row.className = 'inspection-row';
row.dataset.code = code;
row.innerHTML = `<h4>M√£ h√†ng: ${code}</h4>
<div class="main-inputs">
<h5>Th√¥ng tin s·ªë l∆∞·ª£ng</h5>
<div class="input-group">
<label><span>ƒê√≥ng g√≥i (TT)</span><input type="number" name="pack_qty_actual" placeholder="Th·ª±c t·∫ø" value="${data.inputs?.pack_qty_actual || ''}"></label>
<label><span>S·∫£n ph·∫©m (TT)</span><input type="number" name="prod_qty_actual" placeholder="Th·ª±c t·∫ø" value="${data.inputs?.prod_qty_actual || ''}"></label>
<label><span>S·∫£n ph·∫©m (TC)</span><input type="number" name="prod_qty_standard" placeholder="Ti√™u chu·∫©n" value="${data.inputs?.prod_qty_standard || ''}"></label>
</div>
</div>
<h5>Ti√™u chu·∫©n AQL</h5>
<div class="aql-table-container">
<table class="aql-results-table">
<thead>
<tr>
<th>Ti√™u ch√≠ ƒë√°nh gi√° AQL</th>
<th>SL ki·ªÉm</th>
<th>Critical</th>
<th>Major</th>
<th>Minor</th>
<th>X√≥a</th>
</tr>
</thead>
<tbody class="aql-tests-tbody"></tbody>
</table>
</div>
<button class="add-aql-frame-btn">+ Th√™m B√†i Test AQL</button>
<h5 style="margin-top: 20px;">T√¨nh tr·∫°ng ki·ªÉm tra</h5>
<div class="checkbox-group">${['has_sample', 'pass_style', 'pass_workmanship', 'pass_packing', 'pass_marking', 'pass_measurement', 'pass_special'].map(name => {
const labels = { has_sample: 'C√≥ Sample', pass_style: 'PASS: Ki·ªÉu d√°ng, ch·∫•t li·ªáu, m√†u s·∫Øc', pass_workmanship: 'PASS: Tay ngh·ªÅ/Ngo·∫°i quan/Ch·ª©c nƒÉng', pass_packing: 'PASS: ƒê√≥ng g√≥i', pass_marking: 'PASS: Ghi nh√£n/M√°c', pass_measurement: 'PASS: ƒêo l∆∞·ªùng/Ki·ªÉm tra th·ª±c ƒë·ªãa', pass_special: 'PASS: Y√™u c·∫ßu ƒë·∫∑c bi·ªát c·ªßa kh√°ch h√†ng' };
const isChecked = data.checkboxes?.[name] || false;
return `<label class="tick-label ${isChecked ? 'checked' : ''}"><input type="checkbox" name="${name}" ${isChecked ? 'checked' : ''}><span>${labels[name]}</span></label>`;
}).join('')}</div>
<h5>·∫¢nh L·ªói (${code})</h5>
<div class="defect-photos-container"></div>
<button class="add-defect-photo-btn">Ch·ª•p ·∫¢nh L·ªói</button>
<input type="file" class="hidden-defect-input" multiple accept="image/*" capture="camera" class="hidden">`;

const aqlTbody = row.querySelector('.aql-tests-tbody');
const defaultOrderQty = data.inputs?.prod_qty_actual || '';

if (createDefaultTests) {
aqlTbody.innerHTML += createAqlTableRowHTML({ description: "Ki·ªÉm tra ngo·∫°i quan", orderQty: defaultOrderQty });
aqlTbody.innerHTML += createAqlTableRowHTML({ description: "Ki·ªÉm tra ch·ª©c nƒÉng", orderQty: defaultOrderQty });
aqlTbody.innerHTML += createAqlTableRowHTML({ description: "Ki·ªÉm tra ƒëo l∆∞·ªùng", orderQty: defaultOrderQty });
} else if (data.aqlFrames && data.aqlFrames.length > 0) {
data.aqlFrames.forEach(frameData => {
if (!frameData.orderQty) { frameData.orderQty = defaultOrderQty; }
aqlTbody.innerHTML += createAqlTableRowHTML(frameData);
});
} else {
aqlTbody.innerHTML += createAqlTableRowHTML({ orderQty: defaultOrderQty });
}

row.querySelector('input[name="prod_qty_actual"]').addEventListener('input', (e) => {
const newQty = e.target.value;
row.querySelectorAll('.aql-tests-tbody tr').forEach(tr => { tr.dataset.orderqty = newQty; });
captureState();
});

row.querySelectorAll('input, select').forEach(input => {
input.addEventListener('input', captureState);
if (input.type === 'checkbox') {
input.addEventListener('change', () => { input.parentElement.classList.toggle('checked', input.checked); captureState(); });
}
});

aqlTbody.addEventListener('click', e => {
const target = e.target;
if (target.classList.contains('open-aql-btn')) {
openAqlModal(target.closest('tr'));
} else if (target.classList.contains('delete-aql-row-btn')) {
if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i test AQL n√†y?")) {
target.closest('tr').remove();
captureState();
}
}
});
aqlTbody.addEventListener('input', e => { if (e.target.classList.contains('aql-test-description')) captureState(); });
row.querySelector('.add-aql-frame-btn').addEventListener('click', () => {
const currentOrderQty = row.querySelector('input[name="prod_qty_actual"]')?.value || '';
aqlTbody.insertAdjacentHTML('beforeend', createAqlTableRowHTML({description: "", orderQty: currentOrderQty}));
captureState();
});

const defectPhotoInput = row.querySelector('.hidden-defect-input');
const defectContainer = row.querySelector('.defect-photos-container');
row.querySelector('.add-defect-photo-btn').addEventListener('click', () => defectPhotoInput.click());
defectPhotoInput.addEventListener('change', async function() { if (this.files.length === 0) return; const files = Array.from(this.files); this.value = ''; showProgress(`ƒêang x·ª≠ l√Ω ${files.length} ·∫£nh l·ªói...`, 0, files.length); for(const file of files) { try { const item = await createDefectPhotoItem(await compressImage(file)); defectContainer.appendChild(item); } catch(err) { console.error("L·ªói x·ª≠ l√Ω ·∫£nh l·ªói:", err); } } hideProgress(); captureState(); });
if (data.defectPhotos) { data.defectPhotos.forEach(async photoData => { if (photoData.imageBlob) { const defectItem = await createDefectPhotoItem(photoData.imageBlob); defectContainer.appendChild(defectItem); } }); }
container.appendChild(row);
}


// --- ZIP EXPORT ---
async function generateZipFromState(state, sessionName, isBackup = false) {
    const zip = new JSZip();
    const today = new Date();
    const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
    const timeString = `${today.getHours().toString().padStart(2, '0')}${today.getMinutes().toString().padStart(2, '0')}${today.getSeconds().toString().padStart(2, '0')}`;
    
    let reportName;
    if (isBackup) {
        reportName = `backup_${sessionName}_${dateString}_${timeString}`;
    } else {
        reportName = `BCKD_${sessionName}_${dateString}`;
    }
    
    const mainFolder = zip.folder(reportName);

    if (state.detailPhotos && state.detailPhotos.length > 0) {
        const detailPhotosFolder = mainFolder.folder("1_Anh_Chi_Tiet");
        for (const [index, photo] of state.detailPhotos.entries()) {
            if (photo.imageBlob) {
                const filename = `${index + 1}. ${photo.baseDescription}.jpg`;
                detailPhotosFolder.file(filename, photo.imageBlob);
            }
        }
    }

    const factoryPhotos = state.factoryMedia.filter(m => m.type === 'image');
    const factoryVideos = state.factoryMedia.filter(m => m.type === 'video');

    if (factoryPhotos.length > 0) {
        const factoryPhotoFolder = mainFolder.folder("2_Anh_Factory");
        for (const [i, photo] of factoryPhotos.entries()) {
            if (photo.mediaBlob) {
                factoryPhotoFolder.file(`factory-photo-${i + 1}.jpg`, photo.mediaBlob);
            }
        }
    }
    
    if (factoryVideos.length > 0) {
        const factoryVideoFolder = mainFolder.folder("3_Video_Factory");
        for (const [i, video] of factoryVideos.entries()) {
            if (video.mediaBlob) {
                const extension = video.mediaBlob.name?.split('.').pop() || 'mp4';
                factoryVideoFolder.file(`factory-video-${i + 1}.${extension}`, video.mediaBlob);
            }
        }
    }
    
    let reportText = `B√ÅO C√ÅO KI·ªÇM ƒê·ªäNH S·∫¢N PH·∫®M\nNg√†y: ${dateString}\nPhi√™n: ${sessionName}\n\n`;
    reportText += `1. ·∫¢NH CHI TI·∫æT S·∫¢N PH·∫®M\n-------------------------\n`;
    state.detailPhotos.forEach((photo, index) => { reportText += `${index + 1}. ${photo.baseDescription} - ${photo.imageBlob ? 'ƒê√£ ch·ª•p' : 'Ch∆∞a ch·ª•p'}\n`; });
    reportText += `\n2. C√ÅC M√É H√ÄNG KI·ªÇM TRA\n------------------------\n`;
    state.itemCodes.forEach(code => {
    reportText += `M√É: ${code}\n`;
    const data = state.inspectionData[code];
    if(data) {
    reportText += `  - S·ªë l∆∞·ª£ng: Th·ª±c t·∫ø ${data.inputs.prod_qty_actual} / Ti√™u chu·∫©n ${data.inputs.prod_qty_standard}\n`;
    data.aqlFrames.forEach((frame, idx) => { reportText += `  - AQL Check #${idx+1}: ${frame.description} | M·∫´u: ${frame.sampleSize} | Cri(Ac): ${frame.criticalAc} | Maj(Ac): ${frame.majorAc} | Min(Ac): ${frame.minorAc}\n`; });
    }
    });
    mainFolder.file("noi_dung_bao_cao.txt", reportText);

    if (Object.keys(zip.files).length <= 1) { 
        if(!isBackup) alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.");
        return; 
    }
    
    return zip.generateAsync({ type: "blob" }, (metadata) => {
        showProgress(`ƒêang n√©n ZIP... ${metadata.percent.toFixed(0)}%`, metadata.percent, 100);
    }).then(content => {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `${reportName}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    });
}

async function exportAllDataAsZip(options = { photos: true, videos: true, text: true }) {
    showProgress("ƒêang chu·∫©n b·ªã d·ªØ li·ªáu...", 0, 100);
    const currentState = getCurrentState();
    
    const stateToExport = {
        detailPhotos: options.photos ? currentState.detailPhotos : [],
        factoryMedia: (options.photos || options.videos) 
            ? currentState.factoryMedia.filter(m => (options.photos && m.type === 'image') || (options.videos && m.type === 'video'))
            : [],
        notePhotos: [], 
        itemCodes: options.text ? currentState.itemCodes : [],
        inspectionData: options.text ? currentState.inspectionData : {}
    };

    const currentSessionName = sessions.find(s => s.id === activeSessionId)?.name || 'Unknown';
    try {
        await generateZipFromState(stateToExport, currentSessionName, false);
    } catch(err) {
        console.error("L·ªói t·∫°o ZIP:", err);
    } finally {
        hideProgress();
    }
}


// --- ZIP IMPORT ---
async function handleArchiveInput(file, targetContainerId) {
if (!file) return;
const isZip = file.name.toLowerCase().endsWith('.zip');
const isRar = file.name.toLowerCase().endsWith('.rar');
if (!isZip && !isRar) { alert("Ch·ªâ h·ªó tr·ª£ file .zip v√† .rar"); return; }
if (targetContainerId === 'boxes-container') {
    if (!confirm("T·∫£i t·ªáp m·ªõi s·∫Ω x√≥a d·ªØ li·ªáu phi√™n hi·ªán t·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) return;
    resetApplicationState(false);
    document.getElementById('boxes-container').innerHTML = '';

    // [Y√äU C·∫¶U 2] S·ª¨A ƒê·ªîI: GI·ªÆ L·∫†I M√É H√ÄNG M·∫∂C ƒê·ªäNH SAU KHI IMPORT
    const currentSessionForImport = sessions.find(s => s.id === activeSessionId);
    if (currentSessionForImport) {
        const sessionName = currentSessionForImport.name;
        // Ki·ªÉm tra ƒë·ªÉ ch·∫Øc ch·∫Øn m√£ h√†ng ch∆∞a t·ªìn t·∫°i (an to√†n)
        if (!document.querySelector(`.item-code-tag[data-code="${sessionName}"]`)) {
             createItemCodeTag(sessionName);
             createInspectionRow(sessionName, {}, true); // T·∫°o k√®m c√°c b√†i test AQL m·∫∑c ƒë·ªãnh
        }
    }
}
showProgress("ƒêang ƒë·ªçc t·ªáp...", 0, 100);
let imageEntries = [];
try {
if (isZip) {
const zip = await JSZip.loadAsync(file);
const filePromises = [];
zip.forEach((relativePath, zipEntry) => {
if (!zipEntry.dir && /\.(jpe?g|png|gif|webp)$/i.test(zipEntry.name)) {
filePromises.push(zipEntry.async('blob').then(blob => ({ name: zipEntry.name, blob: blob })));
}
});
imageEntries = await Promise.all(filePromises);
} else {
const rarBuffer = await file.arrayBuffer();
const extractor = await unrar.createExtractorFromData({ data: rarBuffer });
const rarFiles = extractor.extract().files;
imageEntries = rarFiles.filter(f => !f.dir && /\.(jpe?g|png|gif|webp)$/i.test(f.name)).map(f => ({ name: f.name, blob: new Blob([f.extraction]) }));
}
if (imageEntries.length === 0) { alert("Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o."); hideProgress(); return; }
imageEntries.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
let processedFiles = 0;
for (const entry of imageEntries) {
showProgress(`ƒêang x·ª≠ l√Ω ·∫£nh ${processedFiles + 1}/${imageEntries.length}...`, processedFiles, imageEntries.length);
const compressedBlob = await compressImage(entry.blob);
if (targetContainerId === 'boxes-container') {
const baseDescription = entry.name.split('/').pop().replace(/\.[^/.]+$/, "").replace(/^\d+\.?\s*/, '');
const box = createDetailBox(baseDescription, `box-${Date.now()}-${processedFiles}`, false);
if (baseDescription.trim().toLowerCase() === 'm√¥ t·∫£ m·ªõi') {
    box.dataset.skipTolerance = 'true';
}
box.imageBlob = compressedBlob;
updateBoxAppearance(box);
document.getElementById('boxes-container').appendChild(box);
} else {
const item = await createNotePhotoItem(compressedBlob);
document.getElementById('note-photos-container').appendChild(item);
}
processedFiles++;
}
if (targetContainerId === 'boxes-container') renumberDetailBoxes();
} catch (err) { console.error("L·ªói x·ª≠ l√Ω t·ªáp:", err); alert("L·ªói khi ƒë·ªçc file."); }
finally { hideProgress(); captureState(); }
}

// --- KH·ªûI T·∫†O CH√çNH ---
document.addEventListener('DOMContentLoaded', async () => {
try {
await initDB();
const lastSession = localStorage.getItem('active_qc_session');
const initialSessionId = (lastSession && sessions.find(s => s.id === lastSession)) ? lastSession : sessions[0].id;

activeSessionId = initialSessionId;
renderTabs();
await loadStateFromDB(initialSessionId);

} catch (error) { console.error(error); alert("L·ªói kh·ªüi t·∫°o DB."); }

document.getElementById('toggle-menu-btn').addEventListener('click', () => {
document.body.classList.toggle('header-hidden');
});
document.getElementById('add-tab-btn').addEventListener('click', createNewSession);

document.getElementById('zipFileInput').addEventListener('change', function() { handleArchiveInput(this.files[0], 'boxes-container'); this.value = ''; });
document.getElementById('toggleToleranceBtn').addEventListener('click', function() {
isToleranceModeActive = !isToleranceModeActive;
this.textContent = `ƒê·ªëi chi·∫øu: ${isToleranceModeActive ? 'B·∫≠t' : 'T·∫Øt'}`;
this.style.backgroundColor = isToleranceModeActive ? '' : 'var(--color-secondary)';
this.style.color = isToleranceModeActive ? '' : 'white';
});

document.getElementById('exportZip').addEventListener('click', () => exportAllDataAsZip({ photos: true, videos: true, text: true }));
document.getElementById('exportZipNoVideo').addEventListener('click', () => exportAllDataAsZip({ photos: true, videos: false, text: true }));
document.getElementById('exportOnlyVideos').addEventListener('click', () => exportAllDataAsZip({ photos: false, videos: true, text: false }));

document.getElementById('clearAll').addEventListener('click', () => {
if (confirm("C·∫¢NH B√ÅO: X√≥a d·ªØ li·ªáu c·ªßa PHI√äN N√ÄY?")) {
resetApplicationState();
}
});
document.getElementById('scrollToEnd').addEventListener('click', () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }));
document.getElementById('scrollToTop').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
document.getElementById('undoBtn').addEventListener('click', async () => { if (historyIndex > 0) { historyIndex--; isRestoringState = true; await rebuildUI(historyStack[historyIndex]); isRestoringState = false; updateHistoryButtons(); saveStateToDB(historyStack[historyIndex]); } });
document.getElementById('redoBtn').addEventListener('click', async () => { if (historyIndex < historyStack.length - 1) { historyIndex++; isRestoringState = true; await rebuildUI(historyStack[historyIndex]); isRestoringState = false; updateHistoryButtons(); saveStateToDB(historyStack[historyIndex]); } });

const factoryPhotoInput = document.getElementById('factoryPhotoInput');
document.getElementById('addFactoryPhotoBtn').addEventListener('click', () => factoryPhotoInput.click());
factoryPhotoInput.addEventListener('change', async function() { if (this.files.length === 0) return; const files = Array.from(this.files); this.value = ''; showProgress(`ƒêang x·ª≠ l√Ω ${files.length} ·∫£nh...`, 0, files.length); for(const file of files) { try { const compressedBlob = await compressImage(file); const item = await createFactoryMediaItem(compressedBlob, 'image'); document.getElementById('factory-media-container').appendChild(item); } catch(err) { console.error("L·ªói factory photo:", err); } } hideProgress(); captureState(); });

const factoryVideoInput = document.getElementById('factoryVideoInput');
document.getElementById('addFactoryVideoBtn').addEventListener('click', () => factoryVideoInput.click());
factoryVideoInput.addEventListener('change', (event) => {
const files = Array.from(event.target.files);
if (files.length > 0) {
files.forEach(file => { addVideoFile(file); });
}
factoryVideoInput.value = '';
});

const itemCodeInput = document.getElementById('itemCodeInput');
const addItemCodeBtn = document.getElementById('addItemCodeBtn');
const addItemAction = () => { const code = itemCodeInput.value.trim().toUpperCase(); if (code && !document.querySelector(`.item-code-tag[data-code="${code}"]`)) { createItemCodeTag(code); createInspectionRow(code); itemCodeInput.value = ''; itemCodeInput.focus(); captureState(); } else if (code) { alert("M√£ h√†ng n√†y ƒë√£ t·ªìn t·∫°i."); } };
addItemCodeBtn.addEventListener('click', addItemAction);
itemCodeInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addItemAction(); } });

const notePhotoInput = document.getElementById('notePhotoInput');
notePhotoInput.addEventListener('change', async function() { if (this.files.length === 0) return; const files = Array.from(this.files); this.value = ''; showProgress(`ƒêang x·ª≠ l√Ω ${files.length} ·∫£nh ghi ch√∫...`, 0, files.length); for (const file of files) { try { const compressedBlob = await compressImage(file, 800); const item = await createNotePhotoItem(compressedBlob); document.getElementById('note-photos-container').appendChild(item); } catch(err) { console.error("L·ªói ·∫£nh ghi ch√∫:", err); } } hideProgress(); captureState(); });
document.getElementById('noteZipInput').addEventListener('change', function() { handleArchiveInput(this.files[0], 'note-photos-container'); this.value = ''; });

initHeaderObserver();
initMultiSelect();
initManualImageUpload();
initImageCropper();

// [Y√äU C·∫¶U 1]
initQuickShot();
// [Y√äU C·∫¶U 2]
initNotes();
// [Y√äU C·∫¶U 3]
initTranslation();


initAqlCalculator();
initZoom();
initNextShotMirror();
initToleranceCalculator();
});

// S·ª¨A L·ªñI VIDEO: B·ªè n√©n, d√πng file g·ªëc
async function addVideoFile(videoFile) {
    const uiId = `video-prog-${Date.now()}`;
    const queueContainer = document.getElementById('video-queue-container');
    const progressItem = document.createElement('div');
    progressItem.className = 'video-progress-item';
    progressItem.id = uiId;
    progressItem.innerHTML = `<p>ƒêang th√™m: ${videoFile.name}</p>`;
    queueContainer.appendChild(progressItem);

    try {
        const item = await createFactoryMediaItem(videoFile, 'video');
        document.getElementById('factory-media-container').appendChild(item);
        
        progressItem.querySelector('p').textContent = `Ho√†n t·∫•t: ${videoFile.name}`;
        progressItem.classList.add('finished');
        
        setTimeout(() => {
            if(progressItem) progressItem.remove();
        }, 5000);

        captureState();
    } catch (error) {
        console.error("L·ªói khi th√™m video:", error);
        progressItem.classList.add('error');
        progressItem.querySelector('p').textContent = `L·ªói khi th√™m video: ${videoFile.name}`;
    }
}


// --- [Y√äU C·∫¶U 1] G∆Ø∆†NG CH·ª§P NHANH - LOGIC ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T HO√ÄN TO√ÄN ---
/**
 * C·∫≠p nh·∫≠t "g∆∞∆°ng" ƒë·ªÉ hi·ªÉn th·ªã √¥ ·∫£nh ti·∫øp theo c·∫ßn ch·ª•p.
 * Logic m·ªõi th√¥ng minh h∆°n, ∆∞u ti√™n √¥ ƒë∆∞·ª£c focus v√† t√¨m √¥ tr·ªëng ti·∫øp theo.
 */
function updateNextShotMirror() {
    const nextShotMirror = document.getElementById('next-shot-mirror');
    const nextShotThumbnail = document.getElementById('next-shot-thumbnail');
    const nextShotDescription = document.getElementById('next-shot-description');

    const allBoxes = Array.from(document.querySelectorAll('#boxes-container .box'));
    if (allBoxes.length === 0) {
        nextShotMirror.classList.add('hidden');
        return;
    }

    let startIndex = -1;
    // ∆ØU TI√äN 1: D√πng √¥ v·ª´a t∆∞∆°ng t√°c (ƒë∆∞·ª£c t√¥ vi·ªÅn cam) l√†m ƒëi·ªÉm b·∫Øt ƒë·∫ßu
    if (lastInteractedBoxId) {
        const lastBox = document.getElementById(lastInteractedBoxId);
        if (lastBox) {
            startIndex = allBoxes.indexOf(lastBox);
        }
    }

    // ∆ØU TI√äN 2: N·∫øu kh√¥ng c√≥ √¥ n√†o ƒë∆∞·ª£c focus, t√¨m √¥ cu·ªëi c√πng c√≥ ·∫£nh
    if (startIndex === -1) {
        for (let i = allBoxes.length - 1; i >= 0; i--) {
            if (allBoxes[i].dataset.isCameraCaptured === 'true') {
                startIndex = i;
                break;
            }
        }
    }

    // B√¢y gi·ªù, t√¨m √¥ tr·ªëng *ti·∫øp theo* t√≠nh t·ª´ ƒëi·ªÉm b·∫Øt ƒë·∫ßu (startIndex)
    let targetBox = null;
    if (startIndex === -1) {
        // Ch∆∞a c√≥ ·∫£nh n√†o, ch∆∞a c√≥ focus. L·∫•y √¥ tr·ªëng ƒë·∫ßu ti√™n.
        targetBox = allBoxes.find(box => !box.dataset.isCameraCaptured);
    } else {
        // B·∫Øt ƒë·∫ßu t√¨m t·ª´ √¥ *sau* √¥ startIndex
        for (let i = startIndex + 1; i < allBoxes.length; i++) {
            if (!allBoxes[i].dataset.isCameraCaptured) {
                targetBox = allBoxes[i];
                break;
            }
        }
        // N·∫øu t√¨m ƒë·∫øn cu·ªëi m√† kh√¥ng th·∫•y, quay l·∫°i t√¨m t·ª´ ƒë·∫ßu
        if (!targetBox) {
             for (let i = 0; i < startIndex + 1; i++) {
                if (!allBoxes[i].dataset.isCameraCaptured) {
                    targetBox = allBoxes[i];
                    break;
                }
            }
        }
    }

    // C·∫≠p nh·∫≠t giao di·ªán c·ªßa "g∆∞∆°ng"
    if (targetBox) {
        const description = targetBox.querySelector('.description').textContent;
        const thumbnailUrl = targetBox.querySelector('.thumbnail').src;

        nextShotDescription.textContent = description;
        nextShotThumbnail.src = thumbnailUrl;
        nextShotMirror.dataset.targetId = targetBox.id;
        nextShotMirror.classList.remove('hidden');
    } else {
        // T·∫•t c·∫£ c√°c √¥ ƒë√£ ƒë∆∞·ª£c l·∫•p ƒë·∫ßy
        nextShotMirror.classList.add('hidden');
    }
}

/**
 * G·∫Øn c√°c s·ª± ki·ªán click cho "g∆∞∆°ng".
 */
function initNextShotMirror() {
    const nextShotMirror = document.getElementById('next-shot-mirror');

    // S·ª± ki·ªán ch√≠nh: Click v√†o g∆∞∆°ng ƒë·ªÉ ch·ª•p ·∫£nh cho √¥ m·ª•c ti√™u
    nextShotMirror.addEventListener('click', () => {
        const targetId = nextShotMirror.dataset.targetId;
        if (!targetId) return;

        const targetBox = document.getElementById(targetId);
        if (targetBox) {
            const input = targetBox.querySelector('input[type="file"]');
            if (input) {
                input.click(); 
            }
        }
    });

    // S·ª± ki·ªán ph·ª•: B·∫≠t/t·∫Øt g∆∞∆°ng
    document.getElementById('toggle-mirror-btn').addEventListener('click', (e) => {
        e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click c·ªßa g∆∞∆°ng b·ªã k√≠ch ho·∫°t
        nextShotMirror.classList.toggle('disabled');
    });
}


// --- ZOOM ·∫¢NH ---
function initZoom() {
const overlay = document.getElementById('zoom-overlay');
const image = document.getElementById('zoom-image');
const closeBtn = document.querySelector('.zoom-close-btn');
const prevBtn = document.getElementById('zoom-prev');
const nextBtn = document.getElementById('zoom-next');

let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 }, pointers = [], prevDiff = -1;
function setTransform() { if (scale < 1) { scale = 1; pointX = 0; pointY = 0; } image.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
const closeZoom = () => { overlay.style.display = 'none'; image.src = ''; pointers = []; prevDiff = -1; currentZoomBoxId = null; };
closeBtn.addEventListener('click', closeZoom);
document.addEventListener('keydown', (e) => { if (e.key === "Escape") closeZoom(); });
overlay.addEventListener('click', (e) => { if (e.target === overlay) closeZoom(); });
overlay.addEventListener('pointerdown', (e) => { if(e.target !== prevBtn && e.target !== nextBtn) { pointers.push(e); if (pointers.length === 1) { panning = true; start = { x: e.clientX - pointX, y: e.clientY - pointY }; image.style.cursor = 'grabbing'; } }});
overlay.addEventListener('pointerup', (e) => { panning = false; image.style.cursor = 'grab'; pointers = pointers.filter(p => p.pointerId !== e.pointerId); if (pointers.length < 2) prevDiff = -1; });
overlay.addEventListener('pointercancel', (e) => { panning = false; image.style.cursor = 'grab'; pointers = pointers.filter(p => p.pointerId !== e.pointerId); if (pointers.length < 2) prevDiff = -1; });
overlay.addEventListener('pointermove', (e) => {
const index = pointers.findIndex(p => p.pointerId === e.pointerId); if (index > -1) pointers[index] = e;
if (pointers.length === 2) { const curDiff = Math.hypot(pointers[0].clientX - pointers[1].clientX, pointers[0].clientY - pointers[1].clientY); if (prevDiff > 0) { scale += (curDiff > prevDiff ? 0.02 : -0.02); scale = Math.max(1, Math.min(scale, 5)); setTransform(); } prevDiff = curDiff; } else if (panning && pointers.length === 1) { e.preventDefault(); pointX = e.clientX - start.x; pointY = e.clientY - start.y; setTransform(); }
});
overlay.addEventListener('wheel', (e) => { e.preventDefault(); const xs = (e.clientX - pointX) / scale, ys = (e.clientY - pointY) / scale, delta = -e.deltaY; (delta > 0) ? (scale *= 1.1) : (scale /= 1.1); scale = Math.max(1, Math.min(scale, 5)); pointX = e.clientX - xs * scale; pointY = e.clientY - ys * scale; setTransform(); });

prevBtn.addEventListener('click', () => navigateZoom(-1));
nextBtn.addEventListener('click', () => navigateZoom(1));
}

function navigateZoom(direction) {
    if (!currentZoomBoxId) return;
    const allBoxes = Array.from(document.querySelectorAll('#boxes-container .box, .factory-media-item')).filter(el => el.imageBlob || el.mediaBlob);
    const currentIndex = allBoxes.findIndex(b => b.id === currentZoomBoxId);
    if (currentIndex === -1) return;
    
    let nextIndex = currentIndex + direction;
    if (nextIndex >= allBoxes.length) nextIndex = 0;
    if (nextIndex < 0) nextIndex = allBoxes.length - 1;
    
    showZoom(allBoxes[nextIndex].id);
}

async function showZoom(boxIdOrUrl) {
    const overlay = document.getElementById('zoom-overlay');
    const image = document.getElementById('zoom-image');
    image.style.transform = 'translate(0px, 0px) scale(1)';
    
    if (boxIdOrUrl.startsWith('data:') || boxIdOrUrl.startsWith('blob:')) {
        image.src = boxIdOrUrl;
        currentZoomBoxId = null;
        document.getElementById('zoom-prev').style.display = 'none';
        document.getElementById('zoom-next').style.display = 'none';
    } else {
        const element = document.getElementById(boxIdOrUrl);
        // [Y√äU C·∫¶U 4] S·ª¨A L·ªñI: Ki·ªÉm tra c·∫£ imageBlob v√† mediaBlob
        if (element) {
            const blob = element.imageBlob || element.mediaBlob;
            if (blob && blob.type.startsWith('image/')) {
                currentZoomBoxId = boxIdOrUrl;
                image.src = await blobToDataURL(blob);
                document.getElementById('zoom-prev').style.display = 'block';
                document.getElementById('zoom-next').style.display = 'block';
            } else {
                return; // Kh√¥ng ph·∫£i ·∫£nh, kh√¥ng zoom
            }
        } else {
            return;
        }
    }
    overlay.style.display = 'flex';
}


// --- LOGIC N√â THANH C√îNG C·ª§ ---
function initHeaderObserver() {
    const controls = document.getElementById('controls');
    const tabs = document.getElementById('tabs-container');

    const updateBodyPadding = () => {
        const totalHeight = controls.offsetHeight + tabs.offsetHeight;
        document.body.style.paddingTop = `${totalHeight}px`;
    };
    
    const resizeObserver = new ResizeObserver(updateBodyPadding);
    resizeObserver.observe(controls);
    
    updateBodyPadding();
}


// --- LOGIC CH·ªåN NHI·ªÄU ·∫¢NH ---
function initMultiSelect() {
const toggleBtn = document.getElementById('toggleSelectModeBtn');
const moveUpBtn = document.getElementById('moveSelectedUpBtn');
const moveDownBtn = document.getElementById('moveSelectedDownBtn');
const exportSelectedBtn = document.getElementById('exportSelectedBtn');

toggleBtn.addEventListener('click', () => {
toggleMultiSelectMode(!isMultiSelectMode);
});

moveUpBtn.addEventListener('click', () => moveSelectedBoxes('up'));
moveDownBtn.addEventListener('click', () => moveSelectedBoxes('down'));
exportSelectedBtn.addEventListener('click', exportSelectedImages);
}

function toggleMultiSelectMode(enable) {
isMultiSelectMode = enable;
const toggleBtn = document.getElementById('toggleSelectModeBtn');
const body = document.body;

body.classList.toggle('multi-select-mode', isMultiSelectMode);
toggleBtn.classList.toggle('active', isMultiSelectMode);
toggleBtn.textContent = isMultiSelectMode ? 'T·∫Øt Ch·ªçn Nhi·ªÅu' : 'Ch·ªçn Nhi·ªÅu ·∫¢nh';

if (!isMultiSelectMode) {
selectedBoxIds.forEach(id => {
document.getElementById(id)?.classList.remove('selected');
});
selectedBoxIds.clear();
}
updateMultiSelectButtonsVisibility();
}

function toggleBoxSelection(boxElement) {
if (!isMultiSelectMode) return;
const id = boxElement.id;
if (selectedBoxIds.has(id)) {
selectedBoxIds.delete(id);
boxElement.classList.remove('selected');
} else {
selectedBoxIds.add(id);
boxElement.classList.add('selected');
}
updateMultiSelectButtonsVisibility();
}

function updateMultiSelectButtonsVisibility() {
const moveUpBtn = document.getElementById('moveSelectedUpBtn');
const moveDownBtn = document.getElementById('moveSelectedDownBtn');
const exportSelectedBtn = document.getElementById('exportSelectedBtn');

const hasSelection = selectedBoxIds.size > 0;
moveUpBtn.classList.toggle('hidden', !hasSelection);
moveDownBtn.classList.toggle('hidden', !hasSelection);
exportSelectedBtn.classList.toggle('hidden', !hasSelection);
}

function moveSelectedBoxes(direction) {
if (selectedBoxIds.size === 0) return;
const container = document.getElementById('boxes-container');
const allBoxes = Array.from(container.children);
const selectedElements = Array.from(selectedBoxIds).map(id => document.getElementById(id)).filter(Boolean);

selectedElements.sort((a, b) => allBoxes.indexOf(a) - allBoxes.indexOf(b));

if (direction === 'up') {
const firstSelected = selectedElements[0];
const precedingElement = firstSelected.previousElementSibling;
if (precedingElement && !selectedBoxIds.has(precedingElement.id)) {
selectedElements.forEach(el => container.insertBefore(el, precedingElement));
}
} else { 
const lastSelected = selectedElements[selectedElements.length - 1];
const followingElement = lastSelected.nextElementSibling;
if (followingElement) {
selectedElements.reverse().forEach(el => container.insertBefore(el, followingElement.nextElementSibling));
}
}
renumberDetailBoxes();
captureState();
}

async function exportSelectedImages() {
    if (selectedBoxIds.size === 0) {
        alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ·∫£nh ƒë·ªÉ xu·∫•t.");
        return;
    }
    showProgress("ƒêang chu·∫©n b·ªã ·∫£nh ƒë√£ ch·ªçn...", 0, 100);
    const zip = new JSZip();
    const today = new Date();
    const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
    const reportName = `Selected_Images_${dateString}`;
    const mainFolder = zip.folder(reportName);

    const allBoxes = Array.from(document.querySelectorAll('#boxes-container .box'));

    for (const id of selectedBoxIds) {
        const box = document.getElementById(id);
        if (box && box.imageBlob) {
            const index = allBoxes.indexOf(box);
            const filename = `${index + 1}. ${box.dataset.baseDescription}.jpg`;
            mainFolder.file(filename, box.imageBlob);
        }
    }

    try {
        const content = await zip.generateAsync({ type: "blob" }, (metadata) => {
            showProgress(`ƒêang n√©n ZIP... ${metadata.percent.toFixed(0)}%`, metadata.percent, 100);
        });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `${reportName}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    } catch (err) {
        console.error("L·ªói khi t·∫°o ZIP ·∫£nh ƒë√£ ch·ªçn:", err);
    } finally {
        hideProgress();
    }
}


// --- LOGIC TH√äM ·∫¢NH TH·ª¶ C√îNG & CROP ---
function initManualImageUpload() {
    const addBtn = document.getElementById('addManualImageBtn');
    const fileInput = document.getElementById('manualImageInput');

    addBtn.addEventListener('click', () => {
        if (!currentlyFocusedBox) {
            alert("Vui l√≤ng nh·∫•p v√†o √¥ m√¥ t·∫£ c·ªßa ·∫£nh b·∫°n mu·ªën th√™m/thay th·∫ø!");
            return;
        }
        fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            openCropper(file);
        }
        e.target.value = ''; 
    });
}

function initImageCropper() {
    const overlay = document.getElementById('crop-modal-overlay');
    const container = document.getElementById('crop-container');
    const imagePreview = document.getElementById('crop-image-preview');
    const cropBox = document.getElementById('crop-box');
    
    document.getElementById('cancel-crop-btn').addEventListener('click', closeCropper);
    document.getElementById('confirm-crop-btn').addEventListener('click', applyCrop);

    let isResizing = false;
    let isDragging = false;
    let resizeHandle = '';
    let startX, startY, startWidth, startHeight, startLeft, startTop;

    const startAction = (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        startX = e.clientX || e.touches[0].clientX;
        startY = e.clientY || e.touches[0].clientY;
        
        const target = e.target;
        if (target.classList.contains('crop-handle')) {
            isResizing = true;
            resizeHandle = Array.from(target.classList).find(c => c !== 'crop-handle');
        } else if (target === cropBox) {
            isDragging = true;
        }
        
        startWidth = parseFloat(getComputedStyle(cropBox).width);
        startHeight = parseFloat(getComputedStyle(cropBox).height);
        startLeft = parseFloat(getComputedStyle(cropBox).left);
        startTop = parseFloat(getComputedStyle(cropBox).top);

        window.addEventListener('mousemove', doAction);
        window.addEventListener('touchmove', doAction, { passive: false });
        window.addEventListener('mouseup', endAction);
        window.addEventListener('touchend', endAction);
    };

    const doAction = (e) => {
        if (!isDragging && !isResizing) return;
        e.preventDefault();
        
        const currentX = e.clientX || e.touches[0].clientX;
        const currentY = e.clientY || e.touches[0].clientY;
        const dx = currentX - startX;
        const dy = currentY - startY;

        if (isDragging) {
            let newLeft = startLeft + dx;
            let newTop = startTop + dy;
            const parentRect = container.getBoundingClientRect();
            if (newLeft < 0) newLeft = 0;
            if (newTop < 0) newTop = 0;
            if (newLeft + startWidth > parentRect.width) newLeft = parentRect.width - startWidth;
            if (newTop + startHeight > parentRect.height) newTop = parentRect.height - startHeight;
            cropBox.style.left = `${newLeft}px`;
            cropBox.style.top = `${newTop}px`;
        } else if (isResizing) {
            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = startLeft;
            let newTop = startTop;

            if (resizeHandle.includes('e')) newWidth = startWidth + dx;
            if (resizeHandle.includes('w')) {
                newWidth = startWidth - dx;
                newLeft = startLeft + dx;
            }
            if (resizeHandle.includes('s')) newHeight = startHeight + dy;
            if (resizeHandle.includes('n')) {
                newHeight = startHeight - dy;
                newTop = startTop + dy;
            }
            
            if (newWidth > 10) {
                 cropBox.style.width = `${newWidth}px`;
                 cropBox.style.left = `${newLeft}px`;
            }
            if(newHeight > 10){
                cropBox.style.height = `${newHeight}px`;
                cropBox.style.top = `${newTop}px`;
            }
        }
    };

    const endAction = () => {
        isDragging = false;
        isResizing = false;
        window.removeEventListener('mousemove', doAction);
        window.removeEventListener('touchmove', doAction);
        window.removeEventListener('mouseup', endAction);
        window.removeEventListener('touchend', endAction);
    };
    
    cropBox.addEventListener('mousedown', startAction);
    cropBox.addEventListener('touchstart', startAction, { passive: false });
}

function openCropper(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const overlay = document.getElementById('crop-modal-overlay');
        const imagePreview = document.getElementById('crop-image-preview');
        const originalImage = new Image();
        
        originalImage.onload = () => {
            imagePreview.src = e.target.result;
            overlay.originalImage = originalImage;
            overlay.style.display = 'flex';
            
            setTimeout(() => {
                const containerRect = imagePreview.getBoundingClientRect();
                const width = containerRect.width * 0.8;
                const height = containerRect.height * 0.8;
                const cropBox = document.getElementById('crop-box');
                cropBox.style.width = `${width}px`;
                cropBox.style.height = `${height}px`;
                cropBox.style.left = `${(containerRect.width - width) / 2}px`;
                cropBox.style.top = `${(containerRect.height - height) / 2}px`;
            }, 50);
        }
        originalImage.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function closeCropper() {
    document.getElementById('crop-modal-overlay').style.display = 'none';
}

async function applyCrop() {
    if (!currentlyFocusedBox) {
        alert("L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c √¥ ·∫£nh ƒë·ªÉ √°p d·ª•ng. Vui l√≤ng th·ª≠ l·∫°i.");
        closeCropper();
        return;
    }
    const overlay = document.getElementById('crop-modal-overlay');
    const imagePreview = document.getElementById('crop-image-preview');
    const cropBox = document.getElementById('crop-box');
    const originalImage = overlay.originalImage;

    const previewRect = imagePreview.getBoundingClientRect();
    const cropBoxRect = cropBox.getBoundingClientRect();
    
    const scaleX = originalImage.naturalWidth / previewRect.width;
    const scaleY = originalImage.naturalHeight / previewRect.height;
    
    const sx = (cropBoxRect.left - previewRect.left) * scaleX;
    const sy = (cropBoxRect.top - previewRect.top) * scaleY;
    const sWidth = cropBoxRect.width * scaleX;
    const sHeight = cropBoxRect.height * scaleY;

    const canvas = document.createElement('canvas');
    canvas.width = sWidth;
    canvas.height = sHeight;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(originalImage, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);

    canvas.toBlob(async (blob) => {
        try {
            showProgress('ƒêang n√©n ·∫£nh ƒë√£ c·∫Øt...', 0, 1);
            const compressedBlob = await compressImage(blob);
            
            currentlyFocusedBox.imageBlob = compressedBlob;
            currentlyFocusedBox.dataset.isCameraCaptured = 'true';

            // [Y√äU C·∫¶U 1] ƒê·∫∑t √¥ n√†y l√†m focus m·ªõi
            setLastInteractedBox(currentlyFocusedBox.id);

            updateBoxAppearance(currentlyFocusedBox);
            captureState();
            
        } catch (error) {
            console.error("L·ªói khi x·ª≠ l√Ω ·∫£nh ƒë√£ c·∫Øt:", error);
        } finally {
            hideProgress();
            closeCropper();
            currentlyFocusedBox = null;
        }
    }, 'image/jpeg');
}

// --- [Y√äU C·∫¶U 1] LOGIC CH·ª§P ·∫¢NH NHANH ---
let quickShotStream = null;
function initQuickShot() {
    const modal = document.getElementById('quick-shot-modal');
    const video = document.getElementById('quick-shot-video');
    const openBtn = document.getElementById('quickShotBtn');
    const closeBtn = document.getElementById('close-quick-shot-btn');
    const captureBtn = document.getElementById('do-quick-shot-btn');

    openBtn.addEventListener('click', async () => {
        try {
            quickShotStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } // ∆Øu ti√™n camera sau
            });
            video.srcObject = quickShotStream;
            await video.play();
            modal.style.display = 'flex';
        } catch (err) {
            console.error("L·ªói truy c·∫≠p camera:", err);
            alert("Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng c·∫•p quy·ªÅn v√† th·ª≠ l·∫°i.");
        }
    });

    closeBtn.addEventListener('click', () => {
        if (quickShotStream) {
            quickShotStream.getTracks().forEach(track => track.stop());
        }
        video.srcObject = null;
        modal.style.display = 'none';
    });

    captureBtn.addEventListener('click', async () => {
        const allBoxes = Array.from(document.querySelectorAll('#boxes-container .box'));
        
        // T√¨m √¥ tr·ªëng d·ª±a tr√™n logic c·ªßa g∆∞∆°ng xem tr∆∞·ªõc
        const mirrorTargetId = document.getElementById('next-shot-mirror').dataset.targetId;
        let firstEmptyBox = mirrorTargetId ? document.getElementById(mirrorTargetId) : null;

        // N·∫øu g∆∞∆°ng kh√¥ng c√≥ m·ª•c ti√™u (c√≥ th·ªÉ t·∫•t c·∫£ ƒë√£ ƒë·∫ßy), t√¨m √¥ tr·ªëng ƒë·∫ßu ti√™n
        if (!firstEmptyBox) {
            firstEmptyBox = allBoxes.find(box => !box.imageBlob);
        }
        
        if (!firstEmptyBox) {
            if (confirm("T·∫•t c·∫£ c√°c √¥ ƒë√£ c√≥ ·∫£nh. B·∫°n c√≥ mu·ªën t·∫°o m·ªôt √¥ m·ªõi ƒë·ªÉ ch·ª•p?")) {
                const lastBox = document.querySelector('#boxes-container .box:last-child');
                const newBox = createDetailBox("·∫¢nh ch·ª•p nhanh", undefined, true);
                if (lastBox) {
                    lastBox.insertAdjacentElement('afterend', newBox);
                } else {
                    document.getElementById('boxes-container').appendChild(newBox);
                }
                renumberDetailBoxes();
                captureAndFill(newBox);
            }
            return;
        }
        
        captureAndFill(firstEmptyBox);
    });
}

async function captureAndFill(targetBox) {
    const video = document.getElementById('quick-shot-video');
    const canvas = document.getElementById('quick-shot-canvas');
    const ctx = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(async (blob) => {
        try {
            showProgress('ƒêang x·ª≠ l√Ω ·∫£nh...', 0, 1);
            const compressedBlob = await compressImage(blob);
            targetBox.imageBlob = compressedBlob;
            targetBox.dataset.isCameraCaptured = 'true';
            
            // [Y√äU C·∫¶U 1] ƒê·∫∑t √¥ n√†y l√†m focus m·ªõi
            setLastInteractedBox(targetBox.id);

            updateBoxAppearance(targetBox);
            captureState();
            // Cho ph√©p ch·ª•p ·∫£nh ti·∫øp theo ngay l·∫≠p t·ª©c
            hideProgress();
        } catch (error) {
            console.error("L·ªói khi x·ª≠ l√Ω ·∫£nh ch·ª•p nhanh:", error);
            hideProgress();
        }
    }, 'image/jpeg');
}

// --- [Y√äU C·∫¶U 2] LOGIC GHI CH√ö ---
function initNotes() {
    const notesArea = document.getElementById('local-notes');
    notesArea.addEventListener('input', () => {
        saveNotesForSession(activeSessionId);
    });
}

function saveNotesForSession(sessionId) {
    if (!sessionId) return;
    const notesArea = document.getElementById('local-notes');
    localStorage.setItem(`notes_${sessionId}`, notesArea.value);
}

function loadNotesForSession(sessionId) {
    if (!sessionId) return;
    const notesArea = document.getElementById('local-notes');
    notesArea.value = localStorage.getItem(`notes_${sessionId}`) || '';
}


// --- [Y√äU C·∫¶U 3] LOGIC D·ªäCH THU·∫¨T ---
function initTranslation() {
    document.getElementById('translateToEnBtn').addEventListener('click', () => translateAllDescriptions('en'));
    document.getElementById('translateToZhBtn').addEventListener('click', () => translateAllDescriptions('zh-CN'));
    document.getElementById('revertTranslationBtn').addEventListener('click', revertAllDescriptions);
}

async function translateAllDescriptions(targetLang) {
    const boxes = Array.from(document.querySelectorAll('#boxes-container .box'));
    if (boxes.length === 0) return;

    showProgress(`ƒêang d·ªãch sang ${targetLang}...`, 0, boxes.length);
    originalDescriptions = {}; // X√≥a b·∫£n l∆∞u c≈©
    
    const promises = boxes.map(async (box, index) => {
        const p = box.querySelector('.description');
        const originalText = box.dataset.baseDescription;
        originalDescriptions[box.id] = originalText; // L∆∞u l·∫°i vƒÉn b·∫£n g·ªëc

        try {
            const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(originalText)}&langpair=vi|${targetLang}`);
            if (!response.ok) throw new Error('API request failed');
            const data = await response.json();
            if (data.responseData && data.responseData.translatedText) {
                const translatedText = data.responseData.translatedText;
                box.dataset.baseDescription = translatedText;
            }
        } catch (error) {
            console.error(`L·ªói d·ªãch cho box ${box.id}:`, error);
            // N·∫øu l·ªói, gi·ªØ nguy√™n vƒÉn b·∫£n g·ªëc
        }
        
        showProgress(`ƒêang d·ªãch sang ${targetLang}...`, index + 1, boxes.length);
    });

    await Promise.all(promises);
    renumberDetailBoxes();
    captureState();
    document.getElementById('revertTranslationBtn').classList.remove('hidden');
    hideProgress();
}

function revertAllDescriptions() {
    if (Object.keys(originalDescriptions).length === 0) {
        alert("Kh√¥ng c√≥ b·∫£n d·ªãch ƒë·ªÉ kh√¥i ph·ª•c.");
        return;
    }
    
    showProgress("ƒêang kh√¥i ph·ª•c...", 0, 1);
    Object.keys(originalDescriptions).forEach(boxId => {
        const box = document.getElementById(boxId);
        if (box) {
            box.dataset.baseDescription = originalDescriptions[boxId];
        }
    });

    renumberDetailBoxes();
    captureState();
    originalDescriptions = {};
    document.getElementById('revertTranslationBtn').classList.add('hidden');
    hideProgress();
}


// --- AQL LOGIC ---
let currentAqlRow = null;
const lotSizeToCodeLetterTable=[{min:2,max:8,levels:{"I":"A","II":"A","III":"B","S-1":"A","S-2":"A","S-3":"A","S-4":"A"}},{min:9,max:15,levels:{"I":"A","II":"B","III":"C","S-1":"A","S-2":"A","S-3":"A","S-4":"A"}},{min:16,max:25,levels:{"I":"B","II":"C","III":"D","S-1":"A","S-2":"A","S-3":"B","S-4":"B"}},{min:26,max:50,levels:{"I":"C","II":"D","III":"E","S-1":"A","S-2":"B","S-3":"B","S-4":"C"}},{min:51,max:90,levels:{"I":"C","II":"E","III":"F","S-1":"B","S-2":"B","S-3":"C","S-4":"C"}},{min:91,max:150,levels:{"I":"D","II":"F","III":"G","S-1":"B","S-2":"B","S-3":"C","S-4":"D"}},{min:151,max:280,levels:{"I":"E","II":"G","III":"H","S-1":"B","S-2":"C","S-3":"D","S-4":"E"}},{min:281,max:500,levels:{"I":"F","II":"H","III":"J","S-1":"B","S-2":"C","S-3":"D","S-4":"E"}},{min:501,max:1200,levels:{"I":"G","II":"J","III":"K","S-1":"C","S-2":"C","S-3":"E","S-4":"F"}},{min:1201,max:3200,levels:{"I":"H","II":"K","III":"L","S-1":"C","S-2":"D","S-3":"E","S-4":"G"}},{min:3201,max:10000,levels:{"I":"J","II":"L","III":"M","S-1":"C","S-2":"D","S-3":"F","S-4":"G"}},{min:10001,max:35000,levels:{"I":"K","II":"M","III":"N","S-1":"C","S-2":"D","S-3":"F","S-4":"H"}},{min:35001,max:150000,levels:{"I":"L","II":"N","III":"P","S-1":"D","S-2":"E","S-3":"G","S-4":"J"}},{min:150001,max:500000,levels:{"I":"M","II":"P","III":"Q","S-1":"D","S-2":"E","S-3":"G","S-4":"J"}},{min:500001,max:10000000,levels:{"I":"N","II":"Q","III":"R","S-1":"D","S-2":"E","S-3":"H","S-4":"K"}}];
const aqlDataTable={"A":{sampleSize:2,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[0,1],"4.0":[0,1],"6.5":[0,1]}},"B":{sampleSize:3,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[0,1],"4.0":[0,1],"6.5":[0,1]}},"C":{sampleSize:5,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[0,1],"4.0":[0,1],"6.5":[1,2]}},"D":{sampleSize:8,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[0,1],"4.0":[1,2],"6.5":[1,2]}},"E":{sampleSize:13,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[1,2],"4.0":[1,2],"6.5":[2,3]}},"F":{sampleSize:20,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[1,2],"2.5":[1,2],"4.0":[2,3],"6.5":[3,4]}},"G":{sampleSize:32,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[1,2],"1.5":[1,2],"2.5":[2,3],"4.0":[3,4],"6.5":[5,6]}},"H":{sampleSize:50,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[1,2],"1.0":[1,2],"1.5":[2,3],"2.5":[3,4],"4.0":[5,6],"6.5":[7,8]}},"J":{sampleSize:80,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[1,2],"0.65":[1,2],"1.0":[2,3],"1.5":[3,4],"2.5":[5,6],"4.0":[7,8],"6.5":[10,11]}},"K":{sampleSize:125,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[1,2],"0.40":[1,2],"0.65":[2,3],"1.0":[3,4],"1.5":[5,6],"2.5":[7,8],"4.0":[10,11],"6.5":[14,15]}},"L":{sampleSize:200,aql:{"0":[0,1],"0.065":[0,1],"0.10":[0,1],"0.15":[1,2],"0.25":[1,2],"0.40":[2,3],"0.65":[3,4],"1.0":[5,6],"1.5":[7,8],"2.5":[10,11],"4.0":[14,15],"6.5":[21,22]}},"M":{sampleSize:315,aql:{"0":[0,1],"0.065":[0,1],"0.10":[1,2],"0.15":[1,2],"0.25":[2,3],"0.40":[3,4],"0.65":[5,6],"1.0":[7,8],"1.5":[10,11],"2.5":[14,15],"4.0":[21,22],"6.5":[21,22]}},"N":{sampleSize:500,aql:{"0":[0,1],"0.065":[1,2],"0.10":[1,2],"0.15":[2,3],"0.25":[3,4],"0.40":[5,6],"0.65":[7,8],"1.0":[10,11],"1.5":[14,15],"2.5":[21,22],"4.0":[21,22],"6.5":[21,22]}},"P":{sampleSize:800,aql:{"0":[0,1],"0.065":[1,2],"0.10":[2,3],"0.15":[3,4],"0.25":[5,6],"0.40":[7,8],"0.65":[10,11],"1.0":[14,15],"1.5":[21,22],"2.5":[21,22],"4.0":[21,22],"6.5":[21,22]}},"Q":{sampleSize:1250,aql:{"0":[0,1],"0.065":[2,3],"0.10":[3,4],"0.15":[5,6],"0.25":[7,8],"0.40":[10,11],"0.65":[14,15],"1.0":[21,22],"1.5":[21,22],"2.5":[21,22],"4.0":[21,22],"6.5":[21,22]}},"R":{sampleSize:2000,aql:{"0":[0,1],"0.065":[3,4],"0.10":[5,6],"0.15":[7,8],"0.25":[10,11],"0.40":[14,15],"0.65":[21,22],"1.0":[21,22],"1.5":[21,22],"2.5":[21,22],"4.0":[21,22],"6.5":[21,22]}}};

function calculateAQL() {
const quantity = parseInt(document.getElementById('aqlOrderQuantity').value), level = document.getElementById('aqlInspectionLevel').value, criticalAqlValue = document.getElementById('aqlCritical').value, majorAqlValue = document.getElementById('aqlMajor').value, minorAqlValue = document.getElementById('aqlMinor').value;
let codeLetter = null;
if (!isNaN(quantity) && quantity >= 2) { for (const range of lotSizeToCodeLetterTable) { if (quantity >= range.min && quantity <= range.max) { codeLetter = range.levels[level]; break; } } }
if (codeLetter && aqlDataTable[codeLetter]) {
const aqlData = aqlDataTable[codeLetter], sampleSize = aqlData.sampleSize, criticalResult = aqlData.aql[criticalAqlValue] || ['0', '1'], majorResult = aqlData.aql[majorAqlValue] || ['N/A', 'N/A'], minorResult = aqlData.aql[minorAqlValue] || ['N/A', 'N/A'];
document.getElementById('aql-result-code-letter').textContent = codeLetter; document.getElementById('aql-result-sample-size').textContent = sampleSize;
document.getElementById('aql-critical-aql-result').textContent = criticalAqlValue; document.getElementById('aql-critical-ac').textContent = criticalResult[0]; document.getElementById('aql-critical-re').textContent = criticalResult[1];
document.getElementById('aql-major-aql-result').textContent = majorAqlValue; document.getElementById('aql-major-ac').textContent = majorResult[0]; document.getElementById('aql-major-re').textContent = majorResult[1];
document.getElementById('aql-minor-aql-result').textContent = minorAqlValue; document.getElementById('aql-minor-ac').textContent = minorResult[0]; document.getElementById('aql-minor-re').textContent = minorResult[1];
} else { const na = 'N/A'; document.getElementById('aql-result-code-letter').textContent = na; document.getElementById('aql-result-sample-size').textContent = na; document.getElementById('aql-critical-ac').textContent = '0'; document.getElementById('aql-critical-re').textContent = '1'; document.getElementById('aql-major-ac').textContent = na; document.getElementById('aql-major-re').textContent = na; document.getElementById('aql-minor-ac').textContent = na; document.getElementById('aql-minor-re').textContent = na; }
}
function initAqlCalculator() { ['aqlOrderQuantity', 'aqlInspectionLevel', 'aqlCritical', 'aqlMajor', 'aqlMinor'].forEach(id => document.getElementById(id).addEventListener('input', calculateAQL)); document.getElementById('aqlCloseBtn').addEventListener('click', closeAqlModal); document.getElementById('aqlApplyBtn').addEventListener('click', applyAndCloseAqlModal); document.getElementById('aql-modal-overlay').addEventListener('click', (e) => { if(e.target.id === 'aql-modal-overlay') closeAqlModal(); }); calculateAQL(); }
function openAqlModal(rowElement) { currentAqlRow = rowElement; const orderQty = rowElement.dataset.orderqty || rowElement.closest('.inspection-row')?.querySelector('input[name="prod_qty_standard"]')?.value || 1000; document.getElementById('aqlOrderQuantity').value = orderQty; document.getElementById('aqlInspectionLevel').value = rowElement.dataset.inspectionlevel || 'II'; document.getElementById('aqlCritical').value = rowElement.dataset.criticalaql || '0'; document.getElementById('aqlMajor').value = rowElement.dataset.majoraql || '2.5'; document.getElementById('aqlMinor').value = rowElement.dataset.minoraql || '4.0'; calculateAQL(); document.getElementById('aql-modal-overlay').style.display = 'flex'; }
function closeAqlModal() { document.getElementById('aql-modal-overlay').style.display = 'none'; currentAqlRow = null; }
function applyAndCloseAqlModal() { if (!currentAqlRow) return;
    const sampleSize = document.getElementById('aql-result-sample-size').textContent;
    const criticalAc = document.getElementById('aql-critical-ac').textContent;
    const majorAc = document.getElementById('aql-major-ac').textContent;
    const minorAc = document.getElementById('aql-minor-ac').textContent;
    currentAqlRow.querySelector('input[name="aql_check_qty"]').value = (sampleSize !== 'N/A') ? sampleSize : '';
    currentAqlRow.querySelector('input[name="critical_standard"]').value = (criticalAc !== 'N/A') ? criticalAc : '0';
    currentAqlRow.querySelector('input[name="major_standard"]').value = (majorAc !== 'N/A') ? majorAc : '';
    currentAqlRow.querySelector('input[name="minor_standard"]').value = (minorAc !== 'N/A') ? minorAc : '';
    Object.assign(currentAqlRow.dataset, { orderqty: document.getElementById('aqlOrderQuantity').value, inspectionlevel: document.getElementById('aqlInspectionLevel').value, criticalaql: document.getElementById('aqlCritical').value, majoraql: document.getElementById('aqlMajor').value, minoraql: document.getElementById('aqlMinor').value });
    captureState();
    closeAqlModal();
}

// --- T√çNH SAI S·ªê ---
function initToleranceCalculator() {
const overlay = document.getElementById('tolerance-modal-overlay');
const valueInput = document.getElementById('tolerance-value-input');
document.getElementById('close-tolerance-modal-btn').addEventListener('click', () => overlay.style.display = 'none');
overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.style.display = 'none'; });
const saveToleranceValue = () => { if (!currentToleranceSourceBox) return; const newValue = valueInput.value; currentToleranceSourceBox.dataset.baseDescription = newValue.replace(/^\d+\.?\s*/, ''); renumberDetailBoxes(); captureState(); };
valueInput.addEventListener('blur', saveToleranceValue);
valueInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); valueInput.blur(); } });
}
async function showToleranceCalculator(standardValue, unit, imageBlob, sourceBox) {
const overlay = document.getElementById('tolerance-modal-overlay');
const tableBody = document.getElementById('tolerance-table-body');
const photoEl = document.getElementById('tolerance-photo');
const valueInput = document.getElementById('tolerance-value-input');
currentToleranceSourceBox = sourceBox;
tableBody.innerHTML = '';
photoEl.src = await blobToDataURL(imageBlob);
const fullDescription = sourceBox.querySelector('.description').textContent;
valueInput.value = fullDescription;
const match = fullDescription.match(/(\d+\.?\d*)\s*(cm|mm|kg|g|s|m)\b/i);
if (match) { const numberIndex = fullDescription.lastIndexOf(match[1]); setTimeout(() => { valueInput.focus(); valueInput.setSelectionRange(numberIndex, numberIndex + match[1].length); }, 100); }
const tolerances = [{ label: '1%', type: 'percent', value: 0.01 }, { label: '5%', type: 'percent', value: 0.05 }, { label: '10%', type: 'percent', value: 0.10 }, { label: '0.5', type: 'absolute', value: 0.5 }, { label: '1', type: 'absolute', value: 1 }, { label: '2', type: 'absolute', value: 2 }, { label: '5', type: 'absolute', value: 5 }];
tableBody.insertAdjacentHTML('beforeend', `<tr><td class="tolerance-header">${standardValue} ${unit}</td><td></td><td></td></tr>`);
tolerances.forEach(tol => { const delta = tol.type === 'percent' ? standardValue * tol.value : tol.value; const minus = (standardValue - delta).toFixed(2); const plus = (standardValue + delta).toFixed(2); tableBody.insertAdjacentHTML('beforeend', `<tr><td class="tolerance-header">${tol.label}</td><td>${minus}</td><td>${plus}</td></tr>`); });
overlay.style.display = 'flex';
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>B√°o C√°o Ki·ªÉm ƒê·ªãnh S·∫£n Ph·∫©m</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/unrar-js@1.0.1/unrar.min.js"></script>

<style>
:root {
--color-unchecked: #fee; /* M√†u n·ªÅn ƒë·ªè nh·∫°t khi ch∆∞a c√≥ ·∫£nh / ch∆∞a x√°c nh·∫≠n */
--color-checked: #e6ffed; /* M√†u n·ªÅn xanh l√° khi ƒë√£ c√≥ ·∫£nh */
--color-unchecked-border: #f88;
--color-checked-border: #8f8;
--color-primary: #007bff;
--color-secondary: #6c757d;
--color-danger: #dc3545;
--color-success: #28a745;
--color-dark: #343a40;
--color-light-gray: #f8f9fa;
}

body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
margin: 0;
padding-top: 70px; /* Space for the sticky header */
padding-bottom: 200px; /* TƒÉng kho·∫£ng ƒë·ªám d∆∞·ªõi ƒë·ªÉ kh√¥ng b·ªã g∆∞∆°ng che */
background-color: var(--color-light-gray);
}

/* --- Thanh ƒëi·ªÅu khi·ªÉn --- */
#controls {
position: fixed;
top: 0;
left: 0;
right: 0;
background-color: white;
z-index: 1000;
padding: 10px 15px;
border-bottom: 2px solid #ddd;
display: flex;
gap: 15px; /* TƒÉng kho·∫£ng c√°ch gi·ªØa c√°c nh√≥m */
align-items: center;
flex-wrap: wrap;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.control-group {
display: flex;
gap: 8px;
align-items: center;
}

#controls button, #controls .file-input-label {
padding: 8px 12px;
border: 1px solid #ccc;
background-color: #f0f0f0;
cursor: pointer;
border-radius: 5px;
font-size: 14px;
font-weight: 500;
transition: background-color 0.2s, opacity 0.2s;
display: flex;
align-items: center;
justify-content: center;
}
#controls button:hover, #controls .file-input-label:hover {
background-color: #e0e0e0;
}
#controls button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* Styling cho c√°c n√∫t quan tr·ªçng */
#controls #exportZip { background-color: var(--color-primary); color: white; border-color: var(--color-primary); font-weight: bold; }
#controls #clearAll { background-color: var(--color-danger); color: white; border-color: var(--color-danger); }
#controls .control-group:last-child { margin-left: auto; } /* ƒê·∫©y n√∫t X√≥a sang ph·∫£i */


h2 {
padding: 0 15px;
margin-top: 25px;
margin-bottom: 15px;
border-bottom: 1px solid #ccc;
padding-bottom: 10px;
}

/* --- 1. ·∫¢nh Chi Ti·∫øt S·∫£n Ph·∫©m --- */
#boxes-container {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 10px;
padding: 0 15px;
}
.box {
position: relative;
border: 2px solid var(--color-unchecked-border);
background-color: var(--color-unchecked);
text-align: center;
aspect-ratio: 1 / 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
border-radius: 5px;
overflow: hidden;
transition: background-color 0.3s, border-color 0.3s;
}
/* L·ªöP .has-photo N√ÄY S·∫º CHUY·ªÇN √î SANG M√ÄU XANH */
.box.has-photo {
background-color: var(--color-checked);
border-color: var(--color-checked-border);
}
.thumbnail { width: 90%; height: 65%; object-fit: cover; cursor: pointer; border: 1px solid #ddd; margin-bottom: 4px; border-radius: 3px; }
.description {
margin: 0;
word-break: break-word;
font-size: 9px;
font-weight: bold;
width: 100%;
padding: 2px 4px;
user-select: text;
}
.description[contenteditable="true"] { cursor: text; background-color: rgba(255, 255, 255, 0.7); }
.add-box-btn, .delete-box-btn { position: absolute; width: 22px; height: 22px; color: white; border: 1px solid white; border-radius: 50%; font-size: 16px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: transform 0.2s; }
.add-box-btn:hover, .delete-box-btn:hover { transform: scale(1.1); }
.add-box-btn { top: -5px; left: -5px; background-color: var(--color-primary); }
.delete-box-btn { top: -5px; right: -5px; background-color: var(--color-danger); line-height: 22px; }

/* --- 2. ·∫¢nh & Video Factory --- */
.factory-controls { padding: 0 15px; display: flex; gap: 10px; margin-bottom: 15px; }
.factory-controls button { flex: 1; padding: 15px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 8px; cursor: pointer; }
#addFactoryPhotoBtn { background-color: var(--color-dark); }
#addFactoryVideoBtn { background-color: #5a2c82; }

#factory-media-container { padding: 0 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
.factory-media-item { position: relative; }
.factory-media-item img, .factory-media-item video { width: 100%; height: auto; display: block; border-radius: 8px; border: 2px solid #ccc; }
.delete-factory-media-btn { position: absolute; top: 5px; right: 5px; background-color: var(--color-danger); z-index: 5;}


/* --- 3. X√°c nh·∫≠n Ki·ªÉm ƒë·ªãnh --- */
#inspection-section { padding: 0 15px; margin-top: 20px; }
.item-code-manager, .inspection-row { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
.item-code-manager h3 { margin-top: 0; }
.item-code-input-group { display: flex; gap: 10px; }
.item-code-input-group input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
.item-code-input-group button { padding: 8px 12px; background: var(--color-primary); color: white; border: none; border-radius: 5px; font-weight: bold; }
#item-codes-display { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
.item-code-tag { background: #e9ecef; padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 8px; }
.item-code-tag button { background: none; border: none; color: var(--color-danger); font-weight: bold; cursor: pointer; padding: 0; line-height: 1; }
.inspection-row h4, .inspection-row h5 { margin-top: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
.inspection-row h4:first-child { margin-top: 0; }
.input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
.input-group label { display: flex; flex-direction: column; flex: 1; min-width: 80px; }
.input-group label span { font-weight: 500; margin-bottom: 3px; color: #555; font-size: 14px; }
.input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
.checkbox-group { display: flex; flex-direction: column; gap: 8px; }
.tick-label { display: block; padding: 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, border-color 0.3s; background-color: var(--color-unchecked); border: 2px solid var(--color-unchecked-border); }
.tick-label.checked { background-color: var(--color-checked); border-color: var(--color-checked-border); }
.tick-label input[type="checkbox"] { display: none; }
.tick-label span { font-size: 14px; }

/* --- AQL Frames Styling --- */
.aql-frame { border: 1px solid #b3e5fc; border-radius: 8px; padding: 15px; margin-top: 15px; background-color: #f1f8ff; position: relative; }
.aql-frame-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.aql-frame-header input { flex-grow: 1; font-weight: bold; font-size: 1.1em; border: none; border-bottom: 1px dashed #03a9f4; background: transparent; padding: 5px;}
.delete-aql-frame-btn { background-color: #ffcdd2; color: #c62828; border: 1px solid #c62828; border-radius: 50%; width: 25px; height: 25px; line-height: 25px; text-align: center; cursor: pointer; font-weight: bold;}
.add-aql-frame-btn { background-color: #0277bd; color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; display: block; width: 100%; margin-top: 15px; }

.defect-photos-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
.defect-photo-item { position: relative; }
.defect-photo-item img { width: 100%; height: auto; border-radius: 5px; }
.add-defect-photo-btn { display: block; width: 100%; margin-top: 15px; padding: 10px; background-color: var(--color-danger); color: white; border: none; border-radius: 5px; font-weight: bold; }
.open-aql-btn { background-color: #ffc107; color: black; padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; }

/* --- 4. ·∫¢nh Ghi Ch√∫ --- */
#note-controls { padding: 0 15px; display: flex; gap: 10px; margin-bottom: 15px; }
#note-controls .file-input-label, #note-controls button { flex: 1; display: block; width: auto; margin: 0; padding: 15px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 8px; cursor: pointer; text-align: center; }
#addNotePhotoBtnLabel { background-color: var(--color-success); }
#noteZipInputLabel { background-color: #ff9800; }

#note-photos-container { padding: 0 15px 15px 15px; display: flex; flex-direction: column; gap: 15px; }
.note-photo-item { position: relative; }
.note-photo-item img { width: 100%; height: auto; max-width: 100%; display: block; border-radius: 8px; border: 2px solid #ccc; }
.delete-note-photo-btn { position: absolute; top: 5px; right: 5px; background-color: var(--color-danger); }

/* --- Ti·ªán √≠ch & Zoom --- */
.hidden { display: none !important; }

/* [S·ª¨A ƒê·ªîI] Overlay ti·∫øn tr√¨nh: kh√¥ng c√≤n ch·∫∑n t∆∞∆°ng t√°c, ch·ªâ l√† m·ªôt thanh bar */
#progress-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.7);
z-index: 9998;
display: none; /* S·∫Ω ƒë∆∞·ª£c ƒë·ªïi th√†nh flex */
justify-content: center;
align-items: center;
flex-direction: column;
color: white;
}
#progress-bar { width: 80%; max-width: 400px; }
#progress-text { margin-top: 10px; font-size: 16px; font-weight: bold; }

/* [M·ªöI] Thanh ti·∫øn tr√¨nh kh√¥ng ch·∫∑n cho video */
#video-progress-container {
position: fixed;
bottom: 0;
left: 0;
width: 100%;
background-color: rgba(0, 0, 0, 0.8);
z-index: 9999;
color: white;
padding: 10px;
box-sizing: border-box;
display: none; /* S·∫Ω ƒë∆∞·ª£c ƒë·ªïi th√†nh block */
text-align: center;
}

#video-progress-bar {
width: 100%;
}


/* [Y√äU C·∫¶U 3] S·ª≠a ƒë·ªïi n√∫t zoom: Di chuy·ªÉn l√™n tr√™n ƒë·ªÉ kh√¥ng che text */
.zoom-icon {
position: absolute;
bottom: 30px; /* Di chuy·ªÉn l√™n tr√™n */
right: 5px;  /* Gi·ªØ nguy√™n ho·∫∑c ƒëi·ªÅu ch·ªânh nh·ªè */
width: 20px;
height: 20px;
background-color: rgba(0, 0, 0, 0.6);
color: white;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
cursor: pointer;
z-index: 5;
border: 1px solid white;
}

/* C·∫£i ti·∫øn Zoom Overlay cho ph√©p vu·ªët/k√©o */
#zoom-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.85);
display: none;
justify-content: center;
align-items: center;
z-index: 10000;
overflow: hidden; /* NgƒÉn cu·ªôn trang ch√≠nh */
touch-action: none; /* Cho ph√©p x·ª≠ l√Ω c·ª≠ ch·ªâ ch·∫°m */
}
#zoom-image {
max-width: 100%; /* ƒê·∫£m b·∫£o v·ª´a m√†n h√¨nh ban ƒë·∫ßu */
max-height: 100%; /* ƒê·∫£m b·∫£o v·ª´a m√†n h√¨nh ban ƒë·∫ßu */
transform-origin: center center;
transition: transform 0.1s ease-out;
cursor: grab;
}
.zoom-close-btn {
position: absolute;
top: 15px;
right: 25px;
color: white;
font-size: 40px;
font-weight: bold;
cursor: pointer;
z-index: 10001; /* Lu√¥n ·ªü tr√™n ·∫£nh */
}


/* --- CSS CHO MODAL AQL --- */
#aql-modal-overlay {
position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1001; display: none; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box;
}
#aql-modal-content { background-color: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
#aql-modal-content h1 { text-align: center; color: #0056b3; margin-top:0; margin-bottom: 25px; font-size: 1.5rem; }
.aql-calculator-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
@media (min-width: 768px) { .aql-calculator-grid { grid-template-columns: 1fr 1.2fr; } }

.aql-input-section, .aql-result-section { padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; }
.aql-input-section h2, .aql-result-section h2 { margin-top: 0; color: #1a73e8; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; font-size: 1.2em; }
.aql-form-group { margin-bottom: 15px; }
.aql-form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
.aql-form-group input, .aql-form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }

.aql-result-summary { display: flex; justify-content: space-around; text-align: center; background-color: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
.aql-result-summary .label { font-size: 0.9em; color: #555; }
.aql-result-summary .value { font-size: 1.4em; font-weight: bold; color: #0056b3; }

.aql-result-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
.aql-result-table th, .aql-result-table td { border: 1px solid #ddd; padding: 10px; text-align: center; }
.aql-result-table th { background-color: #1a73e8; color: white; font-weight: bold; }
.aql-result-table .accept { color: var(--color-success); font-weight: bold; }
.aql-result-table .reject { color: var(--color-danger); font-weight: bold; }

.aql-modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
#aqlApplyBtn { background-color: var(--color-success); color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
#aqlCloseBtn { background-color: var(--color-secondary); color: white; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }


/* --- CSS CHO G∆Ø∆†NG CH·ª§P NHANH --- */
#next-shot-mirror {
position: fixed;
bottom: 20px;
left: 50%;
width: 175px;
height: 175px;
transform-origin: center center;
transform: translateX(-50%) rotate(90deg);
background-color: #ffffff;
border: 3px solid var(--color-primary);
border-radius: 12px;
box-shadow: 0 5px 15px rgba(0,0,0,0.25);
z-index: 2000;
cursor: pointer;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 8px;
box-sizing: border-box;
transition: opacity 0.3s;
}

#next-shot-mirror.hidden {
display: none !important;
}

#next-shot-mirror.disabled {
opacity: 0.3;
pointer-events: none;
}

/* [Y√äU C·∫¶U 2] S·ª≠a ƒë·ªïi v·ªã tr√≠ n√∫t b·∫≠t/t·∫Øt g∆∞∆°ng */
#toggle-mirror-btn {
position: absolute;
top: -5px;
left: -5px; /* ƒê·ªïi t·ª´ right sang left */
width: 28px;
height: 28px;
background-color: #f44336;
color: white;
border: 2px solid white;
border-radius: 50%;
font-size: 14px;
font-weight: bold;
line-height: 24px;
text-align: center;
cursor: pointer;
z-index: 2001;
box-shadow: 0 1px 3px rgba(0,0,0,0.3);
pointer-events: all !important;
}

#next-shot-thumbnail {
width: 90%;
height: 70%;
object-fit: cover;
border: 1px solid #ccc;
border-radius: 5px;
background-color: #f0f0f0;
}

#next-shot-description {
margin: 8px 0 0 0;
font-size: 13px;
font-weight: bold;
color: var(--color-dark);
text-align: center;
width: 100%;
word-break: break-word;
display: -webkit-box;
-webkit-line-clamp: 2;
-webkit-box-orient: vertical;
overflow: hidden;
}

/* --- CSS CHO B·∫¢NG T√çNH SAI S·ªê --- */
#tolerance-modal-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.9);
z-index: 11000; /* Cao h∆°n m·ªçi th·ª© kh√°c */
display: none; /* S·∫Ω ƒë∆∞·ª£c ƒë·ªïi th√†nh flex */
justify-content: center;
align-items: center;
color: white;
flex-direction: row;
gap: 20px;
padding: 20px;
box-sizing: border-box;
}

#tolerance-modal-content {
display: contents; /* ƒê·ªÉ flexbox c·ªßa parent ho·∫°t ƒë·ªông tr·ª±c ti·∫øp l√™n children */
}

#tolerance-photo-container {
flex: 1;
max-width: 45%;
}

#tolerance-photo-container img {
width: 100%;
height: auto;
border-radius: 8px;
border: 2px solid #fff;
}

#tolerance-calculator-container {
flex: 1;
display: flex;
flex-direction: column;
gap: 15px; /* Th√™m kho·∫£ng c√°ch gi·ªØa c√°c ph·∫ßn t·ª≠ */
}

/* [Y√äU C·∫¶U 1] CSS cho √¥ input ch·ªânh s·ª≠a gi√° tr·ªã */
#tolerance-edit-container {
text-align: center;
}
#tolerance-edit-container label {
display: block;
margin-bottom: 5px;
font-weight: bold;
}
#tolerance-value-input {
width: 80%;
padding: 8px;
font-size: 1.2rem;
text-align: center;
border-radius: 5px;
border: 2px solid var(--color-primary);
}


#tolerance-table {
width: 100%;
border-collapse: collapse;
text-align: center;
font-size: 1.2rem;
}

#tolerance-table th, #tolerance-table td {
border: 1px solid #555;
padding: 10px;
}

#tolerance-table th {
background-color: var(--color-primary);
}
#tolerance-table tr:first-child td {
font-weight: bold;
font-size: 1.5rem;
color: #ffeb3b;
}
#tolerance-table tr:nth-child(even) {
background-color: #333;
}
.tolerance-header {
font-weight: bold;
color: #4caf50;
}

#close-tolerance-modal-btn {
position: absolute;
top: 15px;
right: 25px;
color: white;
font-size: 40px;
font-weight: bold;
cursor: pointer;
z-index: 11001;
}

/* ƒêi·ªÅu ch·ªânh cho m√†n h√¨nh d·ªçc */
@media (orientation: portrait) {
#tolerance-modal-overlay {
flex-direction: column;
}
#tolerance-photo-container {
max-width: 80%;
margin-bottom: 20px;
}
}


</style>
</head>
<body>
<!-- Thanh ƒëi·ªÅu khi·ªÉn c·ªë ƒë·ªãnh -->
<div id="controls">
<div class="control-group">
<label for="zipFileInput" class="file-input-label">Nh·∫≠p SP (ZIP/RAR)</label>
<button id="exportZip">Xu·∫•t ZIP</button>
</div>
<div class="control-group">
<button id="undoBtn" disabled title="Ho√†n t√°c">‚Ü∂</button>
<button id="redoBtn" disabled title="L√†m l·∫°i">‚Ü∑</button>
</div>
<div class="control-group">
<button id="scrollToTop" title="Cu·ªôn l√™n ƒë·∫ßu">‚Üë</button>
<button id="scrollToEnd" title="Cu·ªôn xu·ªëng cu·ªëi">‚Üì</button>
</div>
<!-- [Y√äU C·∫¶U 4] N√∫t b·∫≠t/t·∫Øt ch·∫ø ƒë·ªô ƒë·ªëi chi·∫øu -->
<div class="control-group">
<button id="toggleToleranceBtn">ƒê·ªëi chi·∫øu: B·∫≠t</button>
</div>
<div class="control-group">
<button id="clearAll" title="X√≥a t·∫•t c·∫£ d·ªØ li·ªáu">X√≥a T·∫•t C·∫£</button>
</div>
<input type="file" accept=".zip,.rar" id="zipFileInput" class="hidden">
</div>

<!-- Khu v·ª±c hi·ªÉn th·ªã ti·∫øn tr√¨nh (cho c√°c t√°c v·ª• ch·∫∑n) -->
<div id="progress-overlay">
<progress id="progress-bar" value="0" max="100"></progress>
<p id="progress-text">ƒêang x·ª≠ l√Ω...</p>
</div>

<!-- Thanh ti·∫øn tr√¨nh kh√¥ng ch·∫∑n cho video -->
<div id="video-progress-container">
<p id="video-progress-text">ƒêang n√©n video...</p>
<progress id="video-progress-bar" value="0" max="100"></progress>
</div>


<!-- Modal Ph√≥ng to ·∫¢nh -->
<div id="zoom-overlay">
<span class="zoom-close-btn">&times;</span>
<img id="zoom-image" src="" alt="Zoomed Image">
</div>

<!-- 1. ·∫¢nh Chi Ti·∫øt S·∫£n Ph·∫©m -->
<h2>1. ·∫¢nh Chi Ti·∫øt S·∫£n Ph·∫©m</h2>
<div id="boxes-container"></div>

<!-- 2. ·∫¢nh & Video Factory -->
<h2>2. ·∫¢nh & Video Factory</h2>
<div class="factory-controls">
<button id="addFactoryPhotoBtn">Th√™m ·∫¢nh Factory</button>
<button id="addFactoryVideoBtn">Quay Video Factory</button>
</div>
<div id="factory-media-container"></div>
<input type="file" id="factoryPhotoInput" multiple accept="image/*" capture="camera" class="hidden">
<input type="file" id="factoryVideoInput" accept="video/*" capture="user" class="hidden">

<!-- 3. X√°c Nh·∫≠n Ki·ªÉm ƒê·ªãnh -->
<h2>3. X√°c Nh·∫≠n Ki·ªÉm ƒê·ªãnh</h2>
<section id="inspection-section">
<div class="item-code-manager">
<h3>C√°c M√£ H√†ng Ki·ªÉm Tra</h3>
<div class="item-code-input-group">
<input type="text" id="itemCodeInput" placeholder="Nh·∫≠p t√™n m√£ h√†ng...">
<button id="addItemCodeBtn">+</button>
</div>
<div id="item-codes-display"></div>
</div>
<div id="inspection-rows-container"></div>
</section>

<!-- 4. ·∫¢nh Ghi Ch√∫ -->
<h2>4. ·∫¢nh Ghi Ch√∫</h2>
<div id="note-controls">
<label id="addNotePhotoBtnLabel" for="notePhotoInput" class="file-input-label">Th√™m ·∫¢nh Ghi Ch√∫</label>
<label id="noteZipInputLabel" for="noteZipInput" class="file-input-label">Import Ghi Ch√∫ (ZIP/RAR)</label>
</div>
<div id="note-photos-container"></div>
<input type="file" id="notePhotoInput" multiple accept="image/*" class="hidden">
<input type="file" id="noteZipInput" accept=".zip,.rar" class="hidden">


<!-- MODAL T√çNH AQL -->
<div id="aql-modal-overlay">
<div id="aql-modal-content">
<h1>C√¥ng C·ª• T√≠nh Ti√™u Chu·∫©n AQL</h1>
<div class="aql-calculator-grid">
<div class="aql-input-section">
<h2>Th√¥ng s·ªë ƒë·∫ßu v√†o</h2>
<div class="aql-form-group">
<label for="aqlOrderQuantity">S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng (Order Quantity):</label>
<input type="number" id="aqlOrderQuantity" value="1000" min="2">
</div>
<div class="aql-form-group">
<label for="aqlInspectionLevel">C·∫•p ƒë·ªô ki·ªÉm tra (Inspection Level):</label>
<select id="aqlInspectionLevel">
<option value="I">General Inspection I</option>
<option value="II" selected>General Inspection II</option>
<option value="III">General Inspection III</option>
<option value="S-1">Special Inspection S-1</option>
<option value="S-2">Special Inspection S-2</option>
<option value="S-3">Special Inspection S-3</option>
<option value="S-4">Special Inspection S-4</option>
</select>
</div>
<div class="aql-form-group">
<label for="aqlMajor">L·ªói n·∫∑ng (Major Defects):</label>
<select id="aqlMajor">
<option value="2.5" selected>AQL 2.5</option>
<option value="0.065">AQL 0.065</option><option value="0.10">AQL 0.10</option><option value="0.15">AQL 0.15</option><option value="0.25">AQL 0.25</option><option value="0.40">AQL 0.40</option><option value="0.65">AQL 0.65</option><option value="1.0">AQL 1.0</option><option value="1.5">AQL 1.5</option><option value="4.0">AQL 4.0</option><option value="6.5">AQL 6.5</option>
</select>
</div>
<div class="aql-form-group">
<label for="aqlMinor">L·ªói nh·∫π (Minor Defects):</label>
<select id="aqlMinor">
<option value="4.0" selected>AQL 4.0</option>
<option value="0.065">AQL 0.065</option><option value="0.10">AQL 0.10</option><option value="0.15">AQL 0.15</option><option value="0.25">AQL 0.25</option><option value="0.40">AQL 0.40</option><option value="0.65">AQL 0.65</option><option value="1.0">AQL 1.0</option><option value="1.5">AQL 1.5</option><option value="2.5">AQL 2.5</option><option value="6.5">AQL 6.5</option>
</select>
</div>
</div>
<div class="aql-result-section">
<h2>K·∫øt qu·∫£ ki·ªÉm tra</h2>
<div class="aql-result-summary">
<div>
<div class="label">M√£ C·ª° M·∫´u</div>
<div class="value" id="aql-result-code-letter">J</div>
</div>
<div>
<div class="label">C·ª° M·∫´u (S·ªë l∆∞·ª£ng)</div>
<div class="value" id="aql-result-sample-size">80</div>
</div>
</div>
<table class="aql-result-table">
<thead><tr><th>Lo·∫°i l·ªói</th><th>M·ª©c AQL</th><th>Ch·∫•p nh·∫≠n (Ac)</th><th>T·ª´ ch·ªëi (Re)</th></tr></thead>
<tbody>
<tr><td>L·ªói n·∫∑ng</td><td id="aql-major-aql-result">2.5</td><td class="accept" id="aql-major-ac">5</td><td class="reject" id="aql-major-re">6</td></tr>
<tr><td>L·ªói nh·∫π</td><td id="aql-minor-aql-result">4.0</td><td class="accept" id="aql-minor-ac">7</td><td class="reject" id="aql-minor-re">8</td></tr>
</tbody>
</table>
</div>
</div>
<div class="aql-modal-actions">
<button id="aqlCloseBtn">ƒê√≥ng</button>
<button id="aqlApplyBtn">√Åp d·ª•ng & ƒê√≥ng</button>
</div>
</div>
</div>

<!-- HTML C·ª¶A G∆Ø∆†NG CH·ª§P NHANH -->
<div id="next-shot-mirror" class="hidden">
<!-- [Y√äU C·∫¶U 2] N√∫t b·∫≠t/t·∫Øt g∆∞∆°ng ƒë√£ ƒë·ªïi v·ªã tr√≠ -->
<div id="toggle-mirror-btn" title="·∫®n/Hi·ªán G∆∞∆°ng">üëÅ</div>
<img id="next-shot-thumbnail" src="" alt="Next Shot Thumbnail">
<p id="next-shot-description"></p>
</div>

<!-- HTML CHO B·∫¢NG T√çNH SAI S·ªê -->
<div id="tolerance-modal-overlay">
<span id="close-tolerance-modal-btn">&times;</span>
<div id="tolerance-modal-content">
<div id="tolerance-photo-container">
<img id="tolerance-photo" src="" alt="·∫¢nh ƒëo l∆∞·ªùng">
</div>
<div id="tolerance-calculator-container">
<!-- [Y√äU C·∫¶U 1] Th√™m √¥ input ƒë·ªÉ ch·ªânh s·ª≠a gi√° tr·ªã -->
<div id="tolerance-edit-container">
<label for="tolerance-value-input">Ch·ªânh s·ª≠a gi√° tr·ªã ƒëo:</label>
<input type="text" id="tolerance-value-input">
</div>
<table id="tolerance-table">
<thead>
<tr>
<th>Ti√™u chu·∫©n</th>
<th>-</th>
<th>+</th>
</tr>
</thead>
<tbody id="tolerance-table-body">
<!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JS -->
</tbody>
</table>
</div>
</div>
</div>


<script>
// --- C√ÄI ƒê·∫∂T C∆† S·ªû D·ªÆ LI·ªÜU & C√ÅC BI·∫æN TO√ÄN C·ª§C ---
function getUniqueFileId() {
const path = window.location.pathname;
return path.replace(/[^a-zA-Z0-9]/g, '_');
}
const UNIQUE_ID = getUniqueFileId();
const DB_NAME = `QCAppDB_${UNIQUE_ID}`;
const DB_VERSION = 1;
const STORE_STATE = 'appState';
const STATE_KEY = 'currentState';
let db;

let historyStack = [];
let historyIndex = -1;
let isRestoringState = false;

// [Y√äU C·∫¶U 4] Bi·∫øn tr·∫°ng th√°i cho ch·∫ø ƒë·ªô ƒë·ªëi chi·∫øu
let isToleranceModeActive = true;
// [Y√äU C·∫¶U 1] Bi·∫øn l∆∞u tr·ªØ box ngu·ªìn cho modal ƒë·ªëi chi·∫øu
let currentToleranceSourceBox = null;


// --- C√ÅC H√ÄM TI·ªÜN √çCH ---
function compressImage(file, maxSizeKB = 500) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = event => {
const img = new Image();
img.src = event.target.result;
img.onload = () => {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
let width = img.width;
let height = img.height;
const max_dim = 1280;

if (width > height) {
if (width > max_dim) { height *= max_dim / width; width = max_dim; }
} else {
if (height > max_dim) { width *= max_dim / height; height = max_dim; }
}
canvas.width = width;
canvas.height = height;
ctx.drawImage(img, 0, 0, width, height);
canvas.toBlob(blob => {
if (blob.size / 1024 > maxSizeKB) {
canvas.toBlob(resolve, 'image/jpeg', 0.7);
} else {
resolve(blob);
}
}, 'image/jpeg', 0.85);
};
img.onerror = reject;
};
reader.onerror = reject;
});
}

function showProgress(text, value, max) {
const overlay = document.getElementById('progress-overlay');
const bar = document.getElementById('progress-bar');
const p = document.getElementById('progress-text');
overlay.style.display = 'flex';
p.textContent = text;
if (max !== undefined) {
bar.value = value;
bar.max = max;
} else {
bar.removeAttribute('value');
}
}

function hideProgress() {
document.getElementById('progress-overlay').style.display = 'none';
}

function blobToDataURL(blob) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = () => resolve(reader.result);
reader.onerror = reject;
reader.readAsDataURL(blob);
});
}

// --- QU·∫¢N L√ù L·ªäCH S·ª¨ (UNDO/REDO) ---
function updateHistoryButtons() {
document.getElementById('undoBtn').disabled = historyIndex <= 0;
document.getElementById('redoBtn').disabled = historyIndex >= historyStack.length - 1;
}

function captureState() {
if (isRestoringState) return;
clearTimeout(window.captureTimeout);
window.captureTimeout = setTimeout(() => {
const state = getCurrentState();
if (historyIndex < historyStack.length - 1) {
historyStack = historyStack.slice(0, historyIndex + 1);
}
historyStack.push(state);
historyIndex++;
updateHistoryButtons();
saveStateToDB(state);
}, 500);
}


// --- LOGIC C∆† S·ªû D·ªÆ LI·ªÜU (INDEXEDDB) ---
function initDB() {
return new Promise((resolve, reject) => {
const request = indexedDB.open(DB_NAME, DB_VERSION);
request.onupgradeneeded = event => {
const db = event.target.result;
if (!db.objectStoreNames.contains(STORE_STATE)) {
db.createObjectStore(STORE_STATE);
}
};
request.onsuccess = event => { db = event.target.result; resolve(db); };
request.onerror = event => { console.error("L·ªói DB:", event.target.error); reject(event.target.error); };
});
}

function saveStateToDB(state) {
if (!db || !state) return;
try {
const transaction = db.transaction([STORE_STATE], 'readwrite');
transaction.objectStore(STORE_STATE).put(state, STATE_KEY);
} catch (e) {
console.error("Kh√¥ng th·ªÉ l∆∞u tr·∫°ng th√°i:", e);
}
}

function loadStateFromDB() {
return new Promise((resolve) => {
if (!db) { resolve(); return; }
const transaction = db.transaction([STORE_STATE], 'readonly');
const request = transaction.objectStore(STORE_STATE).get(STATE_KEY);
request.onsuccess = async (event) => {
const savedState = event.target.result;
if (savedState) {
historyStack = [savedState];
historyIndex = 0;
await rebuildUI(savedState);
updateHistoryButtons();
}
resolve();
};
request.onerror = () => resolve();
});
}

function resetApplicationState() {
document.getElementById('boxes-container').innerHTML = '';
document.getElementById('factory-media-container').innerHTML = '';
document.getElementById('note-photos-container').innerHTML = '';
document.getElementById('item-codes-display').innerHTML = '';
document.getElementById('inspection-rows-container').innerHTML = '';
document.getElementById('itemCodeInput').value = '';

historyStack = [];
historyIndex = -1;

captureState();
}

// --- THU TH·∫¨P & T√ÅI T·∫†O GIAO DI·ªÜN ---
function getCurrentState() {
const detailPhotos = Array.from(document.querySelectorAll('#boxes-container .box')).map(box => ({
id: box.id,
baseDescription: box.dataset.baseDescription,
imageBlob: box.imageBlob || null,
isCameraCaptured: box.dataset.isCameraCaptured === 'true'
}));

const factoryMedia = Array.from(document.querySelectorAll('.factory-media-item')).map(item => ({
id: item.id,
mediaBlob: item.mediaBlob || null,
type: item.dataset.type
}));

const notePhotos = Array.from(document.querySelectorAll('.note-photo-item')).map(item => ({
id: item.id,
imageBlob: item.imageBlob || null
}));

const itemCodes = Array.from(document.querySelectorAll('.item-code-tag')).map(tag => tag.dataset.code);
const inspectionData = {};
itemCodes.forEach(code => {
const row = document.querySelector(`.inspection-row[data-code="${code}"]`);
if (!row) return;

const inputs = {};
row.querySelectorAll('.main-inputs input[type="text"], .main-inputs input[type="number"]').forEach(input => {
inputs[input.name] = input.value;
});

const checkboxes = {};
row.querySelectorAll('input[type="checkbox"]').forEach(checkbox => { checkboxes[checkbox.name] = checkbox.checked; });

const defectPhotos = Array.from(row.querySelectorAll('.defect-photo-item')).map(item => ({ imageBlob: item.imageBlob }));

const aqlFrames = Array.from(row.querySelectorAll('.aql-frame')).map(frame => ({
description: frame.querySelector('.aql-test-description').value,
orderQty: frame.dataset.orderQty || '',
sampleSize: frame.querySelector('input[name="aql_check_qty"]').value,
majorAc: frame.querySelector('input[name="major_standard"]').value,
minorAc: frame.querySelector('input[name="minor_standard"]').value,
inspectionLevel: frame.dataset.inspectionLevel,
majorAql: frame.dataset.majorAql,
minorAql: frame.dataset.minorAql
}));

inspectionData[code] = { inputs, checkboxes, defectPhotos, aqlFrames };
});

return { detailPhotos, factoryMedia, notePhotos, itemCodes, inspectionData };
}

async function rebuildUI(state) {
isRestoringState = true;
document.getElementById('boxes-container').innerHTML = '';
document.getElementById('factory-media-container').innerHTML = '';
document.getElementById('note-photos-container').innerHTML = '';
document.getElementById('item-codes-display').innerHTML = '';
document.getElementById('inspection-rows-container').innerHTML = '';

if (state.detailPhotos) {
for (const data of state.detailPhotos) {
const box = createDetailBox(data.baseDescription, data.id);
if (data.imageBlob) {
box.imageBlob = data.imageBlob;
if (data.isCameraCaptured) {
box.dataset.isCameraCaptured = 'true';
}
}
updateBoxAppearance(box);
document.getElementById('boxes-container').appendChild(box);
}
}
renumberDetailBoxes();

if (state.factoryMedia) {
for (const data of state.factoryMedia) {
if(data.mediaBlob) {
const item = await createFactoryMediaItem(data.mediaBlob, data.type, data.id);
document.getElementById('factory-media-container').appendChild(item);
}
}
}

if (state.notePhotos) {
for (const data of state.notePhotos) {
if (data.imageBlob) {
const item = await createNotePhotoItem(data.imageBlob, data.id);
document.getElementById('note-photos-container').appendChild(item);
}
}
}

if (state.itemCodes) {
for (const code of state.itemCodes) {
createItemCodeTag(code);
const data = state.inspectionData[code] || {};
createInspectionRow(code, data);
}
}
isRestoringState = false;
updateNextShotMirror();
}

// --- C√ÅC H√ÄM T·∫†O PH·∫¶N T·ª¨ GIAO DI·ªÜN ---

function updateBoxAppearance(box) {
const thumbnail = box.querySelector('.thumbnail');
if (!thumbnail) return;

if (box.dataset.isCameraCaptured === 'true') {
box.classList.add('has-photo');
} else {
box.classList.remove('has-photo');
}

if (box.imageBlob && box.imageBlob.size > 0) {
blobToDataURL(box.imageBlob)
.then(url => { thumbnail.src = url; })
.catch(err => console.error("L·ªói chuy·ªÉn blob th√†nh URL:", err));
} else {
thumbnail.src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
}
}


function createDetailBox(baseDescription, id = `box-${Date.now()}`) {
const box = document.createElement('div');
box.className = 'box';
box.id = id;
box.dataset.baseDescription = baseDescription;
box.imageBlob = null;

const addButton = document.createElement('div');
addButton.className = 'add-box-btn';
addButton.textContent = '+';
addButton.onclick = (e) => { e.stopPropagation(); const newBox = createDetailBox("M√¥ t·∫£ m·ªõi"); box.insertAdjacentElement('afterend', newBox); renumberDetailBoxes(); captureState(); };
box.appendChild(addButton);

const deleteButton = document.createElement('div');
deleteButton.className = 'delete-box-btn';
deleteButton.innerHTML = '&times;';
deleteButton.onclick = (e) => { e.stopPropagation(); if (confirm('X√≥a √¥ ·∫£nh n√†y?')) { box.remove(); renumberDetailBoxes(); captureState(); } };
box.appendChild(deleteButton);

const thumbnail = document.createElement('img');
thumbnail.className = 'thumbnail';
box.appendChild(thumbnail);

const p = document.createElement('p');
p.className = 'description';
p.textContent = baseDescription;
p.contentEditable = true;
p.onblur = () => { const newDesc = p.textContent.replace(/^\d+\.?\s*/, ''); box.dataset.baseDescription = newDesc; renumberDetailBoxes(); captureState(); };
p.onkeydown = e => { if (e.key === 'Enter') { e.preventDefault(); p.blur(); } };
box.appendChild(p);

const zoomIcon = document.createElement('div');
zoomIcon.className = 'zoom-icon';
zoomIcon.innerHTML = '&#128269;';
zoomIcon.onclick = (e) => { e.stopPropagation(); if(box.imageBlob) showZoom(thumbnail.src); };
box.appendChild(zoomIcon);

const input = document.createElement('input');
input.type = 'file'; input.accept = 'image/*'; input.capture = 'camera'; input.className = 'hidden';

input.onchange = async () => {
const file = input.files[0];
if (!file) return;
showProgress('ƒêang n√©n ·∫£nh...', 0, 1);
try {
const compressedBlob = await compressImage(file);
box.imageBlob = compressedBlob;
box.dataset.isCameraCaptured = 'true';

updateBoxAppearance(box);
captureState();
updateNextShotMirror();

// [Y√äU C·∫¶U 1 & 4] Ki·ªÉm tra v√† hi·ªÉn th·ªã b·∫£ng t√≠nh sai s·ªë (n·∫øu ch·∫ø ƒë·ªô ƒë∆∞·ª£c b·∫≠t)
const fullDescription = box.querySelector('.description').textContent;
const measurementRegex = /(\d+\.?\d*)\s*(cm|mm|kg|g|s|m)\b/i;
const match = fullDescription.match(measurementRegex);

if (isToleranceModeActive && match) {
const value = parseFloat(match[1]);
const unit = match[2];
showToleranceCalculator(value, unit, compressedBlob, box);
}

} catch (error) { console.error("L·ªói n√©n ·∫£nh:", error); }
finally {
hideProgress();
}
};
box.appendChild(input);
thumbnail.onclick = () => input.click();

updateBoxAppearance(box);

return box;
}

function renumberDetailBoxes() {
document.querySelectorAll('#boxes-container .box').forEach((box, index) => {
const p = box.querySelector('.description');
if (p) {
p.textContent = `${index + 1}. ${box.dataset.baseDescription}`;
}
});
updateNextShotMirror();
}

async function createFactoryMediaItem(mediaBlob, type, id = `factory-${Date.now()}`) {
const item = document.createElement('div');
item.className = 'factory-media-item';
item.id = id;
item.mediaBlob = mediaBlob;
item.dataset.type = type;

const mediaURL = URL.createObjectURL(mediaBlob);
let mediaElement;

if (type === 'image') {
mediaElement = document.createElement('img');
mediaElement.src = mediaURL;
} else { // video
mediaElement = document.createElement('video');
mediaElement.src = mediaURL;
mediaElement.controls = true;
mediaElement.playsInline = true;
mediaElement.muted = true; // Video kh√¥ng c√≥ √¢m thanh nh∆∞ng ƒë·ªÉ thu·ªôc t√≠nh n√†y cho ch·∫Øc
}
item.appendChild(mediaElement);

const deleteBtn = document.createElement('div');
deleteBtn.className = 'delete-box-btn delete-factory-media-btn';
deleteBtn.innerHTML = '&times;';
deleteBtn.onclick = (e) => { e.stopPropagation(); if(confirm(`X√≥a ${type === 'image' ? '·∫£nh' : 'video'} n√†y?`)) { item.remove(); captureState(); URL.revokeObjectURL(mediaURL); } };
item.appendChild(deleteBtn);

if (type === 'image') {
const zoomIcon = document.createElement('div');
zoomIcon.className = 'zoom-icon';
zoomIcon.innerHTML = '&#128269;';
zoomIcon.onclick = (e) => { e.stopPropagation(); showZoom(mediaElement.src); };
item.appendChild(zoomIcon);
}

return item;
}

async function createNotePhotoItem(imageBlob, id = `note-${Date.now()}`) {
const item = document.createElement('div');
item.className = 'note-photo-item';
item.id = id;
item.imageBlob = imageBlob;
const img = document.createElement('img');
img.src = await blobToDataURL(imageBlob);
item.appendChild(img);

const deleteBtn = document.createElement('div');
deleteBtn.className = 'delete-box-btn delete-note-photo-btn';
deleteBtn.innerHTML = '&times;';
deleteBtn.onclick = (e) => { e.stopPropagation(); if(confirm('X√≥a ·∫£nh ghi ch√∫ n√†y?')) { item.remove(); captureState(); } };
item.appendChild(deleteBtn);

const zoomIcon = document.createElement('div');
zoomIcon.className = 'zoom-icon';
zoomIcon.innerHTML = '&#128269;';
zoomIcon.onclick = (e) => { e.stopPropagation(); showZoom(img.src); };
item.appendChild(zoomIcon);

return item;
}

async function createDefectPhotoItem(imageBlob) {
const item = document.createElement('div');
item.className = 'defect-photo-item';
item.imageBlob = imageBlob;
const img = document.createElement('img');
img.src = await blobToDataURL(imageBlob);
item.appendChild(img);
const deleteBtn = document.createElement('div');
deleteBtn.className = 'delete-box-btn';
deleteBtn.innerHTML = '&times;';
deleteBtn.onclick = (e) => { e.stopPropagation(); if(confirm('X√≥a ·∫£nh l·ªói n√†y?')) { item.remove(); captureState(); } };
item.appendChild(deleteBtn);

const zoomIcon = document.createElement('div');
zoomIcon.className = 'zoom-icon';
zoomIcon.innerHTML = '&#128269;';
zoomIcon.onclick = (e) => { e.stopPropagation(); showZoom(img.src); };
item.appendChild(zoomIcon);

return item;
}

function createItemCodeTag(code) {
const display = document.getElementById('item-codes-display');
const tag = document.createElement('div');
tag.className = 'item-code-tag';
tag.dataset.code = code;
tag.textContent = code;
const removeBtn = document.createElement('button');
removeBtn.innerHTML = '&times;';
removeBtn.onclick = () => {
if (confirm(`X√≥a m√£ h√†ng "${code}" v√† to√†n b·ªô d·ªØ li·ªáu li√™n quan?`)) {
tag.remove();
document.querySelector(`.inspection-row[data-code="${code}"]`)?.remove();
captureState();
}
};
tag.appendChild(removeBtn);
display.appendChild(tag);
}

function createAqlFrameHTML(data = {}) {
const description = data.description || "Ki·ªÉm tra ngo·∫°i quan";
const sampleSize = data.sampleSize || "";
const majorAc = data.majorAc || "";
const minorAc = data.minorAc || "";
const orderQty = data.orderQty || "";
const datasetAttributes = [
'inspectionLevel', 'majorAql', 'minorAql'
].map(key => data[key] ? `data-${key.toLowerCase()}="${data[key]}"` : '').join(' ');

return `
<div class="aql-frame" data-orderqty="${orderQty}" ${datasetAttributes}>
<div class="aql-frame-header">
<input type="text" class="aql-test-description" placeholder="M√¥ t·∫£ b√†i test AQL..." value="${description}">
<button class="delete-aql-frame-btn" title="X√≥a b√†i test n√†y">&times;</button>
</div>
<div class="input-group">
<label><span>S·ªë l∆∞·ª£ng ki·ªÉm</span><input type="number" name="aql_check_qty" value="${sampleSize}" readonly></label>
<label><span>Major (Ac)</span><input type="number" name="major_standard" value="${majorAc}" readonly></label>
<label><span>Minor (Ac)</span><input type="number" name="minor_standard" value="${minorAc}" readonly></label>
</div>
<button class="open-aql-btn">M·ªü C√¥ng c·ª• t√≠nh AQL</button>
</div>`;
}


function createInspectionRow(code, data = {}) {
const container = document.getElementById('inspection-rows-container');
const row = document.createElement('div');
row.className = 'inspection-row';
row.dataset.code = code;

row.innerHTML = `
<h4>M√£ h√†ng: ${code}</h4>
<div class="main-inputs">
<h5>Th√¥ng tin s·ªë l∆∞·ª£ng</h5>
<div class="input-group">
<label><span>ƒê√≥ng g√≥i (TT)</span><input type="number" name="pack_qty_actual" placeholder="Th·ª±c t·∫ø" value="${data.inputs?.pack_qty_actual || ''}"></label>
<label><span>S·∫£n ph·∫©m (TT)</span><input type="number" name="prod_qty_actual" placeholder="Th·ª±c t·∫ø" value="${data.inputs?.prod_qty_actual || ''}"></label>
<label><span>S·∫£n ph·∫©m (TC)</span><input type="number" name="prod_qty_standard" placeholder="Ti√™u chu·∫©n" value="${data.inputs?.prod_qty_standard || ''}"></label>
</div>
</div>

<h5>Ti√™u chu·∫©n AQL</h5>
<div class="aql-frames-container"></div>
<button class="add-aql-frame-btn">+ Th√™m B√†i Test AQL</button>

<h5 style="margin-top: 20px;">T√¨nh tr·∫°ng ki·ªÉm tra</h5>
<div class="checkbox-group">
${['has_sample', 'pass_style', 'pass_workmanship', 'pass_packing', 'pass_marking', 'pass_measurement', 'pass_special']
.map(name => {
const labels = {
has_sample: 'C√≥ Sample',
pass_style: 'PASS: Ki·ªÉu d√°ng, ch·∫•t li·ªáu, m√†u s·∫Øc',
pass_workmanship: 'PASS: Tay ngh·ªÅ/Ngo·∫°i quan/Ch·ª©c nƒÉng',
pass_packing: 'PASS: ƒê√≥ng g√≥i',
pass_marking: 'PASS: Ghi nh√£n/M√°c',
pass_measurement: 'PASS: ƒêo l∆∞·ªùng/Ki·ªÉm tra th·ª±c ƒë·ªãa',
pass_special: 'PASS: Y√™u c·∫ßu ƒë·∫∑c bi·ªát c·ªßa kh√°ch h√†ng'
};
const isChecked = data.checkboxes?.[name] || false;
return `<label class="tick-label ${isChecked ? 'checked' : ''}"><input type="checkbox" name="${name}" ${isChecked ? 'checked' : ''}><span>${labels[name]}</span></label>`;
}).join('')}
</div>

<h5>·∫¢nh L·ªói (${code})</h5>
<div class="defect-photos-container"></div>
<button class="add-defect-photo-btn">Ch·ª•p ·∫¢nh L·ªói</button>
<input type="file" class="hidden-defect-input" multiple accept="image/*" capture="camera" class="hidden">
`;

const actualProdQtyInput = row.querySelector('input[name="prod_qty_actual"]');
actualProdQtyInput.addEventListener('input', (e) => {
const newQty = e.target.value;
const aqlFrames = row.querySelectorAll('.aql-frame');
aqlFrames.forEach(frame => {
frame.dataset.orderqty = newQty;
});
captureState();
});


const aqlContainer = row.querySelector('.aql-frames-container');
if (data.aqlFrames && data.aqlFrames.length > 0) {
data.aqlFrames.forEach(frameData => {
if (!frameData.orderQty && data.inputs?.prod_qty_actual) {
frameData.orderQty = data.inputs.prod_qty_actual;
}
aqlContainer.innerHTML += createAqlFrameHTML(frameData);
});
} else {
const defaultOrderQty = data.inputs?.prod_qty_actual || '';
aqlContainer.innerHTML += createAqlFrameHTML({ orderQty: defaultOrderQty });
}

row.querySelectorAll('input, select').forEach(input => {
input.addEventListener('input', captureState);
if (input.type === 'checkbox') {
input.addEventListener('change', () => {
input.parentElement.classList.toggle('checked', input.checked);
captureState();
});
}
});

aqlContainer.addEventListener('click', e => {
if (e.target.classList.contains('open-aql-btn')) {
const frame = e.target.closest('.aql-frame');
openAqlModal(frame);
}
if (e.target.classList.contains('delete-aql-frame-btn')) {
if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i test AQL n√†y?")) {
e.target.closest('.aql-frame').remove();
captureState();
}
}
});
aqlContainer.addEventListener('input', e => {
if (e.target.classList.contains('aql-test-description')) {
captureState();
}
});

row.querySelector('.add-aql-frame-btn').addEventListener('click', () => {
const currentOrderQty = row.querySelector('input[name="prod_qty_actual"]')?.value || '';
const newFrameHTML = createAqlFrameHTML({description: "", orderQty: currentOrderQty});
aqlContainer.insertAdjacentHTML('beforeend', newFrameHTML);
captureState();
});

const defectPhotoInput = row.querySelector('.hidden-defect-input');
const defectContainer = row.querySelector('.defect-photos-container');
row.querySelector('.add-defect-photo-btn').addEventListener('click', () => defectPhotoInput.click());

defectPhotoInput.addEventListener('change', async function() {
if (this.files.length === 0) return;
const files = Array.from(this.files);
this.value = '';
showProgress(`ƒêang x·ª≠ l√Ω ${files.length} ·∫£nh l·ªói...`, 0, files.length);
for(const file of files) {
try {
const item = await createDefectPhotoItem(await compressImage(file));
defectContainer.appendChild(item);
} catch(err) { console.error("L·ªói x·ª≠ l√Ω ·∫£nh l·ªói:", err); }
}
hideProgress();
captureState();
});

if (data.defectPhotos) {
data.defectPhotos.forEach(async photoData => {
if (photoData.imageBlob) {
const defectItem = await createDefectPhotoItem(photoData.imageBlob);
defectContainer.appendChild(defectItem);
}
});
}

container.appendChild(row);
}


// --- XU·∫§T ZIP & C√ÅC S·ª∞ KI·ªÜN CH√çNH ---
async function exportAllDataAsZip() {
showProgress("ƒêang chu·∫©n b·ªã d·ªØ li·ªáu...", 0, 100);
const zip = new JSZip();
const today = new Date();
const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
const reportName = `Bao_Cao_Kiem_Dinh_${dateString}`;
const mainFolder = zip.folder(reportName);

const currentState = getCurrentState();

if (currentState.detailPhotos.length > 0) {
const detailPhotosFolder = mainFolder.folder("1_Anh_Chi_Tiet");
for (const [index, photo] of currentState.detailPhotos.entries()) {
if (photo.imageBlob) {
const filename = `${index + 1}. ${photo.baseDescription}.jpg`;
detailPhotosFolder.file(filename, photo.imageBlob);
}
}
}

if (currentState.factoryMedia.length > 0) {
const factoryFolder = mainFolder.folder("2_Anh_Video_Factory");
for (const [i, media] of currentState.factoryMedia.entries()) {
if (media.mediaBlob) {
const extension = media.type === 'image' ? '.jpg' : '.mp4';
factoryFolder.file(`factory-media-${i + 1}${extension}`, media.mediaBlob);
}
}
}

// ... (ph·∫ßn t·∫°o report text gi·ªØ nguy√™n)

zip.generateAsync({ type: "blob" }, (metadata) => {
showProgress(`ƒêang n√©n t·ªáp ZIP... ${metadata.percent.toFixed(0)}%`, metadata.percent, 100);
}).then(content => {
const link = document.createElement('a');
link.href = URL.createObjectURL(content);
link.download = `${reportName}.zip`;
document.body.appendChild(link);
link.click();
document.body.removeChild(link);
URL.revokeObjectURL(link.href);
hideProgress();
}).catch(err => {
console.error("L·ªói t·∫°o ZIP:", err);
hideProgress();
});
}

async function handleArchiveInput(file, targetContainerId) {
if (!file) return;

const isZip = file.name.toLowerCase().endsWith('.zip');
const isRar = file.name.toLowerCase().endsWith('.rar');

if (!isZip && !isRar) {
alert("Ch·ªâ h·ªó tr·ª£ file .zip v√† .rar");
return;
}

if (targetContainerId === 'boxes-container') {
if (!confirm("T·∫£i t·ªáp m·ªõi s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) {
return;
}
resetApplicationState();
}

showProgress("ƒêang ƒë·ªçc t·ªáp...", 0, 100);
let imageEntries = [];

try {
if (isZip) {
const zip = await JSZip.loadAsync(file);
const filePromises = [];
zip.forEach((relativePath, zipEntry) => {
if (!zipEntry.dir && /\.(jpe?g|png|gif|webp)$/i.test(zipEntry.name)) {
filePromises.push(
zipEntry.async('blob').then(blob => ({
name: zipEntry.name,
blob: blob
}))
);
}
});
imageEntries = await Promise.all(filePromises);
} else { // isRar
const rarBuffer = await file.arrayBuffer();
const extractor = await unrar.createExtractorFromData({ data: rarBuffer });
const rarFiles = extractor.extract().files;
imageEntries = rarFiles
.filter(f => !f.dir && /\.(jpe?g|png|gif|webp)$/i.test(f.name))
.map(f => ({
name: f.name,
blob: new Blob([f.extraction])
}));
}

if (imageEntries.length === 0) {
alert("Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o trong t·ªáp.");
hideProgress();
return;
}

imageEntries.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

let processedFiles = 0;
for (const entry of imageEntries) {
showProgress(`ƒêang x·ª≠ l√Ω ·∫£nh ${processedFiles + 1}/${imageEntries.length}...`, processedFiles, imageEntries.length);
const compressedBlob = await compressImage(entry.blob);

if (targetContainerId === 'boxes-container') {
const baseDescription = entry.name.split('/').pop().replace(/\.[^/.]+$/, "").replace(/^\d+\.?\s*/, '');
const box = createDetailBox(baseDescription, `box-${Date.now()}-${processedFiles}`);
box.imageBlob = compressedBlob;
updateBoxAppearance(box);
document.getElementById('boxes-container').appendChild(box);
} else if (targetContainerId === 'note-photos-container') {
const item = await createNotePhotoItem(compressedBlob);
document.getElementById('note-photos-container').appendChild(item);
}
processedFiles++;
}
if (targetContainerId === 'boxes-container') {
renumberDetailBoxes();
}
} catch (err) {
console.error("L·ªói x·ª≠ l√Ω t·ªáp:", err);
alert("L·ªói khi ƒë·ªçc file. File c√≥ th·ªÉ b·ªã h·ªèng ho·∫∑c kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£.");
} finally {
hideProgress();
captureState();
}
}


// --- G·∫ÆN S·ª∞ KI·ªÜN KHI TRANG T·∫¢I XONG ---
document.addEventListener('DOMContentLoaded', async () => {
try {
await initDB();
await loadStateFromDB();

if (document.getElementById('boxes-container').children.length === 0) {
const initialBox = createDetailBox("·∫¢nh T·ªïng Quan 1");
document.getElementById('boxes-container').appendChild(initialBox);
renumberDetailBoxes();
}

if(historyStack.length === 0) {
captureState();
}
} catch (error) {
console.error(error);
alert("Kh√¥ng th·ªÉ kh·ªüi t·∫°o c∆° s·ªü d·ªØ li·ªáu. ·ª®ng d·ª•ng c√≥ th·ªÉ kh√¥ng l∆∞u ƒë∆∞·ª£c d·ªØ li·ªáu.");
}

document.getElementById('zipFileInput').addEventListener('change', function() {
handleArchiveInput(this.files[0], 'boxes-container');
this.value = '';
});

// [Y√äU C·∫¶U 4] G·∫Øn s·ª± ki·ªán cho n√∫t b·∫≠t/t·∫Øt ƒë·ªëi chi·∫øu
const toggleToleranceBtn = document.getElementById('toggleToleranceBtn');
toggleToleranceBtn.addEventListener('click', () => {
isToleranceModeActive = !isToleranceModeActive;
toggleToleranceBtn.textContent = `ƒê·ªëi chi·∫øu: ${isToleranceModeActive ? 'B·∫≠t' : 'T·∫Øt'}`;
toggleToleranceBtn.style.backgroundColor = isToleranceModeActive ? '' : 'var(--color-secondary)';
toggleToleranceBtn.style.color = isToleranceModeActive ? '' : 'white';
});


document.getElementById('exportZip').addEventListener('click', exportAllDataAsZip);
document.getElementById('clearAll').addEventListener('click', () => {
if (confirm("C·∫¢NH B√ÅO: X√≥a T·∫§T C·∫¢ d·ªØ li·ªáu c·ªßa b√°o c√°o n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
if (!db) { alert("L·ªói c∆° s·ªü d·ªØ li·ªáu, kh√¥ng th·ªÉ x√≥a."); return; }
const transaction = db.transaction([STORE_STATE], 'readwrite');
const store = transaction.objectStore(STORE_STATE);
const request = store.clear();
request.onsuccess = () => { alert("ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu. Trang s·∫Ω ƒë∆∞·ª£c t·∫£i l·∫°i."); window.location.reload(); };
request.onerror = (event) => { alert("L·ªói khi x√≥a d·ªØ li·ªáu: " + event.target.error); };
}
});

document.getElementById('scrollToEnd').addEventListener('click', () => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }));
document.getElementById('scrollToTop').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

document.getElementById('undoBtn').addEventListener('click', async () => {
if (historyIndex > 0) {
historyIndex--;
isRestoringState = true;
await rebuildUI(historyStack[historyIndex]);
isRestoringState = false;
updateHistoryButtons();
saveStateToDB(historyStack[historyIndex]);
}
});
document.getElementById('redoBtn').addEventListener('click', async () => {
if (historyIndex < historyStack.length - 1) {
historyIndex++;
isRestoringState = true;
await rebuildUI(historyStack[historyIndex]);
isRestoringState = false;
updateHistoryButtons();
saveStateToDB(historyStack[historyIndex]);
}
});

// Factory media handlers
const factoryPhotoInput = document.getElementById('factoryPhotoInput');
document.getElementById('addFactoryPhotoBtn').addEventListener('click', () => factoryPhotoInput.click());
factoryPhotoInput.addEventListener('change', async function() {
if (this.files.length === 0) return;
const files = Array.from(this.files);
this.value = '';
showProgress(`ƒêang x·ª≠ l√Ω ${files.length} ·∫£nh...`, 0, files.length);
for(const file of files) {
try {
const compressedBlob = await compressImage(file);
const item = await createFactoryMediaItem(compressedBlob, 'image');
document.getElementById('factory-media-container').appendChild(item);
} catch(err) { console.error("L·ªói factory photo:", err); }
}
hideProgress();
captureState();
});

// LOGIC N√âN VIDEO KH√îNG CH·∫∂N
const factoryVideoInput = document.getElementById('factoryVideoInput');
document.getElementById('addFactoryVideoBtn').addEventListener('click', () => factoryVideoInput.click());
factoryVideoInput.addEventListener('change', (event) => {
const file = event.target.files[0];
if (file) {
compressVideoInBackground(file);
}
factoryVideoInput.value = '';
});

function compressVideoInBackground(videoFile) {
const videoProgressContainer = document.getElementById('video-progress-container');
const videoProgressBar = document.getElementById('video-progress-bar');
const videoProgressText = document.getElementById('video-progress-text');

videoProgressContainer.style.display = 'block';
videoProgressText.textContent = 'ƒêang chu·∫©n b·ªã n√©n video...';
videoProgressBar.value = 0;

const originalVideoURL = URL.createObjectURL(videoFile);
const sourceVideo = document.createElement('video');
sourceVideo.src = originalVideoURL;
sourceVideo.muted = true;

sourceVideo.onloadedmetadata = async () => {
const videoStream = sourceVideo.captureStream ? sourceVideo.captureStream() : sourceVideo.mozCaptureStream();
if (!videoStream || videoStream.getVideoTracks().length === 0) {
alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ captureStream. Kh√¥ng th·ªÉ n√©n video.');
videoProgressContainer.style.display = 'none';
return;
}
const pureVideoStream = new MediaStream(videoStream.getVideoTracks());

let recordedChunks = [];
const options = {
mimeType: 'video/mp4; codecs=avc1',
videoBitsPerSecond: 750000
};
let mediaRecorder;
try {
if (!MediaRecorder.isTypeSupported(options.mimeType)) {
console.warn('MP4 kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£, chuy·ªÉn sang WebM.');
options.mimeType = 'video/webm; codecs=vp8';
}
mediaRecorder = new MediaRecorder(pureVideoStream, options);
} catch (e) {
console.error('L·ªói khi t·∫°o MediaRecorder:', e);
alert('L·ªói: Kh√¥ng th·ªÉ kh·ªüi t·∫°o ch·ª©c nƒÉng n√©n.');
videoProgressContainer.style.display = 'none';
return;
}

mediaRecorder.ondataavailable = (event) => {
if (event.data.size > 0) recordedChunks.push(event.data);
};

mediaRecorder.onstop = async () => {
const fileExtension = options.mimeType.includes('mp4') ? 'mp4' : 'webm';
const compressedBlob = new Blob(recordedChunks, { type: `video/${fileExtension}` });

const item = await createFactoryMediaItem(compressedBlob, 'video');
document.getElementById('factory-media-container').appendChild(item);

videoProgressContainer.style.display = 'none';
captureState();
URL.revokeObjectURL(originalVideoURL);
sourceVideo.remove();
};

let duration = sourceVideo.duration;
sourceVideo.ontimeupdate = () => {
if(duration > 0) {
const progress = (sourceVideo.currentTime / duration) * 100;
videoProgressBar.value = progress;
}
};

mediaRecorder.start();
await sourceVideo.play();
videoProgressText.textContent = 'ƒêang n√©n video... (b·∫°n v·∫´n c√≥ th·ªÉ thao t√°c)';
};

sourceVideo.onended = () => {
if (mediaRecorder && mediaRecorder.state === 'recording') {
mediaRecorder.stop();
}
};

sourceVideo.onerror = () => {
alert('L·ªói: Kh√¥ng th·ªÉ t·∫£i video g·ªëc ƒë·ªÉ n√©n.');
videoProgressContainer.style.display = 'none';
};
}


const itemCodeInput = document.getElementById('itemCodeInput');
const addItemCodeBtn = document.getElementById('addItemCodeBtn');
const addItemAction = () => {
const code = itemCodeInput.value.trim().toUpperCase();
if (code && !document.querySelector(`.item-code-tag[data-code="${code}"]`)) {
createItemCodeTag(code);
createInspectionRow(code);
itemCodeInput.value = '';
itemCodeInput.focus();
captureState();
} else if (code) { alert("M√£ h√†ng n√†y ƒë√£ t·ªìn t·∫°i."); }
};
addItemCodeBtn.addEventListener('click', addItemAction);
itemCodeInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addItemAction(); } });

// Note Photo handlers
const notePhotoInput = document.getElementById('notePhotoInput');
notePhotoInput.addEventListener('change', async function() {
if (this.files.length === 0) return;
const files = Array.from(this.files);
this.value = '';
showProgress(`ƒêang x·ª≠ l√Ω ${files.length} ·∫£nh ghi ch√∫...`, 0, files.length);

for (const [index, file] of files.entries()) {
try {
const compressedBlob = await compressImage(file, 800);
const item = await createNotePhotoItem(compressedBlob);
document.getElementById('note-photos-container').appendChild(item);
} catch(err) { console.error("L·ªói ·∫£nh ghi ch√∫:", err); }
}

hideProgress();
captureState();
});

document.getElementById('noteZipInput').addEventListener('change', function() {
handleArchiveInput(this.files[0], 'note-photos-container');
this.value = '';
});


initAqlCalculator();
initZoom();
initNextShotMirror();
initToleranceCalculator();
updateNextShotMirror();
});

// ====================================================================
// --- LOGIC G∆Ø∆†NG CH·ª§P NHANH (NEXT-SHOT MIRROR) ---
// ====================================================================
const nextShotMirror = document.getElementById('next-shot-mirror');
const nextShotThumbnail = document.getElementById('next-shot-thumbnail');
const nextShotDescription = document.getElementById('next-shot-description');

function updateNextShotMirror() {
const allBoxes = Array.from(document.querySelectorAll('#boxes-container .box'));
if (allBoxes.length === 0) {
nextShotMirror.classList.add('hidden');
return;
}
let lastPhotoIndex = -1;
for (let i = allBoxes.length - 1; i >= 0; i--) {
if (allBoxes[i].dataset.isCameraCaptured === 'true') {
lastPhotoIndex = i;
break;
}
}
let targetBox = null;
if (lastPhotoIndex === -1) {
targetBox = allBoxes.find(box => box.dataset.isCameraCaptured !== 'true');
} else if (lastPhotoIndex < allBoxes.length - 1) {
targetBox = allBoxes[lastPhotoIndex + 1];
} else {
targetBox = null;
}

if (targetBox) {
nextShotDescription.textContent = targetBox.querySelector('.description').textContent;
nextShotThumbnail.src = targetBox.querySelector('.thumbnail').src;
nextShotMirror.dataset.targetId = targetBox.id;
nextShotMirror.classList.remove('hidden');
} else {
nextShotMirror.classList.add('hidden');
}
}

function initNextShotMirror() {
nextShotMirror.addEventListener('click', () => {
const targetId = nextShotMirror.dataset.targetId;
if (!targetId) return;
const targetBox = document.getElementById(targetId);
if (targetBox) {
const input = targetBox.querySelector('input[type="file"]');
if (input) {
input.click();
}
}
});

// [Y√äU C·∫¶U 2] Th√™m s·ª± ki·ªán cho n√∫t b·∫≠t/t·∫Øt
document.getElementById('toggle-mirror-btn').addEventListener('click', (e) => {
e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click c·ªßa g∆∞∆°ng
nextShotMirror.classList.toggle('disabled');
});
}


// ====================================================================
// --- LOGIC CHO ZOOM ·∫¢NH (ƒê√É C·∫¢I TI·∫æN) ---
// ====================================================================
function initZoom() {
const overlay = document.getElementById('zoom-overlay');
const image = document.getElementById('zoom-image');
const closeBtn = document.querySelector('.zoom-close-btn');

let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 };
let pointers = [];
let prevDiff = -1;

function setTransform() {
if (scale < 1) { scale = 1; pointX = 0; pointY = 0; }
image.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
}

const closeZoom = () => {
overlay.style.display = 'none';
image.src = '';
pointers = [];
prevDiff = -1;
};

closeBtn.addEventListener('click', closeZoom);
document.addEventListener('keydown', (e) => { if (e.key === "Escape") closeZoom(); });
overlay.addEventListener('click', (e) => {
if (e.target === overlay) closeZoom();
});


overlay.addEventListener('pointerdown', (e) => {
pointers.push(e);
if (pointers.length === 1) { // Pan
panning = true;
start = { x: e.clientX - pointX, y: e.clientY - pointY };
image.style.cursor = 'grabbing';
}
});

overlay.addEventListener('pointerup', (e) => {
panning = false;
image.style.cursor = 'grab';
pointers = pointers.filter(p => p.pointerId !== e.pointerId);
if (pointers.length < 2) prevDiff = -1;
});

overlay.addEventListener('pointercancel', (e) => {
panning = false;
image.style.cursor = 'grab';
pointers = pointers.filter(p => p.pointerId !== e.pointerId);
if (pointers.length < 2) prevDiff = -1;
});

overlay.addEventListener('pointermove', (e) => {
const index = pointers.findIndex(p => p.pointerId === e.pointerId);
if (index > -1) pointers[index] = e;

if (pointers.length === 2) { // Zoom
const curDiff = Math.hypot(pointers[0].clientX - pointers[1].clientX, pointers[0].clientY - pointers[1].clientY);
if (prevDiff > 0) {
if (curDiff > prevDiff) scale += 0.02; else scale -= 0.02;
scale = Math.max(1, Math.min(scale, 5));
setTransform();
}
prevDiff = curDiff;
} else if (panning && pointers.length === 1) { // Pan
e.preventDefault();
pointX = e.clientX - start.x;
pointY = e.clientY - start.y;
setTransform();
}
});

overlay.addEventListener('wheel', (e) => {
e.preventDefault();
const xs = (e.clientX - pointX) / scale;
const ys = (e.clientY - pointY) / scale;
const delta = -e.deltaY;
(delta > 0) ? (scale *= 1.1) : (scale /= 1.1);
scale = Math.max(1, Math.min(scale, 5));
pointX = e.clientX - xs * scale;
pointY = e.clientY - ys * scale;
setTransform();
});
}

function showZoom(imageUrl) {
const overlay = document.getElementById('zoom-overlay');
const image = document.getElementById('zoom-image');

image.style.transform = 'translate(0px, 0px) scale(1)';

image.src = imageUrl;
overlay.style.display = 'flex';
}



// ==========================================================
// --- LOGIC CHO C√îNG C·ª§ T√çNH AQL ---
// ==========================================================
let currentAqlFrame = null;
const lotSizeToCodeLetterTable=[{min:2,max:8,levels:{"I":"A","II":"A","III":"B","S-1":"A","S-2":"A","S-3":"A","S-4":"A"}},{min:9,max:15,levels:{"I":"A","II":"B","III":"C","S-1":"A","S-2":"A","S-3":"A","S-4":"A"}},{min:16,max:25,levels:{"I":"B","II":"C","III":"D","S-1":"A","S-2":"A","S-3":"B","S-4":"B"}},{min:26,max:50,levels:{"I":"C","II":"D","III":"E","S-1":"A","S-2":"B","S-3":"B","S-4":"C"}},{min:51,max:90,levels:{"I":"C","II":"E","III":"F","S-1":"B","S-2":"B","S-3":"C","S-4":"C"}},{min:91,max:150,levels:{"I":"D","II":"F","III":"G","S-1":"B","S-2":"B","S-3":"C","S-4":"D"}},{min:151,max:280,levels:{"I":"E","II":"G","III":"H","S-1":"B","S-2":"C","S-3":"D","S-4":"E"}},{min:281,max:500,levels:{"I":"F","II":"H","III":"J","S-1":"B","S-2":"C","S-3":"D","S-4":"E"}},{min:501,max:1200,levels:{"I":"G","II":"J","III":"K","S-1":"C","S-2":"C","S-3":"E","S-4":"F"}},{min:1201,max:3200,levels:{"I":"H","II":"K","III":"L","S-1":"C","S-2":"D","S-3":"E","S-4":"G"}},{min:3201,max:10000,levels:{"I":"J","II":"L","III":"M","S-1":"C","S-2":"D","S-3":"F","S-4":"G"}},{min:10001,max:35000,levels:{"I":"K","II":"M","III":"N","S-1":"C","S-2":"D","S-3":"F","S-4":"H"}},{min:35001,max:150000,levels:{"I":"L","II":"N","III":"P","S-1":"D","S-2":"E","S-3":"G","S-4":"J"}},{min:150001,max:500000,levels:{"I":"M","II":"P","III":"Q","S-1":"D","S-2":"E","S-3":"G","S-4":"J"}},{min:500001,max:10000000,levels:{"I":"N","II":"Q","III":"R","S-1":"D","S-2":"E","S-3":"H","S-4":"K"}}];
const aqlDataTable={"A":{sampleSize:2,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[0,1],"4.0":[0,1],"6.5":[0,1]}},"B":{sampleSize:3,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[0,1],"4.0":[0,1],"6.5":[0,1]}},"C":{sampleSize:5,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[0,1],"4.0":[0,1],"6.5":[1,2]}},"D":{sampleSize:8,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[0,1],"4.0":[1,2],"6.5":[1,2]}},"E":{sampleSize:13,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[0,1],"2.5":[1,2],"4.0":[1,2],"6.5":[2,3]}},"F":{sampleSize:20,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[0,1],"1.5":[1,2],"2.5":[1,2],"4.0":[2,3],"6.5":[3,4]}},"G":{sampleSize:32,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[0,1],"1.0":[1,2],"1.5":[1,2],"2.5":[2,3],"4.0":[3,4],"6.5":[5,6]}},"H":{sampleSize:50,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[0,1],"0.65":[1,2],"1.0":[1,2],"1.5":[2,3],"2.5":[3,4],"4.0":[5,6],"6.5":[7,8]}},"J":{sampleSize:80,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[0,1],"0.40":[1,2],"0.65":[1,2],"1.0":[2,3],"1.5":[3,4],"2.5":[5,6],"4.0":[7,8],"6.5":[10,11]}},"K":{sampleSize:125,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[0,1],"0.25":[1,2],"0.40":[1,2],"0.65":[2,3],"1.0":[3,4],"1.5":[5,6],"2.5":[7,8],"4.0":[10,11],"6.5":[14,15]}},"L":{sampleSize:200,aql:{"0.065":[0,1],"0.10":[0,1],"0.15":[1,2],"0.25":[1,2],"0.40":[2,3],"0.65":[3,4],"1.0":[5,6],"1.5":[7,8],"2.5":[10,11],"4.0":[14,15],"6.5":[21,22]}},"M":{sampleSize:315,aql:{"0.065":[0,1],"0.10":[1,2],"0.15":[1,2],"0.25":[2,3],"0.40":[3,4],"0.65":[5,6],"1.0":[7,8],"1.5":[10,11],"2.5":[14,15],"4.0":[21,22],"6.5":[21,22]}},"N":{sampleSize:500,aql:{"0.065":[1,2],"0.10":[1,2],"0.15":[2,3],"0.25":[3,4],"0.40":[5,6],"0.65":[7,8],"1.0":[10,11],"1.5":[14,15],"2.5":[21,22],"4.0":[21,22],"6.5":[21,22]}},"P":{sampleSize:800,aql:{"0.065":[1,2],"0.10":[2,3],"0.15":[3,4],"0.25":[5,6],"0.40":[7,8],"0.65":[10,11],"1.0":[14,15],"1.5":[21,22],"2.5":[21,22],"4.0":[21,22],"6.5":[21,22]}},"Q":{sampleSize:1250,aql:{"0.065":[2,3],"0.10":[3,4],"0.15":[5,6],"0.25":[7,8],"0.40":[10,11],"0.65":[14,15],"1.0":[21,22],"1.5":[21,22],"2.5":[21,22],"4.0":[21,22],"6.5":[21,22]}},"R":{sampleSize:2000,aql:{"0.065":[3,4],"0.10":[5,6],"0.15":[7,8],"0.25":[10,11],"0.40":[14,15],"0.65":[21,22],"1.0":[21,22],"1.5":[21,22],"2.5":[21,22],"4.0":[21,22],"6.5":[21,22]}}};

function calculateAQL() {
const quantity = parseInt(document.getElementById('aqlOrderQuantity').value);
const level = document.getElementById('aqlInspectionLevel').value;
const majorAqlValue = document.getElementById('aqlMajor').value;
const minorAqlValue = document.getElementById('aqlMinor').value;
let codeLetter = null;
if (!isNaN(quantity) && quantity >= 2) {
for (const range of lotSizeToCodeLetterTable) {
if (quantity >= range.min && quantity <= range.max) {
codeLetter = range.levels[level];
break;
}
}
}
if (codeLetter && aqlDataTable[codeLetter]) {
const aqlData = aqlDataTable[codeLetter];
const sampleSize = aqlData.sampleSize;
const majorResult = aqlData.aql[majorAqlValue] || ['N/A', 'N/A'];
const minorResult = aqlData.aql[minorAqlValue] || ['N/A', 'N/A'];
document.getElementById('aql-result-code-letter').textContent = codeLetter;
document.getElementById('aql-result-sample-size').textContent = sampleSize;
document.getElementById('aql-major-aql-result').textContent = majorAqlValue;
document.getElementById('aql-major-ac').textContent = majorResult[0];
document.getElementById('aql-major-re').textContent = majorResult[1];
document.getElementById('aql-minor-aql-result').textContent = minorAqlValue;
document.getElementById('aql-minor-ac').textContent = minorResult[0];
document.getElementById('aql-minor-re').textContent = minorResult[1];
} else {
const na = 'N/A';
document.getElementById('aql-result-code-letter').textContent = na;
document.getElementById('aql-result-sample-size').textContent = na;
document.getElementById('aql-major-ac').textContent = na;
document.getElementById('aql-major-re').textContent = na;
document.getElementById('aql-minor-ac').textContent = na;
document.getElementById('aql-minor-re').textContent = na;
}
}

function initAqlCalculator() {
const inputs = ['aqlOrderQuantity', 'aqlInspectionLevel', 'aqlMajor', 'aqlMinor'];
inputs.forEach(id => {
document.getElementById(id).addEventListener('input', calculateAQL);
});
document.getElementById('aqlCloseBtn').addEventListener('click', closeAqlModal);
document.getElementById('aqlApplyBtn').addEventListener('click', applyAndCloseAqlModal);
document.getElementById('aql-modal-overlay').addEventListener('click', (e) => {
if(e.target.id === 'aql-modal-overlay') closeAqlModal();
});
calculateAQL();
}

function openAqlModal(frameElement) {
currentAqlFrame = frameElement;
const orderQty = frameElement.dataset.orderqty || frameElement.closest('.inspection-row')?.querySelector('input[name="prod_qty_standard"]')?.value || 1000;

document.getElementById('aqlOrderQuantity').value = orderQty;
document.getElementById('aqlInspectionLevel').value = frameElement.dataset.inspectionlevel || 'II';
document.getElementById('aqlMajor').value = frameElement.dataset.majoraql || '2.5';
document.getElementById('aqlMinor').value = frameElement.dataset.minoraql || '4.0';

calculateAQL();
document.getElementById('aql-modal-overlay').style.display = 'flex';
}

function closeAqlModal() {
document.getElementById('aql-modal-overlay').style.display = 'none';
currentAqlFrame = null;
}

function applyAndCloseAqlModal() {
if (!currentAqlFrame) return;
const sampleSize = document.getElementById('aql-result-sample-size').textContent;
const majorAc = document.getElementById('aql-major-ac').textContent;
const minorAc = document.getElementById('aql-minor-ac').textContent;
const orderQty = document.getElementById('aqlOrderQuantity').value;
const inspectionLevel = document.getElementById('aqlInspectionLevel').value;
const majorAql = document.getElementById('aqlMajor').value;
const minorAql = document.getElementById('aqlMinor').value;

currentAqlFrame.querySelector('input[name="aql_check_qty"]').value = (sampleSize !== 'N/A') ? sampleSize : '';
currentAqlFrame.querySelector('input[name="major_standard"]').value = (majorAc !== 'N/A') ? majorAc : '';
currentAqlFrame.querySelector('input[name="minor_standard"]').value = (minorAc !== 'N/A') ? minorAc : '';
currentAqlFrame.dataset.orderqty = orderQty;
currentAqlFrame.dataset.inspectionlevel = inspectionLevel;
currentAqlFrame.dataset.majoraql = majorAql;
currentAqlFrame.dataset.minoraql = minorAql;

captureState();
closeAqlModal();
}

// ====================================================================
// --- [Y√äU C·∫¶U 1] LOGIC B·∫¢NG T√çNH SAI S·ªê (ƒê√É S·ª¨A ƒê·ªîI) ---
// ====================================================================
function initToleranceCalculator() {
const overlay = document.getElementById('tolerance-modal-overlay');
const valueInput = document.getElementById('tolerance-value-input');

document.getElementById('close-tolerance-modal-btn').addEventListener('click', () => {
overlay.style.display = 'none';
});
overlay.addEventListener('click', (e) => {
if (e.target === overlay) {
overlay.style.display = 'none';
}
});

// Th√™m s·ª± ki·ªán ƒë·ªÉ l∆∞u khi ng∆∞·ªùi d√πng s·ª≠a xong
const saveToleranceValue = () => {
if (!currentToleranceSourceBox) return;
const newValue = valueInput.value;
const descriptionP = currentToleranceSourceBox.querySelector('.description');

// C·∫≠p nh·∫≠t l·∫°i base description v√† text content
const baseDesc = newValue.replace(/^\d+\.?\s*/, '');
currentToleranceSourceBox.dataset.baseDescription = baseDesc;
descriptionP.textContent = newValue;

renumberDetailBoxes(); // ƒê·∫£m b·∫£o s·ªë th·ª© t·ª± ƒë√∫ng
captureState();
};

valueInput.addEventListener('blur', saveToleranceValue);
valueInput.addEventListener('keydown', e => {
if (e.key === 'Enter') {
e.preventDefault();
valueInput.blur(); // Trigger blur ƒë·ªÉ l∆∞u
}
});
}

async function showToleranceCalculator(standardValue, unit, imageBlob, sourceBox) {
const overlay = document.getElementById('tolerance-modal-overlay');
const tableBody = document.getElementById('tolerance-table-body');
const photoEl = document.getElementById('tolerance-photo');
const valueInput = document.getElementById('tolerance-value-input');

// L∆∞u box ngu·ªìn ƒë·ªÉ c√≥ th·ªÉ c·∫≠p nh·∫≠t l·∫°i sau khi s·ª≠a
currentToleranceSourceBox = sourceBox;

// D·ªçn d·∫πp b·∫£ng c≈©
tableBody.innerHTML = '';

// Chuy·ªÉn blob sang URL ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh
photoEl.src = await blobToDataURL(imageBlob);

// [Y√äU C·∫¶U 1] L·∫•y text t·ª´ √¥ t√™n ·∫£nh v√† t·ª± ƒë·ªông ch·ªçn con s·ªë
const fullDescription = sourceBox.querySelector('.description').textContent;
valueInput.value = fullDescription;

// T√¨m v√† ch·ªçn con s·ªë ƒëo l∆∞·ªùng, b·ªè qua s·ªë th·ª© t·ª±
const measurementRegex = /(\d+\.?\d*)\s*(cm|mm|kg|g|s|m)\b/i;
const match = fullDescription.match(measurementRegex);
if (match) {
const numberStr = match[1]; // Con s·ªë c·∫ßn ch·ªçn, v√≠ d·ª• "15.5"
// T√¨m v·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa chu·ªói con s·ªë trong to√†n b·ªô chu·ªói m√¥ t·∫£
const numberIndex = fullDescription.lastIndexOf(numberStr);
// ƒê·∫∑t focus v√† ch·ªçn (select) con s·ªë ƒë√≥
setTimeout(() => {
valueInput.focus();
valueInput.setSelectionRange(numberIndex, numberIndex + numberStr.length);
}, 100); // Timeout nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o modal hi·ªÉn th·ªã xong
}


// C√°c m·ª©c sai s·ªë
const tolerances = [
{ label: '1%', type: 'percent', value: 0.01 },
{ label: '5%', type: 'percent', value: 0.05 },
{ label: '10%', type: 'percent', value: 0.10 },
{ label: '0.5', type: 'absolute', value: 0.5 },
{ label: '1', type: 'absolute', value: 1 },
{ label: '2', type: 'absolute', value: 2 },
{ label: '5', type: 'absolute', value: 5 },
];

// H√†ng ƒë·∫ßu ti√™n hi·ªÉn th·ªã gi√° tr·ªã ti√™u chu·∫©n
let headerRow = `<tr><td class="tolerance-header">${standardValue} ${unit}</td><td></td><td></td></tr>`;
tableBody.insertAdjacentHTML('beforeend', headerRow);

// T√≠nh to√°n v√† t·∫°o c√°c h√†ng c√≤n l·∫°i
tolerances.forEach(tol => {
let delta;
if (tol.type === 'percent') {
delta = standardValue * tol.value;
} else {
delta = tol.value;
}
const minus = (standardValue - delta).toFixed(2);
const plus = (standardValue + delta).toFixed(2);

const rowHTML = `
<tr>
<td class="tolerance-header">${tol.label}</td>
<td>${minus}</td>
<td>${plus}</td>
</tr>`;
tableBody.insertAdjacentHTML('beforeend', rowHTML);
});

// Hi·ªÉn th·ªã modal
overlay.style.display = 'flex';
}

</script>
</body>
</html>
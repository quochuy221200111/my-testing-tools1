<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocal Studio Pro (Upgraded)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        :root {
            --bg: #101010; --surface: #1e1e1e; --panel: #252525;
            --primary: #00d2ff; --secondary: #7b42f6; --accent: #ff0055;
            --warning: #ffc107;
            --text: #e0e0e0; --text-muted: #888;
            --border-color: #333;
        }
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Tắt highlight khi chạm trên mobile */
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text);
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            padding: 10px;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1fr; /* Mặc định là 1 cột cho mobile */
            gap: 15px;
            width: 100%;
            max-width: 1300px;
            margin-top: 15px;
        }
        /* Grid cho màn hình lớn hơn */
        @media (min-width: 900px) {
            .main-container {
                grid-template-columns: 1fr 380px;
            }
        }
        .panel { background: var(--panel); border-radius: 15px; padding: 15px; border: 1px solid var(--border-color); margin-bottom: 15px; }
        .panel-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .panel-content { max-height: 1000px; overflow: hidden; transition: max-height 0.5s ease-in-out, margin-top 0.5s ease-in-out; }
        .panel.collapsed .panel-content { max-height: 0; margin-top: -15px !important; }
        .panel-title .toggle-icon { transition: transform 0.3s; }
        .panel.collapsed .toggle-icon { transform: rotate(-90deg); }

        .monitor-screen { background: #000; border-radius: 10px; height: 150px; position: relative; border: 1px solid #444; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        canvas#realtimeVisualizer { width: 100%; height: 100%; display: block; }
        .timer-overlay { position: absolute; bottom: 10px; right: 15px; font-family: monospace; color: var(--primary); font-size: 1.5rem; z-index: 10; text-shadow: 0 0 5px black; }

        .main-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin: 15px 0; }
        .btn-control { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--surface); font-size: 1.8rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; color: white; }
        #btnRecordControl { background: #1a7a1f; } /* Sẵn sàng */
        #btnRecordControl.recording { background: var(--accent); animation: pulse 1.5s infinite; } /* Đang ghi */
        #btnRecordControl.paused { background: #ffc107; } /* Tạm dừng */
        #btnPauseControl { background-color: #333; font-size: 1.5rem; width: 55px; height: 55px; }
        #btnPauseControl:disabled { background-color: #222; color: #555; cursor: not-allowed; }
        
        .fx-panel .panel-title { display: flex; justify-content: space-between; align-items: center; width: 100%;}
        .controls-lock { display: flex; align-items: center; gap: 10px; }
        #btnToggleSliders { background: none; border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer; padding: 5px 8px; border-radius: 5px; }
        #btnToggleSliders.unlocked { color: var(--primary); border-color: var(--primary); }
        .slider-container { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .slider-label { width: 80px; font-size: 0.8rem; color: #aaa; flex-shrink: 0; }
        input[type=range] { flex-grow: 1; accent-color: var(--primary); -webkit-appearance: none; background: #444; height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: white; border-radius: 50%; cursor: pointer; }
        input[type=range]:disabled { opacity: 0.5; }
        input[type=range]:disabled::-webkit-slider-thumb { cursor: not-allowed; }
        .slider-value-input { width: 55px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; text-align: center; font-size: 0.8rem; padding: 4px; }
        .slider-value-input:disabled { background: #2b2b2b; cursor: not-allowed; }
        
        .presets-container { display: flex; gap: 10px; margin-top: 15px; }
        .presets-container select, .presets-container button { flex-grow: 1; background: #333; border: 1px solid var(--border-color); color: var(--text); padding: 8px; border-radius: 5px; font-size: 0.8rem; }
        .presets-container button { flex-grow: 0; padding: 8px 12px; }

        .project-manager { padding: 10px; background: #1a1a1a; border-radius: 8px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; }
        .project-manager label { font-size: 0.8rem; color: var(--text-muted); }
        .project-manager select, .project-manager button { width: 100%; background: #333; border: 1px solid var(--border-color); color: var(--text); padding: 8px; border-radius: 5px; font-size: 0.9rem; }

        .record-item, .lyric-item { background: #2a2a2a; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #444; transition: 0.2s; font-size: 0.9rem; }
        .record-item { display: flex; align-items: center; gap: 10px; }
        .lyric-item { cursor: pointer; }
        .record-item.selected, .lyric-item.selected { background-color: #303f5a; border-color: var(--primary); }
        .record-item-info { flex-grow: 1; }
        
        #storageStatus { padding: 10px; background: var(--surface); border-radius: 8px; font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; text-align: center; }
        #storageWarning { display: none; padding: 10px; background: var(--warning); color: black; font-weight: bold; border-radius: 8px; margin-bottom: 10px; font-size: 0.85rem; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: var(--surface); padding: 20px; border-radius: 15px; width: 95%; max-width: 500px; }
        .modal-input-group { margin: 15px 0; }
        .modal-input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-muted); }
        .modal-input-group .filename-prefix { background: #333; padding: 8px; border-radius: 5px 0 0 5px; border: 1px solid #555; border-right: none; }
        .modal-input-group .filename-container { display: flex; }
        .modal-input-group input, .modal-input-group select { width: 100%; background: #252525; border: 1px solid #555; color: white; padding: 8px; border-radius: 5px; }
        .modal-input-group .filename-container input { border-radius: 0 5px 5px 0; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-modal { padding: 10px 20px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; }
        .btn-modal.primary { background: var(--primary); color: #000; }
        .btn-modal.secondary { background: #444; color: white; }

        .trim-canvas-container { width: 100%; height: 120px; background: #000; position: relative; margin: 20px 0; border: 1px solid #444; }
        #trimCanvas { position: absolute; top:0; left:0; width:100%; height:100%;}
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 0, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); } }
    </style>
</head>
<body>

<div class="main-container">
    <!-- CỘT TRÁI: ĐIỀU KHIỂN & HÌNH ẢNH -->
    <div>
        <div class="panel">
            <div class="monitor-screen">
                <canvas id="realtimeVisualizer"></canvas>
                <div id="timer" class="timer-overlay">00:00</div>
            </div>
        </div>

        <div class="main-controls">
            <button id="btnRecordControl" class="btn-control" title="Bắt đầu Ghi âm">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="btnPauseControl" class="btn-control" title="Tạm dừng" disabled>
                <i class="fas fa-pause"></i>
            </button>
        </div>

        <div class="panel fx-panel">
            <div class="panel-title">
                <span>Hiệu ứng & EQ</span>
                <div class="controls-lock">
                    <button id="btnToggleSliders" title="Mở/Khóa các thanh trượt"><i class="fas fa-lock"></i></button>
                    <i class="fas fa-sliders-h toggle-icon"></i>
                </div>
            </div>
            <div class="panel-content">
                <div class="control-group">
                    <div style="margin-bottom:10px; font-size:0.8rem; color:#aaa;">Equalizer (5-Band)</div>
                    <!-- Các thanh trượt EQ -->
                    <div class="slider-container"><span class="slider-label">Low</span><input type="range" class="fx-slider" data-param="eq.low" min="-12" max="12" value="0" step="1" disabled><input type="number" class="slider-value-input" data-param="eq.low" value="0" disabled></div>
                    <div class="slider-container"><span class="slider-label">Low-Mid</span><input type="range" class="fx-slider" data-param="eq.lowMid" min="-12" max="12" value="0" step="1" disabled><input type="number" class="slider-value-input" data-param="eq.lowMid" value="0" disabled></div>
                    <div class="slider-container"><span class="slider-label">Mid</span><input type="range" class="fx-slider" data-param="eq.mid" min="-12" max="12" value="0" step="1" disabled><input type="number" class="slider-value-input" data-param="eq.mid" value="0" disabled></div>
                    <div class="slider-container"><span class="slider-label">Hi-Mid</span><input type="range" class="fx-slider" data-param="eq.highMid" min="-12" max="12" value="0" step="1" disabled><input type="number" class="slider-value-input" data-param="eq.highMid" value="0" disabled></div>
                    <div class="slider-container"><span class="slider-label">High</span><input type="range" class="fx-slider" data-param="eq.high" min="-12" max="12" value="0" step="1" disabled><input type="number" class="slider-value-input" data-param="eq.high" value="0" disabled></div>
                </div>
                <div class="control-group">
                     <div class="slider-container">
                        <span class="slider-label">Reverb Mix</span>
                        <input type="range" class="fx-slider" data-param="reverb.mix" min="0" max="1" step="0.01" value="0.3" disabled>
                        <input type="number" class="slider-value-input" data-param="reverb.mix" value="0.3" step="0.1" disabled>
                    </div>
                </div>
                <div class="presets-container">
                    <select id="presetSelector" title="Chọn preset đã lưu"></select>
                    <button id="btnSavePreset" title="Lưu cài đặt hiện tại thành preset mới"><i class="fas fa-save"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- CỘT PHẢI: LỜI BÀI HÁT & THƯ VIỆN -->
    <div>
        <div class="project-manager panel">
             <label for="projectSelector">DỰ ÁN HIỆN TẠI</label>
             <select id="projectSelector"></select>
             <button id="btnNewProject">Tạo dự án mới</button>
        </div>

         <div class="panel lyrics-panel">
            <div class="panel-title"><span>Lời bài hát</span> <i class="fas fa-music toggle-icon"></i></div>
            <div class="panel-content">
                <div id="lyrics-playlist" style="max-height: 150px; overflow-y: auto;"></div>
                 <textarea id="lyricsInput" placeholder="Dán lời bài hát vào đây..." style="width:100%; height: 120px; background: #1a1a1a; border-radius: 8px; padding: 10px; color:white; border:1px solid var(--border-color); margin:10px 0;"></textarea>
                 <button id="btnSaveLyrics" class="btn-modal primary" style="width:100%"><i class="fas fa-save"></i> Lưu lời bài hát</button>
            </div>
        </div>

        <div class="panel playlist-panel">
            <div class="panel-title"><span>Thư viện Bản ghi</span> <i class="fas fa-list-ul toggle-icon"></i></div>
            <div class="panel-content">
                <div id="storageWarning"></div>
                <div id="playlist"></div>
                <div id="storageStatus">Đang tính toán dung lượng...</div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CẮT ÂM THANH -->
<div id="trimModal" class="modal">
    <div class="modal-content">
        <h2>Chỉnh sửa & Cắt Âm thanh</h2>
        <div class="trim-canvas-container"><canvas id="trimCanvas"></canvas></div>
        <div class="modal-buttons">
            <button id="btnCancelTrim" class="btn-modal secondary">Hủy bỏ</button>
            <button id="btnOpenSaveDialog" class="btn-modal primary"><i class="fas fa-cut"></i> Tiếp tục & Lưu</button>
        </div>
    </div>
</div>

<!-- MODAL LƯU TỆP -->
<div id="saveModal" class="modal">
     <div class="modal-content">
        <h2>Lưu bản ghi</h2>
        <div class="modal-input-group">
            <label for="recordingNameInput">Tên bản ghi</label>
            <div class="filename-container">
                 <span id="fileNamePrefix" class="filename-prefix"></span>
                 <input type="text" id="recordingNameInput" placeholder="My masterpiece...">
            </div>
        </div>
        <div class="modal-input-group">
            <label for="saveToProjectSelector">Lưu vào dự án</label>
            <select id="saveToProjectSelector"></select>
        </div>
        <div class="modal-buttons">
             <button onclick="document.getElementById('saveModal').style.display='none'" class="btn-modal secondary">Hủy</button>
             <button id="btnSaveTrim" class="btn-modal primary"><i class="fas fa-save"></i> Lưu</button>
        </div>
    </div>
</div>

<script>
// --- GLOBAL STATE ---
let db;
let audioCtx, micStream, micSource, workletNode, analyser, gainNode;
let recordingState = 'idle'; // idle, recording, paused
let audioBuffer = [];
let fullAudioData;
let sampleRate = 48000;
let timerInterval, startTime, accumulatedTime = 0;
let fxState = {
    eq: { low: 0, lowMid: 0, mid: 0, highMid: 0, high: 0 },
    reverb: { type: 'studio', mix: 0.3 }
};
const DB_NAME = "VocalStudioDB_V3";
const DB_VERSION = 3; 

// --- KHỞI TẠO ---
document.addEventListener('DOMContentLoaded', () => {
    initDB();
    setupEventListeners();
    loadPresets();
    updateFXControlsFromState();
});

function initDB() {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
        db = e.target.result;
        // Object store cho Projects
        if (!db.objectStoreNames.contains('projects')) {
            db.createObjectStore('projects', { keyPath: 'id', autoIncrement: true });
        }
        // Object store cho Recordings
        if (!db.objectStoreNames.contains('recs')) {
            const recStore = db.createObjectStore('recs', { keyPath: 'id', autoIncrement: true });
            recStore.createIndex('projectId', 'projectId', { unique: false });
        }
        // Object store cho Lyrics
        if (!db.objectStoreNames.contains('lyrics')) {
            const lyricStore = db.createObjectStore('lyrics', { keyPath: 'id', autoIncrement: true });
            lyricStore.createIndex('projectId', 'projectId', { unique: false });
        }
    };
    req.onsuccess = e => {
        db = e.target.result;
        requestPersistentStorage(); // Yêu cầu 1: Lưu trữ bền vững
        checkStorageQuota(); // Yêu cầu 2: Kiểm tra dung lượng
        loadProjects();
    };
    req.onerror = e => console.error("DB Error:", e.target.errorCode);
}

// --- YÊU CẦU 1: LƯU TRỮ BỀN VỮNG ---
async function requestPersistentStorage() {
    if (navigator.storage && navigator.storage.persist) {
        const isPersisted = await navigator.storage.persisted();
        if (!isPersisted) {
            const result = await navigator.storage.persist();
            console.log(`Persistent storage request: ${result ? 'GRANTED' : 'DENIED'}.`);
        }
    }
}

// --- YÊU CẦU 2 & 3: GIÁM SÁT DUNG LƯỢNG ---
async function checkStorageQuota(showAlerts = true) {
    if (navigator.storage && navigator.storage.estimate) {
        const { usage, quota } = await navigator.storage.estimate();
        const usageMB = (usage / 1024 / 1024).toFixed(2);
        const quotaMB = (quota / 1024 / 1024).toFixed(2);
        const percentageUsed = quota > 0 ? (usage / quota) * 100 : 0;
        
        // Cập nhật UI
        document.getElementById('storageStatus').textContent = `Đã dùng: ${usageMB} MB / ${quotaMB} MB (${percentageUsed.toFixed(1)}%)`;
        
        const warningDiv = document.getElementById('storageWarning');
        if (percentageUsed > 80 && showAlerts) {
            warningDiv.style.display = 'block';
            warningDiv.textContent = `CẢNH BÁO: Bộ nhớ đã sử dụng ${percentageUsed.toFixed(0)}%. Hãy tải về các bản ghi cũ để giải phóng không gian.`;
        } else {
            warningDiv.style.display = 'none';
        }
        return percentageUsed;
    }
    return 0; // Trả về 0 nếu không thể kiểm tra
}

// --- EVENT LISTENERS ---
function setupEventListeners() {
    // Controls
    document.getElementById('btnRecordControl').onclick = handleRecordControl;
    document.getElementById('btnPauseControl').onclick = handlePauseControl;
    document.getElementById('btnToggleSliders').onclick = toggleSliderLock;
    document.querySelectorAll('.panel-title').forEach(t => t.onclick = () => t.parentElement.classList.toggle('collapsed'));
    
    // FX Sliders & Inputs
    document.querySelectorAll('.fx-slider, .slider-value-input').forEach(input => {
        input.oninput = handleFXInputChange;
    });
    
    // Presets
    document.getElementById('btnSavePreset').onclick = savePreset;
    document.getElementById('presetSelector').onchange = (e) => loadSelectedPreset(e.target.value);
    
    // Projects
    document.getElementById('projectSelector').onchange = refreshLibraries;
    document.getElementById('btnNewProject').onclick = createNewProject;

    // Lyrics
    document.getElementById('btnSaveLyrics').onclick = saveLyrics;
    document.getElementById('lyrics-playlist').addEventListener('click', (e) => {
        const item = e.target.closest('.lyric-item');
        if (item) loadSelectedLyrics(parseInt(item.dataset.id));
    });
    
    // Modal
    document.getElementById('btnCancelTrim').onclick = () => document.getElementById('trimModal').style.display = 'none';
    document.getElementById('btnOpenSaveDialog').onclick = openSaveDialog;
    document.getElementById('btnSaveTrim').onclick = saveTrimmedAudio;
}

// --- AUDIO ENGINE ---
async function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
    sampleRate = audioCtx.sampleRate;
    micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, channelCount: 1 }});
    micSource = audioCtx.createMediaStreamSource(micStream);
    
    // Main gain node for overall control
    gainNode = audioCtx.createGain();

    // Worklet for recording
    const workletURL = URL.createObjectURL(new Blob([`
        class RecorderProcessor extends AudioWorkletProcessor {
            process(inputs) { this.port.postMessage(inputs[0][0]); return true; }
        }
        registerProcessor('recorder-processor', RecorderProcessor);
    `], { type: 'application/javascript' }));
    await audioCtx.audioWorklet.addModule(workletURL);
    workletNode = new AudioWorkletNode(audioCtx, 'recorder-processor');
    workletNode.port.onmessage = e => {
        if (recordingState === 'recording' && e.data) {
            audioBuffer.push(new Float32Array(e.data));
        }
    };
    
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    
    micSource.connect(gainNode).connect(analyser).connect(workletNode).connect(audioCtx.destination);
    // TODO: Re-integrate FX chain here if needed
}

// --- RECORDING CONTROLS ---
async function handleRecordControl() {
    if (recordingState === 'idle') { // Start recording
        if (audioCtx) await audioCtx.close();
        await initAudio();
        recordingState = 'recording';
        audioBuffer = [];
        accumulatedTime = 0;
        startTimer();
        drawRealtimeVisualizer();
        updateUIForState();
    } else { // Stop recording
        recordingState = 'stopping';
        stopTimer();
        micStream.getTracks().forEach(track => track.stop());
        micStream = null;
        if (audioCtx) audioCtx.close().then(() => { audioCtx = null; });
        openTrimmer();
        recordingState = 'idle';
        updateUIForState();
    }
}

function handlePauseControl() {
    if (recordingState === 'recording') {
        recordingState = 'paused';
        audioCtx.suspend();
        stopTimer();
    } else if (recordingState === 'paused') {
        recordingState = 'recording';
        audioCtx.resume();
        startTimer();
    }
    updateUIForState();
}

function updateUIForState() {
    const btn = document.getElementById('btnRecordControl');
    const pauseBtn = document.getElementById('btnPauseControl');
    btn.classList.remove('recording', 'paused');
    btn.innerHTML = ''; // Clear icon
    
    switch (recordingState) {
        case 'idle':
            btn.title = "Bắt đầu Ghi âm";
            btn.innerHTML = '<i class="fas fa-microphone"></i>';
            pauseBtn.disabled = true;
            document.getElementById('timer').innerText = "00:00";
            break;
        case 'recording':
            btn.title = "Dừng Ghi âm";
            btn.classList.add('recording');
            btn.innerHTML = '<i class="fas fa-stop"></i>';
            pauseBtn.disabled = false;
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            break;
        case 'paused':
            btn.title = "Dừng Ghi âm";
            btn.classList.add('paused');
            btn.innerHTML = '<i class="fas fa-stop"></i>';
            pauseBtn.disabled = false;
            pauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            break;
    }
}

// --- TIMER ---
function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const totalSeconds = Math.floor((accumulatedTime + elapsed) / 1000);
        const m = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const s = String(totalSeconds % 60).padStart(2, '0');
        document.getElementById('timer').innerText = `${m}:${s}`;
    }, 1000);
}

function stopTimer() {
    if(timerInterval) {
        accumulatedTime += Date.now() - startTime;
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// --- REAL-TIME VISUALIZATION ---
let volumeHistory = new Array(200).fill(0);
function drawRealtimeVisualizer() {
    if (recordingState === 'idle' || recordingState === 'stopping') {
        // Clear canvas
        const canvas = document.getElementById('realtimeVisualizer');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    
    requestAnimationFrame(drawRealtimeVisualizer);
    
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(dataArray);

    let sum = 0;
    for (const amplitude of dataArray) {
        sum += amplitude * amplitude;
    }
    let rms = Math.sqrt(sum / dataArray.length) / 128.0; // Normalize to 0-1 range

    volumeHistory.push(rms);
    if (volumeHistory.length > 200) volumeHistory.shift();
    
    const canvas = document.getElementById('realtimeVisualizer');
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, w, h);
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'var(--primary)';
    ctx.beginPath();
    
    const sliceWidth = w / (volumeHistory.length - 1);
    for(let i = 0; i < volumeHistory.length; i++) {
        const v = volumeHistory[i];
        const y = h - (v * h);
        if (i === 0) {
            ctx.moveTo(i * sliceWidth, y);
        } else {
            ctx.lineTo(i * sliceWidth, y);
        }
    }
    ctx.stroke();
}


// --- FX & PRESETS ---
function toggleSliderLock() {
    const btn = document.getElementById('btnToggleSliders');
    const isLocked = !btn.classList.contains('unlocked');
    btn.classList.toggle('unlocked', isLocked);
    btn.innerHTML = isLocked ? '<i class="fas fa-lock-open"></i>' : '<i class="fas fa-lock"></i>';
    
    document.querySelectorAll('.fx-slider, .slider-value-input').forEach(input => {
        input.disabled = !isLocked;
    });
}

function handleFXInputChange(e) {
    const [group, param] = e.target.dataset.param.split('.');
    const value = e.target.type === 'range' ? parseFloat(e.target.value) : parseFloat(e.target.value);
    fxState[group][param] = value;
    updateFXControlsFromState();
    // ApplyFX(); // You would call a function here to apply the settings to the audio nodes
}

function updateFXControlsFromState() {
    document.querySelectorAll('.fx-slider, .slider-value-input').forEach(input => {
        const [group, param] = input.dataset.param.split('.');
        const value = fxState[group][param];
        if (input.type === 'range') {
            input.value = value;
        } else {
            input.value = value.toFixed(input.step >= 1 ? 0 : 2);
        }
    });
}

function savePreset() {
    const name = prompt("Enter a name for this preset:");
    if (!name) return;
    let presets = JSON.parse(localStorage.getItem('fxPresets') || '{}');
    presets[name] = JSON.parse(JSON.stringify(fxState)); // Deep copy
    localStorage.setItem('fxPresets', JSON.stringify(presets));
    loadPresets();
    alert(`Preset "${name}" saved!`);
}

function loadPresets() {
    const presets = JSON.parse(localStorage.getItem('fxPresets') || '{}');
    const selector = document.getElementById('presetSelector');
    selector.innerHTML = '<option value="">Load Preset...</option>';
    for (const name in presets) {
        selector.innerHTML += `<option value="${name}">${name}</option>`;
    }
}

function loadSelectedPreset(name) {
    if (!name) return;
    const presets = JSON.parse(localStorage.getItem('fxPresets') || '{}');
    if (presets[name]) {
        fxState = presets[name];
        updateFXControlsFromState();
        // ApplyFX();
    }
}

// --- PROJECT MANAGEMENT ---
function loadProjects() {
    const projectSelector = document.getElementById('projectSelector');
    const saveToProjectSelector = document.getElementById('saveToProjectSelector');
    projectSelector.innerHTML = '<option value="0">All Projects</option>';
    saveToProjectSelector.innerHTML = '';
    
    const tx = db.transaction('projects', 'readonly');
    tx.objectStore('projects').openCursor().onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
            const option = `<option value="${cursor.value.id}">${cursor.value.name}</option>`;
            projectSelector.innerHTML += option;
            saveToProjectSelector.innerHTML += option;
            cursor.continue();
        } else {
            // After loading all projects, refresh the libraries
            refreshLibraries();
        }
    };
}

function createNewProject() {
    const name = prompt("Enter new project name:");
    if (name) {
        const tx = db.transaction('projects', 'readwrite');
        tx.objectStore('projects').add({ name });
        tx.oncomplete = loadProjects;
    }
}

function refreshLibraries() {
    const projectId = parseInt(document.getElementById('projectSelector').value);
    loadPlaylist(projectId);
    loadLyricsLibrary(projectId);
}

// --- LYRICS LIBRARY ---
function saveLyrics() {
    const content = document.getElementById('lyricsInput').value.trim();
    if (!content) return alert("Lyrics content cannot be empty.");
    const name = prompt("Name for these lyrics:", `Lyrics ${new Date().toLocaleDateString()}`);
    if (!name) return;

    const currentProjectId = parseInt(document.getElementById('projectSelector').value) || null;
    const lyricData = { name, content, projectId: currentProjectId };

    const tx = db.transaction(['lyrics'], 'readwrite');
    tx.objectStore('lyrics').add(lyricData);
    tx.oncomplete = () => {
        alert('Lyrics saved!');
        refreshLibraries();
    };
}

function loadLyricsLibrary(projectId = 0) {
    const container = document.getElementById('lyrics-playlist');
    container.innerHTML = '';
    const store = db.transaction('lyrics').objectStore('lyrics');
    const cursorReq = projectId ? store.index('projectId').openCursor(IDBKeyRange.only(projectId)) : store.openCursor(null, 'prev');
    
    cursorReq.onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
            const item = document.createElement('div');
            item.className = 'lyric-item';
            item.dataset.id = cursor.value.id;
            item.textContent = cursor.value.name;
            container.appendChild(item);
            cursor.continue();
        }
    };
}
function loadSelectedLyrics(id) {
    document.querySelectorAll('.lyric-item').forEach(i => i.classList.remove('selected'));
    document.querySelector(`.lyric-item[data-id='${id}']`).classList.add('selected');
    db.transaction('lyrics').objectStore('lyrics').get(id).onsuccess = e => {
        if(e.target.result) document.getElementById('lyricsInput').value = e.target.result.content;
    };
}

// --- TRIMMER & SAVING ---
function openTrimmer() {
    if(audioBuffer.length === 0) return;
    const modal = document.getElementById('trimModal');
    modal.style.display = 'flex';
    
    const length = audioBuffer.reduce((sum, chunk) => sum + chunk.length, 0);
    fullAudioData = new Float32Array(length);
    let offset = 0;
    audioBuffer.forEach(chunk => {
        fullAudioData.set(chunk, offset);
        offset += chunk.length;
    });
    audioBuffer = []; // Clear buffer
    
    drawTrimWaveform();
}

function drawTrimWaveform() {
    const cvs = document.getElementById('trimCanvas');
    const ctx = cvs.getContext('2d');
    const w = cvs.width = cvs.clientWidth;
    const h = cvs.height = cvs.clientHeight;
    ctx.clearRect(0, 0, w, h);
    if (!fullAudioData) return;
    
    const step = Math.ceil(fullAudioData.length / w);
    const amp = h / 2;
    ctx.strokeStyle = 'var(--primary)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for (let i = 0; i < w; i++) {
        let min = 1.0, max = -1.0;
        for (let j = 0; j < step; j++) {
            const val = fullAudioData[(i * step) + j] || 0;
            if (val < min) min = val;
            if (val > max) max = val;
        }
        ctx.moveTo(i, amp + min * amp);
        ctx.lineTo(i, amp + max * amp);
    }
    ctx.stroke();
}

function openSaveDialog() {
    document.getElementById('trimModal').style.display = 'none';
    const d = new Date();
    const datePrefix = String(d.getFullYear()).slice(-2) + String(d.getMonth() + 1).padStart(2, '0') + String(d.getDate()).padStart(2, '0');
    document.getElementById('fileNamePrefix').textContent = datePrefix + '_';
    document.getElementById('recordingNameInput').value = '';
    
    const currentProjectId = parseInt(document.getElementById('projectSelector').value);
    if(currentProjectId > 0) {
        document.getElementById('saveToProjectSelector').value = currentProjectId;
    }

    document.getElementById('saveModal').style.display = 'flex';
}

async function saveTrimmedAudio() {
    // Yêu cầu 2: Kiểm tra dung lượng trước khi lưu
    const usagePercentage = await checkStorageQuota();
    if (usagePercentage > 95) {
        alert("Lỗi: Bộ nhớ cục bộ gần đầy! Vui lòng xóa các bản ghi cũ trước khi lưu bản ghi mới.");
        return;
    }
    
    const customName = document.getElementById('recordingNameInput').value.trim() || 'recording';
    const prefix = document.getElementById('fileNamePrefix').textContent;
    const recordingName = prefix + customName;
    const projectId = parseInt(document.getElementById('saveToProjectSelector').value) || null;
    
    if (!projectId) {
        alert("Vui lòng chọn một dự án để lưu.");
        return;
    }

    const wavBlob = encodeWAV(fullAudioData, sampleRate);
    const recData = { name: recordingName, blob: wavBlob, date: new Date(), projectId: projectId };
    
    const tx = db.transaction(['recs'], 'readwrite');
    tx.objectStore('recs').add(recData);
    tx.oncomplete = () => {
        document.getElementById('saveModal').style.display = 'none';
        refreshLibraries();
        fullAudioData = null;
        checkStorageQuota(); // Cập nhật lại UI dung lượng sau khi lưu
    };
    tx.onerror = () => alert("Có lỗi xảy ra khi lưu bản ghi!");
}

function encodeWAV(samples, sampleRate) { /* ... Giữ nguyên hàm encodeWAV ... */
    const buffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(buffer);
    const write = (o,s) => { for(let i=0;i<s.length;i++) view.setUint8(o+i,s.charCodeAt(i)); };
    write(0, 'RIFF'); view.setUint32(4, 36 + samples.length * 2, true);
    write(8, 'WAVE'); write(12, 'fmt '); view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true); view.setUint16(34, 16, true);
    write(36, 'data'); view.setUint32(40, samples.length * 2, true);
    for (let i = 0; i < samples.length; i++) {
        let s = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }
    return new Blob([view], { type: 'audio/wav' });
}

// --- PLAYLIST ---
function loadPlaylist(projectId = 0) {
    const list = document.getElementById('playlist');
    list.innerHTML = '';
    const store = db.transaction('recs').objectStore('recs');
    const cursorReq = projectId ? store.index('projectId').openCursor(IDBKeyRange.only(projectId)) : store.openCursor(null, 'prev');

    cursorReq.onsuccess = e => {
        const cursor = e.target.result;
        if(cursor) {
            const url = URL.createObjectURL(cursor.value.blob);
            const div = document.createElement('div');
            div.className = 'record-item';
            div.dataset.id = cursor.value.id;
            div.innerHTML = `
                <div class="record-item-info">
                    <div style="font-weight:bold">${cursor.value.name}</div>
                    <div style="font-size:0.8rem; color:#888">${cursor.value.date.toLocaleString('vi-VN')}</div>
                </div>
                <audio controls src="${url}" style="height:35px; width: 150px;"></audio>
                <a href="${url}" download="${cursor.value.name.replace(/[^a-z0-9]/gi, '_')}.wav" title="Tải xuống" class="btn-control" style="width:35px; height:35px; font-size:1rem; background:#333;"><i class="fas fa-download"></i></a>`;
            list.appendChild(div);
            cursor.continue();
        }
    };
}
</script>
</body>
</html>
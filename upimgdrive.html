<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω ·∫¢nh Drive - Ch·ªçn T·∫•t C·∫£</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #ddd; margin: 0; padding: 20px; }
        h2 { text-align: center; color: #fff; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .upload-box { background: #2d2d2d; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-align: center; margin-bottom: 30px; }
        #paste-area {
            border: 2px dashed #555; height: 120px; display: flex; align-items: center; justify-content: center;
            margin: 15px 0; cursor: pointer; color: #aaa; flex-direction: column; transition: 0.3s;
            background: #252525; border-radius: 8px;
        }
        #paste-area.active { border-color: #4CAF50; background: #2f3f2f; color: #fff; }
        #paste-area:hover { border-color: #666; }
        .file-input-wrapper { margin-top: 10px; }
        input[type="file"] { display: none; }
        .btn-select { background: #2196F3; color: white; padding: 8px 20px; border-radius: 5px; cursor: pointer; display: inline-block; font-size: 14px; transition: 0.2s; }
        .btn-select:hover { background: #1976D2; }
        .status-log { margin-top: 10px; font-size: 13px; text-align: left; max-height: 100px; overflow-y: auto; color: #bbb; }
        .log-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #333; }
        .log-success { color: #4CAF50; } .log-error { color: #f44336; } .log-loading { color: #FF9800; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .controls h3 { margin-right: auto; }
        .controls .button-group { display: flex; gap: 10px; }
        .btn { color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: background 0.2s; }
        .btn-refresh { background: #444; } .btn-refresh:hover { background: #555; }
        .btn-delete-selected { background: #c0392b; } .btn-delete-selected:hover { background: #e74c3c; }
        .btn-select-all { background: #007bff; } .btn-select-all:hover { background: #0056b3; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .img-card { background: #2d2d2d; border-radius: 8px; overflow: hidden; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; display: flex; flex-direction: column; }
        .img-card:hover { transform: translateY(-3px); }
        .img-thumb-container { width: 100%; height: 180px; background-color: #000; display: flex; align-items: center; justify-content: center; }
        .img-thumb { width: 100%; height: 100%; object-fit: contain; display: block; }
        .img-info { padding: 8px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-top: 1px solid #333; margin-top: auto; }
        .btn-delete { position: absolute; top: 8px; right: 8px; background: rgba(244, 67, 54, 0.8); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; opacity: 0; transition: 0.2s; z-index: 10; }
        .img-card:hover .btn-delete { opacity: 1; }
        .btn-delete:hover { background: #d32f2f; transform: scale(1.1); }
        .img-card.selected { box-shadow: 0 0 0 3px #2196F3; }
        .img-card.selected::after { content: '‚úî'; position: absolute; top: 8px; left: 8px; background: #2196F3; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; pointer-events: none; }
        .loading-overlay { text-align: center; padding: 20px; color: #888; font-style: italic; }
    </style>
</head>
<body>

    <div class="container">
        <div style="background: #252525; border-left: 4px solid #f39c12; color: #ccc; padding: 15px; margin: 20px 0; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #f39c12;">H·ªá Th·ªëng Qu·∫£n L√Ω ·∫¢nh Drive - Ch·∫•t L∆∞·ª£ng T·ªëi ƒêa</h3>
            <p><b>T√≠nh nƒÉng:</b> ·∫¢nh ƒë∆∞·ª£c hi·ªÉn th·ªã v·ªõi ch·∫•t l∆∞·ª£ng cao nh·∫•t. B·ªï sung n√∫t "Ch·ªçn t·∫•t c·∫£" ƒë·ªÉ x√≥a ·∫£nh h√†ng lo·∫°t.</p>
        </div>
        
        <h2>Qu·∫£n L√Ω ·∫¢nh Drive</h2>
        <div class="upload-box">
            <div id="paste-area"><span>Ctrl + V ƒë·ªÉ d√°n ·∫£nh</span><small>Ho·∫∑c k√©o th·∫£ file</small></div>
            <div class="file-input-wrapper"><label class="btn-select">üìÇ Ch·ªçn file<input type="file" id="file-input" multiple accept="image/*"></label></div>
            <div class="status-log"></div>
        </div>
        <div class="controls">
            <h3>Danh s√°ch ·∫£nh</h3>
            <!-- ================== TH√äM N√öT M·ªöI T·∫†I ƒê√ÇY ================== -->
            <div class="button-group">
                <button class="btn btn-delete-selected" style="display: none;">üóëÔ∏è X√≥a ƒë√£ ch·ªçn</button>
                <button id="btn-select-all" class="btn btn-select-all" style="display: none;">‚òëÔ∏è Ch·ªçn t·∫•t c·∫£</button>
                <button class="btn btn-refresh">‚Üª C·∫≠p nh·∫≠t</button>
            </div>
            <!-- ========================================================== -->
        </div>
        <div class="gallery"></div>
        <div class="loading-overlay">ƒêang t·∫£i...</div>
    </div>

    <script>
    // ======================================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby4x825A6wuoIA2jC6LUujtAK7un69P3AsxI645UWUbDmMrUWnxwjlCLNK-aXJlKyS1FA/exec'; 
    // ======================================================

    document.addEventListener('DOMContentLoaded', () => {
        const pasteArea = document.getElementById('paste-area');
        const fileInput = document.getElementById('file-input');
        const statusList = document.querySelector('.status-log');
        const galleryArea = document.querySelector('.gallery');
        const loadingMsg = document.querySelector('.loading-overlay');
        const btnDeleteSelected = document.querySelector('.btn-delete-selected');
        const btnRefresh = document.querySelector('.btn-refresh');
        // --- L·∫•y n√∫t "Ch·ªçn t·∫•t c·∫£" ---
        const btnSelectAll = document.getElementById('btn-select-all');

        // --- G√°n s·ª± ki·ªán cho c√°c n√∫t ---
        pasteArea.addEventListener('dragleave', () => pasteArea.classList.remove('active'));
        pasteArea.addEventListener('dragover', (e) => { e.preventDefault(); pasteArea.classList.add('active'); });
        pasteArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pasteArea.classList.remove('active');
            handleFiles(e.dataTransfer.files);
        });
        pasteArea.addEventListener('click', () => {
             pasteArea.querySelector('span').textContent = 'ƒêang ch·ªù d√°n...';
             document.onpaste = (e) => {
                handlePaste(e);
                pasteArea.querySelector('span').textContent = 'Ctrl + V ƒë·ªÉ d√°n ·∫£nh';
             };
        });
        fileInput.addEventListener('change', (e) => { 
            handleFiles(e.target.files); 
            e.target.value = '';
        });
        btnRefresh.addEventListener('click', fetchImages);
        btnDeleteSelected.addEventListener('click', deleteSelectedImages);
        // --- G√°n s·ª± ki·ªán cho n√∫t "Ch·ªçn t·∫•t c·∫£" ---
        btnSelectAll.addEventListener('click', toggleSelectAll);

        // C√°c h√†m x·ª≠ l√Ω upload
        function handlePaste(e) { /* ... gi·ªØ nguy√™n ... */ }
        function handleFiles(files) { /* ... gi·ªØ nguy√™n ... */ }
        function uploadFile(file) { /* ... gi·ªØ nguy√™n ... */ }
        
        // H√†m l·∫•y ·∫£nh
        function fetchImages() {
            loadingMsg.style.display = 'block';
            galleryArea.innerHTML = '';
            updateSelectionControls(); // C·∫≠p nh·∫≠t ƒë·ªÉ ·∫©n c√°c n√∫t khi ƒëang t·∫£i
            fetch(SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                loadingMsg.style.display = 'none';
                if (data.result === 'success') {
                    renderGallery(data.images);
                } else {
                    loadingMsg.innerHTML = 'L·ªói: ' + data.message;
                    loadingMsg.style.display = 'block';
                }
                updateSelectionControls(); // C·∫≠p nh·∫≠t l·∫°i c√°c n√∫t sau khi t·∫£i xong
            })
            .catch(err => {
                loadingMsg.innerHTML = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.';
                loadingMsg.style.display = 'block';
                console.error(err);
            });
        }
        
        // H√†m hi·ªÉn th·ªã ·∫£nh
        function renderGallery(images) { /* ... gi·ªØ nguy√™n ... */ }

        // ================== H√ÄM M·ªöI: CH·ªåN/B·ªé CH·ªåN T·∫§T C·∫¢ ==================
        function toggleSelectAll() {
            const allCards = galleryArea.querySelectorAll('.img-card');
            const selectedCards = galleryArea.querySelectorAll('.img-card.selected');
            
            // N·∫øu s·ªë l∆∞·ª£ng ƒë√£ ch·ªçn < t·ªïng s·ªë l∆∞·ª£ng -> ch·ªçn t·∫•t c·∫£
            // Ng∆∞·ª£c l·∫°i -> b·ªè ch·ªçn t·∫•t c·∫£
            const shouldSelectAll = selectedCards.length < allCards.length;

            allCards.forEach(card => {
                // Th√™m ho·∫∑c x√≥a class 'selected' d·ª±a tr√™n bi·∫øn shouldSelectAll
                card.classList.toggle('selected', shouldSelectAll);
                const checkbox = card.querySelector('.select-checkbox');
                if (checkbox) {
                    checkbox.checked = shouldSelectAll;
                }
            });

            updateSelectionControls(); // C·∫≠p nh·∫≠t l·∫°i giao di·ªán c√°c n√∫t
        }
        // =================================================================

        // C√°c h√†m x√≥a ·∫£nh
        function deleteImage(fileId) { /* ... gi·ªØ nguy√™n ... */ }
        async function deleteSelectedImages() { /* ... gi·ªØ nguy√™n ... */ }

        // ========== C·∫¨P NH·∫¨T H√ÄM updateSelectionControls ==========
        function updateSelectionControls() {
            const allCards = galleryArea.querySelectorAll('.img-card');
            const selectedCount = galleryArea.querySelectorAll('.img-card.selected').length;

            // C·∫≠p nh·∫≠t n√∫t "X√≥a ƒë√£ ch·ªçn"
            if (selectedCount > 0) {
                btnDeleteSelected.style.display = 'inline-flex';
                btnDeleteSelected.textContent = `üóëÔ∏è X√≥a ${selectedCount} ·∫£nh`;
            } else {
                btnDeleteSelected.style.display = 'none';
            }

            // C·∫≠p nh·∫≠t n√∫t "Ch·ªçn t·∫•t c·∫£"
            if (allCards.length > 0) {
                btnSelectAll.style.display = 'inline-flex';
                if (selectedCount === allCards.length) {
                    btnSelectAll.innerHTML = 'üî≤ B·ªè ch·ªçn t·∫•t c·∫£';
                } else {
                    btnSelectAll.innerHTML = '‚òëÔ∏è Ch·ªçn t·∫•t c·∫£';
                }
            } else {
                // ·∫®n n√∫t n·∫øu kh√¥ng c√≥ ·∫£nh n√†o
                btnSelectAll.style.display = 'none';
            }
        }
        // =========================================================
        
        // H√†m ghi log
        function logStatus(id, name, msg, type) { /* ... gi·ªØ nguy√™n ... */ }

        // Kh·ªüi ƒë·ªông
        if (SCRIPT_URL.includes('AKfyc')) {
            fetchImages();
        } else {
             alert("Vui l√≤ng s·ª≠a SCRIPT_URL trong code HTML th√†nh link Web App c·ªßa b·∫°n!");
        }

        // --- M√£ ngu·ªìn c√°c h√†m gi·ªØ nguy√™n ---
        function handlePaste(e) {
            const files = [];
            for (const item of (e.clipboardData || e.originalEvent.clipboardData).items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    files.push(item.getAsFile());
                }
            }
            if (files.length > 0) handleFiles(files);
            document.onpaste = null;
        }

        function handleFiles(files) {
            if (SCRIPT_URL.includes('AKfyc')) {
                [...files].forEach(uploadFile);
            } else {
                 alert("Vui l√≤ng s·ª≠a SCRIPT_URL trong code HTML th√†nh link Web App c·ªßa b·∫°n!");
            }
        }

        function uploadFile(file) {
            const rowId = 'log-' + Math.random().toString(36).substr(2, 9);
            logStatus(rowId, file.name, 'ƒêang t·∫£i l√™n...', 'log-loading');
            const reader = new FileReader();
            reader.onload = (e) => {
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'upload', base64: e.target.result, name: file.name })
                })
                .then(() => {
                    logStatus(rowId, file.name, '‚úÖ ƒê√£ g·ª≠i l·ªánh', 'log-success');
                    setTimeout(fetchImages, 3000);
                })
                .catch(error => { 
                    logStatus(rowId, file.name, '‚ùå L·ªói m·∫°ng', 'log-error'); 
                    console.error(error); 
                });
            };
            reader.readAsDataURL(file);
        }
        
        function renderGallery(images) {
            galleryArea.innerHTML = '';
            if (images.length === 0) {
                galleryArea.innerHTML = '<p style="text-align:center; width:100%; color:#666;">Th∆∞ m·ª•c tr·ªëng</p>';
                return;
            }
            images.forEach(img => {
                const div = document.createElement('div');
                div.className = 'img-card';
                div.dataset.fileId = img.id;
                const highResThumbUrl = `https://drive.google.com/thumbnail?id=${img.id}&sz=w2048`;
                div.innerHTML = `
                    <button class="btn-delete" title="X√≥a ·∫£nh">√ó</button>
                    <div class="img-thumb-container">
                        <img src="${highResThumbUrl}" class="img-thumb" alt="${img.name}">
                    </div>
                    <div class="img-info" title="${img.name}">${img.name}</div>
                `;
                div.querySelector('.btn-delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteImage(img.id);
                });
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'select-checkbox';
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    div.classList.toggle('selected', checkbox.checked);
                    updateSelectionControls();
                });
                div.prepend(checkbox);
                galleryArea.appendChild(div);
            });
        }
        
        function deleteImage(fileId) {
             if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y kh√¥ng?")) return;
             const card = document.querySelector(`.img-card[data-file-id="${fileId}"]`);
             if (card) card.style.opacity = '0.3';
             fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', fileId }) })
             .then(() => { 
                 if (card) card.remove();
                 updateSelectionControls();
             })
             .catch(() => { 
                 alert("L·ªói khi x√≥a ·∫£nh."); 
                 if (card) card.style.opacity = '1'; 
             });
        }

        async function deleteSelectedImages() {
            const selectedCards = document.querySelectorAll('.img-card.selected');
            if (selectedCards.length === 0) return;
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedCards.length} ·∫£nh ƒë√£ ch·ªçn?`)) return;
            for (const card of selectedCards) {
                card.style.opacity = '0.3';
                try {
                    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', fileId: card.dataset.fileId }) });
                    card.remove();
                } catch (err) {
                    card.style.opacity = '1';
                }
            }
            updateSelectionControls();
        }
        
        function logStatus(id, name, msg, type) {
            let logRow = statusList.querySelector(`#${id}`);
            const html = `<span>${name}</span> <span class="${type}">${msg}</span>`;
            if (!logRow) {
                logRow = document.createElement('div');
                logRow.id = id;
                logRow.className = 'log-item';
                statusList.prepend(logRow);
            }
            logRow.innerHTML = html;
        }

    });
    </script>

</body>
</html>

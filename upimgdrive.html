<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω ·∫¢nh Drive</title>
    <style>
        /* --- C√ÄI ƒê·∫∂T CHUNG --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #ddd; margin: 0; padding: 20px; }

        /* --- CSS CHUNG --- */
        h2 { text-align: center; color: #fff; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .upload-box { background: #2d2d2d; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-align: center; margin-bottom: 30px; }
        #paste-area {
            border: 2px dashed #555; height: 120px; display: flex; align-items: center; justify-content: center;
            margin: 15px 0; cursor: pointer; color: #aaa; flex-direction: column; transition: 0.3s;
            background: #252525; border-radius: 8px;
        }
        #paste-area.active { border-color: #4CAF50; background: #2f3f2f; color: #fff; }
        #paste-area:hover { border-color: #666; }
        .file-input-wrapper { margin-top: 10px; }
        input[type="file"] { display: none; }
        .btn-select { background: #2196F3; color: white; padding: 8px 20px; border-radius: 5px; cursor: pointer; display: inline-block; font-size: 14px; transition: 0.2s; }
        .btn-select:hover { background: #1976D2; }
        .status-log { margin-top: 10px; font-size: 13px; text-align: left; max-height: 100px; overflow-y: auto; color: #bbb; }
        .log-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #333; }
        .log-success { color: #4CAF50; } .log-error { color: #f44336; } .log-loading { color: #FF9800; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn { color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: background 0.2s; }
        .btn-refresh { background: #444; } .btn-refresh:hover { background: #555; }
        .btn-delete-selected { background: #c0392b; } .btn-delete-selected:hover { background: #e74c3c; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .img-card { background: #2d2d2d; border-radius: 8px; overflow: hidden; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .img-card:hover { transform: translateY(-3px); }
        .img-thumb { width: 100%; height: 180px; object-fit: cover; display: block; cursor: pointer; background-color: #000; }
        .img-info { padding: 8px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-top: 1px solid #333; }
        .btn-delete { position: absolute; top: 8px; right: 8px; background: rgba(244, 67, 54, 0.8); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; opacity: 0; transition: 0.2s; z-index: 10; }
        .img-card:hover .btn-delete { opacity: 1; }
        .btn-delete:hover { background: #d32f2f; transform: scale(1.1); }
        .img-card.selected { box-shadow: 0 0 0 3px #2196F3; }
        .img-card.selected::after { content: '‚úî'; position: absolute; top: 8px; left: 8px; background: #2196F3; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; pointer-events: none; }
        .loading-overlay { text-align: center; padding: 20px; color: #888; font-style: italic; }

        /* --- CSS CHO LIGHTBOX --- */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .lightbox.show { opacity: 1; visibility: visible; }
        .lightbox-content { max-width: 90%; max-height: 90%; position: relative; }
        .lightbox-content img { width: 100%; height: 100%; object-fit: contain; }
        .lightbox-close { position: absolute; top: -40px; right: 0; font-size: 35px; color: #fff; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <!-- M√¥ t·∫£ phi√™n b·∫£n -->
        <div style="background: #252525; border-left: 4px solid #f39c12; color: #ccc; padding: 15px; margin: 20px 0; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #f39c12;">H·ªá Th·ªëng Qu·∫£n L√Ω ·∫¢nh - D√πng Link Thumbnail Ch·∫•t L∆∞·ª£ng Cao</h3>
            <p>
                <b>C√°ch ho·∫°t ƒë·ªông:</b> S·ª≠ d·ª•ng API thumbnail c·ªßa Google Drive nh∆∞ng y√™u c·∫ßu m·ªôt k√≠ch th∆∞·ªõc ·∫£nh l·ªõn (v√≠ d·ª•: `sz=w2048`). ·∫¢nh tr·∫£ v·ªÅ c√≥ ch·∫•t l∆∞·ª£ng g·∫ßn nh∆∞ g·ªëc v√† hi·ªÉn th·ªã c·ª±c k·ª≥ ·ªïn ƒë·ªãnh.
            </p>
            <p><b>∆Øu ƒëi·ªÉm:</b> R·∫•t nhanh, ·ªïn ƒë·ªãnh, kh√¥ng c·∫ßn s·ª≠a code Apps Script. T·ª∑ l·ªá th√†nh c√¥ng cao nh·∫•t.</p>
        </div>
        
        <!-- HTML c·ªßa ·ª©ng d·ª•ng -->
        <h2>Qu·∫£n L√Ω ·∫¢nh Drive</h2>
        <div class="upload-box">
            <div id="paste-area"><span>Ctrl + V ƒë·ªÉ d√°n ·∫£nh</span><small>Ho·∫∑c k√©o th·∫£ file</small></div>
            <div class="file-input-wrapper"><label class="btn-select">üìÇ Ch·ªçn file<input type="file" id="file-input" multiple accept="image/*"></label></div>
            <div class="status-log"></div>
        </div>
        <div class="controls">
            <h3>Danh s√°ch ·∫£nh</h3>
            <div>
                <button class="btn btn-delete-selected" style="display: none;">üóëÔ∏è X√≥a ƒë√£ ch·ªçn</button>
                <button class="btn btn-refresh">‚Üª C·∫≠p nh·∫≠t</button>
            </div>
        </div>
        <div class="gallery"></div>
        <div class="loading-overlay">ƒêang t·∫£i...</div>
        
        <!-- Lightbox ƒë·ªÉ xem ·∫£nh -->
        <div class="lightbox">
            <div class="lightbox-content">
                <span class="lightbox-close">&times;</span>
                <img src="" alt="·∫¢nh ph√≥ng to">
            </div>
        </div>
    </div>

    <script>
    // ======================================================
    // D√ÅN URL APP SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby4x825A6wuoIA2jC6LUujtAK7un69P3AsxI645UWUbDmMrUWnxwjlCLNK-aXJlKyS1FA/exec'; 
    // ======================================================

    document.addEventListener('DOMContentLoaded', () => {
        // --- L·∫•y c√°c ph·∫ßn t·ª≠ DOM ---
        const pasteArea = document.getElementById('paste-area');
        const fileInput = document.getElementById('file-input');
        const statusList = document.querySelector('.status-log');
        const galleryArea = document.querySelector('.gallery');
        const loadingMsg = document.querySelector('.loading-overlay');
        const btnDeleteSelected = document.querySelector('.btn-delete-selected');
        const btnRefresh = document.querySelector('.btn-refresh');
        const lightbox = document.querySelector('.lightbox');
        const lightboxImg = lightbox.querySelector('img');
        const lightboxClose = lightbox.querySelector('.lightbox-close');

        // --- G√°n s·ª± ki·ªán ---
        pasteArea.addEventListener('dragleave', () => pasteArea.classList.remove('active'));
        pasteArea.addEventListener('dragover', (e) => { e.preventDefault(); pasteArea.classList.add('active'); });
        pasteArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pasteArea.classList.remove('active');
            handleFiles(e.dataTransfer.files);
        });
        pasteArea.addEventListener('click', () => {
             pasteArea.querySelector('span').textContent = 'ƒêang ch·ªù d√°n...';
             document.onpaste = (e) => {
                handlePaste(e);
                pasteArea.querySelector('span').textContent = 'Ctrl + V ƒë·ªÉ d√°n ·∫£nh';
             };
        });
        fileInput.addEventListener('change', (e) => { 
            handleFiles(e.target.files); 
            e.target.value = ''; // Reset input ƒë·ªÉ c√≥ th·ªÉ ch·ªçn l·∫°i file gi·ªëng nhau
        });
        btnRefresh.addEventListener('click', fetchImages);
        btnDeleteSelected.addEventListener('click', deleteSelectedImages);

        // --- Ch·ª©c nƒÉng x·ª≠ l√Ω file ---
        function handlePaste(e) {
            const files = [];
            for (const item of (e.clipboardData || e.originalEvent.clipboardData).items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    files.push(item.getAsFile());
                }
            }
            if (files.length > 0) handleFiles(files);
            document.onpaste = null; // H·ªßy s·ª± ki·ªán sau khi d√°n xong
        }

        function handleFiles(files) {
            if (SCRIPT_URL.includes('AKfyc')) { // Ki·ªÉm tra SCRIPT_URL m·∫∑c ƒë·ªãnh
                [...files].forEach(uploadFile);
            } else {
                 alert("Vui l√≤ng s·ª≠a SCRIPT_URL trong code HTML th√†nh link Web App c·ªßa b·∫°n!");
            }
        }

        function uploadFile(file) {
            const rowId = 'log-' + Math.random().toString(36).substr(2, 9);
            logStatus(rowId, file.name, 'ƒêang t·∫£i l√™n...', 'log-loading');

            const reader = new FileReader();
            reader.onload = (e) => {
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // S·ª≠ d·ª•ng no-cors ƒë·ªÉ g·ª≠i l·ªánh m√† kh√¥ng c·∫ßn ch·ªù ph·∫£n h·ªìi ph·ª©c t·∫°p
                    body: JSON.stringify({ action: 'upload', base64: e.target.result, name: file.name })
                })
                .then(() => {
                    logStatus(rowId, file.name, '‚úÖ ƒê√£ g·ª≠i l·ªánh (Ch·ªù c·∫≠p nh·∫≠t)', 'log-success');
                    // T·ª± ƒë·ªông c·∫≠p nh·∫≠t sau m·ªôt kho·∫£ng th·ªùi gian ng·∫Øn
                    setTimeout(fetchImages, 3000);
                })
                .catch(error => { 
                    logStatus(rowId, file.name, '‚ùå L·ªói m·∫°ng', 'log-error'); 
                    console.error(error); 
                });
            };
            reader.readAsDataURL(file);
        }

        // --- Ch·ª©c nƒÉng hi·ªÉn th·ªã v√† qu·∫£n l√Ω th∆∞ vi·ªán ·∫£nh ---
        function fetchImages() {
            loadingMsg.style.display = 'block';
            galleryArea.innerHTML = '';
            updateSelectionControls();

            fetch(SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                loadingMsg.style.display = 'none';
                if (data.result === 'success') {
                    renderGallery(data.images);
                } else {
                    loadingMsg.innerHTML = 'L·ªói: ' + data.message;
                    loadingMsg.style.display = 'block';
                }
            })
            .catch(err => {
                loadingMsg.innerHTML = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. H√£y ki·ªÉm tra l·∫°i link SCRIPT_URL ho·∫∑c ƒë∆∞·ªùng truy·ªÅn m·∫°ng.';
                loadingMsg.style.display = 'block';
                console.error(err);
            });
        }

        function renderGallery(images) {
            galleryArea.innerHTML = ''; // X√≥a ·∫£nh c≈© tr∆∞·ªõc khi render
            if (images.length === 0) {
                galleryArea.innerHTML = '<p style="text-align:center; width:100%; color:#666;">Th∆∞ m·ª•c tr·ªëng</p>';
                return;
            }

            images.forEach(img => {
                const div = document.createElement('div');
                div.className = 'img-card';
                div.dataset.fileId = img.id;
                
                const thumbUrl = img.url; // Google t·ª± ƒë·ªông t·∫°o thumbnail
                const highResUrl = `https://drive.google.com/thumbnail?id=${img.id}&sz=w2048`;

                div.innerHTML = `
                    <button class="btn-delete" title="X√≥a ·∫£nh">√ó</button>
                    <img src="${thumbUrl}" class="img-thumb" alt="${img.name}" data-highres-url="${highResUrl}">
                    <div class="img-info" title="${img.name}">${img.name}</div>
                `;
                
                // G√°n s·ª± ki·ªán tr·ª±c ti·∫øp thay v√¨ d√πng onclick trong HTML
                div.querySelector('.btn-delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteImage(img.id);
                });

                div.querySelector('.img-thumb').addEventListener('click', () => {
                    openLightbox(highResUrl);
                });

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'select-checkbox';
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    div.classList.toggle('selected', checkbox.checked);
                    updateSelectionControls();
                });
                div.prepend(checkbox);

                galleryArea.appendChild(div);
            });
        }
        
        function deleteImage(fileId) {
             if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y kh√¥ng?")) return;
             const card = document.querySelector(`.img-card[data-file-id="${fileId}"]`);
             if (card) card.style.opacity = '0.3';
             
             fetch(SCRIPT_URL, { 
                 method: 'POST', 
                 mode: 'no-cors', 
                 body: JSON.stringify({ action: 'delete', fileId: fileId }) 
             })
             .then(() => { 
                 if (card) card.remove();
                 updateSelectionControls();
             })
             .catch(() => { 
                 alert("L·ªói khi x√≥a ·∫£nh."); 
                 if (card) card.style.opacity = '1'; 
             });
        }

        async function deleteSelectedImages() {
            const selectedCards = document.querySelectorAll('.img-card.selected');
            if (selectedCards.length === 0) return;
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedCards.length} ·∫£nh ƒë√£ ch·ªçn?`)) return;

            for (const card of selectedCards) {
                card.style.opacity = '0.3';
                try {
                    await fetch(SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        body: JSON.stringify({ action: 'delete', fileId: card.dataset.fileId }) 
                    });
                    card.remove();
                } catch (err) {
                    console.error('L·ªói x√≥a file:', card.dataset.fileId);
                    card.style.opacity = '1';
                }
            }
            updateSelectionControls();
        }

        function updateSelectionControls() {
            const selectedCount = document.querySelectorAll('.img-card.selected').length;
            if (selectedCount > 0) {
                btnDeleteSelected.style.display = 'inline-flex';
                btnDeleteSelected.textContent = `üóëÔ∏è X√≥a ${selectedCount} ·∫£nh`;
            } else {
                btnDeleteSelected.style.display = 'none';
            }
        }
        
        function logStatus(id, name, msg, type) {
            let logRow = statusList.querySelector(`#${id}`);
            const html = `<span>${name}</span> <span class="${type}">${msg}</span>`;
            if (!logRow) {
                logRow = document.createElement('div');
                logRow.id = id;
                logRow.className = 'log-item';
                statusList.prepend(logRow);
            }
            logRow.innerHTML = html;
        }

        // --- Ch·ª©c nƒÉng Lightbox ---
        function openLightbox(imageUrl) {
            lightboxImg.src = imageUrl;
            lightbox.classList.add('show');
        }

        function closeLightbox() {
            lightbox.classList.remove('show');
            lightboxImg.src = ''; // X√≥a link ·∫£nh ƒë·ªÉ tr√°nh t·∫£i l·∫°i
        }

        lightboxClose.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => {
            // Ch·ªâ ƒë√≥ng khi click v√†o n·ªÅn ƒëen, kh√¥ng ph·∫£i ·∫£nh
            if (e.target === lightbox) {
                closeLightbox();
            }
        });

        // --- T·ª± ƒë·ªông t·∫£i ·∫£nh khi trang ƒë∆∞·ª£c m·ªü ---
        if (SCRIPT_URL.includes('AKfyc')) { // Ki·ªÉm tra SCRIPT_URL m·∫∑c ƒë·ªãnh
            fetchImages();
        } else {
             alert("Vui l√≤ng s·ª≠a SCRIPT_URL trong code HTML th√†nh link Web App c·ªßa b·∫°n!");
        }
    });
    </script>

</body>
</html>

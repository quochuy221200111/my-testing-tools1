<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω ·∫¢nh Drive</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #ddd; margin: 0; padding: 20px; }
        h2 { text-align: center; color: #fff; margin-bottom: 20px; }
        
        /* Container ch√≠nh */
        .container { max-width: 1000px; margin: 0 auto; }

        /* Khu v·ª±c Upload */
        .upload-box { 
            background: #2d2d2d; padding: 20px; border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-align: center; margin-bottom: 30px;
        }
        
        #paste-area { 
            border: 2px dashed #555; height: 120px; display: flex; align-items: center; 
            justify-content: center; margin: 15px 0; cursor: pointer; color: #aaa;
            flex-direction: column; transition: 0.3s; background: #252525;
            border-radius: 8px;
        }
        #paste-area.active { border-color: #4CAF50; background: #2f3f2f; color: #fff; }
        #paste-area:hover { border-color: #666; }
        
        /* N√∫t ch·ªçn file th·ªß c√¥ng */
        .file-input-wrapper { margin-top: 10px; }
        input[type="file"] { display: none; }
        .btn-select {
            background: #2196F3; color: white; padding: 8px 20px; border-radius: 5px; cursor: pointer;
            display: inline-block; font-size: 14px; transition: 0.2s;
        }
        .btn-select:hover { background: #1976D2; }

        /* Khu v·ª±c hi·ªÉn th·ªã tr·∫°ng th√°i log */
        .status-log { margin-top: 10px; font-size: 13px; text-align: left; max-height: 100px; overflow-y: auto; color: #bbb; }
        .log-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #333; }
        .log-success { color: #4CAF50; } .log-error { color: #f44336; } .log-loading { color: #FF9800; }

        /* N√∫t Refresh */
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-refresh { 
            background: #444; color: #fff; border: none; padding: 8px 15px; border-radius: 5px; 
            cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px;
        }
        .btn-refresh:hover { background: #555; }

        /* --- S·ª¨A ƒê·ªîI PH·∫¶N GRID V√Ä ·∫¢NH --- */
        .gallery { 
            display: grid; 
            /* C·ªôt t·ª± ƒë·ªông co gi√£n, t·ªëi thi·ªÉu 180px */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 15px; 
            align-items: start; /* CƒÉn ch·ªânh c√°c item l√™n tr√™n c√πng ƒë·ªÉ tr√°nh kho·∫£ng tr·∫Øng l·∫° */
        }
        
        .img-card { 
            background: #2d2d2d; border-radius: 8px; overflow: hidden; 
            position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            transition: transform 0.2s;
            /* Kh√¥ng set chi·ªÅu cao c·ªë ƒë·ªãnh cho card */
        }
        .img-card:hover { transform: translateY(-3px); }
        
        /* S·ª≠a ƒë·ªïi style ·∫£nh thumbnail */
        .img-thumb { 
            width: 100%; 
            height: auto; /* ƒê·ªÉ chi·ªÅu cao t·ª± ƒë·ªông theo ·∫£nh */
            max-height: 400px; /* (T√πy ch·ªçn) Gi·ªõi h·∫°n chi·ªÅu cao n·∫øu ·∫£nh qu√° d√†i */
            object-fit: contain; /* ƒê·∫£m b·∫£o hi·ªÉn th·ªã tr·ªçn v·∫πn ·∫£nh */
            display: block; 
            cursor: pointer;
            background-color: #000; /* Th√™m n·ªÅn ƒëen n·∫øu ·∫£nh trong su·ªët */
        }
        
        .img-info { padding: 8px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-top: 1px solid #333; }

        /* S·ª≠a ƒë·ªïi n√∫t x√≥a - Lu√¥n hi·ªán */
        .btn-delete {
            position: absolute; top: 5px; right: 5px;
            background: #f44336; /* M√†u ƒë·ªè r√µ h∆°n */
            color: white; border: none;
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; 
            opacity: 1; /* LU√îN HI·ªÜN (Thay v√¨ 0) */
            box-shadow: 0 2px 4px rgba(0,0,0,0.6); /* Th√™m b√≥ng ƒë·ªÉ d·ªÖ nh√¨n tr√™n n·ªÅn tr·∫Øng */
            transition: 0.2s;
            z-index: 10;
        }
        .btn-delete:hover { background: #d32f2f; transform: scale(1.1); }
        
        /* Hi·ªáu ·ª©ng ƒëang t·∫£i danh s√°ch */
        .loading-overlay { text-align: center; padding: 20px; color: #888; font-style: italic; }

    </style>
</head>
<body>

    <div class="container">
        <h2>Qu·∫£n L√Ω ·∫¢nh Drive</h2>

        <!-- KHU V·ª∞C UPLOAD -->
        <div class="upload-box">
            <div id="paste-area">
                <span>Click v√†o ƒë√¢y v√† nh·∫•n <b>Ctrl + V</b> (D√°n ·∫£nh)</span>
                <small>Ho·∫∑c k√©o th·∫£ file v√†o khung n√†y</small>
            </div>
            
            <div class="file-input-wrapper">
                <label class="btn-select">
                    üìÇ Ch·ªçn file t·ª´ m√°y t√≠nh
                    <input type="file" id="file-input" multiple accept="image/*">
                </label>
            </div>
            <div id="status-list" class="status-log"></div>
        </div>

        <!-- KHU V·ª∞C HI·ªÇN TH·ªä ·∫¢NH -->
        <div class="controls">
            <h3>Danh s√°ch ·∫£nh tr√™n Drive</h3>
            <button class="btn-refresh" onclick="fetchImages()">‚Üª C·∫≠p nh·∫≠t danh s√°ch</button>
        </div>
        
        <div id="gallery-area" class="gallery">
            <!-- ·∫¢nh s·∫Ω ƒë∆∞·ª£c load v√†o ƒë√¢y -->
        </div>
        <div id="loading-msg" class="loading-overlay">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Drive...</div>
    </div>

    <script>
        // ======================================================
        // D√ÅN URL APP SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY (GI·ªÆ NGUY√äN)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby4x825A6wuoIA2jC6LUujtAK7un69P3AsxI645UWUbDmMrUWnxwjlCLNK-aXJlKyS1FA/exec'; 
        // ======================================================

        const pasteArea = document.getElementById('paste-area');
        const fileInput = document.getElementById('file-input');
        const statusList = document.getElementById('status-list');
        const galleryArea = document.getElementById('gallery-area');
        const loadingMsg = document.getElementById('loading-msg');

        // --- 1. X·ª¨ L√ù S·ª∞ KI·ªÜN UPLOAD (Paste, Drop, Select) ---
        pasteArea.addEventListener('click', () => pasteArea.classList.add('active'));
        pasteArea.addEventListener('dragleave', () => pasteArea.classList.remove('active'));
        pasteArea.addEventListener('dragover', (e) => { e.preventDefault(); pasteArea.classList.add('active'); });

        pasteArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pasteArea.classList.remove('active');
            handleFiles(e.dataTransfer.files);
        });

        document.onpaste = function(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            const files = [];
            for (let item of items) {
                if (item.kind === 'file' && item.type.includes('image')) {
                    files.push(item.getAsFile());
                }
            }
            if (files.length > 0) handleFiles(files);
        };

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = ''; 
        });

        function handleFiles(files) {
            if (SCRIPT_URL.includes('XXXXX')) {
                alert("Vui l√≤ng s·ª≠a SCRIPT_URL trong code HTML th√†nh link Web App c·ªßa b·∫°n!");
                return;
            }
            ([...files]).forEach(uploadFile);
        }

        // --- 2. H√ÄM UPLOAD FILE ---
        function uploadFile(file) {
            const rowId = 'log-' + Math.random().toString(36).substr(2, 9);
            logStatus(rowId, file.name, 'ƒêang t·∫£i l√™n...', 'log-loading');

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'upload', 
                        base64: base64,
                        name: file.name
                    })
                })
                .then(() => {
                    logStatus(rowId, file.name, '‚úÖ ƒê√£ g·ª≠i l·ªánh (Ch·ªù c·∫≠p nh·∫≠t)', 'log-success');
                    setTimeout(fetchImages, 3000); 
                })
                .catch(error => {
                    logStatus(rowId, file.name, '‚ùå L·ªói m·∫°ng', 'log-error');
                    console.error(error);
                });
            };
            reader.readAsDataURL(file);
        }

        // --- 3. H√ÄM L·∫§Y DANH S√ÅCH ·∫¢NH (GET) ---
        function fetchImages() {
            loadingMsg.style.display = 'block';
            galleryArea.innerHTML = ''; 

            fetch(SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                loadingMsg.style.display = 'none';
                if (data.result === 'success') {
                    renderGallery(data.images);
                } else {
                    loadingMsg.innerHTML = 'L·ªói: ' + data.message;
                    loadingMsg.style.display = 'block';
                }
            })
            .catch(err => {
                loadingMsg.innerHTML = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi Server.';
                loadingMsg.style.display = 'block';
                console.error(err);
            });
        }

        function renderGallery(images) {
            if (images.length === 0) {
                galleryArea.innerHTML = '<p style="text-align:center; width:100%; color:#666;">Th∆∞ m·ª•c tr·ªëng</p>';
                return;
            }

            images.forEach(img => {
                const div = document.createElement('div');
                div.className = 'img-card';
                div.id = 'img-' + img.id;
                div.innerHTML = `
                    <button class="btn-delete" onclick="deleteImage('${img.id}')" title="X√≥a ·∫£nh">√ó</button>
                    <a href="${img.url.replace('thumbnail', 'uc')}&export=view" target="_blank">
                        <img src="${img.url}" class="img-thumb" alt="${img.name}">
                    </a>
                    <div class="img-info">${img.name}</div>
                `;
                galleryArea.appendChild(div);
            });
        }

        // --- 4. H√ÄM X√ìA ·∫¢NH (POST) ---
        function deleteImage(fileId) {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y kh√¥ng?")) return;

            const card = document.getElementById('img-' + fileId);
            if (card) card.style.opacity = '0.3';

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'delete',
                    fileId: fileId
                })
            })
            .then(() => {
                console.log("ƒê√£ g·ª≠i l·ªánh x√≥a: " + fileId);
                if (card) card.remove();
                setTimeout(fetchImages, 2000);
            })
            .catch(err => {
                alert("L·ªói khi g·ª≠i l·ªánh x√≥a");
                if (card) card.style.opacity = '1'; 
            });
        }

        function logStatus(id, name, msg, type) {
            const oldRow = document.getElementById(id);
            const html = `<span>${name}</span> <span class="${type}">${msg}</span>`;
            if (oldRow) {
                oldRow.innerHTML = html;
            } else {
                const div = document.createElement('div');
                div.id = id;
                div.className = 'log-item';
                div.innerHTML = html;
                statusList.prepend(div);
            }
        }

        if (!SCRIPT_URL.includes('XXXXX')) {
            fetchImages();
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω File Drive</title>
    <style>
        /* ... (CSS gi·ªØ nguy√™n, kh√¥ng c·∫ßn thay ƒë·ªïi) ... */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #ddd; margin: 0; padding: 20px; }
        h2 { text-align: center; color: #fff; margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .upload-box { background: #2d2d2d; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-align: center; margin-bottom: 30px; }
        #paste-area {
            border: 2px dashed #555; height: 120px; display: flex; align-items: center; justify-content: center;
            margin: 15px 0; cursor: pointer; color: #aaa; flex-direction: column; transition: 0.3s;
            background: #252525; border-radius: 8px;
        }
        #paste-area.active { border-color: #4CAF50; background: #2f3f2f; color: #fff; }
        #paste-area:hover { border-color: #666; }
        .file-input-wrapper { margin-top: 10px; }
        input[type="file"] { display: none; }
        .btn-select { background: #2196F3; color: white; padding: 8px 20px; border-radius: 5px; cursor: pointer; display: inline-block; font-size: 14px; transition: 0.2s; }
        .btn-select:hover { background: #1976D2; }
        .status-log { margin-top: 10px; font-size: 13px; text-align: left; max-height: 100px; overflow-y: auto; color: #bbb; }
        .log-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid #333; }
        .log-success { color: #4CAF50; } .log-error { color: #f44336; } .log-loading { color: #FF9800; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .controls h3 { margin-right: auto; }
        .controls .button-group { display: flex; gap: 10px; }
        .btn { color: #fff; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; transition: background 0.2s; }
        .btn-refresh { background: #444; } .btn-refresh:hover { background: #555; }
        .btn-delete-selected { background: #c0392b; } .btn-delete-selected:hover { background: #e74c3c; }
        .btn-select-all { background: #007bff; } .btn-select-all:hover { background: #0056b3; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .file-card { background: #2d2d2d; border-radius: 8px; overflow: hidden; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; display: flex; flex-direction: column; cursor: pointer; }
        .file-card:hover { transform: translateY(-3px); }
        .file-thumb-container { width: 100%; height: 180px; background-color: #252525; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 10px; box-sizing: border-box;}
        .file-thumb-img { width: 100%; height: 100%; object-fit: contain; display: block; }
        .file-icon-svg { width: 60px; height: 75px; }
        .file-extension { font-weight: bold; color: #fff; background-color: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; margin-top: 10px; font-size: 14px; }
        .file-info { padding: 8px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-top: 1px solid #333; margin-top: auto; }
        /* Th√™m style cho link t√™n file */
        .file-info a { color: #ddd; text-decoration: none; display: block; }
        .file-info a:hover { color: #2196F3; }
        .btn-delete { position: absolute; top: 8px; right: 8px; background: rgba(244, 67, 54, 0.8); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; opacity: 0; transition: 0.2s; z-index: 10; }
        .file-card:hover .btn-delete { opacity: 1; }
        .btn-delete:hover { background: #d32f2f; transform: scale(1.1); }
        .file-card.selected { box-shadow: 0 0 0 3px #2196F3; }
        .file-card.selected::after { content: '‚úî'; position: absolute; top: 8px; left: 8px; background: #2196F3; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; pointer-events: none; }
        .loading-overlay { text-align: center; padding: 20px; color: #888; font-style: italic; }
    </style>
</head>
<body>
    <!-- ... (Ph·∫ßn body HTML gi·ªØ nguy√™n) ... -->
    <div class="container">
        <div style="background: #252525; border-left: 4px solid #f39c12; color: #ccc; padding: 15px; margin: 20px 0; border-radius: 5px;">
            <h3 style="margin-top: 0; color: #f39c12;">H·ªá Th·ªëng Qu·∫£n L√Ω File Drive</h3>
            <p><b>T√≠nh nƒÉng:</b> Upload v√† qu·∫£n l√Ω m·ªçi lo·∫°i file. T√™n file l√† link ƒë·ªÉ m·ªü/t·∫£i v·ªÅ. Click v√†o ·∫£nh/icon ƒë·ªÉ ch·ªçn x√≥a.</p>
        </div>
        <h2>Qu·∫£n L√Ω File Drive</h2>
        <div class="upload-box">
            <div id="paste-area"><span>Ctrl + V ƒë·ªÉ d√°n ·∫£nh</span><small>Ho·∫∑c k√©o th·∫£ file b·∫•t k·ª≥</small></div>
            <div class="file-input-wrapper"><label class="btn-select">üìÇ Ch·ªçn file<input type="file" id="file-input" multiple></label></div>
            <div class="status-log"></div>
        </div>
        <div class="controls">
            <h3>Danh s√°ch file</h3>
            <div class="button-group">
                <button class="btn btn-delete-selected" style="display: none;">üóëÔ∏è X√≥a ƒë√£ ch·ªçn</button>
                <button id="btn-select-all" class="btn btn-select-all" style="display: none;">‚òëÔ∏è Ch·ªçn t·∫•t c·∫£</button>
                <button class="btn btn-refresh">‚Üª C·∫≠p nh·∫≠t</button>
            </div>
        </div>
        <div class="gallery"></div>
        <div class="loading-overlay">ƒêang t·∫£i...</div>
    </div>

    <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpZJEPOf36UU_xqEio-zKvJ46Fa1i6VHEfVor2avEq9WLmD3WBkNve_YTVnyg1dJobGw/exec'; // Thay URL c·ªßa b·∫°n v√†o ƒë√¢y

    document.addEventListener('DOMContentLoaded', () => {
        const galleryArea = document.querySelector('.gallery');
        
        function getIconForFile(mimeType, fileName) { /* ... (h√†m n√†y gi·ªØ nguy√™n) ... */
            const extension = fileName.split('.').pop().toLowerCase();
            let color = '#555';
            let iconPath = 'M20 8l-8 8-8-8h16z';
            if (mimeType.includes('pdf')) { color = '#D32F2F'; iconPath = 'M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H10v-2h8v2zm-4-4H10v-2h4v2zm4-4H10V6h8v2z';
            } else if (mimeType.includes('zip') || mimeType.includes('rar') || mimeType.includes('compressed')) { color = '#F57C00'; iconPath = 'M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-2 6h-2v2h-2v-2h-2v-2h2v-2h2v2h2v2z';
            } else if (mimeType.includes('word')) { color = '#1976D2'; iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 11h-2v-2h2v2zm-1 5.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm-2-7h-2v2h2v-2z';
            } else if (mimeType.includes('spreadsheet') || mimeType.includes('excel')) { color = '#388E3C'; iconPath = 'M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-2 14h-2v-2h2v2zm-2-4h-2v-2h2v2zm4 4h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V9h2v3z'; }
            return `<svg class="file-icon-svg" viewBox="0 0 24 24"><path fill="${color}" d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6z" /><path fill="#fff" opacity="0.6" d="${iconPath}" /></svg><span class="file-extension">${extension}</span>`;
        }
        
        // ===============================================
        // === C·∫¨P NH·∫¨T CH√çNH TRONG H√ÄM renderGallery ===
        // ===============================================
        function renderGallery(files) {
            galleryArea.innerHTML = '';
            if (!files || files.length === 0) {
                galleryArea.innerHTML = '<p style="text-align:center; width:100%; color:#666;">Th∆∞ m·ª•c tr·ªëng</p>';
                return;
            }
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-card';
                div.dataset.fileId = file.id;

                let fileDisplayHTML = '';
                if (file.mimeType.startsWith('image/')) {
                    fileDisplayHTML = `<img src="${file.url}&sz=w512" class="file-thumb-img" alt="${file.name}" loading="lazy">`;
                } else {
                    fileDisplayHTML = getIconForFile(file.mimeType, file.name);
                }
                
                // Thay th·∫ø th·∫ª div.file-info b·∫±ng th·∫ª a.file-info
                div.innerHTML = `
                    <button class="btn-delete" title="X√≥a file">√ó</button>
                    <div class="file-thumb-container">${fileDisplayHTML}</div>
                    <div class="file-info" title="M·ªü file: ${file.name}">
                        <a href="${file.driveUrl}" target="_blank">${file.name}</a>
                    </div>
                `;

                // S·ª± ki·ªán click v√†o th·∫ª (card) ƒë·ªÉ ch·ªçn
                div.addEventListener('click', () => {
                    div.classList.toggle('selected');
                    updateSelectionControls();
                });

                // NgƒÉn s·ª± ki·ªán click v√†o link t√™n file l√†m th·∫ª b·ªã ch·ªçn theo
                div.querySelector('.file-info a').addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                // NgƒÉn s·ª± ki·ªán click v√†o n√∫t x√≥a l√†m th·∫ª b·ªã ch·ªçn theo
                div.querySelector('.btn-delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFile(file.id);
                });
                
                galleryArea.appendChild(div);
            });
            updateSelectionControls();
        }

        // ... (T·∫•t c·∫£ c√°c h√†m c√≤n l·∫°i gi·ªØ nguy√™n kh√¥ng thay ƒë·ªïi) ...
        const loadingMsg = document.querySelector('.loading-overlay');
        function fetchFiles() {
            loadingMsg.style.display = 'block';
            galleryArea.innerHTML = '';
            updateSelectionControls(); 
            fetch(SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                loadingMsg.style.display = 'none';
                if (data.result === 'success') { renderGallery(data.files); } else { loadingMsg.innerHTML = 'L·ªói: ' + data.message; }
                updateSelectionControls();
            })
            .catch(err => { loadingMsg.innerHTML = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.'; console.error(err); });
        }
        const btnDeleteSelected = document.querySelector('.btn-delete-selected');
        const btnSelectAll = document.getElementById('btn-select-all');
        btnDeleteSelected.addEventListener('click', deleteSelectedFiles);
        btnSelectAll.addEventListener('click', toggleSelectAll);
        function toggleSelectAll() {
            const allCards = galleryArea.querySelectorAll('.file-card');
            const shouldSelectAll = galleryArea.querySelectorAll('.file-card.selected').length < allCards.length;
            allCards.forEach(card => card.classList.toggle('selected', shouldSelectAll));
            updateSelectionControls();
        }
        function updateSelectionControls() {
            const allCardsCount = galleryArea.querySelectorAll('.file-card').length;
            const selectedCount = galleryArea.querySelectorAll('.file-card.selected').length;
            btnDeleteSelected.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
            btnDeleteSelected.textContent = `üóëÔ∏è X√≥a ${selectedCount} file`;
            btnSelectAll.style.display = allCardsCount > 0 ? 'inline-flex' : 'none';
            btnSelectAll.innerHTML = (selectedCount === allCardsCount && allCardsCount > 0) ? 'üî≤ B·ªè ch·ªçn t·∫•t c·∫£' : '‚òëÔ∏è Ch·ªçn t·∫•t c·∫£';
        }
        function deleteFile(fileId) {
             if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a file n√†y kh√¥ng?")) return;
             const card = document.querySelector(`.file-card[data-file-id="${fileId}"]`);
             if (card) card.style.opacity = '0.3';
             fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', fileId }) })
             .then(() => { if (card) card.remove(); updateSelectionControls(); })
             .catch(() => { alert("L·ªói khi x√≥a file."); if (card) card.style.opacity = '1'; });
        }
        async function deleteSelectedFiles() {
            const selectedCards = document.querySelectorAll('.file-card.selected');
            if (selectedCards.length === 0 || !confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedCards.length} file ƒë√£ ch·ªçn?`)) return;
            for (const card of selectedCards) {
                card.style.opacity = '0.3';
                try {
                    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', fileId: card.dataset.fileId }) });
                    card.remove();
                } catch (err) { card.style.opacity = '1'; }
            }
            updateSelectionControls();
        }
        const fileInput = document.getElementById('file-input');
        const btnRefresh = document.querySelector('.btn-refresh');
        const pasteArea = document.getElementById('paste-area');
        const statusList = document.querySelector('.status-log');
        btnRefresh.addEventListener('click', fetchFiles);
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        pasteArea.addEventListener('dragleave', () => pasteArea.classList.remove('active'));
        pasteArea.addEventListener('dragover', (e) => { e.preventDefault(); pasteArea.classList.add('active'); });
        pasteArea.addEventListener('drop', (e) => { e.preventDefault(); pasteArea.classList.remove('active'); handleFiles(e.dataTransfer.files); });
        pasteArea.addEventListener('click', () => {
             pasteArea.querySelector('span').textContent = 'ƒêang ch·ªù d√°n...';
             document.onpaste = (e) => {
                const files = Array.from((e.clipboardData || e.originalEvent.clipboardData).items).filter(item => item.kind === 'file' && item.type.startsWith('image/')).map(item => item.getAsFile());
                if (files.length > 0) handleFiles(files);
                document.onpaste = null;
                pasteArea.querySelector('span').textContent = 'Ctrl + V ƒë·ªÉ d√°n ·∫£nh';
             };
        });
        function handleFiles(files) { [...files].forEach(uploadFile); }
        function uploadFile(file) {
            const rowId = 'log-' + Math.random().toString(36).substr(2, 9);
            logStatus(rowId, file.name, 'ƒêang t·∫£i l√™n...', 'log-loading');
            const reader = new FileReader();
            reader.onload = (e) => {
                fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'upload', base64: e.target.result, name: file.name }) })
                .then(() => { logStatus(rowId, file.name, '‚úÖ ƒê√£ g·ª≠i l·ªánh', 'log-success'); setTimeout(fetchFiles, 2000); })
                .catch(error => { logStatus(rowId, file.name, '‚ùå L·ªói m·∫°ng', 'log-error'); console.error(error); });
            };
            reader.readAsDataURL(file);
        }
        function logStatus(id, name, msg, type) {
            let logRow = statusList.querySelector(`#${id}`);
            if (!logRow) { logRow = document.createElement('div'); logRow.id = id; logRow.className = 'log-item'; statusList.prepend(logRow); }
            logRow.innerHTML = `<span>${name}</span> <span class="${type}">${msg}</span>`;
        }
        if (SCRIPT_URL && SCRIPT_URL.includes('AKfyc')) { fetchFiles(); } else { alert("Vui l√≤ng s·ª≠a SCRIPT_URL trong code HTML th√†nh link Web App c·ªßa b·∫°n!"); }
    });
    </script>
</body>
</html>
